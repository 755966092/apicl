<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="./css/api.css"/>
    <style>
        body{
        }
        header {
            background-color: #fff;
            height: 1rem;
            color: #A3DEA3;
            line-height: 1rem;
            text-align: center;
            position: relative;
            font-size: .36rem;
            position: relative;
        }
        
        header span:nth-child(1) {
            position: absolute;
            left: 0;
            background: url(./image/icon_login/icon_qx.png)no-repeat;
            background-size: .3rem .31rem;
            padding-left: .8rem;
            background-position: .34rem .36rem;
        }
       
        .main h3 {
            margin: .6rem auto;
            text-align: center;
            font-size: .64rem;
            color: #08BB08;
        }
        .main .ipt {
            padding: 0 .48rem; 
        }
        .main .ipt input {
            border-bottom: 1px solid #F0F0F0;
            width: 100%;
            height: .78rem;
            padding-left: 1.5rem;
            font-size: .28rem;
            outline:none;
            box-sizing: border-box;
        }
        .main .ipt input:nth-child(1) {
            background: url(./image/icon_login/icon_sj.png)no-repeat;
            -webkit-background-size: .34rem .49rem;
            background-size: .34rem .49rem;
            background-position: .26rem .16rem;
        }
        .main .ipt input:nth-child(2) {
            background: url(./image/icon_login/icon_psd.png)no-repeat;
             -webkit-background-size: .34rem .49rem;
            background-size: .34rem .49rem;
            background-position: .26rem .16rem;
        }
        .btn {
            text-align: center;
            font-size: .28rem;
        }
        .btn button {
            width: 5.4rem;
            height: .7rem;
            text-align: center;
            border-radius: .1rem;
            outline: none;
        }
        .btn button {
            background-color: #C1E9C1;
            color: #fff;
            margin-top: .9rem;
            margin-bottom: .1rem;
        }
        .btn p {
            margin-top: .1rem;
            color: #C3C3C3;
            font-size: .28rem;
        }
        .btn p span {
            color: #6B9359;
            /*background-color: #f00;
            width: .56rem;
            height: .19rem;*/
        }
        .qt {
            width: 100%;
            text-align: center;
            margin-bottom: .5rem;
        }
        .qt span:nth-child(1),
        .qt span:nth-child(3) {
            display: inline-block;
            width: 2.5rem;
            height: .01rem;
            border-bottom: 1px solid #D2EFD2;
        }
        .qt span:nth-child(2) {
            display: inline-block;
            font-size: .22rem;
            background-color: #fff;
            color: #578C45;
        }
        .qt p {
            width: .88rem;
            height: .88rem;
            background: url(./image/icon_login/icon_dsf.png);
            -webkit-background-size: .88rem .88rem;
            background-size: .88rem .88rem;
            margin: .3rem auto 0;
        }
        footer {
            font-size: .24rem;
            text-align: center;
            width: 7.5rem;
            color: #588D46;
            position: fixed;
            bottom: .5rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <header>
        <!-- <span onclick="api.closeWin()">取消</span> -->
    </header>
    <div class="main">
        <h3>我在</h3>
        <div class="ipt">
            <input placeholder="请填写手机号码" id="txzh"  type="text" name="txzh" onkeyup="iptChange()">
            <input placeholder="请填写密码" id="psd" type="password" name="">
        </div>
        <div class="btn">
            <button onclick="login()" id="login">登录</button>
            <p>没有我在账号?
                <span onclick="register()" id="register">去注册</span> 
                <span> / </span> 
                <span onclick=" forgetPsd()">忘记密码</span>
            </p>
        </div>
    </div>
    <footer>
        <div class="qt">
            <span></span>
            <span>其他方式登录</span>
            <span></span>
            <p></p>
        </div>
    </footer>
</body>
<script type="text/javascript" src="./script/api.js"></script>
<script type="text/javascript" src="./script/common.js"></script>
<script type="text/javascript">
    var userToken, rongToken;
    apiready = function(){
        fnInit();
        // 初始化模块
        moduleInit();
        // 退出app
        exitApp();
    };

    // 输入帐号登录按钮变色
    function iptChange() {
        $api.css($api.dom('#login'), 'background: #08BB08');
        if($api.val($api.dom('#txzh')) === '') {
            $api.css($api.dom('#login'), 'background: #C1E9C1');
        }
    }
    function login() {
        // 登陆 测试不输入账号密码
        var mobile = $api.val($api.dom('#txzh'));
        var password = $api.val($api.dom('#psd'));
        
        // 后期删除
        // var mobile = '17600103536';
        // var password = '123456'
        api.ajax({
            url: apiSite + '/api/login/doLogin',
            method: 'post',
            headers: apiHeader,
            data: {
                values: { 
                    mobile: mobile,
                    password: password
                }
            }
        }, function(ret, err) {
            if (ret) {
                if (ret.code == 200) {
                   
                    // 把用户token缓存到本地
                        userToken = ret.data.token;
                        rongToken = ret.data.rongcloud_token;
                    $api.setStorage('userToken', userToken);
                    $api.setStorage('rongToken', rongToken);
                    
                    // alert('缓存信息：' + $api.getStorage('userToken'))
                    // 把当前的usertoken和rongtoken广播出去
                    // sendToken (userToken,rongToken)

                    loginSuccess(userToken,rongToken);
                    rongyun(rongToken);
                } else {
                    api.toast({
                        msg: ret.msg
                    });
                }
            } else {
                api.toast({
                        msg: ret.msg
                    });
            }
        });
        
    }

    function loginSuccess () {
        // 登陆完成
         api.openWin({
            name: 'main',
            url: 'html/main.html',
            slidBackEnabled: false,
            pageParam: {
                userToken: userToken,
                rongToken: rongToken
            }
        });
    }
    // function sendToken (userToken,rongToken) {
    //     api.sendEvent({
    //         name: 'sendToken',
    //         extra: {
    //             userToken: userToken, 
    //             rongToken: rongToken
    //         }
    //     });
    // }

    // 注册
    function register() {
        api.openWin({
            name: 'registerWin',
            url: './html/enroll/login_enroll1.html',
            // pageParam: {
            //     name: 'value'
            // }
            bounces: false
        });
    }
    // 修改密码
    function forgetPsd() {
        api.openWin({
            name: 'ForgetPassword',
            url: './html/enroll/login_ForgetPassword1.html',
            bounces: false
        });
    }
   
</script>
</html>