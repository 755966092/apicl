<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <style type="text/css">
       /* #fileToUpload {
            width: .5rem;
            height: .5rem;
            background-color: #0f0;
        }*/
    </style>
</head>

<body>
    <header class="header">
        <div class="head">
            <span class="callback" tapmode="hover" onclick="api.closeWin()">返回</span>
            <span class="winTitle">
                设置
            </span>
        </div>
    </header>
    <div class="main">
        <div id="container">
            <!-- <input type="file" id="fileToUpload"> -->
            <span onclick="upload()" id='fileToUpload'>选择图片</span>
        </div>
    </div>

    <div onclick="startPush()">开始上传</div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/jquery.min.js"></script>
<script type="text/javascript" src="../../script/qiniu.min.js"></script>
<script type="text/javascript" src="../../script/moxie.min.js"></script>
<script type="text/javascript" src="../../script/plupload.dev.js"></script>
<script type="text/javascript">
    function startPush() {
        console.log(111)
        // uploader.start();
        console.log(JSON.stringify(uploader))
    }
    var uploader
    apiready = function() {
        moduleInit();
        fnInit()
        uploader = Qiniu.uploader({
                runtimes: 'html5,flash,html4',      // 上传模式，依次退化
                browse_button: 'fileToUpload',         // 上传选择的点选按钮，必需
              //   uptoken_func: function(){    // 在需要获取uptoken时，该方法会被调用
              //       var token;
              //       $.ajax({
              //           "async": false,
              //           "crossDomain": true,
              //           "url": "https://wozai.tonyliangli.cn/common/getQiNiuToken",
              //           "method": "POST",
              //           "processData": false,
              //           "contentType": false,
              //           "mimeType": "multipart/form-data",
              //           success: function(data) {
              //               var obj = JSON.parse(data);
              //               console.log(JSON.stringify(obj))
              //               token = obj;
              //           }
              //       });
              //       return token
              //       // api.ajax({
              //       //     url: apiSite + '/common/getQiNiuToken',
              //       //     method: 'post',
              //       //     headers: apiHeader,
              //       //     data: {
              //       //            values: { 
              //       //                token: $api.getStorage('userToken'),
              //       //            }
              //       //     }
              //       // }, function(ret, err) {
              //       //     if(ret) {
              //       //         console.log(JSON.stringify(ret))
              //       //         return ret.data.token
              //       //     } else {
              //       //         alert(JSON.stringify(err))
              //       //     }
              //       // })
              // },
              uptoken: 'kSOwkmmHDFXQzTh3LtZCrWTj-_hzLdyRMVKSyUm6:uK_h0-E64E0bTK8jN_LOhKyVOVY=:eyJzY29wZSI6IndvemFpLWltYWdlcyIsImRlYWRsaW5lIjoxNTAwMDExMjczLCJ1cEhvc3RzIjpbImh0dHA6XC9cL3VwLnFpbml1LmNvbSIsImh0dHA6XC9cL3VwbG9hZC5xaW5pdS5jb20iLCItSCB1cC5xaW5pdS5jb20gaHR0cDpcL1wvMTgzLjEzMS43LjE4Il19',
              get_new_uptoken: false,             // 设置上传文件的时候是否每次都重新获取新的uptoken
              // downtoken_url: '/downtoken',
              // Ajax请求downToken的Url，私有空间时使用，JS-SDK将向该地址POST文件的key和domain，服务端返回的JSON必须包含url字段，url值为该文件的下载地址
              unique_names: true,              // 默认false，key为文件名。若开启该选项，JS-SDK会为每个文件自动生成key（文件名）
              // save_key: true,                  // 默认false。若在服务端生成uptoken的上传策略中指定了sava_key，则开启，SDK在前端将不对key进行任何处理
              domain: 'http://upload.qiniu.com/',     // bucket域名，下载资源时用到，必需
              container: 'container',             // 上传区域DOM ID，默认是browser_button的父元素
              max_file_size: '100mb',             // 最大文件体积限制
              flash_swf_url: 'path/of/plupload/Moxie.swf',  //引入flash，相对路径
              max_retries: 0,                     // 上传失败最大重试次数
              dragdrop: true,                     // 开启可拖曳上传
              drop_element: 'container',          // 拖曳上传区域元素的ID，拖曳文件或文件夹后可触发上传
              chunk_size: '4mb',                  // 分块上传时，每块的体积
              auto_start: false,                   // 选择文件后自动上传，若关闭需要自己绑定事件触发上传
              //x_vars : {
              //    查看自定义变量
              //    'time' : function(up,file) {
              //        var time = (new Date()).getTime();
                        // do something with 'time'
              //        return time;
              //    },
              //    'size' : function(up,file) {
              //        var size = file.size;
                        // do something with 'size'
              //        return size;
              //    }
              //},
              init: {
                  'FilesAdded': function(up, files) {
                      plupload.each(files, function(file) {
                          // 文件添加进队列后，处理相关的事情
                          console.log('文件添加进队列后，处理相关的事情:::'+JSON.stringify(file))
                      });
                  },
                  'BeforeUpload': function(up, file) {
                         // 每个文件上传前，处理相关的事情
                         console.log('每个文件上传前，处理相关的事情:::'+JSON.stringify(up))
                         console.log('每个文件上传前，处理相关的事情:::'+JSON.stringify(file))
                  },
                  'UploadProgress': function(up, file) {
                         // 每个文件上传时，处理相关的事情
                         console.log('每个文件上传时，处理相关的事情:::'+JSON.stringify(up))
                         console.log('每个文件上传时，处理相关的事情:::'+JSON.stringify(file))
                  },
                  'FileUploaded': function(up, file, info) {
                        console.log('每个文件上传成功后，处理相关的事情:::'+JSON.stringify(up))
                        console.log('每个文件上传成功后，处理相关的事情:::'+JSON.stringify(file))
                        console.log(info)
                         // 每个文件上传成功后，处理相关的事情
                         // 其中info是文件上传成功后，服务端返回的json，形式如：
                         // {
                         //    "hash": "Fh8xVqod2MQ1mocfI4S4KpRL6D98",
                         //    "key": "gogopher.jpg"
                         //  }
                         // 查看简单反馈
                         var domain = up.getOption('domain');
                         var res = JSON.parse(info.response).key;

                         var sourceLink = 'img.2017duobao.com' +"/"+ res; //获取上传成功后的文件的Url
                         alert(sourceLink)
                  },
                  'Error': function(up, err, errTip) {
                         //上传出错时，处理相关的事情
                         console.log('上传出错时，处理相关的事情:::'+JSON.stringify(up))
                         console.log('上传出错时，处理相关的事情:::'+JSON.stringify(err))
                         console.log('上传出错时，处理相关的事情:::'+JSON.stringify(errTip))
                  },
                  'UploadComplete': function() {
                         //队列文件处理完毕后，处理相关的事情
                         console.log('队列文件处理完毕后，处理相关的事情:::')
                  },
                  'Key': function(up, file) {
                      // 若想在前端对每个文件的key进行个性化处理，可以配置该函数
                      // 该配置必须要在unique_names: false，save_key: false时才生效
                      var key = "";
                      // do something with key here
                      return key
                  }
              }
          });
    };

     function upload() {
        console.log('执行upload')
        // var val = $api.attr(str, 'data-str')
        // if (val === 'camear') {
        //      api.getPicture({
        //             sourceType: 'camera',
        //             mediaValue: 'pic',
        //             encodingType: 'jpg',
        //             destinationType: 'url',
        //             quality: 80,
        //             targetWidth: 750,
        //             targetHeight: 750,
        //             saveToPhotoAlbum: true // 拍照后是否保存照片到相册
        //         }, function(ret, err) {
        //             if (ret.data) {
        //                 $api.attr($api.dom('img'),'src', ret.data);
        //             } 
        //         });
        // } else {
            api.getPicture({
                sourceType: 'library',
                mediaValue: 'pic',
                encodingType: 'jpg',
                destinationType: 'url',
                quality: 80,
                targetWidth: 750,
                targetHeight: 750
            }, function(ret, err) {
                if (ret) {
                    if (ret.data) {
                        console.log('tx2页面：'+ret.data)
                        // api.sendEvent({
                        //     name: 'headUrl',
                        //     extra: {
                        //         headUrl: ret.data, 
                        //     }
                        // });
                    } 
                    
                } else {
                    alert(JSON.stringify(err.msg));
                }
            });
        // }
    }
</script>

</html>
