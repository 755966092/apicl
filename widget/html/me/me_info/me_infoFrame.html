<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>我</title>
    <link rel="stylesheet" type="text/css" href="../../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../../css/style.css"/>
    <style>
        .empty{ text-align: center; padding: 120px 0; }
        body,html {
            background-color: #EDECF3;
        }

        ul.no1 {
            background-color: #EDECF3;
            width: 100%;
            box-sizing: border-box;
            margin-top: .5rem;
            padding-bottom: .3rem;
        }
        ul.no1 li {
            background-color: #fff;
            padding-left: .3rem;
            width: 100%;
            box-sizing: border-box;
            height: .797rem;
        }
        .mb30 {
            margin-bottom: .3rem;
        }
        .wrap1 {
            border-bottom: .01rem solid #EDEDED;
            padding-left: .05rem;
            width: 100%;
            height: .797rem;
            line-height: .797rem;
            box-sizing: border-box;
            padding-right: .37rem;
            position: relative;
        }
        .wrap {
             position: relative;
        }
        .wrap .zkIcon {
             display: inline-block;
            width: .15rem;
            height: 1.42rem;
            background: url(../../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: 0 center;
            position: absolute;
            right: .37rem;
            top: 0;
        }
        .wrap .imgDiv {
            height: 1.42rem;
            position: absolute;
            right: .64rem;
             display: -webkit-box;
            display: flex;
            -webkit-box-align:  center;
            align-items: center;
        }
        .wrap1 span.zkIcon {
            display: inline-block;
            width: .15rem;
            height: .797rem;
            background: url(../../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: 0 center;
            float: right;
            margin-left: .16rem;
        }
        .wrap1 .text {
            float: right;
            font-size: .3rem;
            color: #999;
        }
        ul.no1 li.liNo1 {
            height: 1.42rem;
            /*border-bottom: .01rem solid #000;*/
           font-size: 0;
        }
        .liNo1 .wrap {
            height: 1.42rem;
             display: -webkit-box;
            display: flex;
            -webkit-box-align:  center;
            align-items: center;
        }
        .label {
            font-size: .3rem;
        }
        .liNo1 .imgDiv img {
            width: 1.078rem;
            height: 1.078rem;
            border-radius: .08rem
        }

    </style>
</head>
<body>
    <div class="main">
        <ul class="no1">
            <li   tapmode   onclick="login(this)" data-val="tx" class="mb30 liNo1">
                <div class="wrap clearfix">
                    <span class="label">头像</span>
                    <div class="imgDiv">
                        <img class="headImg fr"  src="../../../image/tx_2.jpg">
                    </div>
                    <span class="zkIcon"></span>
                </div>
            </li>
            <li   tapmode   onclick="login(this)"  data-val="name">
               <div class="wrap1">
                    <span class="label">真实姓名</span>
                    <span class="zkIcon"></span>
                    <span class="text name">必填</span>
               </div>
            </li>
            <li   tapmode   onclick="login(this)"  data-val="nickname">
                <div class="wrap1">
                    <span class="label">昵称</span>
                    <span class="zkIcon"></span>
                    <span class="text nickname">必填</span>
                </div>
            </li>
            <li   tapmode   onclick="selectList(this)"  data-val="sex">
                <div class="wrap1">
                    <span class="label">性别</span>
                    <span class="zkIcon"></span>
                    <span class="text sex">请选择</span>
                </div>
            </li>
            <li   tapmode   onclick="selectList(this)" data-val="jx">
                <div class="wrap1">
                    <span class="label">家乡</span>
                    <span class="zkIcon"></span>
                    <span class="text jx">请选择</span>
                </div>
            </li>
            <li   tapmode   onclick="openTime(this)" data-val="sr" >
                <div class="wrap1">
                    <span class="label">生日</span>
                    <span class="zkIcon"></span>
                    <span class="text sr">请选择</span>
                </div>
            </li>
            <li  data-val="zz" class="mb30" tapmode onclick="login(this)">
                <div class="wrap1">
                    <span class="label">住址</span>
                    <span class="zkIcon"></span>
                </div>
            </li>


            <li  data-val="lxfs"  tapmode onclick="login(this)">
                <div class="wrap1">
                    <span class="label">联系方式</span>
                    <span class="zkIcon"></span>
                </div>
            </li>
            <li  data-val="qtlxfs" class="mb30" tapmode onclick="login(this)">
                <div class="wrap1">
                    <span class="label">其他联系方式</span>
                    <span class="zkIcon"></span>
                </div>
            </li>

            <li  data-val="study" tapmode onclick="login(this)">
                <div class="wrap1">
                    <span class="label">学习经历</span>
                    <span class="zkIcon"></span>
                </div>
            </li>

            <li  data-val="workExper" tapmode onclick="login(this)">
                <div class="wrap1">
                    <span class="label">工作经历</span>
                    <span class="zkIcon"></span>
                </div>
            </li>

            <li  data-val="project" class="mb30" tapmode onclick="login(this)">
                <div class="wrap1">
                    <span class="label">项目业绩</span>
                    <span class="zkIcon"></span>
                </div>
            </li>


            <li data-val="zydh" tapmode onclick="login(this)">
                <div class="wrap1">
                    <span class="label">主要电话</span>
                    <span class="zkIcon"></span>
                </div>
            </li>
            <li data-val="workStatus" tapmode onclick="login(this)">
                <div class="wrap1">
                    <span class="label">目前动态</span>
                    <span class="zkIcon"></span>
                </div>
            </li>

        </ul>
    </div>
    <script type="text/javascript" src="../../../script/api.js"></script>
    <script type="text/javascript" src="../../../script/common.js"></script>
    <script type="text/javascript" src="../../../data/city_3.js"></script>
    <script type="text/javascript">
    var  userName, zName ,headImg, sex, hometown, birthday,imgChche ;
    var imgCache;
        apiready = function(){
            moduleInit();
            myAjax();
            // 修改头像
            monitor('changeHead' , $api.dom('.headImg'));

            // 修改用户名
            monitor('modifyUserName' , $api.dom('.name'));
            // 修改用户名
            monitor('modifyNickName' , $api.dom('.nickname'));
        // 获取用户信息
        }
        function login(ele) {
           // 根据点击的按钮进入不同的页面
            var val = $api.attr(ele, 'data-val');
            if (val == 'name') {
                    api.openWin({
                        name: 'me_info_' + val,
                        url: './me_info_name.html',
                        pageParam: {
                            type: 'name',
                            name: $api.text($api.dom('.name'))
                        }
                    });
                } else if (val == 'nickname') {
                    api.openWin({
                        name: 'me_info_' + val,
                        url: './me_info_name.html',
                        pageParam: {
                            type: 'nickname',
                            name: $api.text($api.dom('.nickname'))
                        }
                    });
                } else {
                     api.openWin({
                        name: 'me_info_' + val,
                        url: './me_info_' + val + '.html',
                        pageParam: {
                            name: $api.attr($api.dom('.headImg'), 'src')
                        }
                    });
                }


            api.sendFrameToBack ({
                // from: 'infoframe'
                // to: 'toFrameName'
            });
        }
          // 打开时间选择器
    function openTime(ele) {
        for (var i = 0; i < $api.domAll('input').length; i++) {$api.domAll('input')[i].blur()}
        var date, date1, date2;
        var current = $api.text($api.dom(ele, '.sr'));
        if (current!='请选择') {
            current = current.split('-')
            date = current[0];
            date1 = current[1];
            date2 = current[2];
            // // console.log(current)
        } else　{
            date = new Date().getFullYear();
            date1 = new Date().getMonth();
            date2 = new Date().getDate();
        }
        api.openPicker({
            type: 'date',
            date: date+'-'+date1+'-'+date2,
            maxDate: new Date().toLocaleDateString().replace(/\//g,'-'),
            title: '选择生日'
        }, function(ret, err) {
            if (ret) {
                $api.text($api.dom('.sr'), ret.year+'-'+ret.month+'-'+ret.day);
                reviseData('birthday');
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }
    // 打开选择器
    function selectList(ele) {
        var label = $api.attr(ele, 'data-val');
        var selText = $api.text($api.dom(ele, '.'+label+''));
        var _dataSource2 = [],_dataSource = [],col=1;
        var active = [];

        if (label === 'sex') {
            _dataSource = [
                {
                    name: '男'
                },{
                    name: '女'
                }
            ]
            _dataSource2 = ['男','女']
            if (_dataSource2.indexOf(selText) == -1) {
                active = [1]
            } else {
                active.push(_dataSource2.indexOf(selText))
            }

        } else {
            col=2;
            _dataSource = city;
            var selText1 = selText.split('-')
            active = [];
            for (var i = 0; i < _dataSource.length; i++) {
                if (_dataSource[i].name == selText1[0]) {
                    active.push(i);
                    for (var j = 0; j < _dataSource[i].sub.length; j++) {
                        if (_dataSource[i].sub[j].name == selText1[1]) {
                            active.push(j);
                            break;
                        }
                    }
                    break;
                }
            }
        }
        var fontsize = 16,rowLength = 5;
        if (api.systemType === 'ios') {
            fontsize = 20;
            rowLength = 7;
        }
        UIActionSelector.open({
            datas: _dataSource,
            actives: active,
            layout: {
                row: rowLength,
                col: col,
                height: 30,
                size: fontsize,
                sizeActive: fontsize+2,
                rowSpacing: 5,
                colSpacing: 5,
                maskBg: 'rgba(0,0,0,0.5)',
                bg: '#fff',
                color: '#888',
                colorSelected: '#000'
            },
            animation: true,
            cancel: {
                text: '取消',
                size: 16,
                w: 60,
                h: 40,
                bg: '#eee',
                // bgActive: '#ccc',
                color: '#000',
                // colorActive: '#fff'
            },
            ok: {
                text: '完成',
                size: 16,
                w: 60,
                h: 40,
                bg: '#eee',
                // bgActive: '#ccc',
                color: '#000',
                // colorActive: '#fff'
            },
            title: {
                text: '请选择',
                size: 20,
                h: 40,
                bg: '#F0F0F0',
                color: '#000'
            },
            fixedOn: api.frameName
        }, function(ret, err) {
            if (ret) {
                if (ret.eventType == 'ok') {
                    if (col === 2) {
                        $api.text($api.dom(ele, '.'+ label +''), ret.level1+'-'+ret.level2);
                        // 修改家乡
                        reviseData('hometown');
                    } else if (ret.level1 === '男' ) {
                        // 修改性别
                        $api.attr($api.dom(ele, '.sex'), 'data-val', 1);
                        $api.text($api.dom(ele, '.'+ label +''), ret.level1);
                        reviseData('sex');
                    } else {
                        // 修改性别
                        $api.attr($api.dom(ele, '.sex'), 'data-val', 2);
                        $api.text($api.dom(ele, '.'+ label +''), ret.level1);
                        reviseData('sex');
                    }

                }
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }

    // 修改文本内容
    function reviseContent(userName1, zName1, headImg1, sex1, hometown1, birthday1) {
        var name = $api.dom('.name'),
            nicheng = $api.dom('.nickname'),
            head = $api.dom('.headImg'),
            sexImg = $api.dom('.sex'),
            birthday = $api.dom('.sr'),
            hometown = $api.dom('.jx');
        // 设置真实姓名
        $api.text(name, zName1);
        // 设置用户昵称
        $api.text(nicheng,userName1);
        // 设置用户头像
        $api.attr(head, 'src', headImg1);
        // 设置用户性别
        if (sex1 == 1 ) {
            $api.text(sexImg, '男');
            $api.attr(sexImg, 'data-val', 1);

        } else {
            $api.text(sexImg, '女');
            $api.attr(sexImg, 'data-val', 2);

        }
        // 设置用户家乡
        // hometown1 = hometown1.replace(',','-')
        $api.text(hometown, hometown1);
        // 设置用户生日
        $api.text(birthday, birthday1);
    }

     // 监听事件
    function monitor (eve, ele) {
        api.addEventListener({
            name: eve
        }, function(ret, err) {

            var val = ret.value.selDate;
            if (ret) {
                if (eve == 'changeHead') {
                    // // console.log(JSON.stringify(ret))
                    // 处理用户头像
                    $api.attr(ele, 'src', val);
                    // // console.log('444:::'+val)
                    reviseData('headImg');
                } else if (eve == 'xiugaisex') {
                    // 处理用户性别
                    if (val == '男' ) {
                        $api.text(ele, '男');
                        $api.attr(ele, 'data-val', 1);
                    } else {
                        $api.text(ele, '女');
                        $api.attr(ele, 'data-val', 2);
                    }
                    reviseData();
                } else {
                    $api.text(ele, val);
                    reviseData();
                }


            } else {
                alert(JSON.stringify(err.msg));
            }
        });

    }
    // 修改资料
    function reviseData (type) {
        var name = $api.text($api.dom('.name')) || userName;
        var niCheng = $api.text($api.dom('.nickname')) || zName;
        var obj = {
             token: $api.getStorage('userToken'),
             nickname:niCheng,
             real_name: name,
        };
        if(type == 'hometown') {
            // 修改加血
            obj.hometown = $api.text($api.dom('.jx')) ;
            // // console.log($api.text($api.dom('.jx')))
        } else if (type == 'sex') {
            // 修改性别
            obj.sex = $api.attr($api.dom('.sex'),'data-val') ;
        } else if (type == 'birthday') {
            obj.birthday = $api.text($api.dom('.sr'));
        } else if (type == 'headImg') {
            obj.head_img_url = $api.attr($api.dom('.headImg'),'src');
        }
        // 上传数据
         api.ajax({
                url: apiSite + '/user_center/editBasicInfo',
                method: 'post',
                headers: apiHeader,
                data: {
                    values: obj
                }
            }, function(ret, err) {
                    // // console.log(JSON.stringify(ret));
                    // requireData();
                    api.execScript({
                        name: 'main',
                        frameName: 'frame4',
                        script: 'userInfo();'
                    });
            })
         // myAjax();
    }
    // 获取个人资料
    function myAjax() {
        if ($api.getStorage('userInfo')) {
            // 有缓存
            // // console.log('缓存' + $api.getStorage('imgCache'))
            userName = $api.getStorage('userInfo').info.nickname,
            zName = $api.getStorage('userInfo').info.real_name,
            headImg = $api.getStorage('imgCache'),
            sex = $api.getStorage('userInfo').info.sex,
            // sex = ($api.getStorage('userInfo').info.sex === 1)?'男':'女',
            // 家乡
            hometown = $api.getStorage('userInfo').info.hometown,
            // 生日
            birthday = $api.getStorage('userInfo').info.birthday;
            reviseContent(userName,zName, headImg, sex, hometown, birthday);
            requireData();
        } else {
            // 无缓存
            requireData();
        }

    }
    function requireData() {
         api.ajax({
                url: apiSite + '/user_center/editBasicInfoIndex',
                method: 'post',
                headers: apiHeader,
                data: {
                    values: {
                        token: $api.getStorage('userToken')
                    }
                }
            }, function(ret, err) {
                if (ret) {
                        // // // console.log('请求数据'+JSON.stringify(ret))
                        $api.setStorage('userInfo', ret.data);
                        userName = ret.data.info.nickname,
                        zName = ret.data.info.real_name,
                        headImg = ret.data.info.head_img_url,
                        sex = ret.data.info.sex,
                        // 家乡
                        hometown = ret.data.info.hometown,
                        // 生日
                        birthday = ret.data.info.birthday;
                        // 设置本地缓存
                        $api.setStorage('real_name', zName);
                        $api.setStorage('hometown', hometown);
                        $api.setStorage('birthday', birthday);
                        // 图片缓存
                        api.imageCache({
                            url: headImg
                        }, function(ret, err) {
                            if(ret.status) {
                                $api.setStorage('imgCache', ret.url);
                            }
                        });
                        reviseContent(userName,zName, headImg, sex, hometown, birthday);
                } else {
                    alert(JSON.stringify(err.msg));
                }
            });
    }
    </script>
</body>
</html>