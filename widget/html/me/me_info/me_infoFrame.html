<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>我</title>
    <link rel="stylesheet" type="text/css" href="../../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../../css/style.css"/>
    <style>
        .empty{ text-align: center; padding: 120px 0; }
        body,html {
            background-color: #EDECF3;
        }
        
        

        .main ul {
            margin-top: .2rem;
        }
        .main ul li {
            height: .82rem;
            line-height: .82rem;
            padding: 0 .6rem 0 .3rem;
            font-size: .28rem;
            border-bottom: 1px solid #EDEDED;
            background: #fff;
            
            position: relative;
            
        }
        .main ul li:nth-child(6),
        .main ul li:nth-child(9),
        .main ul li:nth-child(12)
         {
            margin-bottom: .2rem;
        }
        .main ul li:nth-child(1) {
           
            height: 1.6rem;
            background: #fff;
            line-height: 1.6rem;
            display: -webkit-flex;
            display: flex;
            align-items: center;
        }

        .main ul li:nth-child(1) img {
            width: 1.18rem;
            height: 1.18rem;
            vertical-align:middle;
            position: absolute;
            right: 1rem;
            top: .21rem;
        }
      
        .main ul li:nth-child(1) p img {
            vertical-align:baseline;
            width: .3rem;
            height: .3rem;
        }
        .uaseName {
            display: inline-block;
            vertical-align:middle;
        }
        .main ul li span:first-child {
            position: relative;
        }
        .main ul li span:last-child {
            display: inline-block;
            width: .15rem;
            height: .8rem;
            background: url(../../../image/icon_member/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: 0 .3rem;
            float: right;
        }
        .main ul li span.zkicon{
            display: inline-block;
            height: 1.6rem;
            width: .15rem;
            position: absolute;
            right: .58rem;
            top: 0;
            background-position: center center;
        }
        
        li.select span:first-child:before {
            content: "";
            display: inline-block;
            width: .1rem;
            height: .1rem;
            background-color: #f00;
            border-radius: .2rem;
            position: absolute;
            top: .2rem;
            right: -.1rem;
        }
        li .text {
            position: absolute; 
            top: 0;
            right: 0.9rem;
            color: #B6AEA9;
        }
        li input {
            height: .8rem;
            text-align: right;
            outline: none;
            width: 2rem;
        }
        li input::-webkit-input-placeholder {
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="main">
        <ul>
            <li onclick="login(this)" data-val="tx">
                <img class="headImg"  src="../../../image/tx_2.jpg">
                <p>头像</p>
                <span class="zkicon"></span>
            </li>
            <li  data-val="name"><span>真实姓名</span>
                <input onchange="reviseData()" type="text" placeholder="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;必填" name="" class="fr name"></li>
            <li  data-val="nicheng"><span>昵称</span>
                <input onchange="reviseData()" type="text" placeholder="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;必填" name="" class="fr nicheng"></li>
            <li onclick="openF(this)"  data-val="sex"><span>性别</span><span class="text sex">请选择</span><span></span></li>
            <li onclick="openF(this)" data-val="jx"><span>家乡</span><span class="text jx">请选择</span><span></span></li>
            <li onclick="openF(this)" data-val="sr"><span >生日</span><span class="text sr">请选择</span><span class="fr"></span></li>
            <li onclick="login(this)" data-val="zydh"><span>主要电话</span><span></span></li>
            <li onclick="login(this)" data-val="qtlxfs"><span>联系方式</span><span></span></li>
            <li onclick="login(this)" data-val="zz"><span>住址</span><span></span></li>
            <li onclick="login(this)" data-val="study"><span>学习经历</span><span></span></li>
            <li onclick="login(this)" data-val="workExper"><span>工作经历</span><span></span></li>
            <li onclick="login(this)" data-val="project"><span>项目业绩</span><span></span></li>
            <li onclick="login(this)" data-val="mqdt"><span>主要工作动态</span><span></span></li>
        </ul>
    </div>
    <script type="text/javascript" src="../../../script/api.js"></script>
    <script type="text/javascript" src="../../../script/common.js"></script>
    <script type="text/javascript">
    var  userName, zName ,headImg, sex, hometown, birthday,imgChche, userToken, rongToken;
        apiready = function(){
            userToken = api.pageParam.userToken || $api.getStorage('userToken');
            rongToken = api.pageParam.rongToken || $api.getStorage('rongToken');
            userInfo(userTokenAll || userToken);
            
            // 修改性别
            monitor('xiugaisex', $api.dom('.sex'));
            // 修改生日
            monitor('xiugaisr' , $api.dom('.sr'));
            // 修改家乡
            monitor('xiugaijx' , $api.dom('.jx'));
            // 修改头像
            monitor('changeHead' , $api.dom('.headImg'));
        // 获取用户信息
        }

        function userInfo(userToken) {
            // 如果没有本地缓存，就从网络获取，有就使用本地缓存
            // if ($api.getStorage('hometown')) {
            //     // 本地数据设置页面内容
            //     userName =   $api.getStorage('userName'); 
            //     zName =   $api.getStorage('zName'); 
            //     headImg =   $api.getStorage('headImg'); 
            //     sex =   $api.getStorage('sex'); 
            //     hometown =   $api.getStorage('hometown'); 
            //     birthday =   $api.getStorage('birthday');
            //     reviseContent(userName, zName, headImg, sex, hometown, birthday);
            // } else {
                 myAjax();
            // }
        }
        //
        function login(ele) {
           // 根据点击的按钮进入不同的页面
            var val = $api.attr(ele, 'data-val');
            api.openWin({
                name: 'me_info_' + val,
                url: './me_info_' + val + '.html',
                pageParam: {
                    name: $api.attr($api.dom('.headImg'), 'src')
                }

            });
            api.sendFrameToBack ({
                // from: 'infoframe'
                // to: 'toFrameName'
            });
        }
        function openF (ele) {
            var val = $api.attr(ele, 'data-val');
            api.openFrame({
                name: 'frameName',
                url: './me_info_' + val + '.html',
                rect: {
                    x: 0,
                    y: 0,
                    w: 'auto',
                    h: api.winHeight
                },
               
                bounces: false
            });
        }
        // 修改文本内容
        function reviseContent(userName1, zName1, headImg1, sex1, hometown1, birthday1) {
            var name = $api.dom('.name'),
                nicheng = $api.dom('.nicheng'),
                head = $api.dom('.headImg'),
                sexImg = $api.dom('.sex'),
                birthday = $api.dom('.sr'),
                hometown = $api.dom('.jx');
            // 设置真实姓名
            $api.val(name, zName1);
            // 设置用户昵称
            $api.val(nicheng,userName1);
            // 设置用户头像
            $api.attr(head, 'src', headImg1);
            // 设置用户性别
            if (sex1 == 1 ) {
                $api.text(sexImg, '男');
                $api.attr(sexImg, 'data-val', 1);
                
            } else {
                $api.text(sexImg, '女');
                $api.attr(sexImg, 'data-val', 2);

            }
            // 设置用户家乡
            hometown1 = hometown1.replace(',','-')
            $api.text(hometown, hometown1);
            // 设置用户生日
            $api.text(birthday, birthday1);
        }


        // 监听事件
        function monitor (eve, ele) {

            api.addEventListener({
                name: eve
            }, function(ret, err) {
                var val = ret.value.selDate;
                if (ret) {
                    if (eve == 'changeHead') {
                        // 处理用户头像
                        $api.attr(ele, 'src', val);
                        reviseData();
                    } else if (eve == 'xiugaisex') {
                        // 处理用户性别
                        if (val == '男' ) {
                            $api.text(ele, '男');
                            $api.attr(ele, 'data-val', 1);
                        } else {
                            $api.text(ele, '女');
                            $api.attr(ele, 'data-val', 2);
                        }
                        reviseData();
                    } else {
                        $api.text(ele, val);
                        reviseData();
                    }
                    
                    
                } else {
                    alert(JSON.stringify(err));
                }
            });
            
        }



        // 修改资料
        function reviseData () {

            var name = $api.val($api.dom('.name')) || userName;
            var niCheng = $api.val($api.dom('.nicheng')) || zName;
            var headImg = $api.attr($api.dom('.headImg'),'src') || headImg;
            var sex = $api.attr($api.dom('.sex'),'data-val') || sex;
            var jx = $api.text($api.dom('.jx')) || hometown;
            var sr = $api.text($api.dom('.sr')) || birthday;


            // 上传数据
             api.ajax({
                    url: apiSite + '/api/user_center/editBasicInfo',
                    method: 'post',
                    headers: apiHeader,
                    data: {
                        values: { 
                            token: userToken,
                            head_img_url: headImg,
                            real_name: name,
                            nickname: niCheng,
                            sex: sex,
                            hometown:jx,
                            birthday:sr
                        }
                    }
                }, function(ret, err) {
                        // alert(JSON.stringify(ret))
                })
             // myAjax();
             
             
        }

        // 获取个人资料
        function myAjax() {
            api.ajax({
                    url: apiSite + '/api/user_center/editBasicInfoIndex',
                    method: 'post',
                    headers: apiHeader,
                    data: {
                        values: { 
                            token: userToken
                        }
                    }
                }, function(ret, err) {
                    if (ret) {
                            
                            userName = ret.data.info.nickname,
                            zName = ret.data.info.real_name,
                            headImg = ret.data.info.head_img_url,
                            sex = ret.data.info.sex,
                            // sex = (ret.data.info.sex === 1)?'男':'女',
                            // 家乡
                            hometown = ret.data.info.hometown, 
                            // 生日
                            birthday = ret.data.info.birthday;
                            // 设置本地缓存
                            $api.setStorage('userName', userName); 
                            $api.setStorage('zName', zName); 
                            $api.setStorage('sex', sex); 
                            $api.setStorage('hometown', hometown); 
                            $api.setStorage('birthday', birthday);
                            
                            // 初始化页面内容   
                            reviseContent(userName,zName, headImg, sex, hometown, birthday);
                            // 图片缓存
                            api.imageCache({
                                url: headImg,
                                policy: 'cache_else_network'
                            }, function(ret, err) {
                                if (ret) {
                                    $api.setStorage('headImg', ret.url); 
                                } else {
                                    alert(JSON.stringify(err));
                                }
                            });
                    } else {
                        alert(JSON.stringify(err));
                    }
                });
        }
    </script>
</body>
</html>