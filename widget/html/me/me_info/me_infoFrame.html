<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>我</title>
    <link rel="stylesheet" type="text/css" href="../../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../../css/style.css"/>
    <style>
        .empty{ text-align: center; padding: 120px 0; }
        body,html {
            background-color: #EDECF3;
        }
        
        ul.no1 {
            background-color: #EDECF3;
            width: 100%;
            box-sizing: border-box;
            margin-top: .5rem;
            padding-bottom: .3rem;
        }
        ul.no1 li {
            background-color: #fff;
            padding-left: .3rem;
            width: 100%;
            box-sizing: border-box;
            height: .797rem;
        }
        .mb30 {
            margin-bottom: .3rem;
        }
        .wrap1 {
            border-bottom: 1px solid #EDEDED;
            padding-left: .05rem;
            width: 100%;
            height: .797rem;
            line-height: .797rem;
            box-sizing: border-box;
            padding-right: .37rem;
            position: relative;
        }
        .wrap {
             position: relative;
        }
        .wrap .zkIcon {
             display: inline-block;
            width: .15rem;
            height: 1.42rem;    
            background: url(../../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: 0 center;
            position: absolute;
            right: .37rem;
            top: 0;
        }
        .wrap .imgDiv {
            height: 1.42rem;
            position: absolute;
            right: .64rem;
             display: -webkit-box; 
            display: flex; 
            -webkit-box-align:  center;
            align-items: center;
        }
        .wrap1 span.zkIcon {
            display: inline-block;
            width: .15rem;
            height: .797rem;    
            background: url(../../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: 0 center;
            float: right;
            margin-left: .16rem;
        }
        .wrap1 .text {
            float: right;
            font-size: .3rem;
            color: #999;
        }
        ul.no1 li.liNo1 {
            height: 1.42rem;
            /*border-bottom: 1px solid #000;*/
           font-size: 0;
        }
        .liNo1 .wrap {
            height: 1.42rem;
             display: -webkit-box; 
            display: flex; 
            -webkit-box-align:  center;
            align-items: center;
        }
        .label {
            font-size: .3rem;
        }
        .liNo1 .imgDiv img {
            width: 1.078rem;
            height: 1.078rem;
            border-radius: .08rem
        }

    </style>
</head>
<body>
    <div class="main">
        <ul class="no1">
            <li   tapmode="hover"   onclick="login(this)" data-val="tx" class="mb30 liNo1">
                <div class="wrap clearfix">
                    <span class="label">头像</span>
                    <div class="imgDiv">
                        <img class="headImg fr"  src="../../../image/tx_2.jpg">
                    </div>
                    <span class="zkIcon"></span>
                </div>
            </li>
            <li   tapmode="hover"   onclick="login(this)"  data-val="name">
               <div class="wrap1">
                    <span class="label">真实姓名</span>
                    <span class="zkIcon"></span>
                    <span class="text name">必填</span>
               </div>
            </li>
            <li   tapmode="hover"   onclick="login(this)"  data-val="nickname">
                <div class="wrap1">
                    <span class="label">昵称</span>
                    <span class="zkIcon"></span>
                    <span class="text nickname">必填</span>
                </div>
            </li>
            <li   tapmode="hover"   onclick="openF(this)"  data-val="sex">
                <div class="wrap1">
                    <span class="label">性别</span>
                    <span class="zkIcon"></span>
                    <span class="text sex">请选择</span>
                </div>
            </li>
            <li   tapmode="hover"   onclick="openF(this)" data-val="jx">
                <div class="wrap1">
                    <span class="label">家乡</span>
                    <span class="zkIcon"></span>
                    <span class="text jx">请选择</span>
                </div>
            </li>
            <li   tapmode="hover"   onclick="openF(this)" data-val="sr" class="mb30">
                <div class="wrap1">
                    <span class="label">生日</span>
                    <span class="zkIcon"></span>
                    <span class="text sr">请选择</span>
                </div>
            </li>
            <li  data-val="zydh"   tapmode="hover"   onclick="login(this)">
                <div class="wrap1">
                    <span class="label">主要电话</span>
                    <span class="zkIcon"></span>
                </div>
            </li>
 
            <li  data-val="qtlxfs">
                <div class="wrap1">
                    <span class="label">联系方式</span>
                    <span class="zkIcon"></span>
                </div>
            </li>
 
            <li  data-val="zz" class="mb30">
                <div class="wrap1">
                    <span class="label">住址</span>
                    <span class="zkIcon"></span>
                </div>
            </li>
 
            <li  data-val="study">
                <div class="wrap1">
                    <span class="label">学习经历</span>
                    <span class="zkIcon"></span>
                </div>
            </li>
 
            <li  data-val="workExper" tapmode="hover" onclick="login(this)">
                <div class="wrap1">
                    <span class="label">工作经历</span>
                    <span class="zkIcon"></span>
                </div>
            </li>
 
            <li  data-val="project" class="mb30">
                <div class="wrap1">
                    <span class="label">项目业绩</span>
                    <span class="zkIcon"></span>
                </div>
            </li>
 
            <li  data-val="mqdt">
                <div class="wrap1">
                    <span class="label">目前动态</span>
                    <span class="zkIcon"></span>
                </div>
            </li>
 
        </ul>
    </div>
    <script type="text/javascript" src="../../../script/api.js"></script>
    <script type="text/javascript" src="../../../script/common.js"></script>
    <script type="text/javascript">
    var  userName, zName ,headImg, sex, hometown, birthday,imgChche, userToken, rongToken;
        apiready = function(){
            userToken = api.pageParam.userToken || $api.getStorage('userToken');
            rongToken = api.pageParam.rongToken || $api.getStorage('rongToken');
            userInfo(userTokenAll || userToken);
            
            // 修改性别
            monitor('xiugaisex', $api.dom('.sex'));
            // 修改生日
            monitor('xiugaisr' , $api.dom('.sr'));
            // 修改家乡
            monitor('xiugaijx' , $api.dom('.jx'));
            // 修改头像
            monitor('changeHead' , $api.dom('.headImg'));
            // 修改用户名
            monitor('modifyUserName' , $api.dom('.name'));
            // 修改用户名
            monitor('modifyNickName' , $api.dom('.nickname'));
        // 获取用户信息
        }

        function userInfo(userToken) {
            // 如果没有本地缓存，就从网络获取，有就使用本地缓存
            // if ($api.getStorage('hometown')) {
            //     // 本地数据设置页面内容
            //     userName =   $api.getStorage('userName'); 
            //     zName =   $api.getStorage('zName'); 
            //     headImg =   $api.getStorage('headImg'); 
            //     sex =   $api.getStorage('sex'); 
            //     hometown =   $api.getStorage('hometown'); 
            //     birthday =   $api.getStorage('birthday');
            //     reviseContent(userName, zName, headImg, sex, hometown, birthday);
            // } else {
                 myAjax();
            // }
        }
        //
        function login(ele) {
           // 根据点击的按钮进入不同的页面
            var val = $api.attr(ele, 'data-val');
            if (val == 'name') {
                    api.openWin({
                        name: 'me_info_' + val,
                        url: './me_info_name.html',
                        pageParam: {
                            type: 'name',
                            name: $api.text($api.dom('.name'))
                        }
                    });
                } else if (val == 'nickname') {
                    api.openWin({
                        name: 'me_info_' + val,
                        url: './me_info_name.html',
                        pageParam: {
                            type: 'nickname',
                            name: $api.text($api.dom('.nickname'))
                        }
                    });
                } else {
                     api.openWin({
                        name: 'me_info_' + val,
                        url: './me_info_' + val + '.html',
                        pageParam: {
                            name: $api.attr($api.dom('.headImg'), 'src')
                        }
                    });
                }
           

            api.sendFrameToBack ({
                // from: 'infoframe'
                // to: 'toFrameName'
            });
        }
        function openF (ele) {
            var val = $api.attr(ele, 'data-val');

            var sexText = $api.text($api.dom('.sex'));
            var homeText = $api.text($api.dom('.jx')).split("-") || 1;
            var birthdayText = $api.text($api.dom('.sr')).split("-") || 1;
            
            api.openFrame({
                name: 'frameName',
                url: './me_info_' + val + '.html',
                rect: {
                    x: 0,
                    y: 0,
                    w: 'auto',
                    h: api.winHeight
                },
                pageParam: {
                    sexText: sexText,
                    homeText: homeText,
                    birthdayText: birthdayText
                },
                bounces: false
            });
        }
        // 修改文本内容
        function reviseContent(userName1, zName1, headImg1, sex1, hometown1, birthday1) {
            var name = $api.dom('.name'),
                nicheng = $api.dom('.nickname'),
                head = $api.dom('.headImg'),
                sexImg = $api.dom('.sex'),
                birthday = $api.dom('.sr'),
                hometown = $api.dom('.jx');
            // 设置真实姓名
            $api.text(name, zName1);
            // 设置用户昵称
            $api.text(nicheng,userName1);
            // 设置用户头像
            $api.attr(head, 'src', headImg1);
            // 设置用户性别
            if (sex1 == 1 ) {
                $api.text(sexImg, '男');
                $api.attr(sexImg, 'data-val', 1);
                
            } else {
                $api.text(sexImg, '女');
                $api.attr(sexImg, 'data-val', 2);

            }
            // 设置用户家乡
            hometown1 = hometown1.replace(',','-')
            $api.text(hometown, hometown1);
            // 设置用户生日
            $api.text(birthday, birthday1);
        }


        // 监听事件
        function monitor (eve, ele) {
            api.addEventListener({
                name: eve
            }, function(ret, err) {
                var val = ret.value.selDate;
                if (ret) {
                    if (eve == 'changeHead') {
                        // 处理用户头像
                        $api.attr(ele, 'src', val);
                        reviseData();
                    } else if (eve == 'xiugaisex') {
                        // 处理用户性别
                        if (val == '男' ) {
                            $api.text(ele, '男');
                            $api.attr(ele, 'data-val', 1);
                        } else {
                            $api.text(ele, '女');
                            $api.attr(ele, 'data-val', 2);
                        }
                        reviseData();
                    } else {
                        $api.text(ele, val);
                        reviseData();
                    }
                    
                    
                } else {
                    alert(JSON.stringify(err));
                }
            });
            
        }



        // 修改资料
        function reviseData () {

            var name = $api.text($api.dom('.name')) || userName;
            var niCheng = $api.text($api.dom('.nickname')) || zName;
            var headImg = $api.attr($api.dom('.headImg'),'src') || headImg;
            var sex = $api.attr($api.dom('.sex'),'data-val') || sex;
            var jx = $api.text($api.dom('.jx')) || hometown;
            var sr = $api.text($api.dom('.sr')) || birthday;


            // 上传数据
             api.ajax({
                    url: apiSite + '/api/user_center/editBasicInfo',
                    method: 'post',
                    headers: apiHeader,
                    data: {
                        values: { 
                            token: userToken,
                            head_img_url: headImg,
                            real_name: name,
                            nickname: niCheng,
                            sex: sex,
                            hometown:jx,
                            birthday:sr
                        }
                    }
                }, function(ret, err) {
                        alert(JSON.stringify(ret))
                })
             // myAjax();
        }

        // 获取个人资料
        function myAjax() {
            api.ajax({
                    url: apiSite + '/api/user_center/editBasicInfoIndex',
                    method: 'post',
                    headers: apiHeader,
                    data: {
                        values: { 
                            token: userToken
                        }
                    }
                }, function(ret, err) {
                    if (ret) {
                            userName = ret.data.info.nickname,
                            zName = ret.data.info.real_name,
                            headImg = ret.data.info.head_img_url,
                            sex = ret.data.info.sex,
                            // sex = (ret.data.info.sex === 1)?'男':'女',
                            // 家乡
                            hometown = ret.data.info.hometown, 
                            // 生日
                            birthday = ret.data.info.birthday;
                            // 设置本地缓存
                            $api.setStorage('userName', userName); 
                            $api.setStorage('zName', zName); 
                            $api.setStorage('sex', sex); 
                            $api.setStorage('hometown', hometown); 
                            $api.setStorage('birthday', birthday);
                            
                            // 初始化页面内容   
                            reviseContent(userName,zName, headImg, sex, hometown, birthday);
                            // 图片缓存
                            api.imageCache({
                                url: headImg,
                                policy: 'cache_else_network'
                            }, function(ret, err) {
                                if (ret) {
                                    $api.setStorage('headImg', ret.url); 
                                } else {
                                    alert(JSON.stringify(err));
                                }
                            });
                    } else {
                        alert(JSON.stringify(err));
                    }
                });
        }
    </script>
</body>
</html>