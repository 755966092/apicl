<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style type="text/css">

        .noOrider {
            text-align: center;
            font-size: .28rem;
            color: #999;
            line-height: .8rem;
            display: none;
        }
        .loading {
            width: .8rem;
            height: .8rem;
            background: url(../../image/loading_more.gif)no-repeat;
            background-size: .8rem .8rem;
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
            margin: auto;
         }
        .main_no1 {
            font-size: 0;
            height: .7rem;
            padding: 0 .3rem;
        }
        .main_no1 img {
            width: .5rem;
            height: .5rem;
            border-radius: 50%;
            margin-right: .2rem;
        }

        .main_no1 span:first-child {
            line-height: .7rem;
            font-size: .3rem;
            line-height: .42rem;
        }
         .main_no1 span:nth-child(2) {
            line-height: .7rem;
            color: #999;
            font-size: .24rem;
            line-height: .33rem;
        }
        .main_no1 i {
            display: inline-block;
            float: right;
            width: .15rem;
            height: .7rem;
            background: url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: 0 center;
        }
        .main_no1 span.status {
            font-size: .24rem;
            color: #F68F23;
        }

        .main_no2  {
            box-sizing: border-box;
            font-size: 0;
            height: 1.5rem;
            /*padding: 0 .3rem;*/
            padding-right: .3rem;
             border-top: .01rem solid #ECECEC;
            /*background-color: #F9F9F9;*/

        }
        .borderb {
            padding-left: .3rem;

        }
        .main_no2 img {
            width: .9rem;
            height: .9rem;
        }
        .main_no2 .title {
            box-sizing: border-box;
            width: 2rem;
            margin-left: .2rem;
            margin-right: .2rem;
            font-size: 0;
            overflow: hidden;
        }
        .main_no2 .title h3 {
             width: 2rem;
            font-size: .28rem;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .main_no2 .title p {
            line-height: .7rem;
            font-size: .24rem;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .main_no2 .jl_right {
            /*width: 5rem;*/
            font-size: 0;
        }
        .main_no2 .jl_right .money {
            font-size: .34rem;
            color: #000;
        }
        .main_no2 .jl_right .count {
            font-size: .28rem;
            color: #999;
        }

        .main_no3 {
            font-size: 0;
        }
        .main_no3 .price {

            font-size: .34rem;
            height: .63rem;
            line-height: .63rem;
            text-align: right;
            /*padding: 0 .3rem;*/
            padding-left: .3rem;
        }
        .main_no3 .price .wrap {
            padding-right: .3rem;
            border-top: .01rem solid #ECECEC;
             color: #F68F23;
        }
        .main_no3 .price span {
            font-size: .24rem;
            color: #000;
        }
        .main_no3 .appraise {
            /*font-size: 0;*/
            margin-top: .26rem;
            height: .8rem;
            border-bottom: .01rem solid #DFDFDF;
        }
        .main_no3 .appraise span {
            font-size: .28rem;
            width: 1.34rem;
            line-height: .6rem;
            display: inline-block;
            height: .54rem;
            text-align: center;
            box-sizing: border-box;
            border: .01rem solid #B2B2B2;
            border-radius: .06rem;
            margin-right: .15rem;

        }

        .shadow {
            position: fixed;
            top: 0;
            right: 0;
            width: 7.5rem;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            margin-top: .81rem;
        }
        .shadow .list {
            background-color: #fff;

        }
        .shadow .list p {
            background-color: #F8F8F8;
            color: #494949;
            padding-left: .3rem;
            font-size: .3rem;
            line-height: .88rem;
        }
        .shadow .list ul {
            padding-left: .3rem;
        }
        .shadow .list ul li {
            border-bottom: .02rem solid #D9D9D9;
            font-size: .28rem;
            line-height: .88rem;
        }
        .shadow .lx, .shadow .zt {
            display: none;
        }
        .warp {
            margin-top: .2rem;
            background-color: #fff;
        }
        .label {
            font-size: .2rem;
            color: #cc0019;
            margin-right: .12rem;
        }
        .textHidden {
            max-width: 4.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .nomain .icon {
            width: 2.2rem;
            height: 2.2rem;
            background: url(../../image/iocn_addressList/icon_noInfo.png)no-repeat;
            -webkit-background-size: 2.2rem 2.2rem;
            background-size: 2.2rem 2.2rem;
            margin: 0 auto;
        }
        .nomain {
            position: absolute;
            top: 0;bottom: 0;left: 0;right: 0;
            margin: auto;
        }
        .nomain p {
            font-size: .3rem;
            color: #999;
            /*width: 3.9rem;*/
            margin: .36rem auto 0;
            text-align: center;
        }
        .nomain .jump {
            color: #89B2EF;
            font-size: 0.34rem;
        }
        .nomain .wrap {
            background-color: rgba(0, 0, 0, 0)
        }
    </style>

</head>
<body>
<!-- <p class="noOrider">暂无订单</p> -->
<div class="loading"></div>
<div class="main resultList">
</div>
<script type="text/x-dot-template" id="listT">
    {{?it.length>0}}
        {{ for (var i = 0; i < it.length; i++) { }}
            <div class="warp" onclick="event.stopPropagation();">
                <div class="main_no1 flex-def flex-cCenter">
                    <img src="{{=it[i].head_img_url}}?imageView2/1/w/150/h/150/interlace/1/q/100|imageslim" data-id="{{=it[i].user_id}}" onclick="openUserId(this)">
                    <div class="flex-item flex-def flex-cCenter flex-zBetween">
                        <div class="flex-def flex-cCenter">
                            <span>{{=it[i].nickname}}</span>
                            {{?it[i].current_company == ''}}
                            {{??it[i].current_position == ''}}
                            <span class="textHidden">({{=it[i].current_company}})</span>
                            {{??it[i].current_position == ''&&it[i].current_company == ''}}
                            {{??}}
                            <span class="textHidden">({{=it[i].current_company}} {{=it[i].current_position}})</span>
                            {{?}}

                        </div>
                        <!-- <i></i> -->
                        <span class="status">{{=it[i].status}}</span>
                    </div>
                </div>
                <div class="list"  >
                    <div class="borderb" data-id="{{=it[i].order_id}}" tapmode onclick="openInfo(this)" data-val='info'>
                        <div class="main_no2 flex-def flex-cCenter">
                            <div class="img">
                                {{?it[i].image_json[0] == null}}
                                <img src="../../image/noimage.jpg">
                                {{??}}
                                <img src="{{=it[i].image_json[0]}}?imageView2/1/w/200/h/200/q/75|imageslim">
                                {{?}}
                            </div>
                            <div class="title flex-item">
                                <div class="flex-def flex-cCenter">
                                    {{?it[i].type==1}}
                                    <span class="label">[个人]</span>
                                    {{??}}
                                    <span class="label">[公司]</span>
                                    {{?}}
                                    <h3 class="">{{=it[i].title}}</h3>
                                </div>
                                <p>{{=it[i].description}}</p>
                            </div>
                            <div class="jl_right flex-cEnd flex-zTopBottom flex-def">
                                <p>
                                    <span class="money">{{=it[i].reward}}元</span>
                                </p>
                                <!-- <p class="bearFruit ydz">
                                    <span class="count">x{{=it[i].amount}}</span>
                                </p> -->
                            </div>
                        </div>
                    </div>
                    <div class="main_no3">
                        <div class="price">
                            <p class="wrap">
                                <span>合计: </span>￥{{=it[i].reward}}元
                            </p>
                        </div>
                        <p class="appraise flex-def flex-cCenter flex-zEnd" tapmode='hover' onclick="event.stopPropagation();">
                            {{for(var j = 0; j < it[i].button.buttonArr.length; j++){ }}
                                    <span data-title="{{=it[i].title}}" data-reasonList='{{=JSON.stringify(it[i].reason_list)}}' data-moeny='{{=it[i].total_money}}' data-id='{{=it[i].order_id}}' data-supply='{{=it[i].supply_id}}'  tapmode='hover' onclick="oriderOperate(this)" class="btn" data-url='{{=it[i].button.buttonArr[j].url}}'>{{=it[i].button.buttonArr[j].key}}</span>
                            {{ }; }}
                        </p>
                    </div>
                </div>
            </div>
        {{ }; }}
    {{??}}
        <div class="nomain flex-def flex-cCenter flex-zCenter">
            <div class="wrap">
                    <div class="icon">
                </div>
                    <p>空空如也 ~</p>
                    <!-- <p class="jump" tapmode onclick="openCreateCirclePage()">快去参与喜欢的圈子吧...</p> -->
            </div>
        </div>
    {{?}}
</script>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript">
    apiready = function(){
        moduleInit();
        requireData();
        api.addEventListener({
            name: 'filterOrder'
        }, function(ret, err) {
            if (ret) {
                // // // console.log(JSON.stringify(ret))
                if (ret.value) {
                    // // // console.log(1)
                    requireData(ret.value.type, ret.value.status, ret.value.sub_type);
                } else {
                    // // // console.log(2)
                    requireData();
                }
            } else {
                alert(JSON.stringify(err.msg));
            }
        });

         // 下拉刷新
        api.setCustomRefreshHeaderInfo({
            bgColor: '#EFEFF4',
        }, function(ret, err) {
            //在这里从服务器加载数据，加载完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
            requireData();
        });
    };
    // 进入会员主页
    function openUserId(ele) {
        api.openWin({
            name: 'winName',
            url: '../addressList/txl_memberInfo_Win.html',
            pageParam: {
                userId: $api.attr(ele, 'data-id')
            }
        });
    }
    // 获取数据
    function requireData(type, status, sub_type) {
        api.ajax({
            url: apiSite + '/demand_order/helperDemandOrder',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: {
                       token: $api.getStorage('userToken'),
                       // token: 'b678d8a0-f0d8-c67e-50b0-4d839ea864d7',
                       type: type || undefined,
                       status: status  || undefined,
                       sub_type: sub_type  || undefined
                   }
            }
        }, function(ret, err) {
            if(ret) {
                if(ret.code == 200) {
                    // // // // console.log('ta:'+JSON.stringify(ret))
                    // 停止下拉刷新
                    api.refreshHeaderLoadDone();
                        $api.css($api.dom('.loading'), 'display:none');
                    if (ret.data.list.length == 0) {
                        // $api.css($api.dom('.noOrider'), 'display: block');
                        getData(ret.data.list)
                    } else {
                        // $api.css($api.dom('.noOrider'), 'display: none');
                        for (var i = 0; i < ret.data.list.length; i++) {
                            ret.data.list[i].image_json = eval(ret.data.list[i].image_json)

                            // 处理显示状态
                            switch (ret.data.list[i].status) {
                                case 1: ret.data.list[i].status = '待付款'; break;
                                case 2: ret.data.list[i].status = '已取消'; break;
                                case 3: ret.data.list[i].status = '待完成'; break;
                                case 4: ret.data.list[i].status = '已取消'; break;
                                case 5: ret.data.list[i].status = '待完成'; break;
                                case 6: ret.data.list[i].status = '已完成'; break;
                                case 7: ret.data.list[i].status = '已完成'; break;
                                case 8: ret.data.list[i].status = '已取消'; break;
                                case 9: ret.data.list[i].status = '已取消'; break;
                                case 10: ret.data.list[i].status = '已取消'; break;
                                case 11: ret.data.list[i].status = '已完成'; break;

                            }

                            // 处理按钮
                            ret.data.list[i].button.buttonArr=[];
                            for(key in ret.data.list[i].button) {
                                for(key1 in ret.data.list[i].button[key]) {
                                    if (ret.data.list[i].button[key].is_show == true){
                                        // // // // console.log(key)
                                        // key 即是要显示的按钮
                                        ret.data.list[i].button[key].key = key;
                                        ret.data.list[i].button.buttonArr.push(ret.data.list[i].button[key])
                                        break;
                                        // // // // console.log(key1 +':::'+ret.data.list[i].button[key][key1])
                                    }
                                }
                            }
                            for (var j = 0; j < ret.data.list[i].button.buttonArr.length; j++) {
                                switch(ret.data.list[i].button.buttonArr[j].key){
                                    case 'cancel_order': ret.data.list[i].button.buttonArr[j].key = '取消订单'; break;
                                    case 'confirm_help': ret.data.list[i].button.buttonArr[j].key = '确认帮助'; break;
                                    case 'refuse_help': ret.data.list[i].button.buttonArr[j].key = '拒绝帮助'; break;
                                    case 'finish': ret.data.list[i].button.buttonArr[j].key = '完成订单'; break;
                                    case 'delete': ret.data.list[i].button.buttonArr[j].key = '删除订单'; break;
                                    case 'confirm_finish': ret.data.list[i].button.buttonArr[j].key = '确认完成'; break;
                                    case 'comment': ret.data.list[i].button.buttonArr[j].key = '评价'; break;
                                    case 'cancel': ret.data.list[i].button.buttonArr[j].key = '取消订单'; break;

                                    // 卖家页面
                                    // case 'confirm_service': ret.data.list[i].button.buttonArr[j].key = '确认接单'; break;
                                    // case 'refuse_cancel': ret.data.list[i].button.buttonArr[j].key = '拒绝接单'; break;
                                    // case 'extend': ret.data.list[i].button.buttonArr[j].key = '延迟服务'; break;
                                    // case 'discount': ret.data.list[i].button.buttonArr[j].key = '优惠'; break;
                                    // case 'confirm_cancel': ret.data.list[i].button.buttonArr[j].key = '同意取消'; break;
                                    // case 'refuse_cancel': ret.data.list[i].button.buttonArr[j].key = '拒绝取消'; break;
                                    // case 'refund': ret.data.list[i].button.buttonArr[j].key = '退款'; break;
                                }
                            }
                        }
                        if (getData(ret.data.list)) {
                            if (api.systemType === 'ios') {
                                for (var i = 0; i < $api.domAll('.btn').length; i++) {
                                    $api.css($api.domAll('.btn')[i], 'line-height:.54rem');
                                }
                                for (var i = 0; i < $api.domAll('.label').length; i++) {

                                     $api.css($api.domAll('.label')[i], 'line-height:.24rem');
                                }
                            }
                        }
                    }
                } else {
                    alert(ret.msg)
                }
            } else {
                alert(JSON.stringify(err.msg))
            }
        })
    }
     // doT模版获取数据
    function getData(data) {
        var listTText = $api.byId('listT').text;
        var fnListT = doT.template(listTText);
        var html = fnListT(data);
        var list = $api.dom('.resultList');
        // 替换resultList所有内容
        $api.html(list, html);
        return true;
    }
    function closeShadow() {
        $api.css($api.dom('.shadow'), 'display:none');
        $api.removeCls($api.dom('.up'), 'up');
        for (var i = 0; i < $api.domAll('.head').length; i++) {
            $api.css( $api.domAll('.head')[i], 'color:#555');
        }
    }
    // 筛选
    function filter(ele) {
        alert($api.text(ele))
        closeShadow();

    }
    // 打开筛选列表
    function listSelect (n, ele) {
        var childNode = $api.dom(ele,'span');
        $api.removeCls($api.dom('.up'), 'up');
        for (var i = 0; i < $api.domAll('.head').length; i++) {
            $api.css( $api.domAll('.head')[i], 'color:#555');
        }

        if (!$api.hasCls(childNode, 'up')) {
            $api.addCls(childNode, 'up');
            $api.css(ele, 'color:#339900');
            $api.css($api.dom('.shadow'), 'display:block');
        } else {
            $api.removeCls(childNode, 'up');
            $api.css(ele, 'color:#555');
            $api.css($api.dom('.shadow'), 'display:none');
        }
        var text = $api.attr(ele, 'data-val');
        if (text == 'lx') {
            // // // console.log(1)
            $api.css($api.dom('.lx'), 'display:block');
            $api.css($api.dom('.zt'), 'display:none');
        } else {
            // // // console.log(2)
            $api.css($api.dom('.lx'), 'display:none');
            $api.css($api.dom('.zt'), 'display:block');
        }
        // api.openFrame({
        //     name: 'shadow',
        //     url: './me_gdd_shadow.html',
        //     rect: {
        //         x: 0,
        //         y: api.pageParam.headerH,
        //         w: 'auto',
        //         h: 'auto'
        //     },
        //     bounces: false
        // });
        // api.bringFrameToFront({
        //     from: 'shadow'
        // });

    }
    // 打开订单详情
    function openInfo(ele) {
        var val = $api.attr(ele,'data-val');
        var order_id = $api.attr(ele,'data-id');
        api.openWin({
            name: val,
            url: './me_qdd_info.html',
            pageParam: {
                flag: 1,
                order_id: order_id
            }
        });
    }

    // 操作按钮
    function oriderOperate(ele) {
        var url = $api.attr(ele, 'data-url');
        var id = $api.attr(ele, 'data-id');
        var supplyId = $api.attr(ele, 'data-supply');
        var title = $api.attr(ele, 'data-title');
        var token = $api.getStorage('userToken');
         var obj = {};
        var flagText = $api.text(ele);
        if (flagText === '删除订单') {
            $api.css($api.dom('.loading'), 'display: block');
            obj = {
                token: token,
                order_id: id,
                title: title
            }
            ajaxOperate(obj,url)
        } else if (flagText === '评价') {
            $api.css($api.dom('.loading'), 'display: block');
            obj = {
                token: token,
                order_id: id,
            }
            api.openWin({
                name: 'supply_commentPage',
                url: '../supply/supply_commentPage.html',
                pageParam: {
                    obj: obj,
                    flag: 1,
                    type: 'demand'
                }
            });
            $api.css($api.dom('.loading'), 'display: none');
        } else if (flagText === '拒绝取消') {

           var reasonList = JSON.parse($api.attr(ele, 'data-reasonList'));
            var datas = []
            for(key in reasonList) {
                datas.push({
                    name:reasonList[key],
                    id:key
                })
            }
            var UIActionSelector = api.require('UIActionSelector');
            UIActionSelector.open({
                datas: datas,
                actives: [1],
                layout: {
                    row: 7,
                    col: 1,
                    height: 30,
                    size: 16,
                    sizeActive: 18,
                    rowSpacing: 5,
                    colSpacing: 5,
                    maskBg: 'rgba(0,0,0,0.5)',
                    bg: '#fff',
                    color: '#888',
                    colorSelected: '#000'
                },
                animation: true,
                cancel: {
                    text: '取消',
                    size: 12,
                    w: 90,
                    h: 35,
                    bg: '#eee',
                    // bgActive: '#ccc',
                    color: '#000',
                    // colorActive: '#fff'
                },
                ok: {
                    text: '确定',
                    size: 12,
                    w: 90,
                    h: 35,
                    bg: '#eee',
                    // bgActive: '#ccc',
                    color: '#000',
                    // colorActive: '#fff'
                },
                title: {
                    text: '请选择退款原因',
                    size: 20,
                    h: 35,
                    bg: '#eee',
                    color: '#000'
                },
                fixedOn: api.frameName
            }, function(ret, err) {
                if (ret) {
                    if (ret.eventType == 'ok') {
                        $api.css($api.dom('.loading'), 'display: block');
                        obj = {
                            token: $api.getStorage('userToken'),
                            order_id: id,
                            reason:  ret.selectedInfo[0].id
                        }
                        ajaxOperate(obj, url)
                    }
                } else {
                    alert(JSON.stringify(err.msg));
                }
            });
        } else if (flagText === '完成订单') {
            $api.css($api.dom('.loading'), 'display: block');
            obj = {
                token: token,
                order_id: id,
            }
            ajaxOperate(obj,url)
        } else if (flagText === '拒绝帮助' || flagText === '取消订单') {
            var reasonList = JSON.parse($api.attr(ele, 'data-reasonList'));
            var datas = []
            for(key in reasonList) {
                datas.push({
                    name:reasonList[key],
                    id:key
                })
            }
            var UIActionSelector = api.require('UIActionSelector');
                UIActionSelector.open({
                    datas: datas,
                    actives: [1],
                    layout: {
                        row: 7,
                        col: 1,
                        height: 30,
                        size: 16,
                        sizeActive: 18,
                        rowSpacing: 5,
                        colSpacing: 5,
                        maskBg: 'rgba(0,0,0,0.5)',
                        bg: '#fff',
                        color: '#888',
                        colorSelected: '#000'
                    },
                    animation: true,
                    cancel: {
                        text: '取消',
                        size: 12,
                        w: 90,
                        h: 35,
                        bg: '#eee',
                        // bgActive: '#ccc',
                        color: '#000',
                        // colorActive: '#fff'
                    },
                    ok: {
                        text: '确定',
                        size: 12,
                        w: 90,
                        h: 35,
                        bg: '#eee',
                        // bgActive: '#ccc',
                        color: '#000',
                        // colorActive: '#fff'
                    },
                    title: {
                        text: '请选择拒绝原因',
                        size: 20,
                        h: 35,
                        bg: '#eee',
                        color: '#000'
                    },
                    fixedOn: api.frameName
                }, function(ret, err) {
                    if (ret) {
                        if (ret.eventType == 'ok') {
                            $api.css($api.dom('.loading'), 'display: block');
                            // // // console.log(JSON.stringify(ret))
                            obj = {
                                token: $api.getStorage('userToken'),
                                order_id: id,
                                reason: ret.selectedInfo[0].id
                            }
                            // // // console.log('obj::'+JSON.stringify(obj))
                            ajaxOperate(obj, url)
                        }
                    } else {
                        alert(JSON.stringify(err.msg));
                    }
                });
        } else {
            $api.css($api.dom('.loading'), 'display: block');
            obj = {
                token: token,
                order_id: id
            };
            ajaxOperate(obj, url);
        }
    }

    function ajaxOperate(obj, url) {
        api.ajax({
            url: apiSite + url,
            method: 'post',
            headers: apiHeader,
            data: {
                   values: obj
            }
        }, function(ret, err) {
            if(ret) {
                if (ret.code !== 200) {
                    alert(ret.msg)
                } else {
                    $api.css($api.dom('.loading'), 'display: none');
                    requireData();
                }
            } else {
                alert(JSON.stringify(err))
            }
        })
    }

</script>
</html>