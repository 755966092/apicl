<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/weui.css"/>
    <style>
        .weui-grid {
            padding: 0;
            width: 2.5rem;
            height: 2.5rem;
            position: relative;
             overflow: hidden;
        }
        .weui-grid__icon {
            width: auto;
            height: auto;
        }
        .selIcon {
            position: absolute;
            right: 0;
            top: 0;
            width: 0.4rem;
            height: 0.4rem;
            background:url(../../image/icon_my/icon_imgSel.png)no-repeat;
            background-size: .4rem;
        }
        .greed {
            background:url(../../image/icon_my/icon_imgSel2.png)no-repeat;
            background-size: .4rem;
        }
        .shadow {
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,.5);
            position: absolute;
            top: 0;
            left: 0;
        }
        .shadow p {
            font-size: 0.28rem;
            color: #fff;
            width: 100%;
            height: 0.4rem;
            background-color: rgba(255,255,255,.4);
            text-align: center;
        }
        .hide {
            display: none;
        }
        .btnWrap {
            position: fixed;
            bottom: 0;
            height: 0.8rem;
            width: 100%;
        }
        .btn {
            width: 100%;
            height: .8rem;
            line-height: 0.8rem;
            font-size: 0.3rem;
            background: #26AB28;
            text-align: center;
            color: #fff;
        }
        .delRed {
            background-color: #E44545;
        }
        body {
            padding-bottom: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="weui-grids resultList"></div>
    <script type="text/x-dot-template" id="listT">
        {{~it :value:index}}
        <a href="javascript:;" class="weui-grid" data-url="{{=value}}" tapmode onclick="openImg(this)" data-index="{{=index}}">
            <span class="selIcon hide" tapmode onclick="selImg(this);event.stopPropagation();" data-url="{{=value}}" data-index="{{=index}}"></span>
            <!-- <span data-url="' + element.path +'" class="shadow flex-def flex-cCenter"><p> 0 %</p></span> -->
            <div class="weui-grid__icon">
                <img src="{{=value}}?imageView2/1/w/200/h/200/q/75|imageslim" alt="">
            </div>
        </a>
        {{~}}
    </script>
    <div class="btnWrap">
        <div class="btn" onclick="delImg(this)"  tapmode>上传</div>
    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript">
    var data = [];
    var aCount;
    var clickFlag = 1;
    apiready = function(){
        $api.fixTabBar($api.dom('.btnWrap'))
        moduleInit();
        if (api.pageParam.imgJson) {
            $api.addCls($api.dom('.btnWrap'), 'hide');
            data = api.pageParam.imgJson;
            getData(data)
        } else {
            requireData();
        }
        showSelIcon();
    };
     
    // 监听事件
    function showSelIcon() {
        api.addEventListener({
            name: 'showSelIcon'
        }, function (ret, err) {
            // 上传按钮变删除
            var btn = $api.dom('.btn');
            if ($api.text(btn) == '上传') {
                clickFlag = 0;
                $api.text(btn, '删除');
                $api.addCls(btn, 'delRed');
            } else {
                clickFlag = 1;
                $api.text(btn, '上传');
                $api.removeCls(btn, 'delRed');
                // console.log('aCount:'+aCount)
                // console.log('后来'+$api.domAll('a').length)
                if (aCount != $api.domAll('a').length) {
                    editImageInfo('del');
                }
            }
            for (let i = 0; i < $api.domAll('.selIcon').length; i++) {
                const element = $api.domAll('.selIcon')[i];
                if ($api.hasCls(element, 'hide')) {
                    $api.removeCls(element, 'hide');
                } else {
                    $api.addCls(element, 'hide');
                }
            }
        });
    }
    // 请求数据
    function requireData() {
        api.ajax({
            url: apiSite + '/user_center/editImageInfoIndex',
            method: 'post',
            headers: apiHeader,
            data: {
                values: { 
                    token: $api.getStorage('userToken'),
                }
            }
        }, function(ret, err) {
            if(ret) {
                if (ret.code === 200) {
                    data = eval(ret.data.info);
                    getData(data);
                    aCount = $api.domAll('a').length
                } else {
                    alert(ret.msg)
                }
            } else {
                alert(JSON.stringify(err))
            }
        })
    }
    // 删除图片
    function delImg(ele) {
        // 获取选中图片的index
        // 删除
        if ($api.text(ele)=='上传') {
            
            UIMediaScanner.open({
                type: 'picture',
                column: 4,
                classify: true,
                max: 9,
                sort: {
                    key: 'time',
                    order: 'desc'
                },
                texts: {
                    stateText: '已选择*项',
                    cancelText: '取消',
                    finishText: '完成'
                },
                styles: {
                    bg: '#fff',
                    mark: {
                        icon: '',
                        position: 'bottom_left',
                        size: 20
                    },
                    nav: {
                        bg: '#eee',
                        stateColor: '#000',
                        stateSize: 18,
                        cancelBg: 'rgba(0,0,0,0)',
                        cancelColor: '#000',
                        cancelSize: 18,
                        finishBg: 'rgba(0,0,0,0)',
                        finishColor: '#000',
                        finishSize: 18
                    }
                },
                scrollToBottom: {
                    intervalTime: 3,
                    anim: true
                },
                exchange: true,
                rotation: true
            }, function (ret) {
                if (ret) {
                    if (api.systemType == 'ios') {
                        var str = '',imgLength = ret.list.length,flagLength = 0;
                        for (let i = 0; i < ret.list.length; i++) {
                            UIMediaScanner.transPath({
                                path: ret.list[i].path
                            }, function (retTransPath, err) {
                                if (retTransPath) {
                                    flagLength++;
                                    ret.list[i].path = retTransPath.path;
                                    str += '<a href="javascript:;" class="weui-grid" data-url="' + retTransPath.path + '" tapmode onclick="openImg(this)"><span class="selIcon hide" tapmode onclick="selImg(this);event.stopPropagation();" data-url="' + retTransPath.path + '"></span><span data-src="' + retTransPath.path + '" class="shadow flex-def flex-cCenter"><p> 0 %</p></span><div class="weui-grid__icon"><img src="' + retTransPath.path + '" alt=""></div></a>'
                                    if (flagLength == imgLength) {
                                         $api.append($api.dom('.resultList'), str);
                                         upImgFile(ret.list)
                                    }
                                } else {
                                    alert(JSON.stringify(err));
                                }
                            });
                        }
                    } else {
                        var str = ''
                        for (let i = 0; i < ret.list.length; i++) {
                            const element = ret.list[i];
                            str += '<a href="javascript:;" class="weui-grid" data-url="'+ element.path +'" tapmode onclick="openImg(this)"><span class="selIcon hide" tapmode onclick="selImg(this);event.stopPropagation();" data-url="'+ element.path +'"></span><span data-src="' + element.path +'" class="shadow flex-def flex-cCenter"><p> 0 %</p></span><div class="weui-grid__icon"><img src="'+ element.path +'" alt=""></div></a>'
                        }
                        $api.append($api.dom('.resultList'), str);
                        upImgFile(ret.list)
                    }
                }
            });
        } else {
            // 删除
            var delArr = [];
            for (let i = 0; i < $api.domAll('.greed').length; i++) {
                const element = $api.domAll('.greed')[i];
                delArr.push($api.attr(element, 'data-url'))
            }
            for (let j = 0; j < delArr.length; j++) {
                const element = delArr[j];
                $api.remove($api.dom('a[data-url="'+ element +'"]'));
            }
            
        }
    }
    function selImg(ele) {
        if ($api.hasCls(ele, 'greed')) {
            $api.removeCls(ele, 'greed');
        } else {
            $api.addCls(ele, 'greed');
        }
    }
    function openImg(ele) {
        if (clickFlag == 1) {
            api.openWin({
                name: 'wiview_the_image_page_winname',
                url: '../supply/view_the_image_page_win.html',
                bounces: false,
                pageParam: { 
                    paramImg : data,
                    url: $api.attr(ele, 'data-url')
                }
            });
        } else {
            // 选择图片selIcon
             if ($api.hasCls($api.dom(ele, '.selIcon'), 'greed')) {
                $api.removeCls($api.dom(ele, '.selIcon'), 'greed');
            } else {
                $api.addCls($api.dom(ele, '.selIcon'), 'greed');
            }
        }
    }
    // 上传图片
    function upImgFile(imgArr) {
        var imgArrlength = imgArr.length,imgUrlArr=[];
        var obj = api.require('qiniuUpfile');
        for (let i = 0; i < imgArr.length; i++) {
            const element = imgArr[i];
            const domShadowText = $api.dom('span[data-src="' + imgArr[i].path + '"] p');
            const domShadow = $api.dom('span[data-src="' + imgArr[i].path + '"]');
            const domA = $api.dom('a[data-url="' + imgArr[i].path + '"]');
            const domSpan = $api.dom('span[data-url="' + imgArr[i].path + '"]');
            const domImg = $api.dom('img[src="' + imgArr[i].path + '"]');
            obj.upfile({
                file: imgArr[i].path,
            }, function (ret, err) {
                if (ret.status) {
                    if (ret.oper == "complete") {
                        //上传成功后组装访问路径，或直接访问文档
                        // 'http://' + baseUrl + '/' + ret.info.key
                        var imgUrl = 'http://' + baseUrl + '/' + ret.info.key; 
                        $api.attr(domA, 'data-url', imgUrl);
                        imgUrlArr.push(imgUrl);
                        $api.attr(domSpan, 'data-url', imgUrl);
                        $api.attr(domImg, 'src', imgUrl+'?imageView2/1/w/200/h/200/q/75|imageslim');
                        $api.addCls(domShadow, 'hide');
                        if (imgUrlArr.length == imgArrlength) {
                            // 上传完成, 
                            editImageInfo('add');
                        }
                    } else if (ret.oper == "progress") {
                        //上传过程中获取进度数据
                        $api.text(domShadowText, Math.floor(ret.percent)+'%');
                    }
                }
            });
        }
    }
    // 上传图
    function editImageInfo(flag) {
        var imgDomArr = $api.domAll('a');
        var imgArr=[];
        for (let i = 0; i < imgDomArr.length; i++) {
            const element = imgDomArr[i];
            imgArr.push($api.attr(element, 'data-url'))
        }
        data = imgArr;
        if (flag == 'add') {
            toastText = '上传成功'
        } else {
            toastText = '删除成功'
        }
        api.ajax({
            url: apiSite + '/user_center/editImageInfo',
            method: 'post',
            headers: apiHeader,
            data: {
                values: { 
                    token: $api.getStorage('userToken'),
                    image_json: imgArr
                }
            }
        }, function(ret, err) {
            if(ret) {
                if (ret.code === 200) {
                    api.toast({
                        msg: toastText,
                        duration: 2000,
                        location: 'bottom'
                    });
                } else {
                    alert(ret.msg)
                }
            } else {
                alert(JSON.stringify(err))
            }
        })
    }
</script>
</html>