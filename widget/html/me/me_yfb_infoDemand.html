

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/swiper.min.css"/>
    <style type="text/css">
        img.default {
            width: 7.5rem;
            height: 4.36rem;
        }

        header.header {
            background: linear-gradient(rgba(58,57,62,.5), rgba(58,57,62,0));
            position: fixed;
            width: 7.5rem;
            top: 0;
            left: 0;
            z-index: 999;
         }
         header .head {
            background-color: rgba(58,57,62,0)
         }
         .swiper-wrapper img {
            height: 4.36rem;
         }
         header .rightBtn {
            line-height: .5rem;
            color: #fff;
            font-size: .65rem;
         }

        .main {
            /*margin-bottom: 1.5rem;*/
            padding-bottom: 1.5rem;
        }
        .img {
            font-size: 0;
        }
        .img img {
            width: 7.5rem;
            height: 7.5rem;
        }
        .title {
            height: 1rem;
            padding: 0 .3rem;
            box-sizing: border-box;
            /* border-bottom: .01rem solid #E8E8E8; */
            background-color: #fff;
        }
        .title img {
            width: .7rem;
            height: .7rem;
        }
        .titleRight {
            font-size: 0;
            padding-left: .2rem;
            box-sizing: border-box;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .titleRight h3 {
            font-size: .3rem;
            line-height: .42rem;

        }
        .titleRight p {
            font-size: .24rem;
            line-height: .33rem;
            color: #999;
        }
        .title2 {
            padding: .2rem .3rem .1rem;
            /* border-bottom: .01rem solid #E8E8E8; */
            margin: .2rem 0;
            background-color: #fff;
        }
        .title2 .typeIcon {
            font-size: .2rem;
            color: #cc0019;
            margin-right: .1rem;
        }

        .title2 .shareIcon {
            width: .258rem;
            height: .36rem;
            background: url(../../image/icon_supply/icon_share.png)no-repeat;
            -webkit-background-size: .258rem .36rem;
            background-size: .258rem .36rem;

        }
        .title2 .titleName {
            font-size: 0;

        }
        .title2 .titleName p {
            font-size: .34rem;
        }
        .price {
            font-size: 0;
            margin: .2rem 0 .2rem;
            padding-bottom: 0.2rem;
            /*width: 100%;*/
            border-bottom: .01rem solid #d9d9d9;
        }
        .price .priceText {
            color: #D0011B;
            font-size: .34rem;
        }
        .price .time {
            color: #999;
            font-size: .24rem;
        }

        .sold_cound {
            font-size: 0;
        }
        .avg_point .avg_pointIcon {
            width: .245rem;
            height: .245rem;
            background: url(../../image/icon_supply/icon_xx.png)no-repeat;
            -webkit-background-size: .245rem .245rem;
            background-size: .245rem .245rem;
            margin-right: .06rem;
        }
        .sold_cound .count, .form{
            font-size: .24rem;
            color: #999;
            margin-right: .2rem;
            margin-bottom: .1rem;
        }

        .sel {
            height: .8rem;
            padding: 0 .3rem;
            font-size: 0;
            line-height: .8rem;
            margin: .2rem 0;
            background-color: #fff;
        }
        .sel .selTitle {
            font-size: .3rem;
            color: #999;
        }
        .sel .selText {
            font-size: .3rem;
            color: #000;
        }
        .sel .selIcon {
            width: .15rem;
            height: .25rem;
            background: url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
        }
        .infoTitle {
            margin-bottom: .3rem;
            font-size: 0;
        }
        .infoTitle .line {
            width: .97rem;
            height: .03rem;
            background-color: #999;
        }
        .infoTitle .imgIcon {
            width: .34rem;
            height: .29rem;
            background: url(../../image/icon_supply/icon_init.png)no-repeat;
            -webkit-background-size: .34rem .29rem;
            background-size: .34rem .29rem;
            margin-right: .1rem;
        }
        .infoTitle .infoTitleText {
            font-size: .34rem;
            line-height: .48rem;
        }

        .infoTitle .text {
            margin: 0 .2rem;
            font-size: 0;
        }
        .info {
            background-color: #fff;
            padding: .2rem .3rem;
        }
        .infoData {
            font-size: 0;
        }
        .infoData p {
            font-size: .3rem;
            color: #555;
            margin: .3rem 0;
        }
        .infoData img {
            width: 6.9rem;
            margin-bottom: .3rem;
        }
        .comment {
            margin-top: .2rem;
            background-color: #fff;
        }
        .comment .commentCount {
            font-size: .3rem;
        }
        .comment .commentTitle {
            width: 100%;
            box-sizing: border-box;
            font-size: 0;
            line-height: .65rem;
            height: .65rem;
            background-color: #fff;
            border-bottom: .01rem solid #D9D9D9;
            padding: 0 .3rem;
        }
        .comment .commentIcon {
            width: .15rem;
            height: .25rem;
            background: url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;

        }
        .commentContent {
            font-size: 0;
            padding: .25rem .3rem .25rem 0;
            margin-left: .3rem;
            border-bottom: .01rem solid #d9d9d9;
            background-color: #fff;
        }
        .commentContentTitle img {
            width: .76rem;
            height: .76rem;
            margin-right: .2rem;
        }
        .commentName {
            width: 6.24rem;
        }

        .commentNameLeft {
            font-size: 0;
        }
        .commentNameLeft .name {
            font-size: .34rem;
        }
        .commentNameRight {
            font-size: .24rem;
            color: #999;
        }
        .commentText {
            font-size: .3rem;
            color: #555;
            margin-top: .18rem;
        }
        .btn {
            height: .75rem;
        }
        .btn>div {
            color: #D0011B;
            font-size: .24rem;
            width: 1.4rem;
            height: .4rem;
            margin: 0 auto;
            border: 2px solid #D0011B;
            border-radius: .1rem;
            text-align: center;
            line-height: .4rem;

        }
        footer {
            font-size: 0;
            height: .88rem;
            /*line-height: .88rem;*/
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #fff;
            border-top: .01rem solid #F8F8F8;
         }
         footer span {
            font-size: .18rem;
            color: #999;
            text-align: center;
            float: left;
         }
         footer span:nth-child(1),
         footer span:nth-child(2) {
             width: 25%;
         }

         footer span:nth-child(3) {
             font-size: .3rem;
             width: 50%;
             line-height: .88rem;
             background-color: #0ABB07;
             color: #fff;
         }
         footer span.edit {
            background-color: #818181;
         }
        footer i {
             display: inline-block;
             width: 100%;
             height: .55rem;
             background: url(../../image/icon_supply/icon_del.png)no-repeat;
            background-size: .39rem .38rem;
            background-position: center bottom;
         }
        footer i.del_2 {
            background: url(../../image/icon_supply/icon_del_2.png)no-repeat;
            background-size: .39rem .38rem;
            background-position: center bottom;
        }
        footer i.sus {
            background: url(../../image/icon_supply/icon_pause.png)no-repeat;
            background-size: .4rem .4rem;
            background-position: center bottom;
        }
        footer i.sus_2 {
            background: url(../../image/icon_supply/icon_pause1.png)no-repeat;
            background-size: .4rem .4rem;
            background-position: center bottom;
        }


        .swiper-wrapper img {
            height: 4.36rem;
         }
         .label {
            font-size: .2rem;
            color: #0076FF;
            border: .01rem solid #0076FF;
            text-align: center;
            padding: 0 .05rem;
            margin-right: .1rem;
            border-radius: .06rem;
        }
    </style>
</head>
<body>
    <header  class="header">
        <div class="head">
            <span class="callback"   tapmode   onclick="api.closeWin()">返回</span>
            <span class="winTitle">
                信息详情
            </span>
        </div>
    </header>
    <div class="loading" ></div>
    <div class="swiper-container">
            <div class="swiper-wrapper"></div>

            <div class="swiper-pagination"></div>
        </div>
    <div class="resultList"></div>
    <script type="text/x-dot-template" id="listT">
        <div class="main flex-def flex-zTopBottom">
            <!-- <div class="img">
                {{?it.info.image_json[0]}}
                    <img src="{{=it.info.image_json[0]}}">
                {{??}}
                    <img src="../../image/noimage.jpg">
                {{?}}
            </div> -->
            <div class="title flex-def flex-zLeftRight flex-cCenter">
                <img src="{{=it.info.head_img_url}}" alt="">
                <div class="titleRight">
                    <h3>{{=it.info.nickname}}</h3>
                    {{?it.info.current_company==null&&it.info.current_position!=null}}
                        <p> {{=it.info.current_position}}</p>
                    {{??it.info.current_position==null&&it.info.current_company!=null}}
                        <p>{{=it.info.current_company}}</p>
                    {{??it.info.current_position==null&&it.info.current_company==null}}
                    {{??}}
                        <p>{{=it.info.current_company}} {{=it.info.current_position}}</p>
                    {{?}}
                </div>
            </div>
            <div class="title2">
                <div class="top flex-def flex-zBetween">
                    <div class="titleName flex-def flex-zLeftRight flex-cCenter">
                        <span class="typeIcon">[{{=it.info.type}}]</span>
                        <p>{{=it.info.title}}</p>
                    </div>
                    <!-- 分享按钮 -->
                    <!-- <div class="shareIcon"></div> -->
                </div>
                <div class="price flex-def flex-zBetween flex-zLeftRight">
                    <div class="priceText">
                        ￥{{=it.info.reward}}
                    </div>
                    <div class="time">
                        {{=it.info.create_time}}
                    </div>
                </div>
                <div class="sold_cound flex-def flex-zLeftRight flex-cCenter">
                    <span class="count">[已售{{=it.info.status}}]</span>

                </div>
                {{?it.info.form == 1}}
                    <div class="form">线上服务</div>
                {{??}}
                    <div class="form">线下服务</div>
                {{?}}
            </div>
            <!-- <div class="sel flex-def flex-zBetween flex-cCenter">
                <div>
                    <span class="selTitle">已选：</span>
                    <span class="selText">设计、“APP图标”</span>
                </div>
                <span class="selIcon"></span>
            </div> -->
            <div class="info">
                <div class="infoTitle flex-def flex-zCenter flex-cCenter flex-zLeftRight">
                    <span class="line"></span>
                    <div class="text flex-def flex-zLeftRight flex-cCenter">
                        <span class="imgIcon"></span>
                        <span class="infoTitleText">详情</span>
                    </div>
                    <span class="line"></span>
                </div>
                <div class="infoData">
                    <p>{{=it.info.description}}</p>
                    {{?it.info.image_json[0]!='0'}}
                        {{for(var i=0;i< it.info.image_json.length; i++){ }}
                            <img src="{{=it.info.image_json[i]}}" tapmode onclick="openImgView(this)">
                        {{ }; }}
                    {{??it.info.image_json[0]=='0'}}
                    {{?}}

                </div>
            </div>
            <div class="comment">
                <div class="commentTitle flex-def flex-cCenter flex-zBetween">
                    {{?!it.info.comment_count}}
                    <span class="commentCount">评论（0）</span>
                    {{??}}
                    <span class="commentCount">评论（{{=it.info.comment_count}}）</span>
                    {{?}}
                    <span class="commentIcon"></span>
                </div>
                {{for(var i = 0;i < it.info.comment_count;i++){ }}
                <div class="commentContent">
                    <div class="commentContentTitle flex-def flex-zLeftRight">
                        <img src="{{=it.last_comment.head_img_url}}">
                        <div class="commentName flex-def flex-zBetween flex-zLeftRight flex-cCenter">
                            <div class="commentNameLeft">
                                <div class="name">{{=it.last_comment.nickname}}</div>
                                <div class="avg_point">
                                    {{for(var i = 0;i < it.last_comment.point;i++){ }}
                                        <span class="avg_pointIcon"></span>
                                    {{};}}
                                </div>
                            </div>
                            <div class="commentNameRight">
                                {{=it.last_comment.create_time}}
                            </div>
                        </div>
                    </div>
                    <p class="commentText">{{=it.last_comment.content}}</p>
                </div>
                {{};}}

                {{?it.info.comment_count}}
                    <div class="btn flex-def flex-cCenter">
                        <div>查看全部</div>
                    </div>
                {{??}}
                {{?}}

            </div>

        </div>
    </script>
    <footer>
        <span id="editStatus" ontouchstart="demandCancel(0)">
            <i class="sus" id="sus"></i>
            放弃求助
        </span>
        <span id="delStatus" ontouchstart="demandCancel(1)">
            <i class="del" id="del"></i>
            删除
        </span>
        <span id="edit" ontouchstart="demandCancel(2)">编辑</span>
    </footer>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/jquery.min.js"></script>
<script type="text/javascript" src="../../script/swiper.min.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript">
    var editStatus = 1, delStatus = 1, edit = 1,paramImg;
    apiready = function(){
        fnInit();
        window.onscroll = function() {
            var opacityNum = document.body.scrollTop/145;
            if (opacityNum < 0.1 ){
                $api.css($api.dom('header.header'), 'background: linear-gradient(rgba(58,57,62,.5), rgba(58,57,62,0));');
            } else {
                $api.css($api.dom('header.header'), 'background-color: rgba(58,57,62,' + opacityNum + ')');
            }
        }
        // 初始化页面
        initialise();
    };
    swiperFun();
    function swiperFun() {
        var mySwiper = new Swiper('.swiper-container',{
            loop: true,
            autoplay: 3000,
            pagination: '.swiper-pagination',
            observer: true, //修改swiper自己或子元素时，自动初始化swiper
            observeParents: true //修改swiper的父元素时，自动初始化swiper
        });
    }
    // 放弃求助
    function demandCancel(n) {
        if (n == 0) {
            // 放弃求助
            if(editStatus) {
                // // console.log('删除:' + delStatus +';编辑:' + edit +';放弃:'+editStatus)
                api.ajax({
                    url: apiSite + '/demand/cancel',
                    method: 'post',
                    headers: apiHeader,
                    data: {
                           values: {
                               token: $api.getStorage('userToken'),
                               demand_id: api.pageParam.demand_id
                           }
                    }
                }, function(ret, err) {
                    if(ret) {
                        if (ret.code == 200) {
                            api.sendEvent({
                                name: 'editSupplyAfter'
                            });
                            initialise();
                        } else {
                            alert(ret.msg)
                        }
                    } else {
                        alert(JSON.stringify(err))
                    }
                })
            } else {
                // // console.log('删除:' + delStatus +';编辑:' + edit +';放弃:'+editStatus)
                alert('当前状态不能放弃求助')
            }
        } else if (n == 1) {
            // 删除求助
            if (delStatus) {
                // // console.log('删除:' + delStatus +';编辑:' + edit +';放弃:'+editStatus)
                api.ajax({
                    url: apiSite + '/demand/delete',
                    method: 'post',
                    headers: apiHeader,
                    data: {
                           values: {
                               token: $api.getStorage('userToken'),
                               demand_id: api.pageParam.demand_id
                           }
                    }
                }, function(ret, err) {
                    if(ret) {
                        if (ret.code == 200) {
                            api.sendEvent({
                                name: 'editSupplyAfter'
                            });
                            api.closeWin();
                        } else {
                            alert(ret.msg)
                        }
                    } else {
                        alert(JSON.stringify(err))
                    }
                })
            } else {
                // // console.log('删除:' + delStatus +';编辑:' + edit +';放弃:'+editStatus)
                alert('当前状态不能删除求助')
            }
        } else {
            // 编辑求租
            if (edit) {
                // // console.log('删除:' + delStatus +';编辑:' + edit +';放弃:'+editStatus)
                api.openWin({
                    name: 'supply_releaseAsk_win',
                    url: '../supply/supply_releaseAsk_win.html',
                    pageParam: {
                        demand_id: api.pageParam.demand_id
                    }
                });
            } else {
                // // console.log('删除:' + delStatus +';编辑:' + edit +';放弃:'+editStatus)
                alert('当前状态不能编辑求助')
            }
        }
    }

    // 初始化页面
    function  initialise() {
        // 请求数据
        api.ajax({
            url: apiSite + '/demand/detail',
            method: 'post',
            headers: apiHeader,
            data: {
               values: {
                   token: $api.getStorage('userToken'),
                   demand_id: api.pageParam.demand_id
               }
            }
        }, function(ret, err) {
            // // console.log(JSON.stringify(ret))
            if (ret.code == 200) {
                // 解析图片json
                ret.data.info.image_json = eval(ret.data.info.image_json);
                paramImg = ret.data.info.image_json;
                ret.data.info.type = ret.data.info.type === 1 ? "个人" : "公司";
                var statusArr=["求助中","帮助中","已结束","已失效","已删除"]
                // ret.data.info.status = statusArr[ret.data.info.status-1]
                var eleHtml = '';
                for (var i = 0; i < ret.data.info.image_json.length; i++) {
                    if(i<5) {
                        eleHtml += '<img src="'+ ret.data.info.image_json[i] +'?imageView2/1/w/750/h/436/format/jpg/q/100|imageslim" class="swiper-slide blue-slide">'
                        ret.data.info.image_json[i] = ret.data.info.image_json[i] +
                        '?imageMogr2/auto-orient/thumbnail/710x/blur/1x0/quality/100|imageslim'
                    }
                }
                // // console.log(eleHtml)
                $api.css($api.dom('.loading'), 'display:none');
                // // // console.log(JSON.stringify(ret.data))
                if (eleHtml) {
                    console.log(eleHtml)
                    $api.html($api.dom('.swiper-wrapper'), eleHtml);
                } else {
                    $api.css($api.dom('header.header'), 'background: rgba(58,57,62,1);position:relative;');
                    // $api.html($api.dom('.swiper-wrapper'),'<img class="default" src="../../image/noimage.jpg">');
                }
                if (ret.data.info.image_json.length > 1) {
                    swiperFun();
                }
                getData(ret.data);
                if (ret.data.info.status == 1) {
                    // 可放弃,可编辑, 不可删除
                    delStatus = 0;
                    edit = 1;
                    editStatus = 1;
                    if (!$api.toggleCls($api.byId('del'), 'del_2')) {
                        $api.addCls($api.byId('del'), 'del_2');
                    }

                    if ($api.toggleCls($api.byId('edit'), 'edit')) {
                        $api.removeCls($api.byId('edit'), 'edit');
                    }
                    if ($api.toggleCls($api.byId('sus'), 'sus_2')) {
                        $api.removeCls($api.byId('sus'), 'sus_2');
                    }
                } else if (ret.data.info.status == 3 || ret.data.info.status == 4) {
                    // 可删除, 不可编辑和放弃
                    edit = 0;
                    editStatus = 0;
                    delStatus = 1;
                    if ($api.toggleCls($api.byId('del'), 'del_2')) {
                        $api.removeCls($api.byId('del'), 'del_2');
                    }

                    if (!$api.toggleCls($api.byId('edit'), 'edit')) {
                        $api.addCls($api.byId('edit'), 'edit');
                    }
                    if (!$api.toggleCls($api.byId('sus'), 'sus_2')) {
                        $api.addCls($api.byId('sus'), 'sus_2');
                    }

                } else {
                    // b帮助中 不可以做任何操作
                    editStatus = 0;
                    delStatus = 0;
                    edit = 0;
                    if (!$api.toggleCls($api.byId('del'), 'del_2')) {
                        $api.addCls($api.byId('del'), 'del_2');
                    }
                    if (!$api.toggleCls($api.byId('edit'), 'edit')) {
                        $api.addCls($api.byId('edit'), 'edit');
                    }
                    if (!$api.toggleCls($api.byId('sus'), 'sus_2')) {
                        $api.addCls($api.byId('sus'), 'sus_2');
                    }
                }

            } else {
                alert(ret.msg)
            }
        })
    }
    // 打开图片页面
    function openImgView(ele) {

        api.openWin({
            name: 'view_the_image_page_win',
            url: '../supply/view_the_image_page_win.html',
            bounces: false,
            pageParam: {
                url : $api.attr(ele, 'src'),
                paramImg: paramImg
            }
        });
    }


</script>
</html>