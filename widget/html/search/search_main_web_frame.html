
<!doctype html>
<html>
    <head>
        <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
        <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
        <title>搜索</title>
        <link rel="stylesheet" type="text/css" href="../../css/api.css" />
        <link rel="stylesheet" type="text/css" href="../../css/style.css" />
        <style>
            .contactPerso {
                background-color: #fff;
                border-bottom: .01rem solid #d9d9d9;
            }
            .contactPerso .title {
                height: 0.7rem;
                line-height: 0.7rem;
                box-sizing: border-box;
                padding: 0 .36rem;
                border-bottom: .01rem solid #d9d9d9;
                font-size: 0.26rem;
                color: #7e7e7e;
            }
            .contactPerso img {
                width: 0.7rem;
                height: 0.7rem;
                margin-right: 0.21rem;
            }
            .chatRecord img {
                width: 0.91rem;
                height: 0.91rem;
                border-radius: .1rem;
            }
            .contactPerso ul {
                box-sizing: border-box;
                padding-left: 0.18rem;
            }
            .contactPerso li {
                height: 1.2rem;
                border-bottom: .01rem solid #d9d9d9;
            }
            .IinCircles li {
                height: 1.57rem;
            }
            .chatRecord li {
                height: 1.24rem;
            }
            .supply li {
                height: 1.34rem;
            }
            /* .contactPerso li:last-child {
                border: 0;
            } */
            .contactPerso h3 {
                
                font-size: 0.3rem;
                max-width: 5rem;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .colorFont {
                color: #27B24A;
            }
            .h3Title {
                max-width: 4rem;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .contactPerso .text p {
                color: #999;
                font-size: 0.24rem;
                max-width: 5rem;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .supply .text p {
                color: #000;
                font-size: 0.28rem;
            }
            .seeMore {
                height: 0.8rem;
                line-height: 0.8rem;
                font-size: 0.26rem;
                box-sizing: border-box;
                padding: 0 .25rem;
                color: #4C5F8C;
            }
            .seeMore .icon {
                width: 0.24rem;
                height: 0.24rem;
                background: #fff url(../../image/icon_supply/icon_search.png)no-repeat;
                background-size: .24rem .24rem;
                margin-right: 0.17rem;
            }
            .seeMore .icon2, 
            .web .icon2 {
                width: 0.15rem;
                height: 0.25rem;
                background: #fff url(../../image/icon_zk.png)no-repeat;
                background-size: .15rem .25rem;
                float: right;
            }
            .circleText {
                width: 2.1rem;
            }
            .label {
                width: 0.41rem;
                height: 0.24rem;
                /* background: url(../../image/icon_supply/icon_gs1.png)no-repeat; */
                /* background-size: .41rem .24rem; */
                margin-right: 0.1rem;
                font-size: 0.18rem;
                border-radius: .04rem;
                border: .01rem solid #5D7099;
                color: #5D7099;
                text-align: center;
                line-height: 0.24rem;
            }
            .web {
                height: 1.24rem;
                background-color: #fff;
                box-sizing: border-box;
                padding: 0 .25rem 0 .18rem;
                margin-bottom: 0.2rem;
            }
            .web img {
                width: 0.91rem;
                height: 0.91rem;
                border-radius: .1rem;
                margin-right: 0.19rem;
            }
            .web h3 {
                font-size: 0.3rem;
            }
            .web p {
                font-size: 0.24rem;
                color: #999;
            }
            .allData {
                text-align: center;
                font-size: 0.28rem;
                color: #999;
                line-height: 0.8rem;
                height: 0.8rem;
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="resultList"></div>
        <script type="text/x-dot-template" id="listT">
            {{?it.length != 0}}
                <div class="contactPerso">
                    <ul>
                        {{~it :value:index}}
                            <li class="flex-def flex-cCenter" data-userId={{=value.user_id}} tapmode onclick="openInfo(this)">
                                <img  src="{{=value.remark_head_img_url?value.remark_head_img_url:value.head_img_url}}" alt="">
                                <div class="text">
                                    <h3>{{=value.remark_nickname?value.remark_nickname:value.nickname}}</h3>
                                    {{?value.contain}}
                                    <p>{{=value.contain}}</p>
                                    {{??}}
                                    {{?}}
                                </div>
                            </li>
                        {{~}}
                    </ul>
                </div>
            {{?}}
        </script>
        <p class="allData">已经加载全部</p>
        <script type="text/javascript" src="../../script/api.js"></script>
        <script type="text/javascript" src="../../script/common.js"></script>
        <script type="text/javascript" src="../../script/doT.min.js"></script>
        <script type="text/javascript">
            var page_num = 2,pageParamData;
            apiready = function(){
                pageParamData = api.pageParam.ret.value.user;
                renderPage(pageParamData);
                searchWeb();
            }
            function openInfo(ele) {
                api.openWin({
                    name: 'txl_memberInfo_Win',
                    url: '../addressList/txl_memberInfo_Win.html',
                    bounces: false,
                    pageParam: {userId : $api.attr(ele, 'data-userId')}
                });
            }
            function renderPage(ret) {
                if(dataProcessing(ret)) {
                    getData(pageParamData);
                }
            }
            function dataProcessing(ret) {
                for (var i = 0; i < ret.length; i++) {
                    var element = ret[i];
                    var reg = new RegExp(api.pageParam.ret.value.keyword, '');
                    // 替换搜索关键字
                    if(element.remark_nickname) {
                        element.remark_nickname = element.remark_nickname.replace(reg, '<span class="colorFont">'+ api.pageParam.ret.value.keyword +'</span>')
                    }
                    if(element.nickname) {
                        element.nickname = element.nickname.replace(reg, '<span class="colorFont">'+ api.pageParam.ret.value.keyword +'</span>')
                    }
                    element.contain = '';
                    if (element.current_contact) {
                        if(element.current_contact.indexOf(api.pageParam.ret.value.keyword) != -1){
                            element.current_contact = element.current_contact.replace(reg, '<span class="colorFont">'+ api.pageParam.ret.value.keyword +'</span>');
                            element.contain += '电话: '+element.current_contact + ' '; 
                        }
                    }
                    if (element.remark_current_contact) {
                        if(element.remark_current_contact.indexOf(api.pageParam.ret.value.keyword) != -1){
                            element.remark_current_contact = element.remark_current_contact.replace(reg, '<span class="colorFont">'+ api.pageParam.ret.value.keyword +'</span>')
                            if(element.remark_current_contact != element.current_contact) {
                                element.contain += '备注电话: '+element.remark_current_contact;
                            }
                        }
                    }
                }
                return true
            }
            function searchWeb() {
                 // 滚动到底部触发的事件
                api.addEventListener({
                    name:'scrolltobottom',
                    extra:{
                        threshold:0            //设置距离底部多少距离时触发，默认值为0，数字类型
                    }
                }, function(ret, err){
                    searcWeb(api.pageParam.ret.value.keyword)
                })    
            }
            // 搜索网络
            function searcWeb(keyword) {
                // console.log(keyword+'at 232');
                if (keyword) {
                    api.ajax({
                        url: apiSite + '/user/search',
                        method: 'post',
                        headers: apiHeader,
                        data: {
                            values: { 
                                token: $api.getStorage('userToken'),
                                keyword: keyword,
                                page_num: page_num
                            }
                        }
                    }, function(ret, err) {
                        if(ret) {
                            if (ret.code === 200) {
                                page_num++;
                                if (ret.data.list.length < 20) {
                                    var webData = ret.data.list;
                                    if(dataProcessing(webData)){
                                        pageParamData = pageParamData.concat(webData);
                                        getData(pageParamData);
                                    }
                                    $api.css($api.dom('.allData'), 'display: block;');
                                    api.removeEventListener({
                                        name: 'scrolltobottom'
                                    });
                                } 
                            } else {
                                alert(ret.msg)
                            }
                        } else {
                            alert(JSON.stringify(err))
                        }
                    })
                }
            }
        </script>
    </body>
</html>
