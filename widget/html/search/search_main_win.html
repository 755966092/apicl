
<!doctype html>
<html>
    <head>
        <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
        <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
        <title>搜索</title>
        <link rel="stylesheet" type="text/css" href="../../css/api.css" />
        <link rel="stylesheet" type="text/css" href="../../css/style.css" />
        <style>
            .top {
                height: 0.8rem;
                /* width: 100%; */
                background-color: #EDECF3;
            }
            .wrap {
                height: 0.8rem;
                /* width: 100%; */
                box-sizing: border-box;
                padding: 0 0.15rem;
            }
            input {
                /* width: 6.35rem; */
                height: 0.5rem;
                margin: 0 .15rem;
                border-radius: .05rem;
                background: #fff url(../../image/icon_supply/icon_search.png)no-repeat;
                background-size: .24rem .24rem;
                background-position: .13rem center;
                box-sizing: border-box;
                padding-left: 0.5rem;
            }
            span {
                color: #0ABB07;
                font-size: 0.3rem;
            }
            #callbackBtn {
                display: none;

            }
        </style>
    </head>
    <body>
        <div class="top ">
            <form class="wrap flex-def flex-cCenter">
                <!-- <span id="callbackBtn">返回</span> -->
                    <input id="input" class="flex-item" type="search" >
                    <span class="flagText" tapmodu onclick="search(this)">取消</span>
            </form>
        </div>
        <script type="text/javascript" src="../../script/api.js"></script>
        <script type="text/javascript" src="../../script/common.js"></script>
        <script type="text/javascript" src="../../script/pinyin4js.js"></script>
        <script type="text/javascript" src="../../script/jquery.min.js"></script>
        <script type="text/javascript">
            var headerH;
            apiready = function(){
                moduleInit();
                // 设置状态栏文字颜色
                // api.setStatusBarStyle({
                //     style: 'dark',
                // });
                pageInit();
                api.openFrame({
                    name: 'search_main_frame',
                    url: './search_main_frame.html',
                    bounces: false,
                    pageParam: {
                        headerH: headerH
                    },
                    rect: {
                        x: 0,
                        y: headerH,
                        w: 'auto',
                        h: 'auto'
                    }
                });
                api.addEventListener({
                    name: 'searchSqlMore'
                }, function(ret, err){
                    if (ret.value) {
                        $api.val($api.dom('input'), ret.value.keyword );
                    } else {
                        $api.val($api.dom('input'), '' );

                    }
                });
                bindEvent();
            }
             function bindEvent() {
                    if (api.systemType == 'ios') {
                        $('#input').on("compositionend", function () {
                            changeInput(this);
                        })
                         $('#input').on("input", function () {
                            changeInput(this);
                        })
                    } else {
                        $('#input').on("input", function () {
                            changeInput(this);
                        })
                    }
                }
            function pageInit() {
                $api.fixStatusBar($api.dom('.top'));
                headerH = $api.offset($api.dom('.top')).h;
            }
            function changeInput(ele) {
                var val = $api.val(ele);
              //  console.log(val)
                // $api.text($api.dom('.flagText'), '搜索');
                // if (!val) {
                //     $api.text($api.dom('.flagText'), '取消');
                // }
                // 搜索功能
                searchSql(val)

            }
            function searchSql(keyword) {
                if (keyword) {
                    db.selectSql({
                        name: 'db_' + $api.getStorage('userToken'),
                        // sql: 'SELECT * FROM addressList '
                        sql: 'SELECT * FROM addressList WHERE (nickname LIKE "%'+keyword+'%") or (remark_nickname LIKE "%'+keyword+'%") or (remark_current_contact LIKE "%'+keyword+'%") or (current_contact LIKE "%'+keyword+'%")'
                    },function(retSql,err){
                        if (retSql.status) {
                          //  console.log(JSON.stringify(retSql,null,4))
                            if (retSql.data.length > 0) {
                                api.sendEvent({
                                    name: 'searchSql',
                                    extra: {
                                        user: retSql.data,
                                        keyword: keyword
                                    }
                                });
                            } else {
                                api.sendEvent({
                                    name: 'searchSql',
                                    extra: {
                                        keyword: keyword,
                                        user: retSql.data
                                    }
                                });
                            }
                        } else {
                            alert(JSON.stringify(ret))
                        }
                    })
                } else {
                    api.sendEvent({
                        name: 'searchSql',
                    });
                }

            }
            function search(ele) {
                var text = $api.text(ele);
                if (text === '取消') {
                    // 关闭页面
                    api.closeWin();
                } else {
                    // 搜索
                    searchResults();
                }
            }
            function searchResults () {
                var keyWord = $api.val($api.dom('input'));

            }
            // 关闭遮罩层
            function closeShadow() {
                $api.css($api.dom('.shadow'), 'display: none');
            }
               $api.dom('form').onsubmit = function() {
                    return false;
                };
        </script>
    </body>
</html>
