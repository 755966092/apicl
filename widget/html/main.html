<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>底部导航</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <style>
        header {
            background-color: #3A393E;
        }
        
        header ul li {
            color: #fff;
            height: .8rem;
            line-height: .8rem;
            text-align: center;
            display: none;
            position: relative;
            font-size: .34rem;
            font-weight: 700;
        }
        
        header ul li.active {
            display: block;
        }
        
        header ul li span.rightBtn {
            font-size: .65rem;
            line-height: .7rem;
            position: absolute;
            right: .3rem;
            font-weight: 200;
            color: #fff;
        }
        
        .addWin {
            width: 2.24rem;
            height: 1.74rem;
            background: url(../image/bg_news.png)no-repeat;
            -webkit-background-size: 2.24rem 1.74rem;
            background-size: 2.24rem 1.74rem;
            position: absolute;
            right: .1rem;
            top: 1.1rem;
            padding-top: .1rem;
            display: block;
            z-index: 1000;
        }
        
        .addWin p {
            padding-left: .3rem;
            height: .82rem;
            line-height: .8rem;
            font-size: .28rem;
        }
        
        .addWin p:nth-child(1) {
            background: url(../image/icon_add.png)no-repeat;
            background-position: .15rem .22rem;
            -webkit-background-size: .41rem .41rem;
            background-size: .41rem .41rem;
            border-bottom: .01rem solid #959498;
        }
        
        .addWin p:nth-child(2) {
            background: url(../image/icon_sao.png)no-repeat;
            background-position: .15rem .22rem;
            -webkit-background-size: .41rem .41rem;
            background-size: .41rem .41rem;
        }
        
        #footer {
            /*background-color: rgba(242,242,242,0.2);      */
            background-color: #F5F5F7;
            position: fixed;
            bottom: 0;
            width: 7.5rem;
            border-top: .6px solid #9D9DA1;
            height: .88rem;
        }
        
        #footer ul {
            /*background-color: rgba(242,242,242,0.2);          */
        }
        
        #footer ul li {
            padding-top: .64rem;
            padding-bottom: .1rem;
            background: url() no-repeat center .15rem;
            background-size: auto .4rem;
            text-align: center;
            position: relative;
            color: #999;
            font-size: .18rem;
        }
        
        #footer ul li.active {
            color: #0ABB07;
        }
        
        #footer ul li:nth-child(1) {
            background-image: url(../image/icon_footer/bottombtn0101.png);
        }
        
        #footer ul li:nth-child(2) {
            background-image: url(../image/icon_footer/bottombtn0201.png);
        }
        
        #footer ul li:nth-child(3) {
            background-image: url(../image/icon_footer/bottombtn0301.png);
        }
        
        #footer ul li:nth-child(4) {
            background-image: url(../image/icon_footer/bottombtn0401.png);
        }
        
        #footer ul li:nth-child(5) {
            background-image: url(../image/icon_footer/bottombtn0501.png);
        }
        
        #footer ul li:nth-child(1).active {
            background-image: url(../image/icon_footer/bottombtn0102.png);
        }
        
        #footer ul li:nth-child(2).active {
            background-image: url(../image/icon_footer/bottombtn0202.png);
        }
        
        #footer ul li:nth-child(3).active {
            background-image: url(../image/icon_footer/bottombtn0302.png);
        }
        
        #footer ul li:nth-child(4).active {
            background-image: url(../image/icon_footer/bottombtn0402.png);
        }
        
        #footer ul li:nth-child(5).active {
            background-image: url(../image/icon_footer/bottombtn0502.png);
        }
        
        #footer ul li.news:before {
            content: "";
            display: inline-block;
            width: .18rem;
            height: .18rem;
            background-color: #f00;
            border-radius: .2rem;
            position: absolute;
            top: .12rem;
            right: .44rem;
        }
        
        .show {
            display: block;
        }
        
        #newsCount {
            display: none;
            position: absolute;
            right: .3rem;
            top: .05rem;
            font-size: .22rem;
            width: .32rem;
            height: .32rem;
            background-color: #f00;
            border-radius: 50%;
            color: #fff;
            text-align: center;
            line-height: .32rem;
        }
        
        .addF {
            display: inline-block;
            position: absolute;
            right: 0;
            width: .39rem;
            height: .8rem;
            background: url(../image/icon_addF.png)no-repeat;
            -webkit-background-size: .39rem .3rem;
            background-size: .39rem .3rem;
            background-position: 0 center;
            float: right;
            margin-right: .28rem;
        }
    </style>
</head>

<body>
    <div id="wrap" class="flex-wrap flex-vertical">
        <header>
            <ul>
                <li class="border-b active" id="title">
                    我在
                    <!-- <span id="addFellow"   tapmode   onclick="addFellow()"></span> -->
                    <span class="rightBtn" ontouchstart="addFellow()">+</span>
                </li>
                <li class="border-b">通讯录
                    <span class="addF" tapmode onclick="addF()"></span>
                </li>
                <li class="border-b supply">
                    供求圈
                    <span class="rightBtn" tapmode onclick="addPublish();event.stopPropagation();">+</span>
                </li>
                <li class="border-b">发现</li>
                <li class="border-b">我</li>
            </ul>
        </header>
        <div id="main" class="flex-con">
        </div>
        <div id="footer" class="border-t">
            <ul class="flex-wrap">
                <li ontouchstart="randomSwitchBtn( this );" class="flex-con active "><span id="newsCount"></span>我在</li>
                <li ontouchstart="randomSwitchBtn( this );" class="flex-con ">通讯录</li>
                <li ontouchstart="randomSwitchBtn( this );" data-val='3' class="flex-con ">供求圈</li>
                <li ontouchstart="randomSwitchBtn( this );" class="flex-con">发现</li>
                <li ontouchstart="randomSwitchBtn( this );" class="flex-con">我</li>
            </ul>
        </div>
    </div>
</body>

</html>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/common.js"></script>
<script type="text/javascript" src="../script/pinyin4js.js"></script>
<script type="text/javascript">
    var userToken, rongToken, footerH, addPublishUrl = './supply/supply_addSupply.html';
    apiready = function() {
        footerH = $api.offset($api.byId('footer')).h;
        fnInit();
        // 适配iPhone X底部
        $api.fixTabBar($api.byId('footer'))
        moduleInit();
        // 注册附近的人
        LocationRegisterLocation();
        $api.fixStatusBar($api.dom('header'));
        api.setStatusBarStyle({
            style: 'light',
            color: 'rbga(0,0,0,0)'
        });
        funIniGroup();
        displaySupply();
        // 退出app
        exitApp();
        api.addEventListener({
            name: 'searchSupply'
        }, function(ret, err) {
            $api.html($api.dom('.supply'), '找供求<span   tapmode   onclick="addPublish();event.stopPropagation();"></span>');
        });
        api.addEventListener({
            name: 'clearSearchSupply'
        }, function(ret, err) {
            $api.html($api.dom('.supply'), '供求<span   tapmode   onclick="addPublish();event.stopPropagation();"></span>');
        });
        getTotalCount();
        api.addEventListener({
            name: 'historNews'
        }, function(ret, err) {
            if (ret) {
                // alert(JSON.stringify(ret));
                getTotalCount();
            } else {
                alert(JSON.stringify(err));
            }
        });
        // 打开数据库
        db.openDatabase({
            name: 'db_' + $api.getStorage('userToken')
        }, function(ret, err) {
            if (ret.status) {
                openRemarksDb()
            } else {
                alert('267:' + JSON.stringify(err.msg));
            }
        });
        // cacheData();
        api.setAppIconBadge({
            badge: 0
                // 清除角标
        });
        // 初始化极光, ios自动推送
        if (api.systemType == 'Android') {
            ajpush.init();
        }
        ajpush.getRegistrationId();
        ajpush.setListener(
            function(ret) {
                // console.log(JSON.stringify(ret))
                var id = ret.id;
                var title = ret.title;
                var content = ret.content;
                var extra = ret.extra;
            }
        );
        // 监听安卓
        api.addEventListener({
                name: 'appintent'
            }, function(ret, err) {
                if (ret && ret.appParam.ajpush) {
                    var ajpush = ret.appParam.ajpush;
                    var id = ajpush.id;
                    var title = ajpush.title;
                    var content = ajpush.content;
                    var extra = ajpush.extra; 
                    // console.log('307:::' + JSON.stringify(ret))
                        // alert('307:::'+JSON.stringify(ret))
                    if (extra.type == 2) {
                        api.openWin({
                            name: 'me_gdd_info',
                            url: './me/me_gdd_info.html',
                            pageParam: {
                                order_id: extra.reference_id
                            }
                        });
                    } else if (extra.type == 3) {
                        api.openWin({
                            name: 'me_qdd_info',
                            url: './me/me_qdd_info.html',
                            pageParam: {
                                order_id: extra.reference_id
                            }
                        });
                    } else if (extra.type == 1) {
                        api.openWin({
                            name: 'txl_addFellow_friendRequest_win',
                            url: './addressList/txl_addFellow_friendRequest_win.html',
                        });
                    }
                }
            })
            // 监听ios信息
        api.addEventListener({
                name: 'noticeclicked'
            }, function(ret, err) {
                if (ret && ret.value) {
                    var ajpush = ret.value;
                    var content = ajpush.content;
                    var extra = ajpush.extra;
                    // console.log('318::key: "苹果", ' + JSON.stringify(ret))
                    if (extra.type == 2) {
                        api.openWin({
                            name: 'me_gdd_info',
                            url: './me/me_gdd_info.html',
                            pageParam: {
                                order_id: extra.reference_id
                            }
                        });
                    } else if (extra.type == 3) {
                        api.openWin({
                            name: 'me_qdd_info',
                            url: './me/me_qdd_info.html',
                            pageParam: {
                                order_id: extra.reference_id
                            }
                        });
                    } else if (extra.type == 1) {
                        api.openWin({
                            name: 'txl_addFellow_friendRequest_win',
                            url: './addressList/txl_addFellow_friendRequest_win.html',
                        });
                    }
                }
            })
            // 监听frame2切换到圈子页面, 弹出层的按钮
        api.addEventListener({
            name: 'switch_to_the_circle_pop_up_button'
        }, function(ret, err) {
            addPublishUrl = './supply/supply_addSupply_1.html'
        });
        api.addEventListener({
            name: 'switch_to_the_supply_pop_up_button'
        }, function(ret, err) {
            addPublishUrl = './supply/supply_addSupply.html'
        });
    }


    // 通讯录添加好友
    function addF() {
        api.openWin({
            name: 'txl_addFellow_win',
            url: './addressList/txl_addFellow_win.html',
            bounces: false
        });
    }
    // 监听从收藏跳转显示供应事件
    function displaySupply() {
        api.addEventListener({
            name: 'displaySupply'
        }, function(ret, err) {
            togglesSpecifiedPage(ret.value.index)
        });
        api.addEventListener({
            name: 'displayChat'
        }, function (ret, err) {
            togglesSpecifiedPage(ret.value.index)
        });
    }
    // 切换到指定的页面
    function togglesSpecifiedPage(n) {
        api.setFrameGroupIndex({
            name: 'group',
            index: n,
            scroll: true
        });
        var eFootLis = $api.domAll('#footer li'),
            eHeaderLis = $api.domAll('header li'),
            index = 0;
        for (var i = 0, len = eFootLis.length; i < len; i++) {
            $api.removeCls(eFootLis[i], 'active');
            $api.removeCls(eHeaderLis[i], 'active');
        }
        $api.addCls(eFootLis[n], 'active');
        $api.addCls(eHeaderLis[n], 'active');
    }
    // 获取所有未读消息数
    function getTotalCount() {
        // console.log('获取所有未读消息数')
        rong.getTotalUnreadCount(function(ret, err) {
            // console.log('295:::'+JSON.stringify(ret))
            if (ret.result == 0 || !ret.result) {
                // console.log('295295消息')
                $api.html($api.byId('title'), '我在<span class="rightBtn"   tapmode   onclick="addFellow()">+</span> ');
                $api.css($api.byId('newsCount'), 'display: none');
                api.setAppIconBadge({
                    badge: ret.result
                        // 清除角标
                });
            } else {
                // console.log('重新设置消息输了1')
                api.setAppIconBadge({
                    badge: ret.result
                        // 清除角标
                });
                // console.log('重新设置消息数量2'+JSON.stringify(ret))
                if (ret.result > 0) {
                    // console.log('重新设置消息数量3'+JSON.stringify(ret))
                    $api.html($api.byId('title'), '我在(' + ret.result + ')<span class="rightBtn"   tapmode   onclick="addFellow()">+</span> ');
                    // console.log('重新设置消息数量3.1'+JSON.stringify(ret))
                    $api.css($api.byId('newsCount'), 'display: inline-block');
                    // console.log('重新设置消息数量3.2'+JSON.stringify(ret))
                    $api.html($api.byId('newsCount'), ret.result);
                    // console.log('重新设置消息数量3.3'+JSON.stringify(ret))
                } else {
                    $api.css($api.byId('newsCount'), 'display: none');
                    // console.log('重新设置消息数量3-1'+JSON.stringify(ret))

                }
            }
        })
    }

    function funIniGroup() {
        var eHeaderLis = $api.domAll('header li'),
            frames = [];
        for (var i = 0, len = eHeaderLis.length; i < len; i++) {
            // 个人中心页面不弹动
            if (i === 4 || i === 1 || i === 2 || i === 0) {
                frames.push({
                    name: 'frame' + i,
                    url: './frame' + i + '.html',
                    bgColor: 'rgba(0,0,0,.2)',
                    pageParam: {
                        userToken: userToken,
                        rongToken: rongToken,
                        headerH: headerH,
                        footerH: footerH
                    },
                    bounces: false
                })
            } else {
                frames.push({
                    name: 'frame' + i,
                    url: './frame' + i + '.html',
                    bgColor: 'rgba(0,0,0,.2)',
                    pageParam: {
                        userToken: userToken,
                        rongToken: rongToken,
                        headerH: headerH,
                        footerH: footerH
                    },
                    bounces: true
                })
            }
        }
        api.openFrameGroup({
            name: 'group',
            scrollEnabled: false,
            preload: 0,
            rect: {
                x: 0,
                y: $api.dom('header').offsetHeight,
                w: api.winWidth,
                h: api.winHeight - $api.dom('header').offsetHeight - $api.dom('#footer').offsetHeight
            },
            index: 0,
            frames: frames
        }, function(ret, err) {

        });
    }

    // 随意切换按钮
    function randomSwitchBtn(tag) {
        // console.log(11)
        if (tag == $api.dom('#footer li.active')) return;
        var eFootLis = $api.domAll('#footer li'),
            eHeaderLis = $api.domAll('header li'),
            index = 0;
        for (var i = 0, len = eFootLis.length; i < len; i++) {
            if (tag == eFootLis[i]) {
                index = i;
            } else {
                $api.removeCls(eFootLis[i], 'active');
                $api.removeCls(eHeaderLis[i], 'active');
            }
        }
        $api.addCls(eFootLis[index], 'active');
        $api.addCls(eHeaderLis[index], 'active');
        api.setFrameGroupIndex({
            name: 'group',
            index: index
        });

        if ($api.attr(tag, 'data-val') !== '3') {
            api.closeFrameGroup({
                name: 'supply_publish'
            });
        } else {
            api.sendEvent({
                name: 'openSupplyPublishr'
            });
        }
    }

    // 添加好友按钮
    function addFellow() {
        //添加时间，控制frame0页面的添加好友弹框的显示，如果在该页面写会被frame覆盖
        api.sendEvent({
            name: 'showNews',
        });
    }
    // 点击发布按钮
    function addPublish() {
        // console.log('点到加号')
        // api.sendEvent({
        //     name: 'addPublish'
        // });
        api.openFrame({
            name: 'supply_addSupply',
            url: addPublishUrl,
            rect: {
                x: 0,
                y: headerH,
                w: 'auto',
                h: 'auto'
            },
            bounces: false
        });
    }

    function openRemarksDb() {
        var SQLName = 'db_' + $api.getStorage('userToken');
        // 备注电话
        db.executeSql({
            name: SQLName,
            sql: 'CREATE TABLE IF NOT EXISTS tb_remarks_contact(list_id varchar(255) PRIMARY KEY NOT NULL,user_id int, contact_id int, phone varchar(255), type int, sub_type int, is_default int)'
        }, function(ret, err) {
            // alert('1main_ret:'+JSON.stringify(ret))
        });

        // 备注其他联系方式
        db.executeSql({
            name: SQLName,
            sql: 'CREATE TABLE IF NOT EXISTS tb_remarks_other_contact(list_id varchar(255) PRIMARY KEY NOT NULL,user_id int, contact_id int, info varchar(255), type int, sub_type int)'
        }, function(ret, err) {
            // alert('2main_ret:'+JSON.stringify(ret))
        });
        // 备注地址
        db.executeSql({
            name: SQLName,
            sql: 'CREATE TABLE IF NOT EXISTS tb_remarks_address(list_id varchar(255) PRIMARY KEY NOT NULL,user_id int, address_id int, province varchar(255), city varchar(255), district varchar(255), address varchar(255), note varchar(255))'
        }, function(ret, err) {
            // alert('3main_ret:'+JSON.stringify(ret))
        });
        // 备注内容
        // 备注学习经历
        db.executeSql({
            name: SQLName,
            sql: 'CREATE TABLE IF NOT EXISTS tb_remarks_education(list_id varchar(255) PRIMARY KEY NOT NULL,user_id int, education_id int, type int, school varchar(255), major varchar(255), degree varchar(255), description varchar(255),start_date varchar(255),end_date varchar(255))'
        }, function(ret, err) {
            // alert('4main_ret:'+JSON.stringify(ret))
        });
        // 备注工作经历
        db.executeSql({
            name: SQLName,
            sql: 'CREATE TABLE IF NOT EXISTS tb_remarks_work(list_id varchar(255) PRIMARY KEY NOT NULL,user_id int, work_id int, company_id int, company_name varchar(255), position varchar(255), description varchar(255), is_default int,start_date varchar(255),end_date varchar(255))'
        }, function(ret, err) {
            // alert('5main_ret:'+JSON.stringify(ret))
        });
        // 备注项目经历
        db.executeSql({
            name: SQLName,
            sql: 'CREATE TABLE IF NOT EXISTS tb_remarks_project(list_id varchar(255) PRIMARY KEY NOT NULL,user_id int, project_id int, name varchar(255), url varchar(255), role varchar(255), description varchar(255), achievement varchar(255),start_date varchar(255),end_date varchar(255))'
        }, function(ret, err) {
            // alert('6main_ret:'+JSON.stringify(ret))
        });
        // 个人信息表
        db.executeSql({
            name: SQLName,
            sql: 'CREATE TABLE IF NOT EXISTS tb_remarks_user_info(remark_user_id int PRIMARY KEY NOT NULL, current_position varchar(255), current_degree varchar(255), current_company varchar(255), nickname varchar(255), real_name varchar(255), birthday varchar(255), hometown varchar(255), sex int, head_img_url varchar(255), extra_id int, extra_content varchar(255), extra_image_url varchar(255))'
        }, function(ret, err) {
            if (ret.status) {
                // alert( JSON.stringify( ret ) );
            } else {
                alert('473' + JSON.stringify(err));
                //console.log('473'+ JSON.stringify( err ) );
            }
        });
        // db.executeSql({
        //      name: SQLName,
        //      sql: 'DROP TABLE tb_chat_list'
        //  }, function(ret, err){
        //      if( ret.status ){
        //          alert('1'+ JSON.stringify( ret ) );
        //      }else{
        //          alert( JSON.stringify( err ) );
        //      }
        //  });
        // 聊天列表
        db.executeSql({
            name: SQLName,
            sql: 'CREATE TABLE IF NOT EXISTS tb_chat_list(user_id int PRIMARY KEY NOT NULL, head_img_url varchar(255), remark_head_img_url varchar(255), nickname varchar(255), remark_nickname varchar(255), latestMessage_text varchar(255), receivedTime varchar(255), targetId varchar(255),unreadMessageCount int)'
        }, function(ret, err) {
            if (ret.status) {
                // alert( JSON.stringify( ret ) );
                // console.log('新建表格成功');

            } else {
                alert('473' + JSON.stringify(err));
                //console.log('473'+ JSON.stringify( err ) );
            }
        });

        // 用户当前状态表格
        db.executeSql({
            name: SQLName,
            sql: 'CREATE TABLE IF NOT EXISTS tb_remarks_status(remark_user_id int , status_id int PRIMARY KEY NOT NULL, name varchar(255), position varchar(255), degree varchar(255), start_date varchar(255), is_default int, type int)'
        }, function(ret, err) {
            if (ret.status) {
                // alert('用户当前状态表格'+ JSON.stringify( ret ) );
            } else {
                alert('473' + JSON.stringify(err));
            }
        });
        db.executeSql({
            name: SQLName,
            sql: 'CREATE TABLE IF NOT EXISTS addressList_simplify(user_id int PRIMARY KEY NOT NULL, title varchar(255),img varchar(255), subTitle varchar(255), current_contact varchar(255), flag varchar(255), type int)'
        }, function(ret, err) {
            if (ret.status) {
                db.executeSql({
                    name: 'db_' + $api.getStorage('userToken'),
                    sql: 'CREATE INDEX  IF NOT EXISTS  type_idx ON addressList_simplify (type);'
                }, function(ret, err) {
                    if (ret.status) {
                        db.executeSql({
                            name: 'db_' + $api.getStorage('userToken'),
                            sql: 'CREATE INDEX  IF NOT EXISTS  flag_idx ON addressList_simplify (flag);'
                        }, function(ret, err) {
                            if (ret.status) {
                                //    synchronousAddressBook();
                            } else {
                                alert(JSON.stringify(err));
                            }
                        });
                    } else {
                        alert(JSON.stringify(err));
                    }
                });
            } else {
                // 报错addressList_simplify 已经存在
            }
        });

        // db.executeSql({
        //     name: SQLName,
        //     sql: 'DROP TABLE addressList_one'
        // }, function(ret, err){
        //     if( ret.status ){
        //         alert('2'+ JSON.stringify( ret ) );
        //     }else{
        //         alert( JSON.stringify( err ) );
        //     }
        // });
    }

    function synchronousAddressBook() {
        // console.log('synchronousAddressBook')
        setTimeout(function() {
            contacts.queryByPage({
                pageIndex: 0
            }, function(ret, err) {
                if (ret.status) {
                    api.ajax({
                        url: apiSite + '/contact/sync',
                        method: 'post',
                        headers: apiHeader,
                        data: {
                            values: {
                                token: $api.getStorage('userToken'),
                                contact_json: ret
                            }
                        }
                    }, function(ret, err) {
                        // 同步通讯录成功
                        if (ret) {
                            // 请求同步的数据，存到本地数据库
                            if (ret.code == 200) {
                                requestData();
                            } else {
                                alert(ret.msg)
                            }
                        } else {
                            // alert(JSON.stringify(err.msg))
                        }
                    })
                } else {
                    api.toast({
                        msg: '请在系统的设置-隐私-通讯录界面允许我在访问您的通讯录'
                    });
                }
            });
        }, 100)
    }
    // 请求数据
    function requestData() {
        // console.log('请求数据')
        api.ajax({
            url: apiSite + '/contact/index',
            method: 'post',
            headers: apiHeader,
            data: {
                values: {
                    token: $api.getStorage('userToken'),
                }
            }
        }, function(ret, err) {
            api.ajax({
                url: apiSite + '/contact/friend',
                method: 'post',
                headers: apiHeader,
                data: {
                    values: {
                        token: $api.getStorage('userToken'),
                    }
                }
            }, function(retFriend, err) {
                if (retFriend) {
                    if (retFriend.code == 200) {
                        disData(ret.data.friend_list.concat(retFriend.data.list), 4)
                    } else {
                        alert(retFriend.msg)
                    }
                } else {
                    // alert(JSON.stringify(err))
                }
            })
            disData(ret.data.single_list, 1)
            disData(ret.data.both_list, 2)
            disData(ret.data.unavailable_list, 3)
        })

    }

    function disData(data, type) {
        // console.log('disData'+type)
        // console.log('disData'+data)
        if (data != '') {
            for (var i = 0; i < data.length; i++) {
                // single_list
                // both_list
                // friend_list
                // 去除空格
                data[i].nickname = $api.trimAll(data[i].nickname)
                if (data[i].remark_nickname) {
                    data[i].litter = PinyinHelper.getShortPinyin(data[i].remark_nickname).toUpperCase();
                } else {
                    data[i].litter = PinyinHelper.getShortPinyin(data[i].nickname).toUpperCase();
                }
                // data[i].litter = PinyinHelper.getShortPinyin(data[i].nickname).toUpperCase();
                data[i].title = data[i].nickname;
                data[i].img = data[i].head_img_url;
                data[i].titleSize = 15;
                if (data[i].current_position == null) {
                    data[i].current_position = '';
                }
                if (data[i].current_company == null) {
                    data[i].current_company = '';
                }
            }
            // 模块数据格式
            litterSort(data, type)
                // sqlSyntax(initialData);
        }
    }
    // 排序
    function litterSort(data, type) {
        for (var i = 0; i < data.length; i++) {
            for (var j = 0; j < data.length; j++) {
                if (data[i].litter < data[j].litter) {
                    var temp = data[i];
                    data[i] = data[j];
                    data[j] = temp;
                }
            }
        }
        sqlSyntax(data, type);
    }
    // 拼数据库语法字符串
    function sqlSyntax(data1, type) {
        // console.log('数据库'+ type)
        // console.log('数据库'+ data1)
        for (var i = 0; i < data1.length; i++) {
            data1[i].flag = data1[i].litter[0];
        }
        // console.log('数据库语法字符串:'+data1);
        var SQLName = 'db_' + $api.getStorage('userToken');
        var SQL = 'INSERT OR REPLACE INTO addressList(user_id,nickname,real_name,head_img_url,current_company,current_position,current_contact,current_degree, titleSize,title,img,flag,litter,type, sex, remark_nickname, remark_real_name, remark_head_img_url, remark_sex, remark_birthday, remark_hometown, remark_current_company, remark_current_position, remark_current_degree, remark_current_contact) VALUES '

        var SQL2 = 'INSERT OR REPLACE INTO addressList_simplify(user_id,title,img,subTitle,current_contact, flag,type) VALUES ';
        for (var i = 0; i < data1.length; i++) {
            var subTitleStr = '',
                contactStr = '';
            SQL += '(' + data1[i].user_id + ',"' + data1[i].nickname + '","' + data1[i].head_img_url + '","' + (data1[i].current_company || "") + '","' + (data1[i].current_position || "") + '","' + (data1[i].current_contact || "") + '","' + (data1[i].current_degree || "") + '","' + data1[i].titleSize + '","' + data1[i].title + '","' + data1[i].img + '","' + data1[i].flag + '","' + data1[i].litter + '","' + type + '","' + (data1[i].sex || 1) + '","' + (data1[i].remark_nickname || "") + '","' + (data1[i].remark_real_name || "") + '","' + (data1[i].remark_head_img_url || "") + '","' + (data1[i].remark_sex || "") + '","' + (data1[i].remark_birthday || "") + '","' + (data1[i].remark_hometown || "") + '","' + (data1[i].remark_current_company || "") + '","' + (data1[i].remark_current_position || "") + '","' + (data1[i].remark_current_degree || "") + '","' + (data1[i].remark_current_contact || "") + '"),';
            if (data1[i].remark_current_company) {
                subTitleStr += data1[i].remark_current_company + " "
            } else if (data1[i].current_company) {
                subTitleStr += data1[i].current_company + " "
            } else {

            }
            if (data1[i].remark_current_position) {
                subTitleStr += data1[i].remark_current_position + " "
            } else if (data1[i].current_position) {
                subTitleStr += data1[i].current_position + " "
            } else {

            }
            if (data1[i].remark_current_degree) {
                subTitleStr += data1[i].remark_current_degree + " "
            } else if (data1[i].current_degree) {
                subTitleStr += data1[i].current_degree + " "
            } else {

            }
            if (data1[i].remark_current_contact) {
                contactStr = data1[i].remark_current_contact;
            } else if (data1[i].current_contact) {
                contactStr = data1[i].current_contact
            } else {

            }
            // subTitleStr
            SQL2 += '(' + data1[i].user_id + ',"' + (data1[i].remark_nickname || data1[i].nickname) + '","' + (data1[i].remark_head_img_url || data1[i].head_img_url) + '","' + subTitleStr + '","' + contactStr + '","' + data1[i].flag + '","' + type + '"),';
        }
        SQL2 = SQL2.substring(0, SQL2.length - 1) + ';'
            // console.log(SQL)
        db.executeSql({
            name: SQLName,
            sql: SQL2
        }, function(ret, err) {
            if (ret.status) {

            } else {
                //console.log('执行语句错误:' + JSON.stringify(err))
            }
        });

    }
    // 附近的人注册位置信息
    function LocationRegisterLocation() {
        bMap.getLocationServices(function (ret, err) {
            if (ret.enable) {
                var lat,lon,address;
                bMap.getLocation({
                    accuracy: '100m',//10m/100m/1km/3km
                    autoStop: true,
                    filter: 1
                }, function(ret, err){
                    if(ret.status){
                        // alert(JSON.stringify(ret));
                        lon = ret.lon;
                        lat = ret.lat;
                        bMap.getNameFromCoords({
                            lon: lon,
                            lat: lat
                        },function(ret,err){
                            if(ret.status){
                                // alert(JSON.stringify(ret));
                                address = ret.address;
                                if ($api.getStorage('LocationRegisterLocation')) {
                                } else {
                                    // 未注册过
                                    api.ajax({
                                        url: apiSite + '/location/registerLocation',
                                        method: 'post',
                                        headers: apiHeader,
                                        data: {
                                            values: {
                                                token: $api.getStorage('userToken'),
                                                latitude: lat,
                                                longitude: lon,
                                                address: address
                                            }
                                        }
                                    }, function(ret, err) {
                                        if(ret) {
                                            if (ret.code === 200) {
                                                $api.setStorage('LocationRegisterLocation', 'true');
                                            } else {
                                                alert(ret.msg)
                                            }
                                        } else {
                                            alert(err.msg)
                                        }
                                    })
                                }
                            }
                        });
                    }else{
                        if (err.code == 62) {
                            api.toast({
                                msg: '请在系统权限中打开我在定位权限',
                                duration: 2000,
                                location: 'bottom'
                            });
                        }
                    }
                });
            } else {
                console.log("未开启定位功能！");
            }
        });
    }
</script>