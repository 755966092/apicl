<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
        body,html{
            background-color: #EDECF3;
            position: relative;
        }
        body {
            margin-bottom: 1.2rem;
        }
        footer {

            position: fixed;
            bottom: 0;
            right: 0;
           
            background-color: #fff;
            height: 1rem;
            line-height: 1rem;
            font-size: 0;
            width: 7.5rem;
        }
        footer div {
            font-size: 0;
            width: 50%;
            text-align: center;
        }
        footer .selRole .text {
            font-size: .34rem;
        }
        footer .selRole .icon {
            width: .28rem;
            height: .17rem; 
            background: url(../../image/icon_find/icon_arrow.png)no-repeat;
            background-size: .28rem .17rem;
            margin-left: .1rem;
            
        }
        footer .selRole .icon3 {
            animation: myfirst1 0.5s;
            animation-fill-mode: forwards;
        }
        footer .selRole .icon2 {
            /*transform: rotate(180deg);*/
            animation: myfirst 0.5s;
            animation-fill-mode: forwards;
        }
        @keyframes myfirst{
            from {transform: rotate(0deg);}
            to {transform: rotate(180deg);}
        }
        @keyframes myfirst1{
            from {transform: rotate(180deg);}
            to {transform: rotate(0deg);}
        }
        footer .collect {
            background-color: #08B508;
            color: #fff;
        }
        footer .collect .icon {
            width: .38rem;
            height: .33rem; 
            background: url(../../image/icon_find/icon_collect.png)no-repeat;
            background-size: .38rem .33rem;
            margin-right: .1rem;
              
        }
        footer .collect .text {
            font-size: .34rem;
        }
        .statePersonInfo {
            margin-top: .3rem;
            margin-bottom: .2rem;
            box-sizing: border-box;
            padding: 0 .3rem;
            font-size: 0;   
            height: 1rem;
            background-color: #fff;
        }
        .statePersonInfo .name {
            font-size: 0;   

        }
        .statePersonInfo .name h3 {
            font-size: .3rem;
        }
        .statePersonInfo .company {
            font-size: .24rem;
            color: #999;
        }
        .statePersonInfo img {
            margin-right: .2rem;
            width: .7rem;
            height: .7rem;
        }
         .label {
            /*width: .74rem;*/
            padding: 0 .06rem;
            font-size: .2rem;

            color: #5D7099;
            text-align: center;
            line-height: .28rem;
            border: 1px solid #5D7099;
            border-radius: .06rem;
            height: .28rem;
            /*background: url(../../image/icon_find/icon_label.png)no-repeat;
            -webkit-background-size: .63rem .28rem;
            background-size: .63rem .28rem;*/

        }
        .content {
            font-size: 0;
            text-align: center;
            /*height: 3.77rem;*/
            background-color: #fff;
            width: 7.5rem;
            box-sizing: border-box;
        }
        .content .wrap {
            width: 100%;
            box-sizing: border-box;
        }
        .content .xqText {
            font-size: .34rem;
            margin-right: .2rem;
        }
        .content .line {
            width: .97rem;
            height: .03rem;
            background-color: #999;
        }
        .content .imgIcon {
            width: .34rem;
            height: .29rem;
            background: url(../../image/icon_supply/icon_init.png)no-repeat;
            -webkit-background-size: .34rem .29rem;
            background-size: .34rem .29rem;
            margin: 0 .2rem;
        }
        .content h3 {
            font-size: .34rem;
            color: #555;
            margin-top: .17rem;
        }
        .content .textContent {
            box-sizing: border-box;
            width: 100%;
            max-height: 1.54rem;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: .28rem;
            color: #555;
            text-align: left;
            padding: 0 .35rem;
            margin-top: .2rem;
        }
        .content .wrap img {
            width: 6.9rem;
            margin: .1rem;
        }
        .content .time {
            font-size: .24rem;
            color: #737373;
            float: right;
            padding-right: .35rem;
            margin-bottom: .13rem;
        }
        .content .next {
            font-size: .24rem;
            color: #fff;
            background-color: #08B508;
            width: 1.28rem;
            position: relative;
            line-height: .3rem;
        }
        .content .next:after {
            content: '';
            display: inline-block;
            width: 0rem;
            height: 0rem;
            background-color: #fff;
            top: 0;
            right: 0;
            border-top: .15rem solid #08B508;
            border-right: .1rem solid transparent;
            border-bottom: .15rem solid #08B508;
            position: absolute;
        }
        .startEndTime {
            box-sizing: border-box;
            width: 7.5rem;
            font-size: 0;
            height: .797rem;
            background-color: #fff;
            padding-left: .3rem;
            padding-right: .35rem;
            line-height: .797rem;
            margin: .2rem 0;
        }
        .startEndTime span {
            font-size: .3rem;
        }
        .startEndTime .zkIcon {
            float: right;
            background: url(../../image/icon_zk.png)no-repeat;
            width: .15rem;
            height: .797rem;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: 0 center;
        }
        
        .discussContent img {
            width: .78rem;
            height: .78rem;

        }
        .discussContent .img {
            height: 100%;
            width: .78rem;
            margin-right: .15rem;
        }
        .discussContent {

            /*height: 1.37rem;*/
            background-color: #fff;
            font-size: 0;
            box-sizing: border-box;
            padding: .27rem .35rem .2rem;
        }
        .discussContent .fl {
            font-size: 0;
        }
        .discussName {
            font-size: .3rem;
            color: #5D7099;
            margin-right: .1rem;
        }
        .discussTime {
            font-size: .24rem;
            color: #999;
        } 
        .discussText {
            font-size: .28rem;
            /*white-space: nowrap;*/
            overflow: hidden;
            text-overflow: ellipsis;
            color: #000;
        }
        .discussTitle {
            margin-bottom: .15rem;
        }
        .shadow {
            position: fixed;
            top: 0;
            left: 0;
            width: 7.5rem;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            
        }
        .dn {
            display: none;
        }
        .warring {
            width: 5.07rem;
            height: 3.36rem;
            background-color: #fff;
            border-radius: .1rem;
            text-align: center;
            box-sizing: border-box;
            padding-top: .45rem;
        }
        .warring h3 {
            font-size: .32rem;
            line-height: .6rem;
        }
        .warring p {
            font-size: .24rem;
            line-height: .6rem;
        }
        .warring .btn {
            margin: .35rem auto 0;
            border-radius: .1rem;
            background-color: #1AAD19;
            width: 4.52rem;
            height: .8rem;
            line-height: .8rem;
            color: #fff;
            font-size: .32rem;
        }
        .selRoleList {
            position: fixed;
            bottom: 1rem;
            left: 0;
            background-color: #fff;
            width: 7.5rem;
            padding-left: .3rem;
            display: none;
        }
        .selRoleList ul {
            font-size: 0;
        }
        .selRoleList ul li {
            font-size: .28rem;
            line-height: .8rem;
            border-bottom: 1px solid #D9D9D9;
            box-sizing: border-box;
        }
        .selRoleList ul li:Last-child {
            border: 0;
        }
        .resultList {

        }
    </style>
</head>
<body>
    <div class="resultList"></div>
    <script type="text/x-dot-template" id="listT">
            <div class="statePersonInfo flex-def flex-cCenter ">
                <img class="headImg" src="{{=it.info.user_info.head_img_url}}" alt="">
                <div class="text flex-item">
                    <div class="name flex-def flex-zBetween">
                        <h3>{{=it.info.user_info.nickname}}</h3>
                        <span class="label">{{=it.info.topic_info.role}}</span>
                    </div>
                    {{?it.info.user_info.current_company && it.info.user_info.current_position==null}}
                    <p class="company">{{=it.info.user_info.current_company}} }}</p>
                    {{??it.info.user_info.current_position && it.info.user_info.current_company==null}}
                    <p class="company">{{=it.info.user_info.current_position}}</p>
                    {{??it.info.user_info.current_position==null && it.info.user_info.current_company==null}}
                    <!-- <p class="company">{{=it.info.user_info.current_position}}</p> -->
                    {{??}}
                    <p class="company">{{=it.info.user_info.current_company}} {{=it.info.user_info.current_position}}</p>
                    {{?}}
                </div>
            </div>
            <div class="content flex-def flex-zBetween flex-zTopBottom flex-cEnd">
                <div class="wrap">
                    <p class="next">即将开始</p>
                    <div class="flex-def flex-cCenter flex-zCenter">
                        <span class="line"></span>
                        <span class="imgIcon"></span>
                        <span class="xqText">详情</span>
                        <span class="line"></span>
                    </div>
                    <h3>{{=it.info.topic_info.title}}</h3>
                    <p class="textContent">{{=it.info.topic_info.content}}</p>
                    {{?it.info.topic_info.image_json!=null}}
                        {{ for(var i=0; i< it.info.topic_info.image_json.length; i++){ }}
                            <img src="{{=it.info.topic_info.image_json[i]}}">
                        {{ }; }}
                    {{?}}
                </div>
                <p class="time">{{=it.info.topic_info.create_time}}</p>
            </div>
            <div class="startEndTime ">
                <span>起止时间</span>
                <span class="zkIcon"></span>
            </div>
            <div class="discuss">
                <div class="startEndTime ">
                    <span>评论（{{=it.commmentLength}}）</span>
                    <span class="zkIcon"></span>
                </div>
                {{ for(var i = 0; i < it.list.length; i++){ }}
                    <div class="discussContent flex-def ">
                        <div class="img flex-def flex-cStart">
                            <img src="../../image/tx_4.jpg">
                        </div>
                        <div class="flex-item">
                            <div class="discussTitle flex-def flex-zBetween flex-cCenter">
                                <div>
                                    <span class="discussName">{{=it.list[i].nickname}}</span>
                                    <span class="label">{{=it.list[i].role}}</span>
                                </div>
                                <span class="discussTime">{{=it.list[i].create_time}}</span>
                            </div>
                            <p class="discussText">{{=it.list[i].content}}</p>
                        </div>
                    </div>
                {{ }; }}
            </div>
    </script>
   <div class="selRoleList">
       <ul>
           <li ontouchstart="selRoleList(this)">关系人</li>
           <li ontouchstart="selRoleList(this)">知情人</li>
           <li ontouchstart="selRoleList(this)">甲方</li>
           <li ontouchstart="selRoleList(this)">总包单位</li>
           <li ontouchstart="selRoleList(this)">分包单位</li>
           <li ontouchstart="selRoleList(this)">设计院</li>
           <li ontouchstart="selRoleList(this)">销售</li>
       </ul>
   </div>
    <footer class="flex-def">
        <div class="selRole" ontouchstart="selRole()">
            <span class="text" id='role' >选择角色</span>
            <span class="icon"></span>
        </div>
        <div class="collect">
            <span class="icon"></span>
            <span class="text" tapmode="hover" onclick="openShadow()">收藏</span>
        </div>
    </footer>
    <div class="shadow dn flex-def flex-cCenter flex-zCenter">
        <div class="warring">
            <h3>您还没有选择项目角色</h3>
            <p>请先选择项目角色后才能收藏</p>
            <div class="btn">去选角色</div>
        </div>
    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript">
    var role = ['关系人','知情人','甲方','总包单位','分包单位','设计院','销售']
    apiready = function(){
        moduleInit();
       
        requestData();
    };
    // 获取数据
    function requestData() {
        
        api.ajax({
            url: apiSite + '/api/circle_topic/detail',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: { 
                       token: $api.getStorage('userToken'),
                       topic_id: api.pageParam.topic_id
                   }
            }
        }, function(ret, err) {
            if(ret) {
                // alert(JSON.stringify(ret))
                if (!ret.data.is_collect) {
                     $api.css($api.dom('footer'), ' display: -webkit-box; display: flex;');
                } else {
                    chatTools();
                    $api.css($api.dom('footer'), ' display:none;');
                }
                var count=0;
                ret.data.info.topic_info.role = role[ret.data.info.topic_info.role]
                for (var i = 0; i < ret.data.list.length; i++) {
                    if (ret.data.list[i].root == 1) {
                        count++;
                    }
                    ret.data.list[i].role = role[ret.data.list[i].role]

                }

                ret.data.commmentLength = count;
                console.log(JSON.stringify(ret.data))
                ret.data.info.topic_info.image_json = eval(ret.data.info.topic_info.image_json)
                getData(ret.data)
            } else {
                alert(JSON.stringify(err))
            }
        })
    }
    // 收藏
    function openShadow() {
        var val = $api.text($api.byId('role')), valId=1;
        if ( val == '选择角色') {
            $api.removeCls($api.dom('.shadow'), 'dn');
        } else {
            for (var i = 0; i < role.length; i++) {
                if (val == role[i]) {
                    valId = i+1;
                    break;
                }
            }
            api.ajax({
                url: apiSite + '/api/circle_topic/collect',
                method: 'post',
                headers: apiHeader,
                data: {
                       values: { 
                           token: $api.getStorage('userToken'),
                           topic_id: api.pageParam.topic_id,
                           role: valId
                       }
                }
            }, function(ret, err) { 
                if(ret) {
                    // 收藏成功
                    requestData();
                } else {
                    alert(JSON.stringify(err))
                }
            })
        }

    }
    // 评论输入框
    function chatTools() {
        UIChatBox.open({
            placeholder: '请输入内容',
            maxRows: 6,
            emotionPath: 'widget://res/img/emotion',
            texts: {
                sendBtn: {
                    title: '发送'
                }
            },
            styles: {
                inputBar: {
                    borderColor: '#d9d9d9',
                    bgColor: '#f2f2f2'
                },
                inputBox: {
                    borderColor: '#B3B3B3',
                    bgColor: '#FFFFFF'
                },
                emotionBtn: {
                    normalImg: 'widget://image/chatPage/face1.png'
                },
               
                keyboardBtn: {
                    normalImg: 'widget://image/chatPage/key1.png'
                },
                recordBtn: {
                    normalBg: '#c4c4c4',
                    activeBg: '#999999',
                    color: '#000',
                    size: 14
                },
                indicator: {
                    target: 'both',
                    color: '#c4c4c4',
                    activeColor: '#9e9e9e'
                },
                sendBtn: {
                    titleColor: '#fff',
                    bg: '#4cc518',
                    activeBg: '#46a91e',
                    titleSize: 14
                }
            }
        }, function(ret, err) {
            if (ret) {
                if (ret.eventType === 'send') {
                    UIChatBox.closeKeyboard();
                    
                    //  //设置输入框的值
                    UIChatBox.value({
                        msg: ret.msg
                    });
                    api.openFrame({
                        name: 'find_discussType',
                        url: './find_discussType.html',
                        bounces: false,
                        rect: {
                            x: 0,
                            y: 0,
                            w: api.winWidth,
                            h: api.winHeight
                        },
                        pageParam: {
                            content: ret.msg,
                            topic_id: api.pageParam.topic_id,
                            rootCount: 1

                        }
                    });
                }
            } else {
                alert(JSON.stringify(err))
            }
        });
    }

    // 选择角色
    function selRole() {
        $api.css($api.dom('.selRoleList'), 'display:block');
        $api.addCls($api.dom('.selRole .icon'), 'icon2');
    }
    // 
    function selRoleList(ele) {
        var val = $api.text(ele);
        $api.text($api.byId('role'), val);
        $api.css($api.dom('.selRoleList'), 'display:none');
        $api.removeCls($api.dom('.selRole .icon'), 'icon2');
        $api.addCls($api.dom('.selRole .icon'), 'icon3');
    }
</script>
</html>