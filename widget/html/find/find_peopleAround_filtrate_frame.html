<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
        ul {
            margin-top: .36rem;
            background-color: #fff;

            border-bottom: .01rem solid #d9d9d9;
            padding-left: .36rem;
        }
       /* li .wrap {
            height: .79rem;
            padding-right: .36rem;
        }*/
       /* li .borderBottom {
            border-bottom: 0;
        }
        */
        li:last-child {
            border-bottom: 0;
        }
        li {
            height: .8rem;
            font-size: 0;
            background-color: #fff;
            border-bottom: .01rem solid #d9d9d9;
            box-sizing: border-box;
            padding-right: .36rem;
        }
        li .title {
            font-size: .3rem;
        }
        li .relation {
            font-size: .3rem;
            color: #999;
            padding-right: .16rem;
        }
        li .icon {
            display: inline-block;
            width: .15rem;
            height: .8rem;
            background: url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: 0 center;
        }
    </style>
</head>
<body>
    <div class="main">

          <ul >
            <!-- <li tapmode onclick="selType(this, 1)" class=" flex-def flex-cCenter flex-zBetween" >
                <span class="title">关系</span>
                <div class="flex-def flex-zEnd flex-cCenter flex-item">
                    <span class="relation">一度人脉</span>
                    <span class="icon"></span>
                </div>
            </li> -->
            <li tapmode onclick="selType(this, 2)" class=" flex-def flex-cCenter flex-zBetween">
                <span class="title">性别</span>
                <div class="flex-def flex-zEnd flex-cCenter flex-item">
                    <span class="relation" id="sex">女生</span>
                    <span class="icon"></span>
                </div>
            </li>
            <li tapmode onclick="selType(this, 3)" class=" flex-def flex-cCenter flex-zBetween">
                <span class="title">家乡</span>
                <div class="flex-def flex-zEnd flex-cCenter flex-item">
                    <span class="relation" id="hometown" >北京-东城区</span>
                    <span class="icon"></span>
                </div>
            </li>
            <li tapmode onclick="selType(this, 4)" class=" flex-def flex-cCenter flex-zBetween">
                <span class="title">年龄</span>
                <div class="flex-def flex-zEnd flex-cCenter flex-item">
                    <span class="relation" id="age">不限</span>
                    <span class="icon"></span>
                </div>
            </li>
        </ul>
    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../data/city_3.js"></script>
<script type="text/javascript">
    apiready = function(){
        moduleInit();
        // 监听点击完成按钮事件
        eventMonitoring('CompleteTheScreeningOfNearbyPeople');
        if (api.pageParam.paramFlitrate) {
            // 有初识条件
            settingParam();
        }
    };
    // 设置初识筛选条件
    function settingParam() {
        var param = api.pageParam.paramFlitrate.filterParameters;
        console.log(JSON.stringify(param))
        // {"filterParameters":{"sex":2,"hometown":"北京-东城区","start_age":null,"end_age":null}}
        var sexText = $api.byId('sex');
        if (param.sex == 1) {
            $api.text(sexText, '男生');
        } else if (param.sex == 2) {
            $api.text(sexText, '女生');
        } else {
            $api.text(sexText, '不限');
        }
        $api.text($api.byId('hometown'), param.hometown);
        var ageText = $api.byId('age');
        if (param.start_age == 1) {
            $api.text(ageText, '18岁以下');
            $api.attr(ageText, 'startAge', '1');
            $api.attr(ageText, 'endAge', '17');
        } else if (param.start_age == 18) {
            $api.text(ageText, '18-22岁');
            $api.attr(ageText, 'startAge', '18');
            $api.attr(ageText, 'endAge', '22');
        } else if (param.start_age == 23) {
            $api.text(ageText, '23-26岁');
            $api.attr(ageText, 'startAge', '18');
            $api.attr(ageText, 'endAge', '22');
        } else if (param.start_age == 27) {
            $api.text(ageText, '27-35岁');
            $api.attr(ageText, 'startAge', '27');
            $api.attr(ageText, 'endAge', '35');
        } else if (param.start_age == 35) {
            $api.text(ageText, '35岁以上');
            $api.attr(ageText, 'startAge', '35');
            $api.attr(ageText, 'endAge', '999');
        } else {
            $api.text(ageText, '不限');

        }
    }
    // 事件监听
    function eventMonitoring(eventName) {
        api.addEventListener({
            name: eventName
        }, function(ret, err) {
            if (ret) {
                submitData();
            } else {
                alert(JSON.stringify(err));
            }
        });
    }
    // 提交数据
    function submitData () {
        var paramElement = $api.domAll('.relation');
        var paramArr = {
            sex:'',
            hometown:'',
            start_age:'',
            end_age:'',
        };
            paramArr.sex = $api.text(paramElement[0])=='男生'?1:($api.text(paramElement[0])=='女生'?2:"");
            paramArr.hometown = $api.text(paramElement[1]);
            paramArr.start_age = $api.attr(paramElement[2],'startAge');
            paramArr.end_age = $api.attr(paramElement[2],'endAge');
            console.log(JSON.stringify(paramArr))
        api.sendEvent({
            name: 'ScreeningIsComplete',
            extra: {
                filterParameters: paramArr
            }
        });
        api.closeWin();
    }
    function selType(ele, n) {
        // 1 关系
        // 2 性别
        // 3 家乡
        // 4 年龄
        var data, dataArr = [],col = 1;
        var active = [];
        var text = $api.text($api.dom(ele, '.relation'));
        if (n === 1) {
            data = [
                {
                    name: '一度人脉'
                },{
                    name: '二度人脉'
                },{
                    name: '三度人脉'
                },{
                    name: '四度人脉'
                },{
                    name: '五度人脉'
                },{
                    name: '六度人脉'
                },{
                    name: '平台好友'
                },{
                    name: '无关系'
                },{
                    name: '不限'
                },
            ];
            dataArr = ['一度人脉','二度人脉','三度人脉','四度人脉','五度人脉','六度人脉','平台好友','无关系','不限'];
            if (dataArr.indexOf(text) == -1) {
                active = [1]
            } else {
                active.push(dataArr.indexOf(text))
            }
        } else if (n === 2) {
            data = [
                {
                    name: '男生'
                },
                {
                    name: '女生'
                },
                {
                    name: '不限'
                }
            ];
            dataArr = ['男生', '女生','不限'];
            if (dataArr.indexOf(text) == -1) {
                active = [1]
            } else {
                active.push(dataArr.indexOf(text))
            }
        } else if (n === 3) {
            col = 2;

            data = city;
            data.unshift({
                  name: "不限",
                  sub: [{
                    name: "不限"
                  }]
              })
            var selText1 = text.split('-')
            for (var i = 0; i < data.length; i++) {
                if (data[i].name == selText1[0]) {
                    active.push(i);
                    for (var j = 0; j < data[i].sub.length; j++) {
                        if (data[i].sub[j].name == selText1[1]) {
                            active.push(j);
                            break;
                        }
                    }
                    break;
                }
            }
        } else  {
            data = [
                {
                    name: '不限'
                },{
                    name: '18岁以下',
                    startAge: '1',
                    endAge: '17'
                },{
                    name: '18-22岁',
                    startAge: '18',
                    endAge: '22'
                },{
                    name: '23-26岁',
                    startAge: '23',
                    endAge: '26'
                },{
                    name: '27-35岁',
                    startAge: '27',
                    endAge: '35'
                },{
                    name: '35岁以上',
                    startAge: '35',
                    endAge: '1000'
                },
            ];
            dataArr = ['不限', '18岁以下','18-22岁','23-26岁','27-35岁','35岁以上'];
            if (dataArr.indexOf(text) == -1) {
                active = [1]
            } else {
                active.push(dataArr.indexOf(text))
            }
        }

        var fontsize = 16,rowLength = 5;
        if (api.systemType === 'ios') {
            fontsize = 20;
            rowLength = 7;
        }
        UIActionSelector.open({
            datas: data,
            actives: active,
            layout: {
                row: rowLength,
                col: col,
                height: 30,
                size: fontsize,
                sizeActive: fontsize+2,
                rowSpacing: 5,
                colSpacing: 5,
                maskBg: 'rgba(0,0,0,0.5)',
                bg: '#fff',
                color: '#888',
                colorSelected: '#000'
            },
            animation: true,
            cancel: {
                text: '取消',
                size: 16,
                w: 60,
                h: 40,
                bg: '#eee',
                // bgActive: '#ccc',
                color: '#000',
                // colorActive: '#fff'
            },
            ok: {
                text: '完成',
                size: 16,
                w: 60,
                h: 40,
                bg: '#eee',
                // bgActive: '#ccc',
                color: '#000',
                // colorActive: '#fff'
            },
            title: {
                text: '请选择',
                size: 20,
                h: 40,
                bg: '#F0F0F0',
                color: '#000'
            },
            fixedOn: api.frameName
        }, function(ret, err) {
            if (ret) {
                if (ret.eventType == 'ok') {
                    // 编辑性别
                    if (n === 3) {
                        $api.text($api.dom(ele, '.relation'), ret.level1 + '-' + ret.level2);
                    } else if(n === 4) {
                        $api.text($api.dom(ele, '.relation'), ret.level1);
                        if (ret.selectedInfo[0].startAge) {
                            $api.attr($api.dom(ele, '.relation'), 'startAge', ret.selectedInfo[0].startAge);
                            $api.attr($api.dom(ele, '.relation'), 'endAge', ret.selectedInfo[0].endAge);
                        }
                    } else {
                        $api.text($api.dom(ele, '.relation'), ret.level1);
                    }

                }
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }

</script>
</html>