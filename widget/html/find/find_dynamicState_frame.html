<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
        .no_data {
            text-align: center;
            line-height: .5rem;
            color: #999;
            font-size: .3rem;
        }
        body,html{
            height: 100%;
        }
        body {
            padding-top: .2rem;
            box-sizing: border-box;
        }
       .search {
            height: .5rem;
            line-height: .5rem;
            background-color: #fff;
            margin: 0 .3rem .2rem;
            text-align: center;
            font-size: 0;
            color: #96969B;

        }
        .search .searchIcon {
            display: inline-block;
            width: .26rem;
            height: .5rem;
            background: url(../../image/icon_supply/icon_search.png)no-repeat;
            -webkit-background-size: .25rem .26rem;
            background-size: .25rem .26rem;
            background-position: 0 center;
            vertical-align: top;
        }
        .search .searchText {
            font-size: .24rem;
        }

        .list {
            box-sizing: border-box;
            width: 100%;
            font-size: 0;
            background-color: #fff;
            padding: .2rem .3rem;
            border-bottom: .01rem solid #e7e7e7;
            /*margin-bottom: .2rem;*/

            /* 定义flex */
            display: -webkit-box;
            display: flex;

             /*侧轴对齐方式 */
            -webkit-box-align: start ;
            align-items: flex-start;

             /*主轴对齐方式 */


             /*主轴方向 */
            -webkit-box-direction: normal;
            flex-direction: row;

        }
        .list .img img {
            width: .78rem;
            height: .78rem;

        }
        .list .text {
            /* 子元素是否伸缩 */
            -webkit-box-flex: 1.0;
            flex-grow: 1;
            box-sizing: border-box;
            margin-left: .2rem;

        }
        .list .text .title {


            box-sizing: border-box;
            position: relative;

            display: -webkit-box;
            display: flex;
            box-sizing: border-box;
            /*主轴方向 */
            -webkit-box-direction: normal;
            flex-direction: row;

            -webkit-box-align: center ;
            -webkit-align-items: center;
            align-items: center;
        }
        .list .text .title h3 {
            font-weight: 700;
            font-size: .26rem;
            color: #333;
            margin-bottom: .05rem;
            /*line-height: .24rem;*/
            margin-right: .1rem;
        }
        .list .text .title .state {
            font-size: .24rem;
            color: #0ABB07;
            position: absolute;
            right: 0;
            top: 0;
        }
        .list .text .title .titleLable {
            font-size: .2rem;
            color: #5D7099;
            text-align: center;
            border: .01rem solid #5D7099;
            border-radius: .06rem;

            margin-left: .02rem;
        }
        .list .text .stateContent {
            font-size: .24rem;
            color: #333;
            /*margin-top: .2rem;*/
        }
        .list .text .stateTime {
            margin-top: .1rem;
        }
        .list .text .stateTime .timeInfo {
            font-size: .2rem;
            color: #999;
        }
        .list .text .stateTime .discussIcon {
            width: .34rem;
            height: .32rem;
            background:url(../../image/icon_supply/icon_comment.png)no-repeat;
            background-size: .34rem .26rem;
            background-position: 0 center;
            float: right;
        }
        .list .text .discussInfo {
            background-color: #F3F3F5;
            padding: .1rem;
            position: relative;
            margin-top: .15rem;
        }

        .list .text .discussInfo::before {
            content: "";
            display: inline-block;
            width: 0;
            height: 0;
            /*border-top: .5rem solid transparent;*/
            border-left: .1rem solid transparent;
            border-bottom: .15rem solid #F3F3F5;
            border-right: .1rem solid transparent;
            position: absolute;
            top: -.13rem;
            left: .2rem;
        }
        .list .text .discussInfo .discussName {
            font-size: .24rem;
            color: #5D7098;
        }
        .list .text .discussInfo .text1 {
            font-size: .24rem;
            color: #000;
        }
        .list .text .discussInfo .discussContent {
            font-size: .24rem;

        }
        .list .text .imgContent {
            margin-top: .1rem;
            max-height: 6rem;
            overflow: hidden;
        }
        .list .text .imgContent img {
            margin-right: .1rem;
            margin-top: .1rem;
        }
    </style>
</head>
<body >
    <!-- <div class="search clearfix"   tapmode   onclick="open1();event.stopPropagation();">
        <span class="searchIcon"></span>
        <span class="searchText" >搜索</span>
    </div> -->
    <div class="main clearfix">
         <div class="resultList"></div>
         <script type="text/x-dot-template" id="listT">
            {{?it.length > 0}}
                {{ for (var i = 0; i < it.length; i++) { }}
                    <div class="list"   tapmode data-id='{{=it[i].topic_id}}' onclick="openStateInfo(this)">
                        <div class="img">
                            <img tapmode onclick="openUserInfoPage(this);event.stopPropagation();" src="{{=it[i].head_img_url}}?imageView2/1/w/150/h/150/interlace/1/q/100|imageslim" data-id="{{=it[i].user_id}}">
                        </div>
                        <div class="text" >
                            <div class="title">
                                {{?it[i].member_note}}
                                <h3>{{=it[i].member_note}}</h3>
                                {{??}}
                                <h3>{{=it[i].nickname}}</h3>
                                {{?}}

                                {{?it[i].role_name}}
                                <span class="titleLable" style="padding: 0 .06rem;line-height: .28rem;height: .28rem;">{{=it[i].role_name}}</span>
                                {{?}}
                                {{?it[i].start_time}}
                                <span class="state">{{=it[i].start_time.substring(0,10)}}</span>
                                {{?}}
                            </div>
                            <p class="stateContent">{{=it[i].content}}</p>
                            {{?it[i].image_json!=null}}
                                <div class="imgContent">
                                    {{ for (var j = 0; j < it[i].image_json.length; j++) { }}
                                        <img class="imgCon" src="{{=it[i].image_json[j]}}" alt="">
                                        <!-- <img class="imgCon" src="../../image/tx_1.jpg" alt=""> -->
                                    {{ }; }}
                                </div>
                            {{?}}
                            <div class="stateTime" onclick="event.stopPropagation();">
                                <span class="timeInfo">{{=it[i].create_time}}</span>
                                <span class="discussIcon" tapmode onclick='commentBtn(this)' data-id='{{=it[i].topic_id}}'></span>
                            </div>
                            {{?it[i].comment_list.length!=0}}
                            <div class="discussInfo claerfix" onclick="event.stopPropagation();">
                                    {{ for (var j = 0; j < it[i].comment_list.length; j++) { }}
                                        {{?it[i].comment_list[j].root==2}}
                                            <div data-usrId='{{=it[i].comment_list[j].comment_id}}' data-id='{{=it[i].topic_id}}' tapmode onclick='addComment(this);event.stopPropagation();'>
                                                <span class="discussName">{{=it[i].comment_list[j].nickname}}</span>
                                                <span class="text1">回复{{=it[i].comment_list.length}}</span>
                                                <span class="discussName">{{=it[i].comment_list[j].comment_nickname}}：</span>
                                                <span class="discussContent">{{=it[i].comment_list[j].content}}</span>
                                            </div>
                                        {{??}}
                                            <div data-usrId='{{=it[i].comment_list[j].comment_id}}' data-id='{{=it[i].topic_id}}' tapmode onclick='addComment(this);event.stopPropagation();'>
                                                <span class="discussName">{{=it[i].comment_list[j].nickname}}：</span>
                                                <span class="discussContent">{{=it[i].comment_list[j].content}}</span>
                                            </div>
                                        {{?}}
                                    {{ }; }}
                            </div>
                            {{?}}
                        </div>
                    </div>
                {{ }; }}
            {{??}}
                <p class="no_data">暂无数据</p>
            {{?}}
        </script>
    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript">
    var role = ['关系人','知情人','甲方','总包单位','分包单位','设计院','销售'],isMenber='';
    apiready = function(){
        moduleInit();
        requestData();
        api.addEventListener({
           name: 'circleTopicComment'
        }, function(ret, err) {
           if (ret) {
               requestData();
           } else {
               alert(JSON.stringify(err));
           }
       });
        // 下拉刷新
        // 下拉刷新
        api.setCustomRefreshHeaderInfo({
            bgColor: '#EFEFF4',
        }, function(ret, err) {
            //在这里从服务器加载数据，加载完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
             requestData();
        });
        // 上啦加载
        api.addEventListener({
            name: 'scrolltobottom'
        }, function(ret, err) {
            if (isMenber) {
                // alert('下拉加载')
                requestData();
            } else {
                // 不是圈子成员
                api.confirm({
                    title: '您尚未加入' + api.pageParam.circle_name,
                    msg: '普通用户只能查看5条内容，会员可查看10条，如果您想看到全部内容，请点击立即加入',
                    buttons:['再逛逛', '立即加入']
                },function(ret,err){
                    if(ret.buttonIndex == 1){
                        // 立即加入
                        api.openWin({
                            name: 'find_payAddCricle_win',
                            url: './find_payAddCricle_win.html',
                            pageParam: {
                                circle_id: api.pageParam.circle_id
                            }
                        });
                    }
                });
                // api.openFrame({
                //     name: 'find_joinCircle',
                //     url: './find_joinCircle.html',
                //     rect: {
                //         x: 0,
                //         y: 0,
                //         w: 'auto',
                //         h: 'auto'
                //     },
                //     pageParam: {
                //         circle_id: api.pageParam.circle_id,
                //         circle_name: api.pageParam.circle_name
                //     },
                //     bounces: false
                // });
            }
        });
    };

    // 用户详情页面
    function openUserInfoPage(ele){
        api.openWin({
            name: 'winName',
            url: '../addressList/txl_memberInfo_Win.html',
            pageParam: {
                userId: $api.attr(ele, 'data-id')
            }
        });
    }
    function requestData() {
        api.ajax({
            url: apiSite + '/circle_topic/index',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: {
                       token: $api.getStorage('userToken'),
                       circle_id: api.pageParam.circle_id
                   }
            }
        }, function(ret, err) {
            if(ret) {
                for (var i = 0; i < ret.data.list.length; i++) {
                    ret.data.list[i].role = role[ret.data.list[i].role];
                    ret.data.list[i].create_time = initTime(ret.data.list[i].create_time);
                    if (ret.data.list[i].image_json != null) {
                        ret.data.list[i].image_json = eval(ret.data.list[i].image_json)
                    }
                }
                isMenber = ret.data.is_member;
                // 停止下拉刷新
                api.refreshHeaderLoadDone()
                getData(ret.data.list);
                selfAdaption()
            } else {
                alert(JSON.stringify(err.msg))
            }
        })
    }

    // 评论
    function commentBtn(ele) {
        var topic_id = $api.attr(ele, 'data-id');
        // alert(id)
        api.ajax({
            url: apiSite + '/circle_topic/detail',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: {
                       token: $api.getStorage('userToken'),
                       topic_id: topic_id
                   }
            }
        }, function(ret, err) {
            if(ret) {
                // // console.log(JSON.stringify(ret))
                if(ret.code == 200) {
                    if (ret.data.is_collect) {
                        openInputBox(topic_id, 1)
                    } else {
                        alert('先收藏主题才可以评论')
                        api.openWin({
                            name: 'find_stateInfo_win',
                            url: './find_stateInfo_win.html',
                            bounces: false,
                            pageParam: {topic_id : topic_id}
                        });
                    }
                } else {
                    alert(ret.msg)
                }
            } else {
                alert(JSON.stringify(err))
            }
        })

        // 圈子主题ID api.pageParam.circle_id
        // 评价内容
        // 评论级别（1-主题，2-用户） 1
        // 评论权限
        // 被评论用户ID（评论级别为用户时必传）

    }
    // 评论用户
    function addComment(ele) {
        var comment_customer_id = $api.attr(ele, 'data-usrId');
        var topic_id = $api.attr(ele, 'data-id');
        api.ajax({
            url: apiSite + '/circle_topic/detail',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: {
                       token: $api.getStorage('userToken'),
                       topic_id: topic_id
                   }
            }
        }, function(ret, err) {
            if(ret) {
                // // console.log(JSON.stringify(ret))
                if(ret.code == 200) {
                    if (ret.data.is_collect) {
                        openInputBox(topic_id, 2, comment_customer_id)
                    } else {
                        api.toast({
                            msg: '先收藏主题才可以评论'
                        });
                        api.openWin({
                            name: 'find_stateInfo_win',
                            url: './find_stateInfo_win.html',
                            bounces: false,
                            pageParam: {topic_id : topic_id}
                        });
                    }
                } else {
                    alert(ret.msg)
                }
            } else {
                alert(JSON.stringify(err))
            }
        })
        // alert(comment_customer_id   )
    }
    function openInputBox(topic_id, rootCount, comment_customer_id) {
        var obj = {};
        if (rootCount == 1) {
            obj = {
                topic_id: topic_id,
                rootCount: rootCount,
            }
        } else {
            obj = {
                topic_id: topic_id,
                rootCount: rootCount,
                comment_customer_id: comment_customer_id
            }
        }

        api.openFrame({
            name: 'find_inputBox',
            url: './find_inputBox.html',
            rect: {
                x: 0,
                y: 0,
                w: 'auto',
                h: 'auto'
            },
            pageParam: obj,
            bounces: false
        });
    }

    // 根据上传图片的多少自适应图片的大小
    function selfAdaption() {

        var listContent = $api.domAll('.list');

        for (var i = 0; i < listContent.length; i++) {
            var imgArr = listContent[i].getElementsByClassName('imgCon');
            // var imgArr = $api.dom(listContent[i], '.imgCon');
            var imgCount = imgArr.length
            // // console.log('::::'+imgCount)
            if (imgCount == 1) {
                    $api.css(listContent[i].getElementsByClassName('imgCon')[0], 'width:2.86rem;height:3.26rem;margin:0');
                    // // console.log('1111')

            }else if (imgCount == 0) {
                    // // console.log('0000')

            } else {
                    // // console.log('2222')
                for (var j = 0; j < imgCount; j++) {
                    $api.css(listContent[i].getElementsByClassName('imgCon')[j], 'height:1.56rem;width:1.56rem');
                }
            }
        }
    }
    // doT模版获取数据
    function getData(data) {

        var listTText = $api.byId('listT').text;

        var fnListT = doT.template(listTText);

        var html = fnListT(data);

        var list = $api.dom('.resultList');

        // 替换resultList所有内容
        $api.html(list, html);
        // alert('getData:' + JSON.stringify(data))
    }


    function openStateInfo(ele) {
        var topic_id = $api.attr(ele, 'data-id');
        api.openWin({
            name: 'find_stateInfo_win',
            url: './find_stateInfo_win.html',
            bounces: false,
            pageParam: {topic_id : topic_id}
        });
    }
</script>
</html>