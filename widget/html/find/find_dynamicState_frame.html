<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
        body,html{
            background-color: #EDECF3;
            height: 100%;
        }
        body {
            padding-top: .2rem;
            box-sizing: border-box;
        }
       .search {
            height: .5rem;
            line-height: .5rem;
            background-color: #fff;
            margin: 0 .3rem .2rem;
            text-align: center;
            font-size: 0;
            color: #96969B;

        }
        .search .searchIcon {
            display: inline-block;
            width: .26rem;
            height: .5rem;
            background: url(../../image/icon_search.png)no-repeat;
            -webkit-background-size: .25rem .26rem;
            background-size: .25rem .26rem;
            background-position: 0 center;
            vertical-align: top;
        }
        .search .searchText {
            font-size: .24rem;
        }

        .list {
            box-sizing: border-box;
            width: 100%;
            font-size: 0;   
            background-color: #fff;
            padding: .2rem .3rem; 
            border-bottom: 1px solid #e7e7e7;    
            margin-bottom: .2rem;

            /* 定义flex */
            display: -webkit-box; 
            display: flex; 
                
             /*侧轴对齐方式 */
            -webkit-box-align: start ;
            align-items: flex-start;
        
             /*主轴对齐方式 */
            
                
             /*主轴方向 */
            -webkit-box-direction: normal;
            flex-direction: row;
            
        }
        .list .img img {
            width: .78rem;
            height: .78rem;  
            
        }
        .list .text {
            /* 子元素是否伸缩 */
            -webkit-box-flex: 1.0;
            flex-grow: 1;
            box-sizing: border-box;
            margin-left: .2rem;
            
        }
        .list .text .title {
            

            box-sizing: border-box;
            position: relative;
            
            display: -webkit-box; 
            display: flex; 
            box-sizing: border-box;
            /*主轴方向 */
            -webkit-box-direction: normal;
            flex-direction: row;

            -webkit-box-align: center ;
            -webkit-align-items: center;
            align-items: center;
        }
        .list .text .title h3 {
            font-size: .34rem;
            color: #333;
            margin-bottom: .05rem;
            line-height: .24rem;
            margin-right: .1rem;
        }
        .list .text .title .state {
            font-size: .24rem;
            color: #0ABB07;
            position: absolute;
            right: 0;
            top: 0;
        }
        .list .text .title .titleLable {
             padding: 0 .06rem;
            font-size: .2rem;

            color: #5D7099;
            text-align: center;
            line-height: .28rem;
            border: 1px solid #5D7099;
            border-radius: .06rem;
            height: .28rem;
        }
        .list .text .stateContent {
            font-size: .24rem;
            color: #333;
            margin-top: .2rem;
        }
        .list .text .stateTime {
            margin-top: .1rem;
        }
        .list .text .stateTime .timeInfo {
            font-size: .2rem;
            color: #999;
        }
        .list .text .stateTime .discussIcon {
            width: .34rem;
            height: .32rem;
            background:url(../../image/icon_supply/icon_comment.png)no-repeat;
            background-size: .34rem .26rem;
            background-position: 0 center;
            float: right;
        }
        .list .text .discussInfo {
            background-color: #F3F3F5;
            padding: .1rem;
            position: relative;
            margin-top: .15rem;
        }
        
        .list .text .discussInfo::before {
            content: "";
            display: inline-block;
            width: 0;
            height: 0;
            /*border-top: .5rem solid transparent;*/
            border-left: .1rem solid transparent;
            border-bottom: .15rem solid #F3F3F5;
            border-right: .1rem solid transparent;
            position: absolute;
            top: -.13rem;
            left: .2rem;
        }
        .list .text .discussInfo .discussName {
            font-size: .24rem;
            color: #5D7098;
        }
        .list .text .discussInfo .text1 {
            font-size: .24rem;
            color: #000;   
        }
        .list .text .discussInfo .discussContent {
            font-size: .24rem;
           
        }
        .list .text .imgContent {
            margin-top: .1rem;
            max-height: 6rem;
            overflow: hidden;
        }
        .list .text .imgContent img {
            margin-right: .1rem;
            margin-top: .1rem;
        }
    </style>
</head>
<body >
    <div class="search clearfix"   tapmode="hover"   onclick="open1();event.stopPropagation();">
        <span class="searchIcon"></span>
        <span class="searchText" >搜索</span>
    </div>
    <div class="main clearfix">
        <!-- <div class="list">
            <div class="img">
                <img src="../../image/tx_2.jpg" alt="">
            </div>
            <div class="text">
                <div class="title">
                    <h3>陈胜东</h3>
                    <span class="titleLable"></span>
                    <span class="state">即将开始</span>
                </div>
                <p class="stateContent">美国平面设计大神安德鲁将在北京举办演讲</p>
                <div class="imgContent">
                    <img class="imgCon" src="../../image/tx_3.jpg" alt="">
                    <img class="imgCon" src="../../image/tx_3.jpg" alt="">
                    <img class="imgCon" src="../../image/tx_3.jpg" alt="">
                </div>
                <div class="stateTime">
                    <span class="timeInfo">2天前</span>
                    <span class="discussIcon"></span>
                </div>
                <div class="discussInfo claerfix">
                    <div class="wrap">
                        <div>
                            <span class="discussName">李志超:</span>
                            <span class="discussContent">是招生办的教师吗？</span>
                        </div>
                        <div>
                            <span class="discussName">李志超</span>
                            <span class="text1">回复</span>
                            <span class="discussName">李志超:</span>
                            <span class="discussContent">是招生办的教师吗？</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>  -->
       
         <div class="resultList"></div>
         <script type="text/x-dot-template" id="listT">
            {{ for (var i = 0; i < it.length; i++) { }} 
                <div class="list"   tapmode="hover" data-id='{{=it[i].topic_id}}' onclick="openStateInfo(this)">
                    <div class="img">
                        <img src="{{=it[i].head_img_url}}" alt="">
                    </div>
                    <div class="text">
                        <div class="title">
                            <h3>{{=it[i].nickname}}</h3>
                            <span class="titleLable">{{=it[i].role}}</span>
                            <span class="state">{{=it[i].start_time}}</span>
                        </div>
                        <p class="stateContent">{{=it[i].content}}</p>
                        {{?it[i].image_json!=null}}
                            <div class="imgContent">
                                {{ for (var j = 0; j < it[i].image_json.length; j++) { }} 
                                    <img class="imgCon" src="{{=it[i].image_json[j]}}" alt="">
                                {{ }; }}
                            </div>
                        {{?}}
                        <div class="stateTime" onclick="event.stopPropagation();">
                            <span class="timeInfo">{{=it[i].create_time}}</span>
                            <span class="discussIcon" ontouchstart='commentBtn(this)' data-id='{{=it[i].topic_id}}'></span>
                        </div>
                        {{?it[i].comment_list.length!=0}}
                        <div class="discussInfo claerfix" onclick="event.stopPropagation();">
                                {{ for (var j = 0; j < it[i].comment_list.length; j++) { }} 
                                    {{?it[i].comment_list[j].root==2}}
                                        <div data-usrId='{{=it[i].comment_list[j].comment_id}}' data-id='{{=it[i].topic_id}}' ontouchstart='addComment(this);event.stopPropagation();'>
                                            <span class="discussName">{{=it[i].comment_list[j].nickname}}</span>
                                            <span class="text1">回{{=it[i].comment_list.length}}复</span>
                                            <span class="discussName">{{=it[i].comment_list[j].comment_nickname}}：</span>
                                            <span class="discussContent">{{=it[i].comment_list[j].content}}</span>
                                        </div>
                                    {{??}}
                                        <div data-usrId='{{=it[i].comment_list[j].comment_id}}' data-id='{{=it[i].topic_id}}' ontouchstart='addComment(this);event.stopPropagation();'>
                                            <span class="discussName">{{=it[i].comment_list[j].nickname}}：</span>
                                            <span class="discussContent">{{=it[i].comment_list[j].content}}</span>
                                        </div>
                                    {{?}}
                                {{ }; }}
                        </div>
                        {{?}}
                    </div>
                </div>
            {{ }; }}
            </script>
    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript">
    var role = ['关系人','知情人','甲方','总包单位','分包单位','设计院','销售'],isMenber='';
    apiready = function(){
        moduleInit();
        requestData();

        // 下拉刷新
        // 下拉刷新
        api.setCustomRefreshHeaderInfo({
            bgColor: '#EFEFF4',
        }, function(ret, err) {
            //在这里从服务器加载数据，加载完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
             requestData();
        });
        // 上啦加载
        api.addEventListener({
            name: 'scrolltobottom'
        }, function(ret, err) {
            if (isMenber) {
                alert('下拉加载')
            } else {
                // 不是圈子成员
                api.openFrame({
                    name: 'find_joinCircle',
                    url: './find_joinCircle.html',
                    rect: {
                        x: 0,
                        y: 0,
                        w: 'auto',
                        h: 'auto'
                    },
                    pageParam: {
                        circle_id: api.pageParam.circle_id
                    },
                    bounces: false
                });
            }
        });
    };
    
   
    function requestData() {
        api.ajax({
            url: apiSite + '/api/circle_topic/index',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: { 
                       token: $api.getStorage('userToken'),
                       circle_id: api.pageParam.circle_id
                   }
            }
        }, function(ret, err) {
            if(ret) {
                for (var i = 0; i < ret.data.list.length; i++) {
                    ret.data.list[i].role = role[ret.data.list[i].role];
                    if (ret.data.list[i].image_json != null) {
                        ret.data.list[i].image_json = eval(ret.data.list[i].image_json)
                    }
                }
                isMenber = ret.data.is_member;
                // 停止下拉刷新
                api.refreshHeaderLoadDone()
                getData(ret.data.list);
                selfAdaption()
            } else {
                alert(JSON.stringify(err))
            }
        })
    }
    
    // 评论
    function commentBtn(ele) {
        var topic_id = $api.attr(ele, 'data-id');
        // alert(id)
        openInputBox(topic_id, 1)
        // 圈子主题ID api.pageParam.circle_id
        // 评价内容 
        // 评论级别（1-主题，2-用户） 1
        // 评论权限 
        // 被评论用户ID（评论级别为用户时必传）
        
    }
    // 评论用户
    function addComment(ele) {
        var comment_customer_id = $api.attr(ele, 'data-usrId');
        var topic_id = $api.attr(ele, 'data-id');
        // alert(comment_customer_id   )
        openInputBox(topic_id, 2, comment_customer_id)
    }
    function openInputBox(topic_id, rootCount, comment_customer_id) {
        var obj = {};
        if (rootCount == 1) {
            obj = {
                topic_id: topic_id,
                rootCount: rootCount,
            }
        } else {
            obj = {
                topic_id: topic_id,
                rootCount: rootCount,
                comment_customer_id: comment_customer_id
            }    
        }
        
        api.openFrame({
            name: 'find_inputBox',
            url: './find_inputBox.html',
            rect: {
                x: 0,
                y: 0,
                w: 'auto',
                h: 'auto'
            },
            pageParam: obj,
            bounces: false
        });
    }
    
    // 根据上传图片的多少自适应图片的大小
    function selfAdaption() {
        
        var listContent = $api.domAll('.list');

        for (var i = 0; i < listContent.length; i++) {
            var imgArr = listContent[i].getElementsByClassName('imgCon');
            var imgCount = imgArr.length
            if (imgCount == 1) {
                    $api.css(listContent[i].getElementsByClassName('imgCon')[i], 'width:2.86rem;height:3.26rem;margin:0');

            } else {
                for (var j = 0; j < imgCount; j++) {
                    $api.css(listContent[i].getElementsByClassName('imgCon')[j], 'height:1.56rem;width:1.56rem');
                }
            }
        }
    }
    // doT模版获取数据
    function getData(data) {
        
        var listTText = $api.byId('listT').text;
        
        var fnListT = doT.template(listTText);
        
        var html = fnListT(data);
        
        var list = $api.dom('.resultList');
        
        // 替换resultList所有内容
        $api.html(list, html);
        // alert('getData:' + JSON.stringify(data))
    }
    

    function openStateInfo(ele) {
        var topic_id = $api.attr(ele, 'data-id');
        api.openWin({
            name: 'find_stateInfo_win',
            url: './find_stateInfo_win.html',
            bounces: false,
            pageParam: {topic_id : topic_id}
        });
    }
</script>
</html>