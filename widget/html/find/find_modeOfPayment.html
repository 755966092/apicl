<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
        body,html{
            background-color: rgba(0,0,0,0.3);
            height: 100%;
        }
        .main {
            width: 6.1rem;
            height: 6.26rem;
            background-color: #fff;
            border-radius: .2rem;
            margin: 0 auto;
            vertical-align: middle;
            /* 垂直居中 */
            position: absolute;
            top: 0;
            bottom: 0;  
            left: 0;
            right: 0; 
            margin: auto;


        }
       
        .zf, .title {
            font-size: .28rem;
            height: 1.56rem;
            vertical-align: middle;
            border-bottom: .01rem solid #EFEFEF;
        }
        .zf {
            line-height: 1.2rem;
            vertical-align: middle;
            height: 1.2rem;
            position: relative;
        }
        
         .title {
            font-size: .34rem;
            text-align: center;
            line-height: 1.56rem;
        }
        
        /* 选择图标 */
        .icon {
            display: inline-block;
            width: .43rem;
            height: 1.2rem;
            background: url(../../image/icon_member/icon_cz01.png)no-repeat;
            -webkit-background-size: .43rem .43rem;
            background-size: .43rem .43rem;
            background-position: 0 center;
            margin-left: .8rem;
            margin-right: .6rem;
            }
        input {
            opacity: 0.5;
             width: .43rem;
            height: 1.2rem;
            position: absolute;
            left: .83rem;
            opacity: 0;
        }
        .select1 {
             background: url(../../image/icon_member/icon_cz02.png)no-repeat;
            -webkit-background-size: .43rem .43rem;
            background-size: .43rem .43rem;
            background-position: 0 center;
        }
        /* 支付图标 */
        .zfb, .wx {
            margin-right: .2rem;
            display: inline-block;
            width: .58rem;
            height: 1.2rem;
            background: url(../../image/icon_member/icon_zfb.png)no-repeat;
            -webkit-background-size: .58rem .58rem;
            background-size: .58rem .58rem;
            background-position: 0 center;
        }
        .wx {
             background: url(../../image/icon_member/icon_wx.png)no-repeat;
            -webkit-background-size: .58rem .58rem;
            background-size: .58rem .58rem;
            background-position: 0 center;
        }
        
        /* 底部按钮 */
        .btn {
            line-height: 1.05rem;
            font-size: 0;
        }
        .clear,.enter {
            height: 1.05rem;
            font-size: .34rem;
            width: 3.05rem;
            text-align: center;
            background-color: #EEEEEE;
            color: #08BB08;
        }
        .clear {
            border-bottom-left-radius: .2rem;
        }
        .enter {
            background-color: #08BB08;
            color: #fff;
            border-bottom-right-radius: .2rem;
            height: 1.08rem;
        }
    </style>
</head>
<body>
     <div class="main">
         <p class="title">支付￥<span class="money"></span>入圈，请选择支付方式</p>
         <p class="zf zf1"   tapmode   onclick="selType(this)">
            <span   class="icon select1 fl" data-val='alipay'></span>
            <!-- <input class="fl" type="radio" name="zf"> -->
            <span class="zfb fl" ></span>
            <span class="text fl">支付宝</span>
        </p>
         <p class="zf"   tapmode   onclick="selType(this)" >
            <span class="icon  fl" data-val='wechat'></span>
            <!-- <input class="fl" type="radio" name="zf"> -->
            <span class="wx fl"></span>
           <span class="text fl">微信</span>
        </p>
        <p class="zf"   tapmode   onclick="selType(this)" >
            <span class="icon  fl" data-val='balance'></span>
            <!-- <input class="fl" type="radio" name="zf"> -->
            <span class="wx fl"></span>
           <span class="text fl">余额</span>
        </p>
        <div class="btn">
            <span class="clear fl"   tapmode   onclick="submit(this)">取消</span>
            <span class="enter fl"   tapmode   onclick="submit(this)">确定</span>
        </div>
     </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    var money;
    apiready = function(){
        moduleInit();
        //console.log('150:::'+JSON.stringify(api.pageParam))
        $api.text($api.dom('.money'), api.pageParam.price);
    }
    function selType(ele) {
        for (var i = 0; i < document.getElementsByClassName('icon').length; i++) {
            $api.removeCls(document.getElementsByClassName('icon')[i],'select1')
        }
        $api.addCls(ele.getElementsByClassName('icon')[0], 'select1');
    }
  
    function submit(ele) {
        var text = $api.text(ele)
        if (text === '确定') {
            var payType = $api.attr($api.dom('.select1'), 'data-val');
            if (payType == 'balance') {
                // 判断是否设置支付密码
                api.ajax({
                    url: apiSite + '/settings/checkPayPassword',
                    method: 'post',
                    headers: apiHeader,
                    data: {
                           values: { 
                               token: $api.getStorage('userToken'),
                           }
                    }
                }, function(ret, err) {
                    if(ret) {
                        if(ret.code == 200) {
                            if (ret.data.is_set_pay_password) {
                                // 已设置
                                api.openWin({
                                    name: 'winName',
                                    url: './find_modeOfPayment_psdKey.html',
                                    pageParam: {
                                        circle_id:api.pageParam.circle_id,
                                        pay_method:payType,
                                    }
                                });
                            } else {
                                // 未设置
                                api.openWin({
                                    name: 'me_hy_tx_setPsd_win',
                                    url: '../me/me_hy_tx_setPsd_win.html',
                                });
                            }
                        } else {
                            alert(ret.msg)
                        }
                    } else {
                        alert(JSON.stringify(err))
                    }
                })
            } else {
                api.ajax({
                    url: apiSite + '/circle/enter',
                    method: 'post',
                    headers: apiHeader,
                    data: {
                           values: { 
                                token: $api.getStorage('userToken'),
                                circle_id:api.pageParam.circle_id,
                                pay_method: payType
                           }
                    }
                }, function(ret, err) {
                    if(ret) {
                        if (ret.code === 200) {
                            if (payType == 'wechat') {
                                wxPayFun(ret);
                            } else if (payType == 'alipay') {
                                aliPay.payOrder({
                                    orderInfo: ret.data.config
                                },function(ret,err) {
                                    //console.log('支付宝支付成功');
                                    openCircleInfo();
                                });
                            } else {
                                
                            }
                                
                        } else {
                            alert(ret.msg)
                        }
                    } else {
                        alert(JSON.stringify(err))
                    }
                })
            }
            
        } else {
            api.closeFrame();
        }
        
    }

     function wxPayFun(retAJAX) {
         wxPay.payOrder({
            apiKey: retAJAX.data.config.appid,
            orderId: retAJAX.data.config.prepayid,
            mchId: retAJAX.data.config.partnerid,
            nonceStr: retAJAX.data.config.noncestr,
            timeStamp: retAJAX.data.config.timestamp,
            package: retAJAX.data.config.package,
            sign: retAJAX.data.config.sign
        }, function(ret, err) {
            if (ret.status) {
                //支付成功
              // payFruitPage(obj)
              openCircleInfo();
              //console.log('微信支付成功')
            } else {
                alert(err.code);
            }
        })
    }
    function openCircleInfo() {
        
        api.sendEvent({
            name: 'circleTopicComment'
        }); 
        api.closeWin({
            name: 'find_payAddCricle_win2'
        });
        api.execScript({
            name: 'find_cricleInfo_win',
            script: 'requestData();'
        });
        api.execScript({
            name: 'find_dynamicState_win',
            frameName: 'find_dynamicState_frame',
            script: 'requestData();'
        });
        // 加入后打開圈子詳情
        // api.openWin({
        //     name: 'find_cricleInfo_win',
        //     url: './find_cricleInfo_win.html',
        //     pageParam: {
        //         circle_id: api.pageParam.circle_id
        //     }
        // });
        api.closeToWin({
            name: 'find_cricleInfo_win'
        });
        api.closeFrame();
    }
</script>
</html>