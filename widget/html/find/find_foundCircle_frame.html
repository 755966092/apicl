<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/weui.css"/>
    <style>
        li {
            padding: 0 .36rem;
            border-bottom: .01rem solid #d9d9d9;
            height: 0.8rem;
            background-color: #fff;
        }
        li .label {
            font-size: 0.3rem;
        }
        li .text {
            font-size: 0.3rem;
            margin-right: 0.2rem;
        }
        li .icon {
            width: 0.15rem;
            height: 0.8rem;
            background: url(../../image/icon_zk.png)no-repeat  center center/.15rem .25rem;
        }
        li img {
            width: 0.57rem;
            height: 0.57rem;
            margin-right: 0.2rem;
        }
        .mt32 {
            margin-top: 0.32rem;
        }
        textarea {
            width: 100%;
            height: 1.85rem;
            background-color: #fff;
            box-sizing: border-box;
            padding: 0.19rem .36rem;
        }
        .hr {
            width: 7.15rem;
            height: 0.02rem;
            background-color: #d9d9d9;
            float: right;
        }
        .ipt {
            font-size: 0;
            height: 2.4rem;
            background-color: #fff;
        }
        .ipt p {
            font-size: 0.24rem;
            text-align: right;
            line-height: 0.55rem;
            box-sizing: border-box;
            padding-right: 0.36rem;
        }
        .btn {
            width: 6.785rem;
            height: .841rem;
            border-radius: .06rem;
            background-color: #1AAD19;
            border: .01rem solid #189c17;
            margin: 0 auto;
            line-height: .841rem;
            text-align: center;
            font-size: .34rem;
            color: #fff;
            margin-top: .36rem;
            margin-bottom: .2rem;
        }
        .remind {
            background: #fff url(../../image/icon_supply/icon_06.png)no-repeat ;
            background-size: .33rem .34rem;
            background-position: .36rem;
            padding-left: 0.78rem;
        }
        .hide {
            display: none;
        }
    </style>
    <style>
        
    </style>
</head>
<body>
    
    <div class="main">
        <ul class="mt32">
            <li class="flex-def flex-cCenter flex-zBetween" tapmode onclick="openPage(this,1)">
                <span class="label">圈子名称</span>
                <div class="flex-def flex-cCenter">
                        <span id="circleName" class="text"></span>
                        <span class="icon"></span>
                </div>
            </li>
            <li class="flex-def flex-cCenter flex-zBetween" tapmode onclick="openPage(this,3)">
                <span class="label">圈子图片</span>
                <div class="flex-def flex-cCenter">
                        <img id="headImg" src="../../image/icon_defaultHead.png" alt="">
                        <span class="icon"></span>
                </div>
            </li>
            <!-- <li class="mt32 flex-def flex-cCenter flex-zBetween">
                <span class="label">圈子类型</span>
                <div class="flex-def flex-cCenter">
                        <span class="text">name</span>
                        <span class="icon"></span>
                </div>
            </li> -->
            <li class="mt32 flex-def flex-cCenter flex-zBetween" onclick="priceSetting(this)" tapmode>
                <span class="label">金额设置</span>
                <div class="flex-def flex-cCenter">
                        <span class="text" id="priceSetting"></span>
                        <span class="icon"></span>
                </div>
            </li>
            <li class="flex-def flex-cCenter flex-zBetween" id="priceBtn" tapmode onclick="openPage(this,2)">
                <span class="label">入圈金额</span>
                <div class="flex-def flex-cCenter">
                        <span class="text" id="addCirclePrice"></span>
                        <span class="icon"></span>
                </div>
            </li>
        </ul>
        <div class="ipt mt32">
            <textarea oninput="changeIpt(this,1)" maxlength="80" placeholder="描述一下你所要创建的圈子..." id="description"></textarea>
            <span class="hr"></span>
            <p id="text1">0/80</p>
        </div>
        <div class="ipt mt32">
            <textarea oninput="changeIpt(this,2)" maxlength="80" placeholder="说一下你的申请理由..." id="reason"></textarea>
            <span class="hr"></span>
            <p id="text2">0/80</p>
        </div>
        <!-- <ul class="mt32">
            <li class="remind flex-def flex-cCenter flex-zBetween">
                <span class="label">提醒谁看</span>
                <span class="icon"></span>
            </li>
        </ul> -->
        <div class="btn" tapmode onclick="foundCircle()">确认创建</div>
    </div>

</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    apiready = function() {
       moduleInit();
       ListenToEvents();
    };
    // 打开编辑页面
    function openPage(ele,n) {
        var url, headImg, text;
        if (n === 1) {
            url = "./find_foundCircle_win_name.html"
            text = $api.text($api.byId('circleName'));
        } else if (n === 2) {
            url = "./find_foundCircle_win_price.html"
            text = $api.text($api.byId('addCirclePrice'));
        } else if (n === 3) {
            url = "./find_foundCircle_win_headImg.html"
            headImg = $api.attr($api.byId('headImg'), 'src');
        }
        // alert(url)
        api.openWin({
            name: 'winname'+url,
            url: url,
            bounces: false,
            pageParam: {
                headImg: headImg,
                text: text
            }
        });

    }
    // 金额设置
    function priceSetting(ele) {
        api.actionSheet({
            buttons: ['免费', '收费']
        },function(ret,err){

            if (ret.buttonIndex === 1) {
                // 免费
                $api.text($api.byId('priceSetting'),'免费');
//                $api.removeAttr($api.byId('priceBtn'), 'onclick');
//                $api.css($api.byId('priceBtn'), 'display: none');
                $api.addCls($api.byId('priceBtn'), 'hide');
            } else if (ret.buttonIndex === 2) {
                // 收费
                $api.text($api.byId('priceSetting'),'收费');
//                $api.attr($api.byId('priceBtn'), 'onclick', 'openPage(2)');
                $api.removeCls($api.byId('priceBtn'), 'hide');
            }else {
                //
            }
        });

    }
    // 监听修改内容事件
    function ListenToEvents() {
        // 修改圈子名称
        api.addEventListener({
            name: 'circleNameEdit2'
        }, function(ret, err){
            $api.text($api.byId('circleName'),ret.value.circleName);
        });
        // 入圈金额
        api.addEventListener({
            name: 'circleNameEdit'
        }, function(ret, err){
            $api.text($api.byId('addCirclePrice'),ret.value.circleName);
        });
        // 头像
        api.addEventListener({
            name: 'circleNameEdit3'
        }, function(ret, err){
          //  console.log(ret.value.imgUrl);
            $api.attr($api.byId('headImg'), 'src', ret.value.imgUrlLocalhost);
            $api.attr($api.byId('headImg'), 'data-src', ret.value.imgUrl);
        });
        api.addEventListener({
           name: 'saveImg'
        }, function(ret, err) {
           if (ret) {
               imgSave();
           } else {
               alert(JSON.stringify(err));
           }
        });
    }
    // 输入框字数
    function changeIpt(ele, n) {
        var val = $api.val(ele).length;
        var dom = $api.byId('text'+n);
        $api.text(dom, val+'/80');
        if (val === 80) {
            $api.css(dom, 'color:#f00');
        } else {
            $api.css(dom, 'color:#000');

        }
    }

    function foundCircle() {
        // token       //   string  用户Token
        // title       //   string  名称
        // image_url       //   string  图标
        // description     // string  简介
        // type        //    int 类型（1-免费，2-付费）
        // price       //   float   价格（付费时必传）
        // apply_reason        // 理由
        var title = $api.text($api.byId('circleName'));
        var description = $api.val($api.byId('description'));
        var image_url = $api.attr($api.byId('headImg'), 'data-src');
        var price = $api.text($api.byId('addCirclePrice'));
        var apply_reason = $api.val($api.byId('reason'));
        var type = $api.text($api.byId('priceSetting')) == '免费' ? 1 : 2;
        var obj = {
            token: $api.getStorage('userToken'),
            title: title,
            description: description,
            image_url: image_url,
            type: type,
            apply_reason: apply_reason
        }
        if (title == '') {
            alert('标题不能为空')
        } else if (description == '') {
            alert('介绍不能为空')
        } else if (image_url == '../../image/icon_defaultHead.png') {
            alert('头像不能为空')
        } else if (apply_reason == '') {
            alert('申请理由不能为空')
        } else {

            if (type == 2 && price == '') {
                alert('收费圈子加入圈子费用不能为空')
            } else {
                if (type == 2) {
                    obj.price = price;
                }
                // obj = {
                //     title: title,
                //     description: description,
                //     image_url: image_url,
                //     price: price,
                //     type: type
                // };
                //console.log(JSON.stringify(obj));
                api.ajax({
                    url: apiSite + '/circle/add',
                    method: 'post',
                    headers: apiHeader,
                    data: {
                           values: obj
                    }
                }, function(ret, err) {
                    if(ret) {
                        if(ret.code == 200) {
                            api.sendEvent({
                                name: 'frame4Open',
                            });
                            api.sendEvent({
                                name: 'circleTopicComment'
                            });
                            api.toast({
                                msg: '创建成功'
                            });
                            // api.openWin({
                            //     name: 'me_wdq',
                            //     url: '../me/me_wdq.html'
                            // });
                            api.closeWin();
                        } else {
                            alert(ret.msg)
                        }
                    } else {
                        alert(JSON.stringify(err.msg))
                    }
                })
                //console.log(JSON.stringify(obj))
            }
        }

    }

    function openCamera() {
        api.getPicture({
            sourceType: 'library',
            mediaValue: 'pic',
            encodingType: 'jpg',
            destinationType: 'url',
            quality: 80,
            // targetWidth: 750,
            // targetHeight: 750
        }, function(ret, err) {
            if (ret) {
                if (ret.data) {
                    // $api.attr($api.dom('img'),'src', ret.data);
                    // pushImg(ret.data)
                    api.sendEvent({
                        name: 'editCircleHead'
                    });
                    clipImage(ret)
                }

            } else {
                // alert(JSON.stringify(err.msg));
            }
        });
    }
    function clipImage(ret) {
        FNImageClip.open({
            rect: {
                x: 0,
                y: 0,
                w: api.frameWidth,
                h: api.frameHeight
            },
            srcPath: ret.data,
            mode: "image",
            // 截图时是否截取高清图（与原图分辨率一致的图）
            highDefinition: true,
            style: {
                mask: 'rgba(0,0,0,0.4)',
                clip: {
                    w: api.winWidth-1,
                    h: api.winWidth,
                    x: 1,
                    y: (api.winHeight - api.winWidth - headerH) / 2 ,
                    borderColor: '#0f0',
                    borderWidth: 1,
                    appearance: 'rectangle'
                }
            },
            fixedOn: api.frameName
        }, function(ret, err) {
            if (ret) {
            } else {
                alert(JSON.stringify(err));
            }
        });
    }
    function enter () {
        if (flag) {
            imgSave();
        } else {
            var url = $api.attr($api.dom('img'),'src');
            pushImg(url)
        }

    }
    function imgSave() {
            FNImageClip.save({
                destPath: 'fs://imageClip/result.png',
                copyToAlbum: false,
                quality: 1
            },function(ret, err){
                if(ret) {
                    $api.attr($api.dom('img'), 'src', ret.destPath);
                    pushImg(ret.destPath)
                    FNImageClip.close();
                } else{
                    alert(JSON.stringify(err));
                }
            });
    }
    function pushImg(imgUrl) {
       //  var baseUrl = 'img.iinnet.com'; //七牛给你的测试域名，也可使用自己捆绑的域名youe.xxx.com
        var obj = api.require('qiniuUpfile');
        obj.upfile({
            file: imgUrl,
        }, function(retUpfile, err) {
            if (retUpfile.status) {
                if (retUpfile.oper == "complete") {
                    //上传成功后组装访问路径，或直接访问文档
                    $api.attr($api.dom('img'),'src', 'http://'+ baseUrl +'/'+ retUpfile.info.key);

                } else if (retUpfile.oper == "progress") {
                    //上传过程中获取进度数据
                    // console.log(retUpfile.percent);
                }
            }
        });
    }
</script>
</html>