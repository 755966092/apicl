<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>我在</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <style>
        html, body {
            background-color: #EFEFF4;
        }

            .search {
            border-radius: .04rem;
            display: block;
            height: .5rem;
            line-height: .5rem;
            background-color: #fff;
            margin: 0 .15rem;
            text-align: center;
            font-size: 0.24rem;
            color: #96969B;
            
        }
        .search .searchIcon {
            display: inline-block;
            width: .26rem;
            height: .5rem;
            background: url(../image/icon_search.png)no-repeat;
            -webkit-background-size: .25rem .26rem;
            background-size: .25rem .26rem;
            background-position: 0 center;
            vertical-align: top;
        }
        .search .searchText {
            font-size: .24rem;
        }
       
        .news {
            display: flex;
            flex-flow: column nowrap;
        }
        
        ul {
            width: 100%;
            box-sizing: border-box;
        }
        
        ul li {
            width: 100%;
            height: 1.2rem;
            box-sizing: border-box;
            padding: .15rem .3rem;
            /*padding: .15rem 0;*/
            border-bottom: 1px solid #D6D6D6;
            position: relative;
        }
        
        ul li img {
            width: .9rem;
            height: .9rem;
            margin-right: .2rem;
        }
        
        ul li h3 {
            margin-top: .1rem;
            margin-bottom: .05rem;
            width: 3.5rem;
            float: left;
            overflow: hidden;
            text-overflow: ellipsis;
        }
       
        ul li.select:before {
            content: "";
            display: inline-block;
            width: .15rem;
            height: .15rem;
            background-color: #f00;
            border-radius: 50%;
            position: absolute;
            top: .1rem;
            left: .8rem;
        }
        
        ul li p {
            color: #9B9B9B;
            word-wrap: break-word;
            white-space: nowrap;
            text-overflow: ellipsis;
            height: .32rem;
            width:3.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        .main_no1,
        .main_no2 {
            height: 1rem;
            border-bottom: 1px solid #EBEBEB;
            font-size: .3rem;
            line-height: 1rem;
            padding-left: 1.1rem;

        }
        .main_no1 {
            background: #fff url(../image/icon_txl/icon_yi.png)no-repeat;
            -webkit-background-size: .64rem .64rem;
            background-size: .64rem .64rem;
            background-position: .2rem center;
        }
        .main_no2 {
            background: #fff url(../image/icon_txl/icon_cs.png)no-repeat;
            -webkit-background-size: .64rem .64rem;
            background-size: .64rem .64rem;
            background-position: .2rem center;
            margin-bottom: .6rem;
        }
        .wrap {
            padding: .2rem 0;
        }
    </style>
</head>

<body>
    <div id="news_wrap" class=" clearfix">
       <div class="wrap clearfix">
            <div class="search" onclick="openS()">
                <span class="searchIcon"></span>
                <span class="searchText">搜索</span>
            </div>
       </div>
        <div class="main_no1" onclick="onceConnected()">
            一度人脉
        </div>
        <div class="main_no2" onclick="contactFriend()">
            初识好友（无通讯录）
        </div>
    </div>
    <script type="text/javascript" src="../script/common.js"></script>
    <script type="text/javascript" src="../script/api.js"></script>
    <script type="text/javascript" src="../script/doT.min.js"></script>
    <script type="text/javascript" src="../script/pinyin4js.js"></script>
    <script type="text/javascript">
    apiready = function() {
        moduleInit()
        // requestData();
        query();

    }
    function openS() {
        api.openWin({
            name: 'txl_fellowSearch',
            url: './addressList/txl_fellowSearch.html',
            pageParam: {
                userToken: api.pageParam.userToken,
                rongToken: api.pageParam.rongToken
            }
        });
    }
    // 打开一度人脉
    function onceConnected() {
        api.openWin({
            name: 'listWin',
            url: './addressList/txl_listWin.html',
            pageParam: {
                userToken: api.pageParam.userToken
            },
            bounces: false
        });
    }
    // 打开初始好友
    function contactFriend () {
        api.openWin({
               name: 'txl_contactFriend_win',
               url: './addressList/txl_contactFriend_win.html',
               bounces: false
           });   
    }
     // 请求数据
    function requestData() {
        alert('我没执行')
        api.ajax({
            url: apiSite + '/api/contact/index',
            method: 'post',
            headers: apiHeader,
            data: {
               values: { 
                  token: $api.getStorage('userToken'),
               }
            }
       }, function(ret, err) {
            // console.log(JSON.stringify(ret))
            // var initialData = ret.data.unavailable_list;
            for (var i = 0; i < ret.data.unavailable_list.length; i++) {
                // 去除空格
                ret.data.unavailable_list[i].nickname = $api.trimAll(ret.data.unavailable_list[i].nickname)
                ret.data.unavailable_list[i].litter = PinyinHelper.getShortPinyin(ret.data.unavailable_list[i].nickname).toUpperCase();
                ret.data.unavailable_list[i].title = ret.data.unavailable_list[i].nickname;
                ret.data.unavailable_list[i].img = ret.data.unavailable_list[i].head_img_url;
                ret.data.unavailable_list[i].titleSize = 15;
                if (ret.data.unavailable_list[i].current_position == null) {
                    ret.data.unavailable_list[i].current_position = '';
                } 
                if (ret.data.unavailable_list[i].current_company == null) {
                    ret.data.unavailable_list[i].current_company = '';
                }
            }
            // 模块数据格式
            var data1 = litterSort(ret.data.unavailable_list)
            console.log(data1)
            dakai(data1)
            // sqlSyntax(initialData);
       })
           
    }
    // 排序
    function litterSort(data) {
        for (var i = 0; i < data.length; i++) {
            for (var j = 0; j < data.length; j++) {
                if (data[i].litter < data[j].litter) {
                    var temp = data[i];
                    data[i] = data[j];
                    data[j] = temp;
                }
            }
         }
         for (var i = 0; i < data.length; i++) {
            // console.log("letter+++:"+data[i].litter)
             data[0].flag = data[0].litter[0]
             // data[i].flag = data[i].litter[0]
             
            if (i>0) {
                if (data[i].litter[0] !== data[i-1].litter[0]) {
                    // console.log("letter+++:"+data[i].litter)
                    data[i].flag = data[i].litter[0];
                    // console.log("flag+++:"+data[i].flag)
                }
            }
         }
        // console.log('数据：'+JSON.stringify(data))
        var arr = {}
        var a;
        for (var i = 0; i < data.length; i++) {
            
            if (data[i].flag) {
                arr[data[i].flag] = [];
                a = i;
            } 
            // if (data[a].flag ) {
                
            // }
            arr[data[a].flag].push (data[i])
        }
        console.log(JSON.stringify(arr))
        return arr;
    }

   
    



    function dakai(data1) {
        var hei = $api.offset($api.dom('.main_no1')).h * 2 + $api.offset($api.dom('.wrap')).h; 
        listContact.open({
                x : 0,
                y : hei,
                w : api.frameWidth,
                h : api.frameHeight - hei,
                bgColor: '#EFEFF4',
                // 分割线颜色
                borderColor: '#EDEDED',
                // rightBtn: [{
                //     color: '#000',
                //     title: '备注'
                // },{
                //     color: '#000',
                //     title: '删除'
                // }],
                imgHeight: 32,
                groupTitle: {
                    color: '#999',       
                    size: 14,   
                    bgColor: '#EFEFF4'
                },
                rightBg: '#fff',
                // 侧滑
                indicator: {
                    bgColor: 'rgba(0,0,0,0)',
                    color: '#5A5A5A'
                },
                cellBgColor: '#fff',
                // 搜索框
                // searchBar: {},
                data: data1,
                fixedOn: api.frameName
            }, function(ret, err) {
                if (ret) {
                    // alert(JSON.stringify(ret));
                } else {
                    // alert(JSON.stringify(err));
                }
            });
    }
  
   function  txl() {
        contacts.select(function(ret, err) {
            if (ret) {
                // alert(JSON.stringify(ret));
            } else {
                // alert(JSON.stringify(err));  
            }
        });
    }

    function sqlSyntax(data1) {
        var SQLName = 'db_'+$api.getStorage('userName');
        var SQL = 'INSERT INTO addressList (user_id,nickname,head_img_url,current_company,current_position,type) VALUES '
        for (var i = 0; i < data1.length; i++) {
            data1[i]
            SQL += '("'+ data1[i].user_id +'","'+ data1[i].nickname +'","'+ data1[i].head_img_url +'","'+ data1[i].current_company +'","'+ data1[i].current_position+ '",3),'
        }
        SQL = SQL.substring(0,SQL.length-1) + ';'
        console.log(SQL)
        db.executeSql({
            name: SQLName,
            sql: SQL
        }, function(ret, err) {
            if (ret.status) {
                alert('正确'+JSON.stringify(ret));
            } else {
                console.log('错误:' + JSON.stringify(err))
            }
        });
    }

    // 查询数据库
    function query() {
         var SQLName = 'db_'+$api.getStorage('userToken');
        // 查询数据库
        db.selectSql({
            name: SQLName,
            // sql: 'SELECT * FROM addressList'  // 查询所有数据
            sql: 'SELECT * FROM addressList'
        }, function(ret, err) {
            console.log('查询到的数据:'+JSON.stringify(ret))
            if (ret.status) {
                // setTimeout(function(){
                //     if (ret.data=='') {
                //         query();
                //     }
                // },1)
                dakai(paixv(ret.data))
            } else {
                console.log(JSON.stringify(err));
            }
        });
    }


function paixv (data) {
    for (var i = 0; i < data.length; i++) {
            // console.log("letter+++:"+data[i].litter)
             data[0].initial = data[0].flag
             // data[i].flag = data[i].litter[0]
             
            if (i>0) {
                if (data[i].flag !== data[i-1].flag) {
                    // console.log("letter+++:"+data[i].litter)
                    data[i].initial = data[i].flag;
                    // console.log("flag+++:"+data[i].flag)
                }
            }
         }
        // console.log('数据：'+JSON.stringify(data))
        var arr = {}
        var a;
        for (var i = 0; i < data.length; i++) {
            
            if (data[i].initial) {
                arr[data[i].initial] = [];
                a = i;
            } 
            // if (data[a].initial ) {
                
            // }
            arr[data[a].initial].push (data[i])
        }
        console.log('处理完的数据:'+JSON.stringify(arr))
        return arr;
    }
    </script>
</body>

</html>
