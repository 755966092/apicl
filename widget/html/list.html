<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>我在</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <style>
        html,body {
            height: 23rem;
            background-color: #fff;
        }
    </style>
</head>
<body >
    <script type="text/javascript" src="../script/common.js"></script>
    <script type="text/javascript" src="../script/jquery.min.js"></script>
    <script type="text/javascript" src="../script/api.js"></script>
    <script type="text/javascript">
    var letterArr = [],letterObj = [];
    apiready = function() {
        moduleInit(); 
        initPage();
        api.addEventListener({
            name: 'editUserInfo'
        }, function(ret, err) {
            if (ret) {
                query();
            } else {
                alert(JSON.stringify(err));
            }
        });
    }
    // doT模版获取数据
    function getData(data, htmlStr) {
            $api.html($api.dom('.slidePage div'), $api.getStorage('frame1SlideBar'));
            var list = $api.dom('.resultList');
            var listTText = $api.byId('listT').text;
            var fnListT = doT.template(listTText);
            var html = fnListT(data);
            $api.html(list, html);
            $api.css($api.dom('.loading'), 'display:none');
    }
    function createFile() {
        fs.exist({
            path: 'widget://html/frame1.html'
        }, function(ret, err) {
            if (ret.exist) {
                    console.log(JSON.stringify(ret))
                    // 存在打开
                    openFile();
            } else {
                // 不纯在新建
                createFile_1();
            }
        });
        
    }
    function createFile_1() {
        fs.createFile({
            path: 'widget://html/frame1.html'
        }, function(ret, err) {
            if (ret.status) {
                console.log('518:::'+JSON.stringify(ret));
                openFile();
            } else {
                console.log('541:::'+JSON.stringify(err));
            }
        });
    }
    function openFile() {
         fs.open({
                path: 'widget://html/frame1.html',
                flags: 'read_write'
            }, function(ret, err) {
                if (ret.status) {
                    var htmlStr = $api.html($api.dom('html'));
                    htmlStr = htmlStr.replace('initPage();','')
                    fs.write({
                        fd: ret.fd,
                        data: '<html>'+ htmlStr +'</html>',
                    }, function(ret, err){        
                        if( ret.status ){
                            console.log('531:::'+ JSON.stringify( ret ) );
                        }else{
                            console.log('533:::'+ JSON.stringify( err ) );
                        }
                    });
                } else {
                    console.log('537:::'+JSON.stringify(err));
                }
            });
    }
    function initPage() {
        setTimeout(function () {
            db.selectSql({
                name: 'db_'+$api.getStorage('userToken'),
                sql: 'SELECT * FROM addressList_simplify WHERE type IN (1,2,3,4) order by flag asc',
            }, function(ret, err){  
                if( ret.status ){
                    if (ret.data.length != 0) {
                        // sortData(ret.data)
                        setTimeout(function () {
                            dakai(paixv(ret.data));
                        },1)
                    } else {
                        setTimeout(function () {
                            query();
                        },1)
                    }
                }else{
                    alert('292'+ JSON.stringify( err ) );
                }
            });
        },1)
    }
    function move() {
        event.preventDefault();
        //  获取开始点击的位置
        //  每滑动一个a标签的高度切换一个锚点
        anchorJump(document.elementFromPoint(event.changedTouches[0].clientX,event.changedTouches[0].clientY))
    }
    function anchorJump(n) {
        event.stopPropagation();
        event.preventDefault();
        var text = $api.text(n);
        if (text.length < 2) {
            // $api.css($api.dom('.letter'), 'display: block');
            // $api.css($api.dom('.letter'), 'opacity: 1');
            // $api.text($api.dom('.letter'), text);
            // location.hash = '#' + text;
            $("html,body").animate({scrollTop:$("#"+text).offset().top}, 1);
            return false;
            // setTimeout(function () {
            //     $api.css($api.dom('.letter'), 'display: none');
            // },1500)

        }
    }
    function anchorJump1(n) {
        // location.hash = '#' + n
        $("#"+n).animate({scrollTop:$("#"+n).offset().top}, 500);
    }
    // 数据排序
    function sortData(data) {
        // for (var i = 0; i < data.length; i++) {
        //     for (var j = 0; j < data.length; j++) {
        //         if (data[i].flag < data[j].flag) {
        //             var temp = data[i];
        //             data[i] = data[j];
        //             data[j] = temp;
        //         }
        //     }
        //  }
        for (var i = 0; i < data.length; i++) {
            if (i>0) {
                if (data[i].flag !== data[i-1].flag) {
                    if (f_check_uppercase(data[i].flag)) {
                        data[i].flagLetter = data[i].flag;
                        letterArr.push(data[i].flag)
                    } else {
                        // data[i].flagLetter = '#';
                        // letterArr.push('#')
                    }
                }
            } else {
                if (f_check_uppercase(data[0].flag)) {
                    letterArr.push(data[0].flag);
                    data[0].flagLetter = data[0].flag
                 } else {
                    letterArr.push('#')
                    data[0].flagLetter = '#'
                 }
            }
         }
         // 侧边栏
         var str = '' ;
         for (var i = 0; i < letterArr.length; i++) {
            str += '<span ontouchstart="anchorJump(this)"  >'+ letterArr[i] +'</span>'
         }
            $api.setStorage('frame1SlideBar', str);
            // getData(data)
            // dakai(data)
            console.log('703:::'+data.length)
    }
    function insertOneSql(type,str) {
        str = $api.jsonToStr(str);
        db.executeSql({
            name: SQLName,
            sql: "INSERT OR REPLACE INTO addressList_one (type, str) VALUES ("+ type +",'"+ str +"')"    
        }, function(ret, err){        
            if( ret.status ){
                console.log('缓存成功')
            }else{
                // alert('756:'+ JSON.stringify( err ) );
            }
        });
    }
    // 选中好友
    function selPerson(ele) {
        // var sel = ele.getElementsByClassName('sel')[0];
        // if ($api.hasCls(sel, 'pitchOn')) {
        //     $api.removeCls(sel, 'pitchOn');
        // } else {
        //     $api.addCls(sel, 'pitchOn');
        // }
        var userId = $api.attr(ele, 'data-id');
        api.openWin({
            name: 'txl_memberInfo_Win',
            url: './addressList/txl_memberInfo_Win.html',
            pageParam: {
                userId: userId
            }
        });
    }

    function function_name() {
            api.openWin({
                name: 'txl_relationSchema_win',
                url: './frame1.html',
                pageParam: {
                    name: 'value'
                }
            });
    }
 
    // 打开一度人脉
    function onceConnected(n,flag) {
        var url;
        if (n == 1) {
            // if (flag == 1) {
            //     url = "txl_listWin_danxiang"
            // } else if (flag == 2) {
            //     url = "txl_listWin_shuangxiang"
            // } else if (flag == 3) {
            //     url = "txl_listWin_you"
            // } else if (flag == 4) { 
            //     url = "txl_listWin_chushi"
            // } else {
            //     url = 'txl_listWin'
            // }
                url = 'txl_listWin'
        } else if (n == 2) {
            url = 'txl_listWin_2'
        } else {
            url = 'txl_listWin_3'
        }
        console.log(url)
        api.openWin({
            name: 'listWin_' + url,
            url: './addressList/'+ url +'.html',
            pageParam: {
                userToken: api.pageParam.userToken,
                headerH: headerH,
                flag: flag
            },
            slidBackEnabled: false,
            bounces: false
        });
    }
    // 打开初始好友
    function contactFriend () {
        api.openWin({
            name: 'txl_contactFriend_win',
            url: './addressList/txl_contactFriend_win.html',
            bounces: false,
            pageParam: {
                headerH: headerH
            }
       });   
    }

    function dakai(data1) {
         listContact.open({
            x: -1000,
            y: -1000,
            w: 5,
            h: 5,
            data: [],
            fixedOn: api.frameName
        },function(ret,err){
        })
        listContact.close();
        listContact.open({
                x : 0,
                y : api.pageParam.heightY,
                w : api.frameWidth,
                h : 550,
                bgColor: '#EFEFF4',
                // 分割线颜色
                borderColor: '#EDEDED',
                // rightBtn: [{
                //     color: '#000',
                //     title: '备注'
                // },{
                //     color: '#000',
                //     title: '删除'
                // }],
                imgHeight: 32,
                groupTitle: {
                    color: '#999',       
                    size: 14,   
                    bgColor: '#EFEFF4'
                },
                rightBg: '#fff',
                // 侧滑
                indicator: {
                    bgColor: 'rgba(0,0,0,0)',
                    color: '#5A5A5A'
                },
                cellBgColor: '#fff',
                // 搜索框
                // searchBar: {},
                data: data1,
                fixedOn: 'frame1',
                fixed: false
            }, function(ret, err) {
                if (ret) {
                    // alert(JSON.stringify(ret))
                    console.log(JSON.stringify(data1[ret.key][ret.index]));
                    addFriends(data1[ret.key][ret.index].user_id);
                } else {
                    // alert(JSON.stringify(err.msg));
                }
            });
            $api.css($api.dom('.loading'), 'display: none');
    }
     // 打开人脉详情
    function addFriends(userId) {
        api.openWin({
            name: 'txl_memberInfo_Win',
            url: './addressList/txl_memberInfo_Win.html',
            pageParam: {
                userId: userId
            }
        });
    }
    function f_check_uppercase(obj)   {          
       if (/[A-Z]/.test(obj))    {   
          return true;   
       }    
       return false;   
    }
    // 查询数据库
    function query() {
        var SQLName = 'db_'+$api.getStorage('userToken');
        // 查询数据库
        db.selectSql({
            name: SQLName,
            sql: 'SELECT * FROM addressList_simplify order by flag asc'
        }, function(ret, err) {
            // console.log('查询到的数据:' + JSON.stringify(ret))
            if (ret.status) {
                // setTimeout(function(){
                //     if (ret.data=='') {
                //         query();
                //     }
                // },1)
                // 
                // console.log('frame1::::::'+JSON.stringify(ret))
                // if (ret.data.length === 0) {
                //     // console.log('暂无数据')
                //     query();
                // } else {
                    // console.log('有数据')
                    // dakai(paixv(ret.data))
                    setTimeout(function () {
                        sortData(ret.data);
                    },1)
                // }
            } else {
                // console.log(JSON.stringify(err));
            }
        });
    }
   function paixv (data) {
        // for (var i = 0; i < data.length; i++) {
        //     for (var j = 0; j < data.length; j++) {
        //         if (data[i].litter < data[j].litter) {
        //             var temp = data[i];
        //             data[i] = data[j];
        //             data[j] = temp;
        //         }
        //     }
        // }
        for (var i = 0; i < data.length; i++) {
            data[i].placeholderImg = "widget://image/icon_defaultHead.png";
            if (f_check_uppercase(data[0].flag)) {
                data[0].initial = data[0].flag;
            } else {
                data[0].initial = '#';
            }
            if (i>0) {
                if (data[i].flag !== data[i-1].flag) {
                    if (f_check_uppercase(data[i].flag)) {
                        data[i].initial = data[i].flag;
                    } else {
                        data[i].initial = '#';
                    }
                }
            }
        }
        var arr = {}
        var a;
        for (var i = 0; i < data.length; i++) {
            data[i].subTitle = '副标题';
            data[i].titleSize = 15;
            data[i].subTitleColor = '#999'

            if (data[i].initial) {
                if (data[i].initial == '#') {
                    if (arr[data[i].initial]) {
                    } else {
                        arr[data[i].initial] = [];
                    }
                    a = i;
                } else {
                    arr[data[i].initial] = [];
                    a = i;
                }
            } 
            // if (data[a].initial ) {
                
            // }
            arr[data[a].initial].push (data[i])
        }
        return arr;
    }
    </script>
</body>

</html>
