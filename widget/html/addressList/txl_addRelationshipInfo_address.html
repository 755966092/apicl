<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"
    />
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/weui.css" />
</head>

<body>
    <header class="header">
        <div class="head">
            <span class="callback" tapmode onclick="api.closeWin()">
                返回
            </span>
            <span class="winTitle">
                认识情况
            </span>
            <span class="rightBtn" tapmode onclick="addF()">保存</span>
        </div>
    </header>
    <div class="weui-cells__title">认识时间</div>
    <div class="weui-cells">
        <a class="weui-cell weui-cell_access" href="javascript:;" tapmode onclick="selDate(this)">
            <div class="weui-cell__bd">
                <p id="date">选择时间</p>
            </div>
            <div class="weui-cell__ft">
            </div>
        </a>
    </div>
    <div class="weui-cells__title">认识地点</div>
    <div class="weui-cells">
        <a class="weui-cell weui-cell_access" href="javascript:;" tapmode onclick="openMap()">
            <div class="weui-cell__bd">
                <p id="address">选择地点</p>
                <p id="address1" style="font-size:.28rem;color:#999">选择地点</p>
            </div>
            <div class="weui-cell__ft">
            </div>
        </a>
    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
var  addressObj= {};
    apiready = function () {
        fnInit();
        moduleInit();
        listenerEvent();
        initPage()
    };
    function initPage() {
        var data = api.pageParam.relation_info;
        $api.text($api.byId('date'), data.know_time||"选择时间");
        $api.text($api.byId('address'), data.know_place||'相识地点');
        $api.text($api.byId('address1'), data.konw_address||'相识地点');
    }
    function listenerEvent() {
        api.addEventListener({
            name: 'sendAddressPosition'
        }, function (ret, err) {
            addressObj = ret.value.positionObj
            $api.text($api.byId('address'), addressObj.name);
            $api.text($api.byId('address1'), addressObj.address);
        });
    }
    function addF() {
        if ($api.text($api.byId('date')) == '选择时间') {
            api.toast({
                msg: '请选择时间',
                duration: 2000,
                location: 'bottom'
            });
        } else if (!addressObj.name&&!api.pageParam.relation_info) {
            api.toast({
                msg: '请选择地址',
                duration: 2000,
                location: 'bottom'
            });
        } 
        else {
            var obj = {
                konw_address: addressObj.address || api.pageParam.relation_info.konw_address,
                token: $api.getStorage('userToken'),
                know_place: addressObj.name || api.pageParam.relation_info.know_place,
                know_time: $api.text($api.byId('date')).replace(/[年月]/g, '-'),
                relation_user_id: api.pageParam.userId,
                place_longitude: addressObj.lon || api.pageParam.relation_info.place_longitude,
                place_latitude: addressObj.lat || api.pageParam.relation_info.place_latitude
            }
            api.ajax({
                url: apiSite + '/RelationUser/editRelation',
                method: 'post',
                headers: apiHeader,
                data: {
                    values: obj
                }
            }, function (ret, err) {
                if (ret) {
                    if (ret.code === 200) {
                        api.sendEvent({
                            name: 'addRelation'
                        });
                        api.closeToWin({
                            name: 'txl_relationshipWin',
                            animation: {
                                type: 'flip',
                                subType: 'from_bottom',
                                duration: 500
                            }
                        });
                    } else {
                        alert(ret.msg)
                    }
                } else {
                    alert(err.msg)
                }
            })
        }
        

    }
     // 打开时间选择器
    function selDate(ele) {
        var date, date1, date2;
        var current = $api.text($api.byId('date'));
        if (current != '请选择') {
            current = current.replace(/[年月]/g,'-').split('-')
            date = current[0];
            date1 = current[1];
            date2 = current[2];
        } else 　{
            date = new Date().getFullYear();
            date1 = new Date().getMonth();
            date2 = new Date().getDate();
        }
        api.openPicker({
            type: 'date',
            date: date + '-' + date1 + '-' + date2,
            maxDate: new Date().toLocaleDateString().replace(/\//g, '-'),
            title: '选择时间'
        }, function (ret, err) {
            if (ret) {
                $api.text($api.byId('date'), ret.year + '年' + ret.month + '月' + ret.day);
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }
    // 打开地图
    function openMap() {
        var obj ;

            if (api.pageParam.relation_info) {
                obj = {
                    key: 'txl_addRelationshipInfo_address',
                    lon: api.pageParam.relation_info.place_longitude || '',
                    lat: api.pageParam.relation_info.place_latitude || ''
                }
            } else {
                 obj = {
                    key: 'txl_addRelationshipInfo_address',
                }
            }
        api.openWin({
            name: 'map_win',
            url: '../news/map_win.html',
            bounces: false,
            pageParam: obj
        });
    }
</script>

</html>