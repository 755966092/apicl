<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/flex.css"/>
    <style type="text/css">
        .main {
            margin-top: .36rem;
        }
        .headImg {
            height: 1.42rem;
            background-color: #fff;
            font-size: 0;
            padding: 0 .36rem;
        }
        .headImg span {
            font-size: .3rem;
        }
        .headImg img {
            width: 1.07rem;
            height: 1.07rem;
            border-radius: .08rem;
        }
        .icon {
            width: .15rem;
            height: .25rem;
            background: url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            margin-left: .2rem;
        }
        .sex {
            width: 7.5rem;
            height: .8rem;
            font-size: .3rem;
            line-height: .8rem;
            padding: 0 .36rem;
            background: #fff url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: 6.94rem center;
        }
        .name {
            font-size: 0;
        }
        p {
            font-size: .24rem;
            color: #999;
            text-align: left;
            padding: 0 .36rem;
            line-height: .6rem;
        }
        input {
            width: 7.5rem;
            background-color: #fff;
            height: .8rem;
            padding: 0 .36rem;
            outline: none;
            font-size: .3rem;
        }
        .btn {
            width: 6.785rem;
            height: .841rem;
            border-radius: .06rem;
            background-color: #1AAD19;
            border: .01rem solid #189c17;
            margin: 0 auto;
            line-height: .841rem;
            text-align: center;
            font-size: .34rem;
            color: #fff;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
    </style>   
</head>
<body>
    <div class="main">
       <div class="headImg flex-def flex-cCenter flex-zBetween" ontouchstart="openHeadPage()">
           <span class="text">头像</span>
           <div class="flex-def flex-cCenter">
               <img src="../../image/tx_1.jpg">
                <span class="icon"></span>
           </div>
       </div>
       <div class="name">
           <p>真实姓名</p>
           <input class="realName" type="text" name="">
       </div>
       <div class="name">
           <p>昵称</p>
           <input class="nickName" type="text" name="">
       </div>
       <div class="name" ontouchstart="selectList(this)">
            <p>性别</p>
            <span class="sex"></span>
       </div>
       <div class="btn" ontouchstart="conserve()">保存</div>
    </div>
  
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/pinyin4js.js"></script>
<script type="text/javascript">
    apiready = function(){
        moduleInit();
        initPage();
        requireData();
    };
    // 初始化页面
    function initPage() {
         db.selectSql({
            name: 'db_'+$api.getStorage('userToken'),
            sql: 'SELECT * FROM addressList where user_id=' + api.pageParam.userId
        }, function(ret, err){        
            if( ret.status ){
                console.log( '通讯录数据库:::::'+JSON.stringify( ret ) );
            }
        })
         db.selectSql({
                name: 'db_'+$api.getStorage('userToken'),
                sql: 'SELECT * FROM tb_remarks_user_info where remark_user_id=' + api.pageParam.userId
            }, function(ret, err){        
                if( ret.status ){
                        console.log('124:::'+JSON.stringify(ret));
                    if(ret.data.length != 0){
                        $api.attr($api.dom('img'), 'src', ret.data[0].head_img_url||'');
                        $api.val($api.dom('.realName'), ret.data[0].realName||'');
                        $api.val($api.dom('.nickName'), ret.data[0].nickname||'');
                        $api.text($api.dom('.sex'), ret.data[0].sex==1?'男':'女');
                    } else {
                        $api.attr($api.dom('img'), 'src', api.pageParam.paramHeadImg);
                        $api.val($api.dom('.realName'), api.pageParam.paramRealName);
                        $api.val($api.dom('.nickName'), api.pageParam.paramNickname);
                        $api.text($api.dom('.sex'), api.pageParam.paramSex==1?'男':'女');
                        }
                }
            })
    }
    // 打开选择头像页面
    function openHeadPage() {
        api.openWin({
            name: 'txl_addFellow_detailsHead_win',
            url: './txl_addFellow_detailsHead_win.html',
            pageParam: {
                name: api.pageParam.paramHeadImg
            }
        });
    }
    // 保存上传数据
    function conserve() {
        // head_img_url    string  头像
        // real_name   string  真实姓名
        // nickname    string  昵称
        // sex int 性别（1-男，2-女）
        var head_img_url = $api.attr($api.dom('img'), 'src'),
            real_name = $api.val($api.dom('.realName')),
            nickname = $api.val($api.dom('.nickName')),
            sex = $api.text($api.dom('.sex')) == '男'? 1 : 2;
        if ((head_img_url == api.pageParam.paramHeadImg) && (real_name === api.pageParam.paramRealName) && (nickname === api.pageParam.paramNickname) && (sex == api.pageParam.paramSex)) {
            // 没修改不提交
        } else {
            console.log(head_img_url+'--'+real_name+'--'+nickname)
            api.ajax({
                url: apiSite + '/api/remark_user/editBasicInfo',
                method: 'post',
                headers: apiHeader,
                data: {
                       values: { 
                            token: $api.getStorage('userToken'),
                            remark_user_id: api.pageParam.userId,
                            head_img_url: head_img_url,
                            real_name: real_name,
                            nickname: nickname,
                            sex: sex
                       }
                }
            }, function(ret, err) {
            if(ret) {
                if(ret.code == 200) {
                    
                    alert(JSON.stringify(ret));
                    api.ajax({
                        url: apiSite + '/api/remark_user/fullInfo',
                        method: 'post',
                        headers: apiHeader,
                        data: {
                              values: { 
                                  token: $api.getStorage('userToken'),
                                  remark_user_id: api.pageParam.userId
                              }
                        }
                    }, function(retWeb, err) {
                        if(retWeb) {
                            console.log('網絡數據:::::'+JSON.stringify(retWeb))
                            db.selectSql({
                                name: 'db_'+$api.getStorage('userToken'),
                                sql: 'SELECT * FROM addressList where user_id=' + api.pageParam.userId
                            }, function(ret, err){        
                                if( ret.status ){
                                    console.log( '通讯录数据库:::::'+JSON.stringify( ret ) );
                                    // 备注后的昵称姓名, 转换为拼音
                                    var letter =  PinyinHelper.getShortPinyin(retWeb.data.info.nickname).toUpperCase();
                                    db.executeSql({
                                        name: 'db_'+$api.getStorage('userToken'),
                                        sql: 'UPDATE addressList SET nickname = "'+ retWeb.data.info.nickname +'",head_img_url = "'+ retWeb.data.info.head_img_url +'", title = "'+ retWeb.data.info.nickname +'", sex = "'+ retWeb.data.info.sex  +'" WHERE user_id = ' + api.pageParam.userId
                                    }, function(ret, err){        
                                        if( ret.status ){
                                            console.log('688:' + JSON.stringify( ret ) );
                                            api.execScript({
                                                name: 'main',
                                                frameName: 'frame1',
                                                script: 'query();'
                                            });
                                            // 缓存生日和家乡
                                            var sql = 'INSERT OR REPLACE INTO tb_remarks_user_info(remark_user_id, nickname, real_name, sex, head_img_url)  VALUES (' + api.pageParam.userId+',"'+ retWeb.data.info.nickname+'","'+ retWeb.data.info.real_name+'","'+ retWeb.data.info.sex+'","'+ retWeb.data.info.head_img_url + '")'
                                            db.selectSql({
                                                name: 'db_'+$api.getStorage('userToken'),
                                                sql: 'SELECT * FROM tb_remarks_user_info where remark_user_id=' + api.pageParam.userId
                                            }, function(ret1, err1){        
                                                if( ret1.status ){
                                                    if (ret1.data.length !== 0) {
                                                        console.log(JSON.stringify(ret1))
                                                        console.log('有数据,更新')
                                                        // 有数据 更新
                                                        db.executeSql({
                                                            name: 'db_'+$api.getStorage('userToken'),
                                                            sql: 'UPDATE tb_remarks_user_info SET nickname = "'+ retWeb.data.info.nickname +'",head_img_url = "'+ retWeb.data.info.head_img_url +'", real_name = "'+ retWeb.data.info.real_name +'", sex = "'+ retWeb.data.info.sex +'" WHERE remark_user_id = ' + api.pageParam.userId
                                                        }, function(ret, err){        
                                                            if( ret.status ){
                                                                console.log('688:' + JSON.stringify( ret ) );
                                                                api.sendEvent({
                                                                    name: 'editUserInfo'
                                                                });
                                                                api.closeWin();
                                                            }else{
                                                                alert('690:' + JSON.stringify( err ) );
                                                            }
                                                        });
                                                    } else {
                                                        console.log('没有数据,插入')
                                                        // 没数据 插入新数据
                                                        db.executeSql({
                                                            name: 'db_'+$api.getStorage('userToken'),
                                                            sql: sql  
                                                        }, function(ret, err){        
                                                            if( ret.status ){
                                                               console.log( '684:::'+JSON.stringify( ret ) );
                                                               db.selectSql({
                                                                   name: 'db_'+$api.getStorage('userToken'),
                                                                   sql: 'SELECT * FROM tb_remarks_user_info'
                                                               }, function(ret, err){        
                                                                   if( ret.status ){
                                                                       console.log('209:'+ JSON.stringify( ret ) );
                                                                   }else{
                                                                       alert( JSON.stringify( err ) );
                                                                   }
                                                               });
                                                            }else{
                                                               alert( JSON.stringify( err ) );
                                                           }
                                                        });
                                                    }
                                                }else{
                                                    alert( JSON.stringify( err1 ) );
                                                }
                                            });
                                        }else{
                                            alert('690:' + JSON.stringify( err ) );
                                        }
                                    });
                                }else{
                                    alert( JSON.stringify( err ) );
                                }
                            });



                            
                        } else {
                           alert(JSON.stringify(err))
                        }
                    })
                } else {
                    alert(JSON.stringify(ret.msg))
                }
            } else {
                alert(JSON.stringify(err))
            }
            });
        }
    }
    function requireData() {
        api.ajax({
            url: apiSite + '/api/remark_user/detail',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: { 
                       token: $api.getStorage('userToken'),
                       remark_user_id: api.pageParam.userId
                   }
            }
        }, function(ret, err) {
            if(ret) {
                console.log(JSON.stringify(ret))
            } else {
                alert(JSON.stringify(err.msg))
            }
        })
    }

     // 打开选择器
    function selectList(ele) {
        var selText = $api.text($api.dom('.sex'));
        var active = [];
            _dataSource2 = ['男','女']
            if (_dataSource2.indexOf(selText) == -1) {
                active = [1]
            } else {
                active.push(_dataSource2.indexOf(selText))
            }
            
        var fontsize = 16,rowLength = 5;
        if (api.systemType === 'ios') {
            fontsize = 20;
            rowLength = 7;
        }
        UIActionSelector.open({
            datas: [
                {
                    name: '男'
                },{
                    name: '女'
                }
            ],
            actives: active,
            layout: {
                row: rowLength,
                col: 1,
                height: 30,
                size: fontsize,
                sizeActive: fontsize+2,
                rowSpacing: 5,
                colSpacing: 5,
                maskBg: 'rgba(0,0,0,0.5)',
                bg: '#fff',
                color: '#888',
                colorSelected: '#000'
            },
            animation: true,
            cancel: {
                text: '取消',
                size: 16,
                w: 60,
                h: 40,
                bg: '#eee',
                // bgActive: '#ccc',
                color: '#000',
                // colorActive: '#fff'
            },
            ok: {
                text: '完成',
                size: 16,
                w: 60,
                h: 40,
                bg: '#eee',
                // bgActive: '#ccc',
                color: '#000',
                // colorActive: '#fff'
            },
            title: {
                text: '请选择',
                size: 20,
                h: 40,
                bg: '#F0F0F0',
                color: '#000'
            },
            fixedOn: api.frameName
        }, function(ret, err) {
            if (ret) {
                if (ret.eventType == 'ok') {
                    $api.text($api.dom('.sex'), ret.level1);
                }
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }
</script>
</html>




