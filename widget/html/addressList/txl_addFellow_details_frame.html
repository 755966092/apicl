<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/flex.css" />
    <style type="text/css">
        .main {
            margin-top: .36rem;
        }
        
        .headImg {
            height: 1.42rem;
            background-color: #fff;
            font-size: 0;
            padding: 0 .36rem;
        }
        
        .headImg span {
            font-size: .3rem;
        }
        
        .headImg img {
            width: 1.07rem;
            height: 1.07rem;
            border-radius: .08rem;
        }
        
        .icon {
            width: .15rem;
            height: .25rem;
            background: url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            margin-left: .2rem;
        }
        
        .sex {
            box-sizing: border-box;
            width: 7.5rem;
            height: .8rem;
            font-size: .3rem;
            line-height: .8rem;
            padding: 0 .36rem;
            background: #fff url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: 6.94rem center;
        }
        
        .name {
            font-size: 0;
        }
        
        p {
            font-size: .24rem;
            color: #999;
            text-align: left;
            padding: 0 .36rem;
            line-height: .6rem;
        }
        
        input {
            box-sizing: border-box;
            width: 7.5rem;
            background-color: #fff;
            height: .8rem;
            padding: 0 .36rem;
            outline: none;
            font-size: .3rem;
        }
        
        .btn {
            width: 6.785rem;
            height: .841rem;
            border-radius: .06rem;
            background-color: #1AAD19;
            border: .01rem solid #189c17;
            margin: 0 auto;
            line-height: .841rem;
            text-align: center;
            font-size: .34rem;
            color: #fff;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <div class="main">
        <div class="headImg flex-def flex-cCenter flex-zBetween" tapmode onclick="openHeadPage()">
            <span class="text">头像</span>
            <div class="flex-def flex-cCenter">
                <img id="headImg" src="../../image/tx_1.jpg">
                <span class="icon"></span>
            </div>
        </div>
        <div class="name">
            <p>真实姓名</p>
            <input class="realName" type="text" name="">
        </div>
        <div class="name">
            <p>昵称</p>
            <input class="nickName" type="text" name="">
        </div>
        <div class="name" tapmode onclick="selectList(this)">
            <p>性别</p>
            <span class="sex"></span>
        </div>
        <div class="btn" tapmode onclick="conserve()">保存</div>
    </div>

</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/pinyin4js.js"></script>
<script type="text/javascript">
    apiready = function() {
        moduleInit();
        initPage();
        // // // console.log('参数:::'+JSON.stringify(api.pageParam))
        api.addEventListener({
            name: 'changeHead'
        }, function(ret, err) {
            if (ret) {
                // // // console.log('监听到事件:::'+JSON.stringify(ret))
                $api.attr($api.byId('headImg'), 'src', ret.value.selDate);
            } else {
                alert(JSON.stringify(err));
            }
        });

    };
    // 初始化页面
    function initPage() {
        db.selectSql({
            name: 'db_' + $api.getStorage('userToken'),
            sql: 'SELECT * FROM addressList where user_id=' + api.pageParam.userId
        }, function(ret, err) {
            if (ret.status) {
                // // // console.log('134:::'+JSON.stringify(ret))
                if (ret.data.length != 0) {
                    // 优先备注头像,其次备注头像
                    $api.attr($api.dom('img'), 'src', ret.data[0].remark_head_img_url || ret.data[0].head_img_url);

                    // 优先备注姓名
                    if (!ret.data[0].remark_real_name && ret.data[0].real_name == 'null') {
                        $api.val($api.dom('.realName'), '')
                    } else {
                        $api.val($api.dom('.realName'), ret.data[0].remark_real_name || ret.data[0].real_name);
                    }

                    // 优先备注昵称, 其次自己昵称
                    $api.val($api.dom('.nickName'), ret.data[0].remark_nickname || ret.data[0].nickname);
                    $api.text($api.dom('.sex'), ret.data[0].remark_sex == '' ? (api.pageParam.paramSex) : (ret.data[0].remark_sex == 1 ? '男' : '女'));
                } else {
                    // // // console.log(2222)
                    $api.attr($api.dom('img'), 'src', api.pageParam.paramHeadImg);
                    $api.val($api.dom('.realName'), api.pageParam.paramRealName);
                    $api.val($api.dom('.nickName'), api.pageParam.paramNickname);
                    $api.text($api.dom('.sex'), api.pageParam.paramSex);
                }
            } else {
                // // // console.log(JSON.stringify(ret))
            }
        })
    }
    // 打开选择头像页面
    function openHeadPage() {
        var imgUrl = $api.attr($api.byId('headImg'), 'src');
        api.openWin({
            name: 'txl_addFellow_detailsHead_win',
            url: './txl_addFellow_detailsHead_win.html',
            pageParam: {
                name: imgUrl
            }
        });
    }
    // 保存上传数据
    function conserve() {
        // head_img_url    string  头像
        // real_name   string  真实姓名
        // nickname    string  昵称
        // sex int 性别（1-男，2-女）
        var head_img_url = $api.attr($api.dom('img'), 'src'),
            real_name = $api.val($api.dom('.realName')),
            nickname = $api.val($api.dom('.nickName')),
            sex = $api.text($api.dom('.sex')) == '男' ? 1 : 2;
        if ((head_img_url == api.pageParam.paramHeadImg) && (real_name === api.pageParam.paramRealName) && (nickname === api.pageParam.paramNickname) && (sex == api.pageParam.paramSex)) {
            // 没修改不提交
        } else {
            api.ajax({
                url: apiSite + '/remark_user/editBasicInfo',
                method: 'post',
                headers: apiHeader,
                data: {
                    values: {
                        token: $api.getStorage('userToken'),
                        remark_user_id: api.pageParam.userId,
                        head_img_url: head_img_url,
                        real_name: real_name,
                        nickname: nickname,
                        sex: sex
                    }
                }
            }, function(ret, err) {
                if (ret) {
                    if (ret.code == 200) {
                        api.sendEvent({
                            name: 'editNonFriendsInfo',
                            extra: {
                                flag: api.pageParam.flag,
                            }
                        });
                        uodateRemarkSql();
                    } else {
                        alert(ret.msg)
                    }
                } else {
                    alert(JSON.stringify(err))
                }
            });
        }
    }
    // 提交完成后更新数据库
    function uodateRemarkSql() {
        api.ajax({
            url: apiSite + '/remark_user/fullInfo',
            method: 'post',
            headers: apiHeader,
            data: {
                values: {
                    token: $api.getStorage('userToken'),
                    remark_user_id: api.pageParam.userId
                }
            }
        }, function(retWeb, err) {
            if (retWeb) {
                var litter = PinyinHelper.getShortPinyin(retWeb.data.info.nickname).toUpperCase();
                undateSqlAddressListSimplify(retWeb.data.info.nickname, retWeb.data.info.head_img_url, litter[0])
                db.selectSql({
                    name: 'db_' + $api.getStorage('userToken'),
                    sql: 'SELECT * FROM addressList where user_id=' + api.pageParam.userId
                }, function(ret, err) {
                    if (ret.status) {
                        // 备注后的昵称姓名, 转换为拼音
                        db.executeSql({
                            name: 'db_' + $api.getStorage('userToken'),
                            sql: 'UPDATE addressList SET remark_nickname = "' + retWeb.data.info.nickname + '",remark_head_img_url = "' + retWeb.data.info.head_img_url + '", title = "' + retWeb.data.info.nickname + '", flag = "' + litter[0] + '", litter = "' + litter + '",remark_real_name = "' + retWeb.data.info.real_name + '", remark_sex = "' + retWeb.data.info.sex + '" WHERE user_id = ' + api.pageParam.userId
                        }, function(ret, err) {
                            if (ret.status) {
                                api.execScript({
                                    name: 'listWin',
                                    frameName: 'txl_listWin_frame',
                                    script: 'query();'
                                });
                                api.sendEvent({
                                    name: 'editUserInfo',
                                    extra: {
                                        flag: api.pageParam.flag
                                    }
                                });
                                api.closeWin();
                            } else {
                                alert('690:' + JSON.stringify(err));
                            }
                        });
                    } else {
                        alert(JSON.stringify(err));
                    }
                });
            } else {
                alert(JSON.stringify(err))
            }
        })
    }

    function undateSqlAddressListSimplify(title, head_img_url, flag) {
        db.executeSql({
            name: SQLName,
            sql: 'UPDATE addressList_simplify SET title = "' + title + '",img="' + head_img_url + '",flag="' + flag + '" WHERE user_id =' + api.pageParam.userId
        }, function(ret, err) {
            if (ret.status) {
                api.sendEvent({
                    name: 'editUserInfo',
                });
            } else {
                alert(JSON.stringify(err));
            }
        });
        // 更新聊天记录数据库
        db.executeSql({
            name: SQLName,
            sql: 'UPDATE tb_chat_' + api.pageParam.userId + ' SET head_img_url="' + head_img_url + '" WHERE user_id =' + api.pageParam.userId
        }, function(ret, err) {
            if (ret.status) {
                api.sendEvent({
                    name: 'editUserInfoList',
                    extra: {title: title}
                });
            } else {
                alert('111' + JSON.stringify(err));
            }
        });
        // 更新聊天列表数据库
        db.executeSql({
            name: SQLName,
            sql: 'UPDATE tb_chat_list SET remark_head_img_url="' + head_img_url + '",remark_nickname="'+ title +'" WHERE user_id =' + api.pageParam.userId
        }, function(ret, err) {
            if (ret.status) {
                api.sendEvent({
                    name: 'updateChatList'
                });
            } else {
                alert('111' + JSON.stringify(err));
            }
        });
    }

    function requireData() {
        api.ajax({
            url: apiSite + '/remark_user/detail',
            method: 'post',
            headers: apiHeader,
            data: {
                values: {
                    token: $api.getStorage('userToken'),
                    remark_user_id: api.pageParam.userId
                }
            }
        }, function(ret, err) {
            if (ret) {
                // // // console.log(JSON.stringify(ret))
            } else {
                alert(JSON.stringify(err.msg))
            }
        })
    }

    // 打开选择器
    function selectList(ele) {
        var selText = $api.text($api.dom('.sex'));
        var active = [];
        _dataSource2 = ['男', '女']
        if (_dataSource2.indexOf(selText) == -1) {
            active = [1]
        } else {
            active.push(_dataSource2.indexOf(selText))
        }

        var fontsize = 16,
            rowLength = 5;
        if (api.systemType === 'ios') {
            fontsize = 20;
            rowLength = 7;
        }
        UIActionSelector.open({
            datas: [{
                name: '男'
            }, {
                name: '女'
            }],
            actives: active,
            layout: {
                row: rowLength,
                col: 1,
                height: 30,
                size: fontsize,
                sizeActive: fontsize + 2,
                rowSpacing: 5,
                colSpacing: 5,
                maskBg: 'rgba(0,0,0,0.5)',
                bg: '#fff',
                color: '#888',
                colorSelected: '#000'
            },
            animation: true,
            cancel: {
                text: '取消',
                size: 16,
                w: 60,
                h: 40,
                bg: '#eee',
                // bgActive: '#ccc',
                color: '#000',
                // colorActive: '#fff'
            },
            ok: {
                text: '完成',
                size: 16,
                w: 60,
                h: 40,
                bg: '#eee',
                // bgActive: '#ccc',
                color: '#000',
                // colorActive: '#fff'
            },
            title: {
                text: '请选择',
                size: 20,
                h: 40,
                bg: '#F0F0F0',
                color: '#000'
            },
            fixedOn: api.frameName
        }, function(ret, err) {
            if (ret) {
                if (ret.eventType == 'ok') {
                    $api.text($api.dom('.sex'), ret.level1);
                }
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }
</script>

</html>