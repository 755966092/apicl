<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/weui.css" />
    <style type="text/css">
       
        
        .loading {
            width: .8rem;
            height: .8rem;
            background: url(../../image/loading_more.gif)no-repeat;
            background-size: .8rem .8rem;
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
            margin: auto;
        }
        .loading {
            width: .8rem;
            height: .8rem;
            background: url(../../image/loading_more.gif)no-repeat;
            background-size: .8rem .8rem;
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
            margin: auto;
        }

        img {
            width: .55rem;
            margin-right: .15rem;
            display: block;
            height: .55rem;
        }

        .weui-cell__bd {
            font-size: 0.28rem;
        }
    </style>
</head>

<body>
    <div class="loading"></div>
    <div class="resultList"></div>
    <script type="text/x-dot-template" id="listT">
         <div class="weui-cells">
            {{~it:value:index}}
                <a class="weui-cell weui-cell_access" href="javascript:;" tapmode onclick="addFriends(this)"
                        data-id="{{=value.user_id}}">
                    <div class="weui-cell__hd">
                        {{?value.remark_head_img_url}}
                            <img src="{{=value.remark_head_img_url}}"> 
                        {{??}}
                            <img src="{{=value.head_img_url}}"> 
                        {{?}} 
                    </div>
                    <div class="weui-cell__bd">
                        {{?value.remark_nickname}}
                            <p>{{=value.remark_nickname}}</p> 
                        {{??}}
                            <p>{{=value.nickname}}</p> 
                        {{?}}
                    </div>
                </a> 
            {{~}}
        <div>
    </script>
    <p data-type='1' class="no1 hide">暂无三度好友</p>
    <p data-type='2' class="no2 hide">暂无尚未加入</p>
    <p data-type='3' class="no3 hide">暂无三度人脉</p>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript" src="../../script/pinyin4js.js"></script>
<script type="text/javascript">
    var pageNum = 1,
        dataArr = [],
        webFlag = 1,
        contactsCount,
    apiready = function() {
        contactsCount = $api.getStorage('contactCount');
        moduleInit();
        requireData();
        scrollToBottom();
        
    };
    function scrollToBottom() {
        // 上啦加载
        api.addEventListener({
            name: 'scrolltobottom'
        }, function (ret, err) {
            if (webFlag == 1) {
                webFlag = 0;
                requireData();

            } else {
            }
        });
        api.addEventListener({
            name: 'editNonFriendsInfo'
        }, function (ret, err) {
            if (ret) {
                pageNum = 1;
                dataArr = [];
                if (ret.value.flag) {
                    requireData();
                } else {
                    requireData();
                }
            } else {
                alert(JSON.stringify(err));
            }
        });
    }
    // 网络获取数据
    function requireData(classify,n) {
        var url;
        var flag;
        if (api.pageParam.flag === 1) {
            flag = 'lev3_available'
            url = '/contact/levelThreeAvailable';
        } else if (api.pageParam.flag === 2) {
            flag = 'lev3_unavailable'
            url = '/contact/levelThreeUnavailable'
        } else {
            flag = 'lev3'
            url = '/contact/levelThree'
        }
        api.ajax({
            url: apiSite + url,
            method: 'post',
            headers: apiHeader,
            timeout: 10000,
            data: {
                values: {
                    token: $api.getStorage('userToken'),
                    page_num: pageNum
                }
            }
        }, function(ret, err) {
            if (ret) {
                $api.css($api.dom('.loading'), 'display:none');
                if (ret.code == 200) {
                    if (ret.data.list.length>0) {
                        pageNum++;
                        dataArr = dataArr.concat(ret.data.list);
                        getData(dataArr);
                        contactsCount[flag] -= 20;
                        if (contactsCount[flag] <= 0) {
                        } else {
                            api.toast({
                                msg: '还有' + contactsCount[flag] + '位人脉未显示哦',
                                duration: 2000,
                                location: 'bottom'
                            });
                        }
                        webFlag = 1;
                    } else {
                        if (api.pageParam.flag === 1) {
                            $api.css($api.dom('p.no1'), 'display:block');
                        } else if (api.pageParam.flag === 2) {
                            $api.css($api.dom('p.no2'), 'display:block');
                        } else {
                            $api.css($api.dom('p.no3'), 'display:block');
                        }
                    }
                } else {
                    alert(ret.msg)
                }
            } else {
                alert(JSON.stringify(err.msg))
            }
        })
    }
    // 打开人脉详情
    function addFriends(ele) {
        var userId = $api.attr(ele, 'data-id');
         var name = $api.text($api.dom(ele, 'p'));
        var headImg = $api.attr($api.dom(ele, 'img'), 'src');
        api.openWin({
            name: 'txl_memberInfo_Win',
            url: './txl_memberInfo_Win.html',
            pageParam: {
                userId: userId,
                flag: api.pageParam.flag,
                name: name,
                headImg: headImg,

            }
        });
    }
</script>

</html>