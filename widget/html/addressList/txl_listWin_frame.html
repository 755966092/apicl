<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/flex.css"/>
    <style type="text/css">
        .search {
            height: .791rem;
            width: 100%;
            background-color: #EFEFF4;
            box-sizing: border-box;
            padding: .14rem .16rem;
            font-size: 0;   
            position: relative;

        }
        .search input {
            background-color: #fff;
            height: .503rem;    
             /*width: 6.4rem;*/
            width: 100%;
            float: left;
            font-size: .24rem;
            outline: none;
            text-align: center;
            padding: 0 .3rem;
            box-sizing: border-box;
        }
        .sxIcon {
            display: inline-block;
            width: .64rem;
            height: .5rem;
            background: url(../../image/icon_supply/icon_sx.png)no-repeat;
            -webkit-background-size: .35rem .35rem;
            background-size: .35rem .35rem;
            background-position: center center;          
            margin-left: .1rem;
        }
        .searchIcon {
            display: inline-block;
            width: .25rem;
            height: .791rem;
            background: url(../../image/icon_supply/icon_search.png)no-repeat;
            -webkit-background-size: .25rem .26rem;
            background-size: .25rem .26rem;
            background-position: 0 center;
            position: absolute;
            top: 0;
            left: 2.8rem;
        }
        p.nodata {
            text-align: center;
            font-size: .3rem;
            color: #999;
            margin-top: .5rem;
            display: none;
        }
        .loading {
            width: .8rem;
            height: .8rem;
            background: url(../../image/loading_more.gif)no-repeat;
            background-size: .8rem .8rem;
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
            margin: auto;
         }

        /* 手写列表 */

            
            .list {
                background-color: #fff;
            }
            .list .item {
                font-size: 0;
                height: 1.1rem;
                box-sizing: border-box;
                padding: 0 .16rem 0 .16rem;
                overflow: hidden;
                border-bottom: .01rem solid #d9d9d9;

               
            }
            .list .item img {
                margin-right: .1rem;
                width: .62rem;
                height: .62rem;
            }
            .list .item .title {
                width: 5rem;
            }
            .list .item .title .name {
                font-size: .29rem;
                font-weight: 400;
                white-space:nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .list .item .title .position {
                display: inline-block;
                font-size: .24rem;
                max-width: 1.8rem;
                white-space:nowrap;
                color: #999;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .sel {
                display: inline-block;
                width: .44rem;
                height: .44rem;
                background: url(../image/icon_member/icon_cz01.png)no-repeat;
                -webkit-background-size: .44rem .44rem;
                background-size: .44rem .44rem;
                background-position: 0 center;
            }
            .pitchOn {
                background: url(../image/icon_member/icon_cz02.png)no-repeat;
                -webkit-background-size: .44rem .44rem;
                background-size: .44rem .44rem;
                background-position: 0 center;
            }
            .slidePage {
                width: .6rem;
                text-align: right;
                /*background-color: rgba(255,0,0,.5);*/
                position: fixed;
                right: 0;
                top: 0;
                height: 100%;
                font-size: .18rem;
                box-sizing: border-box;
                padding-right: .1rem;
            }
            .slidePage a{
               /* text-align: right;
                box-sizing: border-box;
                display: block;
                padding-right: .1rem;*/
                width: .2rem;
                font-weight: 550;
                margin: .02rem 0;
                text-align: center;
                color: #555;
            }
            .slidePage div {
                width: .2rem;
            }
            .groupTitle {
                font-size: .24rem;
                padding: .08rem .16rem;
                background-color: #F0F0F6;
            }
            .letter {
                position: fixed;
                top: 0;bottom: 0;
                right: 0;left: 0;
                margin: auto;
                border-radius: 50%;
                width: .8rem;
                height: .8rem;
                line-height: .8rem;
                text-align: center;
                font-size: .3rem;
                background-color: rgba(0,0,0,.3);
                display: none;
                /*opacity: 0;*/
            }
            .contactCount {
                text-align: center;
                color: #999;
                font-size: .34rem;
                line-height: 1.1rem
            }
        /* 手写列表 */
   </style>
</head>
<body>
    <div class="search">
        <input type="text" onblur="loseFocus()" onfocus="getFocus()" onkeyup="hideSearIcon(this)" name="" placeholder="搜索">
        <span class="searchIcon"></span>
        <!-- <span class="sxIcon"  tapmode onclick="openSlideBar()"></span> -->
    </div>
    <div class="loading" ></div>
    <p data-type='1' class=" nodata no1">暂无相识好友</p>
    <p data-type='2' class=" nodata no2">暂无熟识好友</p>
    <p data-type='3' class=" nodata no3">暂无尚未加入</p>
    <p data-type='4' class=" nodata no4">暂无初识好友</p>
    <p data-type='5' class=" nodata no5">暂无一度人脉</p>
    <div class="main">
        <div class=" list resultList"></div>
        <script type="text/x-dot-template" id="listT">
        {{ for (var i = 0; i < it.length; i++) { }} 
            {{?it[i].flagLetter}}
                <p id="{{=it[i].flagLetter}}" class="groupTitle">{{=it[i].flagLetter}}</p>
            {{?}}
            <div class="item flex-def flex-cCenter"  data-id="{{=it[i].user_id}}" tapmode   onclick="selPerson(this)" data-val='no1'>
            <!-- <div class="item"   tapmode   onclick="selPerson(this)" data-val='no1'> -->
                <!-- <span class="sel"></span> -->
                <img src="{{=it[i].head_img_url}}">
                <div class="title">
                    <h3 class="name">{{=it[i].nickname}}</h3>
                 
                    {{?it[i].current_company}}
                    <p class="position">{{=it[i].current_company}}&nbsp;</p>
                    {{??}}
                    {{?}}

                    {{?it[i].current_position}}
                    <p class="position">{{=it[i].current_position}}&nbsp;</p>
                    {{??}}
                    {{?}}

                    {{?it[i].current_degree}}
                    <p class="position">{{=it[i].current_degree}}</p>
                    {{??}}
                    {{?}}
                </div>
            </div>
        {{ }; }}
        <p class="contactCount">{{=it.length}}位联系人</p>
        </script>
    </div>
    <div class="slidePage flex-def flex-zTopBottom flex-zCenter flex-cEnd" ontouchmove="move()">
        <div ></div>
    </div>
    <div class="letter"></div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript" src="../../script/pinyin4js.js"></script>
<script type="text/javascript">
    var selVal=0,selectedObj,apiPageParamFlag;
    var letterArr = [],letterObj = [];
    apiready = function(){
        moduleInit();
        // 监听筛选条件
        apiPageParamFlag = api.pageParam.flag;
        api.addEventListener({
            name: 'removeFriend'
        }, function(ret, err) {
            if (ret) {
                requireFriend();
            } else {
                alert(JSON.stringify(err));
            }
        });
        if (apiPageParamFlag == 4) {
            requireFriend();
        } else if(apiPageParamFlag && apiPageParamFlag!= 4) {
            query(apiPageParamFlag);
        } else {
            query()
        }
        addFilter();
        api.addEventListener({
            name: 'editUserInfo'
        }, function(ret, err) {
            if (ret) {
                if(ret.value.flag) {
                    query(ret.value.flag)
                } else {
                    query();
                }
            } else {
                alert(JSON.stringify(err));
            }
        });
        api.addEventListener({
            name: 'delectFriend'
        }, function(ret, err) {
            if (ret) {
                apiPageParamFlag = ret.value.flag
                // // console.log(JSON.stringify(ret));
                query(apiPageParamFlag);
            } else {
                alert(JSON.stringify(err));
            }
        });
    };
    // 初始化页面
    function initPage() {
        // if(apiPageParamFlag) {
        //     // db.selectSql({
        //     //         name: 'db_'+$api.getStorage('userToken'),
        //     //         sql: 'SELECT * FROM addressList_one WHERE type = ' + apiPageParamFlag,
        //     //     }, function(ret, err){        
        //     //         if( ret.status ){
        //     //             if (ret.data.length != 0) {
        //     //                 // // console.log('有数据')
        //     //                 // // console.log(apiPageParamFlag)
        //     //                 dakai($api.strToJson(ret.data[0].str))
        //     //             } else {
        //     //                 // // console.log('无数据')
        //     //                 // // console.log(apiPageParamFlag)
        //     //                 query(parseInt(apiPageParamFlag));
        //     //             }
        //     //         }else{
        //     //             alert('273:'+ JSON.stringify( err ) );
        //     //         }
        //     //     });
            
        // } else {
        //         db.selectSql({
        //             name: 'db_'+$api.getStorage('userToken'),
        //             sql: 'SELECT * FROM addressList_one WHERE type = 1',
        //         }, function(ret, err){        
        //             if( ret.status ){
        //                 if (ret.data.length != 0) {
        //                     // // console.log('有数据')
        //                     // // console.log(apiPageParamFlag)
        //                     dakai($api.strToJson(ret.data[0].str))
        //                 } else {
        //                     // // console.log('无数据')
        //                     // // console.log(apiPageParamFlag)
        //                     query();
        //                 }
        //             }else{
        //                 alert('292'+ JSON.stringify( err ) );
        //             }
        //         });
        // }
        setTimeout(function () {
            var sqlStatement;
            if (!apiPageParamFlag) {
                sqlStatement = 'SELECT str FROM addressList_one WHERE type = 5'
            } else {
                sqlStatement = 'SELECT str FROM addressList_one WHERE type = ' + apiPageParamFlag
            }
            var time = new Date().getTime(),time2;
            db.selectSql({
                name: 'db_'+$api.getStorage('userToken'),
                sql: sqlStatement,
            }, function(ret, err){        
                time2 = new Date().getTime();
                // // console.log('查询时间:'+(time2 - time))
                if( ret.status ){
                    if (ret.data.length != 0) {
                        // // console.log('有数据')
                        dakai($api.strToJson(ret.data[0].str))
                        if (apiPageParamFlag) {
                            query(parseInt(apiPageParamFlag), ret.data[0].str);
                        } else {
                            query(0,ret.data[0].str);
                        }
                    } else {
                        // // console.log('无数据')
                        // // console.log(apiPageParamFlag)
                        if (apiPageParamFlag) {
                            query(parseInt(apiPageParamFlag));
                        } else {
                            query();
                        }
                    }
                }else{
                    alert('292'+ JSON.stringify( err ) );
                }
            });
        },10)
    }
    // 查询缓存数据库
    function searchAddressListOne() {
        var sqlStatement;
        if (!apiPageParamFlag) {
            sqlStatement = 'SELECT * FROM addressList_one WHERE type = 5'
        } else {
            sqlStatement = 'SELECT * FROM addressList_one WHERE type = ' + apiPageParamFlag
        }
        db.selectSql({
            name: 'db_'+$api.getStorage('userToken'),
            sql: sqlStatement,
        }, function(ret, err){        
            if( ret.status ){
                if (ret.data.length != 0) {
                    // // console.log('有数据')
                    dakai($api.strToJson(ret.data[0].str))
                } else {
                    // // console.log('无数据')
                    // // console.log(apiPageParamFlag)
                    if (apiPageParamFlag) {
                        query(parseInt(apiPageParamFlag));
                    } else {
                        query();
                    }
                }
            }else{
                alert('292'+ JSON.stringify( err ) );
            }
        });
    }
    function requireFriend() {
        api.ajax({
                url: apiSite + '/contact/friend',
                method: 'post',
                headers: apiHeader,
                data: {
                       values: { 
                           token: $api.getStorage('userToken'),
                       }
                }
            }, function(retFriend, err) {
                // // console.log('400:'+JSON.stringify(retFriend))
                if(retFriend) {
                    db.selectSql({
                        name: SQLName,
                        sql: 'SELECT * FROM addressList_simplify WHERE type = 4'
                    }, function(retSql, errSql) {
                        if (retSql) {
                            if (retSql.status) {
                                // 网上相识好友和数据库一样多 不更新数据库
                                if (retSql.data.length == retFriend.data.list.length) {
                                    // // console.log('不更新')
                                    query(4);
                                } else {
                                    // // console.log('更新数据')
                                    delSqlType4(retFriend.data.list, 4);
                                    
                                }
                            } else {
                                // alert(JSON.stringify(ret))
                            }
                        } else {
                            alert(JSON.stringify(errSql))
                        }
                    })

                    
                } else {
                    alert(JSON.stringify(err))
                }
            })
    }
    // 删除数据库
    function delSqlType4(data,num) {
        db.executeSql({
            name: SQLName,
            sql: 'DELETE FROM addressList_simplify WHERE type = 4'    
        }, function(ret, err){        
            if( ret.status ){
                disData(data,num)
            }else{
                alert( JSON.stringify( err ) );
            }
        });
    }
     // 处理数据
    function disData (data, type) {
        // // // console.log('disData'+JSON.stringify(data))
        if (data != '' ) {
            for (var i = 0; i < data.length; i++) {
                // single_list
                // both_list
                // friend_list
                // 去除空格
                data[i].nickname = $api.trimAll(data[i].nickname)
                if (data[i].remark_nickname) {
                    data[i].litter = PinyinHelper.getShortPinyin(data[i].remark_nickname).toUpperCase();
                } else {
                    data[i].litter = PinyinHelper.getShortPinyin(data[i].nickname).toUpperCase();
                }
                data[i].title = data[i].nickname;
                data[i].img = data[i].head_img_url;
                data[i].titleSize = 15;
                if (data[i].current_position == null) {
                    data[i].current_position = '';
                } 
                if (data[i].current_company == null) {
                    data[i].current_company = '';
                }
            }
            // 模块数据格式
            litterSort(data, type)
        }
    }
    // 排序
    function litterSort(data,type) {
        for (var i = 0; i < data.length; i++) {
            for (var j = 0; j < data.length; j++) {
                if (data[i].litter < data[j].litter) {
                    var temp = data[i];
                    data[i] = data[j];
                    data[j] = temp;
                }
            }
         }
         sqlSyntax(data, type);
    }
    // 拼数据库语法字符串
    function sqlSyntax(data1, type) {
        for (var i = 0; i < data1.length; i++) {
            data1[i].flag = data1[i].litter[0];
        }
        // // // console.log('数据库语法字符串:'+data1);
        var SQLName = 'db_'+$api.getStorage('userToken');
         var SQL = 'INSERT OR REPLACE INTO addressList(user_id,nickname,head_img_url,current_company,current_position,current_contact,current_degree, titleSize,title,img,flag,litter,type, sex, remark_nickname, remark_real_name, remark_head_img_url, remark_sex, remark_birthday, remark_hometown, remark_current_company, remark_current_position, remark_current_degree, remark_current_contact) VALUES '
            var SQL2 = 'INSERT OR REPLACE INTO addressList_simplify(user_id,title,img,subTitle,current_contact, flag,type) VALUES ';
            for (var i = 0; i < data1.length; i++) {
                var subTitleStr= '',contactStr = '';
                SQL += '('+data1[i].user_id+',"'+ data1[i].nickname +'","'+ data1[i].head_img_url +'","'+ (data1[i].current_company || "") +'","'+ (data1[i].current_position || "")+'","'+ (data1[i].current_contact || "") +'","'+ (data1[i].current_degree || "") +'","'+ data1[i].titleSize +'","'+ data1[i].title +'","'+ data1[i].img+'","'+ data1[i].flag +'","'+ data1[i].litter +'","'+ type +'","'+ (data1[i].sex || 1) +'","'+ (data1[i].remark_nickname || "") +'","'+ (data1[i].remark_real_name || "") +'","'+ (data1[i].remark_head_img_url || "") +'","'+ (data1[i].remark_sex || "") +'","'+ (data1[i].remark_birthday || "") +'","'+ (data1[i].remark_hometown || "") +'","'+ (data1[i].remark_current_company || "") +'","'+ (data1[i].remark_current_position || "") +'","'+ (data1[i].remark_current_degree || "") +'","'+ (data1[i].remark_current_contact || "") +'"),';
                if (data1[i].remark_current_company) {
                    subTitleStr += data1[i].remark_current_company+" "   
                } else if(data1[i].current_company){
                    subTitleStr += data1[i].current_company+" "   
                } else {
                   
                }
                if (data1[i].remark_current_position) {
                    subTitleStr += data1[i].remark_current_position + " "
                } else if (data1[i].current_position) {
                    subTitleStr += data1[i].current_position + " "
                } else {
                   
                }
                if (data1[i].remark_current_degree) {
                    subTitleStr += data1[i].remark_current_degree+" "
                } else if (data1[i].current_degree) {
                    subTitleStr += data1[i].current_degree+" "
                } else {
                   
                }
                if (data1[i].remark_current_contact) {
                    contactStr = data1[i].remark_current_contact;
                } else if(data1[i].current_contact) {
                    contactStr = data1[i].current_contact
                } else {
                    
                }
            // subTitleStr
            SQL2 += '('+data1[i].user_id+',"'+ (data1[i].remark_nickname || data1[i].nickname) +'","'+ (data1[i].remark_head_img_url || data1[i].head_img_url) +'","'+ subTitleStr+'","'+ contactStr +'","'+  data1[i].flag  +'","'+ type  +'"),';            
        }
            SQL = SQL.substring(0,SQL.length-1) + ';'
            SQL2 = SQL2.substring(0,SQL2.length-1) + ';'

        // db.executeSql({
        //      name: SQLName,
        //      sql: 'CREATE UNIQUE INDEX IF NOT EXISTS user_id_idx ON addressList (user_id)'    
        //  }, function(ret, err){        
        //      if( ret.status ){
                // // // console.log( JSON.stringify( ret ) );
                db.executeSql({
                    name: SQLName,
                    sql: SQL2
                }, function(ret, err) {
                    if (ret.status) {
                        query(4);
                        // // console.log('执行语句正确'+JSON.stringify(ret));
                    } else {
                        // // console.log('执行语句错误:' + JSON.stringify(err))
                    }
                });
                db.executeSql({
                    name: SQLName,
                    sql: SQL   
                }, function(ret, err){        
                    if( ret.status ){
                        // // console.log( '插入数据'+JSON.stringify( ret ) );
                    }else{
                        alert( '插入数据:' + JSON.stringify( err ) );
                    }
                });

         //     }else{
         //         alert( '设置唯一索引' + JSON.stringify( err ) );
         //     }
         // });
    }
    function contactFriend(userId) {
        api.ajax({
            url: apiSite + '/contact/friend',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: { 
                       token: $api.getStorage('userToken'),
                   }
            }
        }, function(ret, err) {
            if(ret) {
                // 新添加好友插入数据库
                var SQLName = 'db_'+$api.getStorage('userToken');
                var SQL = 'INSERT OR REPLACE INTO addressList(user_id,nickname,head_img_url,current_company,current_position,current_degree, titleSize,title,img,flag,litter,type, sex, remark_nickname, remark_real_name, remark_head_img_url, remark_sex, remark_birthday, remark_hometown, remark_current_company, remark_current_position, remark_current_degree, remark_current_contact) VALUES '
                for (var i = 0; i < ret.data.list.length; i++) {
                        var litter;
                        if (ret.data.list[i].remark_nickname) {
                            litter =  PinyinHelper.getShortPinyin(ret.data.list[i].remark_nickname).toUpperCase();
                        } else {
                            litter =  PinyinHelper.getShortPinyin(ret.data.list[i].nickname).toUpperCase();
                        }
                        SQL += '('+ret.data.list[i].user_id+',"'+ ret.data.list[i].nickname +'","'+ ret.data.list[i].head_img_url +'","'+ (ret.data.list[i].current_company || "") +'","'+ (ret.data.list[i].current_position || "") +'","'+ (ret.data.list[i].current_degree || "") +'","'+ 15 +'","'+ ret.data.list[i].nickname +'","'+ ret.data.list[i].head_img_url+'","'+ litter[0] +'","'+ litter +'","'+ 4 +'","'+ (ret.data.list[i].sex || 1) +'","'+ (ret.data.list[i].remark_nickname || "") +'","'+ (ret.data.list[i].remark_real_name || "") +'","'+ (ret.data.list[i].remark_head_img_url || "") +'","'+ (ret.data.list[i].remark_sex || "") +'","'+ (ret.data.list[i].remark_birthday || "") +'","'+ (ret.data.list[i].remark_hometown || "") +'","'+ (ret.data.list[i].remark_current_company || "") +'","'+ (ret.data.list[i].remark_current_position || "") +'","'+ (ret.data.list[i].remark_current_degree || "") +'","'+ (ret.data.list[i].remark_current_contact || "") +'"),';
                    }
                SQL = SQL.substring(0,SQL.length-1)
                // // // console.log(SQL+'000')
                db.executeSql({
                    name: SQLName,
                    sql: SQL
                }, function(ret, err){        
                    if( ret.status ){

                        if(apiPageParamFlag) {
                            query(parseInt(apiPageParamFlag));
                        } else {
                            query()
                        }
                    }else{
                        alert( JSON.stringify( err ) );
                    }
                });
            } else {
                alert(JSON.stringify(err))
            }
        })
    }
    // 获取焦点事件
    function getFocus() {
        $api.css($api.dom('input'), 'text-align:left');
        $api.css($api.dom('.searchIcon'), 'left:.2rem');

    }
    // 逝去焦点事件
    function loseFocus() {
        if ($api.val($api.dom('input')) == '') {
            $api.css($api.dom('input'), 'text-align:center');
            $api.css($api.dom('.searchIcon'), 'left:2.8rem');
        }
    }
    // 网络获取数据
    function requestData() {
        api.ajax({
            url: apiSite + '/contact/index',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: { 
                       token: $api.getStorage('userToken'),
                   }
            }
        }, function(ret, err) {
            if(ret) {
                // // console.log(JSON.stringify(ret))
            } else {
                alert(JSON.stringify(err.msg))
            }
        })
    }
    // 添加筛选条件
    function addFilter() {
        api.addEventListener({
            name: 'screeningResultsType'
        }, function(ret, err) {
            if (ret) {
                selVal = ret.value.selVal
                selectedObj = ret.value.selectedObj
                listContact.close();
                // alert('监听到的参数:'+ret.value.selVal)
                query(parseInt(ret.value.selVal));
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }
    function openSlideBar() {
        api.openFrame({
            name: 'txl_slideBar',
            url: './txl_slideBar.html',
            rect: {
                x: 0,
                y: 0,
                w: api.winWidth,
                h: api.winHeight
            },
            slidBackEnabled: false,
            pageParam: {
                selVal: selVal,
                selectedObj: selectedObj
            },
            bounces: false
        });
    }
    function hideSearIcon(ele) {
        var val = $api.val(ele);
        if (val!==''){
            // $api.css($api.dom('.searchIcon'), 'display:none');
            searchSQL(val);
        } else {
            // $api.css($api.dom('.searchIcon'), 'display:inline-block');
            searchSQL();
        }


    }
    function searchSQL(condition) {
        // 查询条件 condition
        var SQLName = 'db_'+$api.getStorage('userToken');
        var SQLsentence; 

        if (apiPageParamFlag) {
            // 有参数
            if (condition) {
                // 有关键字
                SQLsentence = 'SELECT * FROM addressList WHERE type = '+ apiPageParamFlag +' AND  (title LIKE "%'+ condition +'%" OR remark_current_contact LIKE "%'+ condition +'%" OR remark_nickname LIKE "%'+ condition +'%")'; 
            } else {
                // 无关键字
                SQLsentence = 'SELECT * FROM addressList WHERE type = '+ apiPageParamFlag ;
            }
        } else {
            // 无参数
            if (condition) {
                // 有关键字
                SQLsentence = 'SELECT * FROM addressList WHERE title LIKE "%'+ condition +'%" OR remark_current_contact LIKE "%'+ condition +'%" OR remark_nickname LIKE "%'+ condition +'%"'; 
            } else {
                // 无关键字
                SQLsentence = 'SELECT * FROM addressList';
            }
        }

        // 查询数据库
        db.selectSql({
            name: SQLName,
            sql: SQLsentence
        }, function(ret, err) {
            if (ret.status) {
                // listContact.close();
                dakai(paixv(ret.data))
                // reloadData(paixv(ret.data))
            } else {
                // // console.log(JSON.stringify(err));
            }
        });
    }
    // 查询数据库
    function query(condition,rawData) {
        // 查询条件 condition
        var SQLName = 'db_'+$api.getStorage('userToken');
        var SQLsentence;
        if (condition) {
            SQLsentence = 'SELECT * FROM addressList_simplify WHERE type = ' + condition + ' order by flag asc'; 
        } else {
            SQLsentence = 'SELECT * FROM addressList_simplify WHERE type IN (1,2,3) order by flag asc';
        }
        // // // console.log('308:::'+SQLsentence)
        // 查询数据库
        db.selectSql({
            name: SQLName,
            sql: SQLsentence
        }, function(ret, err) {
            // // // console.log('ret:'+JSON.stringify(ret))
            // // // console.log('err:'+JSON.stringify(err))
            if (ret.status) {
                // // // console.log('查询数据库'+JSON.stringify(ret))
                $api.css($api.dom('.loading'), 'display:none');
                for (var i = 0; i < $api.domAll('p').length; i++) {
                    $api.css($api.domAll('p.nodata')[i], 'display:none');
                } 
                if (ret.data.length == 0 && condition === 4) {
                    $api.css($api.dom('p.no4'), 'display:block');
                } else if(ret.data.length == 0 && condition===1) {
                    // // // console.log(2222 +'--'+ condition)
                    $api.css($api.dom('p.no1'), 'display:block');
                }else if(ret.data.length == 0 && condition===2) {
                    // // // console.log(333 +'--'+ condition)
                    $api.css($api.dom('p.no2'), 'display:block');
                }else if(ret.data.length == 0 && condition===3) {
                    // // // console.log(444 +'--'+ condition)
                    $api.css($api.dom('p.no3'), 'display:block');
                } else if(ret.data.length == 0){
                    $api.css($api.dom('p.no5'), 'display:block');
                } else {
                    var contactLevelOne = paixv(ret.data);
                    if (apiPageParamFlag) {
                            if (rawData == $api.jsonToStr(contactLevelOne)) {
                                // // console.log('数据没更新')
                            } else {
                                // // console.log('数据更新')
                                dakai(contactLevelOne)
                                // insertOneSql(apiPageParamFlag,contactLevelOne)
                            }
                    } else {
                            if (rawData == $api.jsonToStr(contactLevelOne)) {
                                // // console.log('数据没更新')
                            } else {
                                // // console.log('数据更新')
                                dakai(contactLevelOne)
                                // insertOneSql(5,contactLevelOne)
                            }
                            // 一度完整列表
                            
                    }
                }
            } else {
                // // console.log(JSON.stringify(err));
            }
        });
    }
    function insertOneSql(type,str) {
        str = $api.jsonToStr(str);
       db.executeSql({
            name: SQLName,
            sql: "INSERT OR REPLACE INTO addressList_one (type, str) VALUES ("+ type +",'"+ str +"')"    
        }, function(ret, err){        
            if( ret.status ){
                // // console.log('缓存成功')
            }else{
                alert('756:'+ JSON.stringify( err ) );
            }
        });
    }
    function reloadData(data) {
        listContact.reloadData({
            data: data
        }, function(ret, err) {
            if (ret) {
                // alert(JSON.stringify(ret));
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }
    // 是否是字母
    function f_check_uppercase(obj)   {          
       if (/[A-Z]/.test(obj))    {   
          return true;   
       }    
       return false;   
    }   
    
    function paixv (data) {
        // for (var i = 0; i < data.length; i++) {
        //     for (var j = 0; j < data.length; j++) {
        //         if (data[i].litter < data[j].litter) {
        //             var temp = data[i];
        //             data[i] = data[j];
        //             data[j] = temp;
        //         }
        //     }
        // }
        for (var i = 0; i < data.length; i++) {
            data[i].placeholderImg = "widget://image/icon_defaultHead.png";
            if (f_check_uppercase(data[0].flag)) {
                data[0].initial = data[0].flag;
            } else {
                data[0].initial = '#';
            }
            if (i>0) {
                if (data[i].flag !== data[i-1].flag) {
                    if (f_check_uppercase(data[i].flag)) {
                        data[i].initial = data[i].flag;
                    } else {
                        data[i].initial = '#';
                    }
                }
            }
        }
        var arr = {}
        var a;
        for (var i = 0; i < data.length; i++) {
            data[i].titleSize = 15;
            data[i].subTitleColor = '#999'

            if (data[i].initial) {
                if (data[i].initial == '#') {
                    if (arr[data[i].initial]) {
                    } else {
                        arr[data[i].initial] = [];
                    }
                    a = i;
                } else {
                    arr[data[i].initial] = [];
                    a = i;
                }
            } 
            // if (data[a].initial ) {
                
            // }
            arr[data[a].initial].push (data[i])
        }
        return arr;
    }
    function dakai(data1) {
        var dataArr = [];
        var dataKeyArr = [];
        for(key in data1) {
            dataArr = dataArr.concat(data1[key]);
            dataKeyArr.push(key)
        }
        var rightObj;
        if (apiPageParamFlag) {
            rightObj = [];
        } else {
            rightObj = [{
                    color: '#20AC19',
                    title: '呼叫'
                }]
        }
        var searchHei = $api.offset($api.dom('.search')).h
        listContact.open({
            x: -1000,
            y: -1000,
            w: 5,
            h: 5,
            data: [],
            fixedOn: api.frameName
        },function(ret,err){
        })
        listContact.close();
        listContact.open({
            x : 0,
            y : searchHei,
            w : api.frameWidth,
            h : api.winHeight - api.pageParam.headerH - searchHei,
            bgColor: '#f8f8f8',
            // 分割线颜色
            borderColor: '#d9d9d9',
            // 左滑按钮
            rightBtn: [{
                color: '#20AC19',
                title: '呼叫'
            }],
            imgHeight: 32,
            groupTitle: {
                color: '#999',       
                size: 14,   
                bgColor: '#f8f8f8'
            },
            rightBg: '#fff',
            indicator: {
                bgColor: 'rgba(0,0,0,0)',
                color: '#5A5A5A'
            },
            cellBgColor: '#fff',
            data: data1,
            fixedOn: api.frameName,
            fixed: false
        }, function(ret, err) {
                if (ret) {
                    // alert(JSON.stringify(ret))
                    if (ret.clickType == 0) {
                        // 获取点击联系人信息
                        addFriends(data1[ret.key][ret.index].user_id);
                    }
                    if (ret.clickType == 1) {
                        // 获取点击联系人信息
                        // 安卓全局索引
                        // ios+1
                        if (api.systemType == 'ios') {
                            var tel;
                            if (dataKeyArr.indexOf(ret.key)==-1) {
                                // 查找不到
                                if (data1[dataKeyArr[0]][ret.index].remark_current_contact) {
                                        tel = data1[dataKeyArr[0]][ret.index].remark_current_contact
                                } else if (data1[dataKeyArr[0]][ret.index].current_contact){
                                        tel = data1[dataKeyArr[0]][ret.index].current_contact
                                }
                            } else {

                                if (data1[dataKeyArr[dataKeyArr.indexOf(ret.key)+1]][ret.index].current_contact) {
                                        tel = data1[dataKeyArr[dataKeyArr.indexOf(ret.key)+1]][ret.index].current_contact
                                } else if (data1[dataKeyArr[dataKeyArr.indexOf(ret.key)+1]][ret.index].current_contact) {
                                        tel = data1[dataKeyArr[dataKeyArr.indexOf(ret.key)+1]][ret.index].current_contact
                                }
                            }
                            if (tel) {
                                api.call({
                                    type: 'tel_prompt',
                                    number: tel
                                });
                            } else {
                                alert('您没有对方的手机号码')
                            }
                        } else {
                             if (dataArr[ret.index].current_contact) {
                                api.call({
                                    type: 'tel_prompt',
                                    number: dataArr[ret.index].current_contact
                                });
                            } else {
                                alert('您没有对方的手机号码')
                            }
                           
                        }
                    }
                } else {
                    alert(JSON.stringify(err));  
                }
            });
    }
    // 打开人脉详情
    function addFriends(userId) {
        api.openWin({
            name: 'txl_memberInfo_Win',
            url: './txl_memberInfo_Win.html',
            pageParam: {
                userId: userId,
                flag: api.pageParam.flag
            }
        });
    }
</script>
</html>




