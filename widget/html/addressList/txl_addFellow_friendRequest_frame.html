<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/flex.css"/>
   <style type="text/css">
        .main {
            margin-bottom: 1rem;
        }
        .search {
            height: .791rem;
            width: 100%;
            background-color: #EFEFF4;
            box-sizing: border-box;
            padding: .14rem .16rem;
            font-size: 0;   
            position: relative;
        }
        .search input {
            background-color: #fff;
            height: .503rem;    
            width: 100%;
            float: left;
            font-size: .24rem;
            outline: none;
            text-align: center;
        }
        
        .searchIcon {
            display: inline-block;
            width: .25rem;
            height: .791rem;
            background: url(../../image/icon_supply/icon_search.png)no-repeat;
            -webkit-background-size: .25rem .26rem;
            background-size: .25rem .26rem;
            background-position: 0 center;
            position: absolute;
            top: 0;
            left: 3.3rem;
        }
        .hisSear {
            font-size: 0;
            height: .74rem;
            padding: 0 .3rem;
            background-color: #F8F8F8;
        }
        .hisSearTitle {
            font-size: .28rem;line-height: .74rem;
            color: #333;
        }
        .hisSearIcon {
            display: inline-block;
            width: .25rem;
            height: .8rem;
            float: right;
            background: url(../../image/icon_other/icon_delet.png)no-repeat;
            -webkit-background-size: .25rem .28rem;
            background-size: .25rem .28rem;
            background-position: 0 center;
        }
        
        ul {

        }
        ul li {
            padding-left: .18rem;
            background-color: #fff;
            line-height: 1.2rem;
            position: relative;
        }
        ul li>div {
            padding-right: .37rem;
            font-size: 0;
            border-bottom: .01rem solid #ECECEC;

            display: -webkit-box; 
            display: flex; 

            -webkit-box-align:  center;
            align-items: center;


        }
        .liLeft {
            height: 1.2rem;
            box-sizing: border-box;
            display: -webkit-box; 
            display: flex; 
            -webkit-box-align:  center;
            align-items: center;
        }
        .liLeft img {
            display: inline-block;
            width: .7rem;
            height: .7rem;
        }
        .liConter {
            -webkit-box-flex: 1.0;
            -webkit-flex-grow: 1;
            flex-grow: 1;
            margin-left: .2rem;
        }
        .liConter h3 {
            font-size: .28rem;
            line-height: .42rem;
        }
        .liConter p {
            font-size: .24rem;
            line-height: .33rem;
            color: #999;
        }
        .liRight {
            height: 1.2rem;
            display: -webkit-box; 
            display: flex; 

            -webkit-box-align:  center;
            align-items: center;
        }
        .liRight .already {
            font-size: .24rem;
            color: #999;
        }
        .liRight .accept {
            display: inline-block;
            width: .852rem;
            height: .54rem;
            background-color: #08B508;
            color: #fff;
            font-size: .24rem;
            text-align: center;
            line-height: .54rem;
            border-radius: .08rem;
        }
        .liRight .waccept {
            width: .852rem;
            text-align: center;
            font-size: .24rem;
            color: #999;
        }
        .button {
            z-index: 1000;
            width: 100%;
            position: fixed;
            bottom: 0;
            bottom: 0;
            height: .975rem;
            background-color: #08B508;
            text-align: center;
            line-height: .975rem;
            color: #fff;
            font-size: .34rem;
        }


        
        .warp {
            height: 1.2rem;
            position: relative;
            z-index: 20;
            width: 100%;
            box-sizing: border-box;
            background-color: #fff;
        }
        .slide {
            position: absolute;
            right: 0;top: 0;
            font-size: 0rem;
            z-index: 1;
            display: inline-block;
            width: 1.2rem;
            box-sizing: border-box;
            line-height: 1.2rem;
            color: #fff;
        }
        .stamp {
            background-color: #C8C7CD;
            width: 1.8rem;
            font-size: .3rem;
            text-align: center;
        }
        .del {
            background-color: #E53933;
            width: 1.2rem;
            font-size: .3rem;
            text-align: center;
        }
   </style>
</head>
<body>
    <div class="search">
        <input type="text" onkeyup="hideSearIcon(this)" name="" placeholder="&nbsp;&nbsp;&nbsp;&nbsp;搜索">
        <span class="searchIcon"></span>
    </div>
    <div class="main">
       <ul class="resultList">
           <!--  <li >
               <div class="warp" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove(this)" ontouchend="gtouchend(this)">
                    <div class="liLeft">
                        <img src="../../image/tx_5.jpg">
                    </div>
                    <div class="liConter">
                        <h3>标题</h3>
                        <p>个人介绍</p>
                    </div>
                    <div class="liRight">
                        <span class="accept">接收</span>
                    </div>
               </div>
                    <span class="slide">
                        <span class="del" data-targetId="{{=it[i].targetId}}" tapmode="hover" onclick="delNesItem(this,0);event.stopPropagation()">删除</span>
                    </span>

            </li>
           <li class="warp" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove(this)" ontouchend="gtouchend(this)">
               <div>
                    <div class="liLeft">
                        <img src="../../image/tx_5.jpg">
                    </div>
                    <div class="liConter">
                        <h3>标题</h3>
                        <p>个人介绍</p>
                    </div>
                    <div class="liRight">
                        <span class="waccept">已接收</span>
                    </div>
                    <span class="slide">
                        <span class="del" data-targetId="{{=it[i].targetId}}" tapmode="hover" onclick="delNesItem(this,0);event.stopPropagation()">删除</span>
                    </span>
               </div> -->
           </li>
       </ul>
        <script type="text/x-dot-template" id="listT">
           {{ for (var i = 0; i < it.length; i++) { }} 
                <li >
                   <div class="warp" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove(this)" ontouchend="gtouchend(this)">
                        <div class="liLeft">
                            <img src="{{=it[i].head_img_url}}">
                        </div>
                        <div class="liConter">
                            <h3>{{=it[i].nickname}}</h3>
                            <p>个人介绍</p>
                        </div>
                        <div class="liRight">
                            {{?it[i].status==1}}
                            <span class="accept" data-userId="{{=it[i].user_id}}" data-applyId="{{=it[i].apply_id}}" tapmode="hover" onclick="friendAcceptApply(this)">接收</span>
                            {{??}}
                            <span class="already">{{=it[i].status}}</span>
                            {{?}}
                        </div>
                   </div>
                   <span class="slide">
                        <span class="del"  data-applyId="{{=it[i].apply_id}}" tapmode="hover" onclick="delNesItem(this);event.stopPropagation()">删除</span>
                    </span>
                </li>
           {{};}}
       </script>
    </div>
    <div class="button">
        全部接收
    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript" src="../../script/pinyin4js.js"></script>
<script type="text/javascript">
    apiready = function(){
        moduleInit();
        requireData();
    };
    function requireData() {
        api.ajax({
            url: apiSite + '/friend/applyList',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: { 
                       token: $api.getStorage('userToken'),
                       
                   }
            }
        }, function(ret, err) {
            if(ret) {
                console.log('285::::'+JSON.stringify(ret))
                for (var i = 0; i < ret.data.list.length; i++) {
                    switch(ret.data.list[i].status) {
                        case 2 : ret.data.list[i].status = '已通过'; break;
                        case 3 : ret.data.list[i].status = '已删除'; break;
                        case 4 : ret.data.list[i].status = '默认同意'; break;
                        case 5 : ret.data.list[i].status = '失效'; break;
                    }   
                }
                getData(ret.data.list)
            } else {
                alert(JSON.stringify(err))
            }
        })
    }
    // 接受好友请求
    function friendAcceptApply(ele) {
        var applyId = $api.attr(ele, 'data-applyId');
        var userId = $api.attr(ele, 'data-userId');
        api.ajax({
            url: apiSite + '/friend/acceptApply',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: { 
                       token: $api.getStorage('userToken'),
                       apply_id: applyId
                   }
            }
        }, function(ret, err) {
            if(ret) {
                console.log(JSON.stringify(ret))
                requireData();
                selectSql(userId);
            } else {
                alert(JSON.stringify(err))
            }
        })
    }
    function selectSql(userId) {
        api.ajax({
            url: apiSite + '/contact/friend',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: { 
                       token: $api.getStorage('userToken'),
                   }
            }
        }, function(ret, err) {
            if(ret) {
                console.log('329::::'+JSON.stringify(ret))
                // 新添加好友插入数据库
                var SQLName = 'db_'+$api.getStorage('userToken');
                var SQL = 'INSERT OR REPLACE INTO addressList(user_id,nickname,head_img_url,current_company,current_position,current_degree, titleSize,title,img,flag,litter,type, sex, remark_nickname, remark_real_name, remark_head_img_url, remark_sex, remark_birthday, remark_hometown, remark_current_company, remark_current_position, remark_current_degree, remark_current_contact) VALUES '
                console.log(userId)
                db.executeSql({
                    name: SQLName,
                    sql: ' DELETE FROM addressList WHERE user_id = ' + userId
                }, function(ret, err){        
                    if( ret.status ){
                        console.log('删除成功'+ JSON.stringify( ret ) );
                    }else{
                        alert( JSON.stringify( err ) );
                    }
                });
                for (var i = 0; i < ret.data.list.length; i++) {
                    if (ret.data.list[i].user_id == userId) {
                        var litter;
                        if (ret.data.list[i].remark_nickname) {
                            litter =  PinyinHelper.getShortPinyin(ret.data.list[i].remark_nickname).toUpperCase();
                        } else {
                            litter =  PinyinHelper.getShortPinyin(ret.data.list[i].nickname).toUpperCase();
                        }
                        console.log(litter)
                        SQL += '('+ret.data.list[i].user_id+',"'+ ret.data.list[i].nickname +'","'+ ret.data.list[i].head_img_url +'","'+ (ret.data.list[i].current_company || "") +'","'+ (ret.data.list[i].current_position || "") +'","'+ (ret.data.list[i].current_degree || "") +'","'+ 15 +'","'+ ret.data.list[i].nickname +'","'+ ret.data.list[i].head_img_url+'","'+ litter[0] +'","'+ litter +'","'+ 1 +'","'+ (ret.data.list[i].sex || 1) +'","'+ (ret.data.list[i].remark_nickname || "") +'","'+ (ret.data.list[i].remark_real_name || "") +'","'+ (ret.data.list[i].remark_head_img_url || "") +'","'+ (ret.data.list[i].remark_sex || "") +'","'+ (ret.data.list[i].remark_birthday || "") +'","'+ (ret.data.list[i].remark_hometown || "") +'","'+ (ret.data.list[i].remark_current_company || "") +'","'+ (ret.data.list[i].remark_current_position || "") +'","'+ (ret.data.list[i].remark_current_degree || "") +'","'+ (ret.data.list[i].remark_current_contact || "") +'"),';
                    }
                }
                SQL = SQL.substring(0,SQL.length-1) + ';'
                console.log(SQL)
                db.executeSql({
                    name: SQLName,
                    sql: SQL
                }, function(ret, err){        
                    if( ret.status ){
                        alert( JSON.stringify( ret ) );
                        api.execScript({
                            name: 'main',
                            frameName: 'frame1',
                            script: 'query();'
                        });
                    }else{
                        alert( JSON.stringify( err ) );
                    }
                });
            } else {
                alert(JSON.stringify(err))
            }
        })
    }
    // 左滑显示删除按钮
    var startX,startY;
     var endX,endY;
     function gtouchstart(ele){
         var e = window.event;
         startX = e.touches[0].pageX;
         startY = e.touches[0].pageY;
     };   
     function gtouchmove(){   
         var e = window.event;
         endX = e.touches[0].pageX;
         endY = e.touches[0].pageY;  
     };   
     function gtouchend(ele) {
        var X = endX - startX,
        Y = Math.abs(endY - startY);  
        if ( X < -10 && Y < 100) {
             for (var i = 0; i < $api.domAll('.warp').length; i++) {
                 $api.css($api.domAll('.warp')[i], 'left: 0rem ');
            } 　　　　　　
            $api.css(ele, 'left: -1.2rem ');
        } else if(X > 10 && Y < 10) {
             $api.css(ele, 'left: 0rem ');
        }   
     }

    // 关闭显示删除按钮
    // function closeSlide() {
    //     for (var i = 0; i < $api.domAll('.warp').length; i++) {
    //         $api.css($api.domAll('.warp')[i], 'left: 0rem ');
    //     } 　
    // }

    // 删除好友请求
    function delNesItem(ele) {
        var applyId = $api.attr(ele, 'data-applyId');
        $api.remove($api.closest(ele, 'li'));
        api.ajax({
            url: apiSite + '/friend/deleteApply',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: { 
                       token: $api.getStorage('userToken'),
                       apply_id: applyId
                   }
            }
        }, function(ret, err) {
            if(ret) {
                if (ret.code != 200) {
                    alert(JSON.stringify(ret))
                }
            } else {
                alert(JSON.stringify(err))
            }
        })
    }
</script>
</html>




