<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/flex.css"/>
   <style type="text/css">
        .loading {
            display: none;
            width: .8rem;
            height: .8rem;
            background: url(../../image/loading_more.gif)no-repeat;
            background-size: .8rem .8rem;
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
            margin: auto;
         }
        .main {
             font-size: 0;
        }
        p {
            color: #999;
            font-size: .28rem;
            height: .7rem;
            line-height: .7rem;
            padding-left: .37rem;
        }
        textarea {
            padding: .16rem .37rem;
            font-size: .3rem;
            color: #4a4a4a;
            box-sizing: border-box;
            width: 100%;
            background-color: #fff;
            height: 2.4rem;
            resize: none;
            outline: none;
            border-bottom: .01rem solid #ddd;
        }
        .img {
            width: 6rem;
            margin: 0 auto;
            text-align: center;
            font-size: 0;
            margin-top: .65rem;
            position: relative;
        }
        .delBtn {
            display: inline-block;
            content: "X";
            font-size: .3rem;
            color: #fff;
            width: .44rem;
            height: .44rem;
            line-height: .44rem;
            border-radius: .22rem;
            background-color: #f00;
            position: absolute;
            top: -.22rem;
            right: -.22rem;
        }
        img {
            width: 6rem;
            /*height: 3.61rem;*/
            border: .01rem solid #979797;
            
        }
   </style>
</head>
<body>
    <div class="main">
        <p>备注</p>
        <textarea name="" id="text" cols="30" rows="10"></textarea>
        <div class="img" tapmode onclick="openImg()">
            <span class="delBtn" onclick="delImg();event.stopPropagation();" tapmode >x</span>
            <img id="img" src="../../image/iocn_addressList/icon_default.png">
        </div>
    </div>
    <div class="loading"></div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    apiready = function(){
        if ($api.attr($api.byId('img'), 'src') == '../../image/iocn_addressList/icon_default.png') {
            $api.css($api.dom('.delBtn'), 'display:none');
        }
        moduleInit(); 
        api.addEventListener({
            name: 'submitData'
        }, function(ret, err) {
            if (ret) {
               submitData();
            } else {
               alert(JSON.stringify(err));
            }
        });   
        requireData();    
    };
    // 请求数据
    function requireData() {
        db.selectSql({
             name:  'db_'+$api.getStorage('userToken'),
             sql: 'SELECT * FROM tb_remarks_user_info WHERE remark_user_id = ' + api.pageParam.userId
         }, function(ret, err){ 
            // // console.log(JSON.stringify(ret))
            if( ret.status ){
                    // // console.log( JSON.stringify( ret ) );
                    if (ret.data.length != 0 && ret.data[0].extra_id) {
                        if (ret.data[0].extra_content != null) {
                            $api.val($api.byId('text'), ret.data[0].extra_content != null ? ret.data[0].extra_content : '');
                        }
                        if (ret.data[0].extra_image_url != 'null') {
                            $api.attr($api.byId('img'), 'src', ret.data[0].extra_image_url);
                             $api.css($api.dom('.delBtn'), 'display:block');
                        }
                        if (ret.data[0].extra_image_url!= 'null' && ret.data[0].extra_content) {
                            $api.attr($api.byId('img'), 'src', ret.data[0].extra_image_url);
                             $api.val($api.byId('text'), ret.data[0].extra_content != null ? ret.data[0].extra_content : '');
                             $api.css($api.dom('.delBtn'), 'display:block');
                        }
                    } else {
                        api.ajax({
                            url: apiSite + '/remark_user/fullInfo',
                            method: 'post',
                            headers: apiHeader,
                            data: {
                                   values: { 
                                       token: $api.getStorage('userToken'),
                                       remark_user_id: api.pageParam.userId
                                   }
                            }
                        }, function(retAjax, err) {
                            if(retAjax) {
                                if (retAjax.code == 200) {
                                    // // console.log('120:::'+JSON.stringify(retAjax))
                                    $api.val($api.byId('text'), retAjax.extra.content);
                                    $api.attr($api.byId('img'), 'src', retAjax.extra.image_url);
                                }

                            } else {
                                alert(JSON.stringify(err))
                            }
                        })
                        
                    }
                
             }else{
                 alert( JSON.stringify( err ) );
             }
         });
       
    }

    // 提交数据
    function submitData() {
         $api.css($api.dom('.loading'), 'display: block');
        var text = $api.val($api.byId('text'));
        var img_url = $api.attr($api.byId('img'), 'src');
        if ($api.attr($api.byId('img'), 'src') == '../../image/iocn_addressList/icon_default.png') {
            submitAjax('null',text)
        } else {
           //  var baseUrl = 'img.iinnet.com'; //七牛给你的测试域名，也可使用自己捆绑的域名youe.xxx.com
           
            var obj = api.require('qiniuUpfile');
            if (img_url[0] != 'h') {
                // 本地路径
                obj.upfile({
                    file: img_url,
                }, function(ret, err) {
                    if (ret) {
                        if (ret.status) {
                            if (ret.oper == "complete") {
                                //上传成功后组装访问路径，或直接访问文档
                                submitAjax('http://'+baseUrl +'/'+ ret.info.key,text);
                               
                            } else if (ret.oper == "progress") {
                                //上传过程中获取进度数据
                                // // // console.log(ret.percent);
                            }
                        } else {
                            // alert(JSON.stringify(ret))
                        }
                    } else {
                        alert(JSON.stringify(err))
                    }
                });
            } else {
                // 网络路径
                submitAjax(img_url,text)
            }
        }
    }
    function submitAjax(argument,text) {
        // // console.log(argument+'+++'+text)
        api.ajax({
            url: apiSite + '/remark_user/editBasicInfo',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: { 
                        token: $api.getStorage('userToken'),
                        remark_user_id: api.pageParam.userId,
                        extra_content: text,
                        extra_image_url: argument
                   }
            }
        }, function(ret, err) {
            if(ret) {
                $api.css($api.dom('.loading'), 'display: none');
                requireAjax();
            } else {
                alert(JSON.stringify(err))
            }
        });
    }
    function requireAjax(argument) {
        api.ajax({
            url: apiSite + '/remark_user/fullInfo',
            method: 'post',
            headers: apiHeader,
            data: {
                  values: { 
                      token: $api.getStorage('userToken'),
                      remark_user_id: api.pageParam.userId
                  }
            }
        }, function(ret, err) {
            if(ret) {
                var SQLName = 'db_'+$api.getStorage('userToken');
                var sql = 'INSERT OR REPLACE INTO tb_remarks_user_info(remark_user_id, extra_id, extra_content, extra_image_url)  VALUES (' + api.pageParam.userId+','+ ret.data.extra.extra_id+',"'+ ret.data.extra.content+'","'+ ret.data.extra.image_url + '")'
                 db.selectSql({
                    name: 'db_'+$api.getStorage('userToken'),
                    sql: 'SELECT * FROM tb_remarks_user_info where remark_user_id=' + api.pageParam.userId
                }, function(ret1, err1){        
                    if( ret1.status ){
                        if (ret1.data.length !== 0) {
                            // // console.log(JSON.stringify(ret1))
                            // // console.log('有数据,更新')
                            // 有数据 更新
                            db.executeSql({
                                name: 'db_'+$api.getStorage('userToken'),
                                sql: 'UPDATE tb_remarks_user_info SET extra_id = '+ ret.data.extra.extra_id +', extra_image_url = "'+ ret.data.extra.image_url +'", extra_content = "'+ ret.data.extra.content +'" WHERE remark_user_id = ' + api.pageParam.userId
                            }, function(ret, err){        
                                if( ret.status ){
                                    // // console.log('688:' + JSON.stringify( ret ) );
                                    api.execScript({
                                        name: 'txl_memberInfo_Win',
                                        frameName: 'txl_memberInfo_Frame',
                                        script: 'initPage();'
                                    });
                                    api.closeWin();
                                }else{
                                    alert('690:' + JSON.stringify( err ) );
                                }
                            });
                        } else {
                            // // console.log('没有数据,插入')
                            // 没数据 插入新数据
                            db.executeSql({
                                name: 'db_'+$api.getStorage('userToken'),
                                sql: sql  
                            }, function(ret, err){        
                                if( ret.status ){
                                   // // console.log( '684:::'+JSON.stringify( ret ) );
                                   api.execScript({
                                       name: 'txl_memberInfo_Win',
                                       frameName: 'txl_memberInfo_Frame',
                                       script: 'initPage();'
                                   });
                                   api.sendEvent({
                                       name: 'editUserInfo',                                     extra: {                                         flag: api.pageParam.flag                                     }
                                   });
                                   api.closeWin();
                                }else{
                                   alert( JSON.stringify( err ) );
                               }
                            });
                        }
                    }else{
                        alert( JSON.stringify( err1 ) );
                    }
                });
               
            }else{
                alert( JSON.stringify( err ) );
            }
        });
    }
    // 打开相册
    function openImg() {
        // if (val === 'camear') {
        //      api.getPicture({
        //             sourceType: 'camera',
        //             mediaValue: 'pic',
        //             encodingType: 'jpg',
        //             destinationType: 'url',
        //             quality: 80,
        //             targetWidth: 750,
        //             targetHeight: 750,
        //             saveToPhotoAlbum: true // 拍照后是否保存照片到相册
        //         }, function(ret, err) {
        //             if (ret.data) {
        //                 $api.attr($api.dom('img'),'src', ret.data);
        //             } 
        //         });
        // } else {
            api.getPicture({
                sourceType: 'library',
                mediaValue: 'pic',
                encodingType: 'jpg',
                destinationType: 'url',
                quality: 80,
                // targetWidth: 750,
                // targetHeight: 750
            }, function(ret, err) {
                if (ret) {
                    if (ret.data) {
                        $api.attr($api.dom('img'),'src', ret.data);
                        if ($api.attr($api.byId('img'), 'src') == '../../image/iocn_addressList/icon_default.png') {
                            $api.css($api.dom('.delBtn'), 'display:none');
                        } else {
                            $api.css($api.dom('.delBtn'), 'display:block');

                        }
                    } 
                    
                } else {
                    // alert(JSON.stringify(err.msg));
                }
            });
        // }
    }
    // 删除图片
    function delImg() {
        $api.attr($api.dom('img'),'src', '../../image/iocn_addressList/icon_default.png');
        $api.css($api.dom('.delBtn'), 'display:none');
    }
</script>
</html>




