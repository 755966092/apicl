<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <style>
    body {}
    
    header {
        background-color: #3A393E;
        height: 1rem;
        color: #fff;
        line-height: 1rem;
        text-align: center;
        position: relative;
        font-size: .36rem;
        position: relative;
    }
    
    header span:nth-child(1) {
        position: absolute;
        left: 0;
        background: url(../../image/icon_fanh.png)no-repeat;
        background-size: .22rem .37rem;
        padding-left: .65rem;
        background-position: .3rem .34rem;
    }
    header span.datum {
      display: inline-block;
      background: url(../../image/icon_other/icon_datum.png)no-repeat;
      -webkit-background-size: .42rem .39rem;
      background-size: .42rem .39rem;
      width: .42rem;
      height: .39rem;
      position: absolute;
      right: .3rem;
      top: .35rem;
    }
    </style>
</head>

<body>
    <header>
        <span onclick="api.closeWin()">返回</span>
        <span id="title"></span>
        <span class="datum"></span>
    </header>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
var rongToken;
  apiready = function() {
      // 初始化模块
      moduleInit()
      
      var rongToken = api.pageParam.rongToken;
      // 获取参数
      var name = api.pageParam.name;
      var title = document.getElementById('title')
      $api.html(title, name);
      
      // 初始化界面
      fnInit();

      // 初始化聊天界面
      chatTools(rongToken);
      
      // 聊天内容
      api.openFrame({
          name: 'chattContent',
          url: './chatContent.html',
          rect: {
              x: 0,
              y: headerH,
              w: 'auto',
              h: 'auto'
          },
          pageParam: {
              name: 'value'
          },
          bounces: true
      });

  };

  // // 接入融云
  // function rongyun (rongToken) {
     
  //     rong.init(function(ret, err) {
  //         if (ret.status == 'error')
  //             api.toast({ msg: err.code });
  //     });
  //    receiveMsg();
  //     rong.connect(
  //         {   
  //             // 用户1
  //             // token: 'aAoW4oalHGpvB6Hw89bG0XzZSHvx/Xm6zmi6cWDa3L4VyfNcz/KXDFQxtpoQ+os1nT0799sMXlXPvUAK3FnjIY94cnJzE+aT'
  //             // 用户2
  //             token: rongToken
  //         },function(ret, err) { 
  //             if (ret.status == 'success') api.toast({ msg: ret.result.userId }); 
  //         });

  // }

  // 监听接收消息
  function receiveMsg() {
     rong.setOnReceiveMessageListener(function(ret, err) {
        // api.toast({ msg: JSON.stringify(ret.result.message) });
        // api.toast({ msg: ret.result.message.left });
        // api.alert({
        //     title: 'title',
        //     msg: ret.result.message,
        // }, function(ret, err) {
        //     if (ret) {
        //         alert(JSON.stringify(ret));
        //     } else {
        //         alert(JSON.stringify(err));
        //     }
        // });
        api.sendEvent({
            name: 'receiveMsg',
            extra: {
                msg: ret.result.message.content.text
            }
        });
      })
  }


  // 聊天界面
  function chatTools(rongToken) {
    UIChatTools.open({
              chatBox: {
                  placeholder: '聊天内容',     
                  autoFocuse: true,  
                  maxRows: 6     
              },
              styles: {
                  bgColor: '#D1D1D1',   
                  margin: 10,           
              },
              tools: {
                  h: 35,          
                  iconSize: 30,   
                  recorder: {     
                     normal: 'fs://UIChatTolls/recorder.png',  
                     selected: 'fs://UIChatTolls/recorder1.png' 
                  },
                  image: {        
                     normal: 'fs://UIChatTolls/image.png',  
                     selected: 'fs://UIChatTolls/image1.png' 
                  },
                  video: {        
                     normal: 'fs://UIChatTolls/video.png',  
                     selected: 'fs://UIChatTolls/video1.png' 
                  },
                  face: {         
                     normal: 'fs://UIChatTolls/face2.png',  
                     selected: 'fs://UIChatTolls/face1.png' 
                  },
                  append: {       
                     normal: 'fs://UIChatTolls/append.png',  
                     selected: 'fs://UIChatTolls/append1.png'
                  }
              },
              // 表情
              // emotions:['widget://image/chatPage/emoticons/basic','widget://image/chatPage/emoticons/append1','widget://image/chatPage/emoticons/append2']
          }, function(ret) {
              if (ret) {
                  if (ret.eventType === 'send') {
                    // alert(JSON.stringify(ret.msg));
                    /**
                     * sendMsg(msg)
                     * msg: 发送的消息
                     */
                    sendMsg(ret.msg);
                  }
              } 
          });
          // 附加按钮
          UIChatTools.setAppendButton({
              styles: {
                  row: 2,         
                  column: 4,         
                  iconSize: 50,      
                  titleSize: 13,   
                  titleColor: '#f00'     
              },
              buttons: [
                 {
                      normal: 'widget://image/chatPage/album2.png',       
                      highlight: 'widget://image/chatPage/album2.png',    
                      title: '电话'       
                 },{
                      normal: 'widget://image/chatPage/album2.png',       
                      highlight: 'widget://image/chatPage/album2.png',    
                      title: '收藏' 
                 },{
                      normal: 'widget://image/chatPage/album2.png',       
                      highlight: 'widget://image/chatPage/album2.png',    
                      title: '发红包' 
                 }
              ]
          }, function(ret) {
             api.alert({msg:'点击了第'+ret.index+'个按钮'});
          });
          // 监听功能按钮
          UIChatTools.toolsListener(function(ret) {
             if (ret.eventType == 'video') {
                api.alert({
                    title: 'title',
                    msg: 'video',
                }, function(ret, err) {
                    if (ret) {
                        alert(JSON.stringify(ret));
                    } else {
                        alert(JSON.stringify(err));
                    }
                });
             }
          });
          // rongyun(rongToken);
  }

  /**
  * 发送消息 
  * sendMsg(msg)
  * msg: 发送的消息
  */
  function sendMsg(msg) {
    var sendMsg;
    rong.sendTextMessage({
        conversationType: 'PRIVATE',
        targetId: 'testUser1',
        text: msg,
        extra: ''
    }, function(ret, err) {
        
        if (ret.status == 'prepare') {
          sendMsg = ret.result.message.content.text;

           // api.toast({ msg: JSON.stringify(ret.result.message) });
          // api.alert({
          //     title: 'title',
          //     msg: '第一个prepare:' + ret.result.message.content.text,
          // }, function(ret, err) {
              
          // });
        }
           
        else if (ret.status == 'success') {
           // api.toast({ msg: ret.result.message.messageId });
           
            // api.alert({
            //     title: 'title',
            //     msg: '第二个message' + ret.result.message.messageId,
            // }, function(ret, err) {
            //     if (ret) {
            //         alert('第二成功'+JSON.stringify(ret));
            //     } else {
            //         alert(JSON.stringify(err));
            //     }
            // });
            api.sendEvent({
                name: 'sendMsg',
                extra: {
                    msg: sendMsg
                }
            });
            
            
        }
           
        else if (ret.status == 'error') {
          // api.toast({ msg: err.code });
            api.alert({
                title: 'title',
                msg: '第三个message' + err.code,
            }, function(ret, err) {
                if (ret) {
                    alert(JSON.stringify(ret));
                } else {
                    alert(JSON.stringify(err));
                }
            });
        }
            
    });
  }
</script>

</html>
