<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"
    />
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <style>
        .head-list {
            font-size: 0;
            padding: 0.1rem 0rem;
            height: 0.9rem;
            border: 1px solid #d9d9d9;
        }

        img {
            width: 0.9rem;
            height: 0.9rem;
            margin: 0 .05rem;
            border-radius: .04rem;
        }

        img:last-child {
            margin-right: .1rem;
        }
        .header button.disabled {
          color: #476146;
      }
    .loading {
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,.5) url(../../image/loading_more.gif)no-repeat;
        background-position: center;
        background-size: .8rem .8rem;
        display: none;
    }
    </style>
</head>

<body>
    <header class="header">
        <div class="head">
            <span class="callback" tapmode onclick="api.closeWin()">返回</span>
            <span class="winTitle" id="title"></span>
            <button disabled class="rightBtn disabled" onclick="createGroupChat()" tapmode>确定<span id="count"></span></button>
        </div>
    </header>
    <div class='head-list flex-def'></div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/pinyin4js.js"></script>
<script type="text/javascript">
    var selectItemText = [];
    var selectItemId = [];
    var selectItemArr = [];
    var userIdList = [];
    var listData;
    apiready = function () {
        // api.pageParam.addUser == 1 加人
        // api.pageParam.addUser == 2 踢人
        console.log('参数:'+JSON.stringify(api.pageParam));
        
        fnInit();
        moduleInit();
        var rightBtn = $api.dom('.rightBtn');
        if (api.pageParam.key == 'createLabel') {
             $api.removeCls(rightBtn, 'disabled');
            $api.removeAttr(rightBtn, 'disabled');
             for (var i = 0; i < api.pageParam.userIdList.length; i++) {
                var element = api.pageParam.userIdList[i];
                userIdList.push(parseInt(element))
            }
            selectData();
            $api.text($api.byId('title'), '选择联系人');
        } else {
             if (!api.pageParam.addUser) {
                // 新建群
                selectData();
                $api.text($api.byId('title'), '选择联系人');
            } else if (api.pageParam.addUser == 1) {
                $api.text($api.byId('title'), '选择联系人');
                // 加人
                // api.pageParam.groupInfo.group_member_info 群成员列表
                // console.log(JSON.stringify(api.pageParam.group_member_info));
                for (var i = 0; i < api.pageParam.groupInfo.group_member_info.length; i++) {
                    var element = api.pageParam.groupInfo.group_member_info[i];
                    userIdList.push(element.user_id)
                }
                selectData();
            } else if (api.pageParam.addUser == 2) {
                // 踢人
                $api.text($api.byId('title'), '删除成员');
                for (var i = 0; i < api.pageParam.groupInfo.group_member_info.length; i++) {
                    var element = api.pageParam.groupInfo.group_member_info[i];
                    element.title = element.remark_nickname ? element.remark_nickname : element.nickname;
                    element.img = element.remark_head_img_url ? element.remark_head_img_url : element.head_img_url;
                    element.flag = PinyinHelper.getShortPinyin(element.title).toUpperCase()[0];
                }
                dakai(paixv(api.pageParam.groupInfo.group_member_info))
            }
        }
       
    }

    function selectData() {
        db.selectSql({
            name: 'db_' + $api.getStorage('userToken'),
            sql: 'SELECT * FROM addressList_simplify WHERE type IN (1,2,4) order by flag asc',
        }, function (ret, err) {
            if (ret.status) {
                // 4 初始好友
                // 1 相识好友
                // 2 熟识好友
                // 3 尚未加入
                listData = ret.data;
                dakai(paixv(ret.data))
            } else {
                api.alert({
                    msg: err.msg
                });
            }
        });
    }

    function dakai(data1) {
        var dataArr = [];
        var dataKeyArr = [];
        for (key in data1) {
            dataArr = dataArr.concat(data1[key]);
            dataKeyArr.push(key)
        }
        listContact.open({
            x: -1000,
            y: -1000,
            w: 5,
            h: 5,
            data: [],
            fixedOn: api.frameName
        }, function (ret, err) {})
        listContact.close();
        listContact.open({
            x: 0,
            y: headerH + $api.offset($api.dom('.head-list')).h,
            w: api.frameWidth,
            h: api.winHeight - $api.offset($api.dom('.head-list')).h - $api.offset($api.dom('header')).h,
            bgColor: '#EFEFF4',
            // 分割线颜色
            borderColor: '#EDEDED',
            imgHeight: 32,
            imgWidth: 32,
            groupTitle: {
                color: '#999',
                size: 14,
                bgColor: '#EFEFF4'
            },
            cellHeight: 50,
            rightBg: '#fff',
            cellBgColor: '#fff',
            data: data1,
        }, function (ret, err) {
            if (ret) {
            // $api.css($api.dom('.loading'), 'display:block');
                // console.log('id列表:'+JSON.stringify(userIdList));
                // console.log('id:'+JSON.stringify(data1[ret.key][ret.index].user_id));
                // console.log('位置:'+JSON.stringify(userIdList.indexOf(parseInt(data1[ret.key][ret.index].user_id))));
                
                if (userIdList.indexOf(parseInt(data1[ret.key][ret.index].user_id)) == -1) {
                    var selFlag = selectItemText.indexOf(data1[ret.key][ret.index].title);
                    var selFlag2 = selectItemId.indexOf(data1[ret.key][ret.index].user_id);
                    if (selFlag != -1) {
                        selectItemText = selectItemText.filter(function (value) {
                            return value != selectItemText[selFlag]
                        })
                        selectItemId = selectItemId.filter(function (value) {
                            return value != selectItemId[selFlag2]
                        })
                        selectItemArr = selectItemArr.filter(function (value, index) {
                            return value.user_id != data1[ret.key][ret.index].user_id

                        })
                        // 已经选择
                        listContact.refreshItem({
                            index: ret.index,
                            key: ret.key,
                            data: {
                                img: data1[ret.key][ret.index].img,
                                title: data1[ret.key][ret.index].title,
                                titleColor: '#000',
                                titleSize: 15,
                                subTitleSize: 10,
                                placeholderImg: "widget://image/icon_defaultHead.png"
                            }
                        });
                        // 删除已选头像
                        $api.remove($api.dom('img[src = "' + data1[ret.key][ret.index].img + '"]'));
        //  $api.css($api.dom('.loading'), 'display:none');
                    } else {
                        // 未选
                        selectItemText.push(data1[ret.key][ret.index].title);
                        selectItemId.push(data1[ret.key][ret.index].user_id);
                        selectItemArr.push(data1[ret.key][ret.index]);
                        listContact.refreshItem({
                            index: ret.index,
                            key: ret.key,
                            data: {
                                img: data1[ret.key][ret.index].img,
                                title: data1[ret.key][ret.index].title,
                                titleColor: '#27B24A',
                                titleSize: 15,
                                subTitleSize: 10,
                                placeholderImg: "widget://image/icon_defaultHead.png"
                            }
                        });
                        $api.append($api.dom('.head-list'), '<img src="' + data1[ret.key][ret.index].img +
                            '" alt="">');
        //  $api.css($api.dom('.loading'), 'display:none');
                    }
                }
                var rightBtn = $api.dom('.rightBtn');
                if (api.pageParam.key == 'createLabel') {
                    var rightBtn = $api.dom('.rightBtn');
                    if (selectItemId.length > 0) {
                        $api.text($api.byId('count'), '(' + selectItemId.length + ')');
                    } else {
                        $api.text($api.byId('count'), '');
                    }
                } else {
                    if (!api.pageParam.addUser) {
                        // 新建群
                        if (selectItemId.length > 0) {
                            $api.text($api.byId('count'), '(' + selectItemId.length + ')');
                            if (selectItemId.length > 1) {
                                $api.removeCls(rightBtn, 'disabled');
                                $api.removeAttr(rightBtn, 'disabled');
                            } else {
                                $api.addCls(rightBtn, 'disabled');
                                $api.attr(rightBtn, 'disabled', true);
                            }
                        } else {
                            $api.text($api.byId('count'), '');
                            $api.addCls(rightBtn, 'disabled');
                            $api.attr(rightBtn, 'disabled', true);
                        }
                    } else if (api.pageParam.addUser == 1) {
                       btnStatu()
                    } else if (api.pageParam.addUser == 2) {
                        btnStatu()
                      
                    }
                }
            }
        });
    }
    function btnStatu() {
        var rightBtn = $api.dom('.rightBtn');
        if (selectItemId.length > 0) {
            $api.text($api.byId('count'), '(' + selectItemId.length + ')');
            $api.removeCls(rightBtn, 'disabled');
            $api.removeAttr(rightBtn, 'disabled');
        } else {
            $api.text($api.byId('count'), '');
            $api.addCls(rightBtn, 'disabled');
            $api.attr(rightBtn, 'disabled', true);
        }
    }
    function f_check_uppercase(obj) {
        if (/[A-Z]/.test(obj)) {
            return true;
        }
        return false;
    }

    function paixv(data) {
        if (api.systemType == 'ios') {
            list = data.length
            for (var i = 0; i < list; i++) {
                data[i].placeholderImg = "widget://image/icon_defaultHead.png";
                if (f_check_uppercase(data[0].flag)) {
                    data[0].initial = data[0].flag;
                } else {
                    data[0].initial = '#';
                }
                if (i > 0) {
                    if (data[i].flag !== data[i - 1].flag) {
                        if (f_check_uppercase(data[i].flag)) {
                            data[i].initial = data[i].flag;
                        } else {
                            data[i].initial = '#';
                        }
                    }
                }
            }
            
        } else {
            list = data.length
            for (var i = 0; i < list; i++) {
                if (f_check_uppercase(data[0].flag)) {
                    data[0].initial = data[0].flag;
                } else {
                    data[0].initial = '#';
                }
                if (i > 0) {
                    if (data[i].flag !== data[i - 1].flag) {
                        if (f_check_uppercase(data[i].flag)) {
                            data[i].initial = data[i].flag;
                        } else {
                            data[i].initial = '#';
                        }
                    }
                }
            }
        }
        var arr = {}
        var a;
        for (var i = 0; i < data.length; i++) {
            delete data[i].flag;
            delete data[i].type;
            delete data[i].subTitle;
            // data[i].subTitle = (data[i].current_company || ""+ data[i].current_position || ""+data[i].current_degree||"") ? (data[i].current_company || ""+" "+ data[i].current_position || ""+" "+data[i].current_degree||"") : ""
            // data[i].subTitleColor = '#999'
            data[i].titleSize = 15;
            // 从群详情加人按钮点击进入之后要判断群里的人s
            if (api.pageParam.addUser == 1 || api.pageParam.key == 'createLabel') {
                if (userIdList.indexOf(parseInt(data[i].user_id)) != -1) {
                    data[i].titleColor = '#27B24A'
                }
            }
            // if (api.pageParam.key == 'createLabel') {
            //     if (userIdList.indexOf(parseInt(data[i].user_id)) != -1) {
            //         data[i].titleColor = '#27B24A'
            //     }
            // }
            if (data[i].initial) {
                if (data[i].initial == '#') {
                    if (arr[data[i].initial]) {} else {
                        arr[data[i].initial] = [];
                    }
                    a = i;
                } else {
                    arr[data[i].initial] = [];
                    a = i;
                }
            }
            arr[data[a].initial].push(data[i])
        }
        
        return arr;
    }
    // 新建群聊
    function createGroupChat() {
        // console.log('已选用户:' + JSON.stringify(selectItemId));
        // console.log('所有用户:' + JSON.stringify(listData));
        var paramObj = {},url;
        if (api.pageParam.key == 'createLabel') {
            paramObj = []
            for (var i = 0; i < selectItemId.length; i++) {
                var element = selectItemId[i];
                paramObj.push(listData.filter(function (value, index) {
                    return value.user_id == element
                })[0])
            }
            api.sendEvent({
                name: 'createLabel',
                extra: { 
                    paramObj: paramObj,
                    selectItemId: selectItemId
                }
            });
            api.closeToWin({
                name: 'txl_createGroup_win',
                animation: {
                    type: 'flip',
                    subType: 'from_bottom',
                    duration: 500
                }
            });
        } else {
            if (api.pageParam.groupInfo) {
                if (api.pageParam.addUser == 1) {
                    // 增加群成员
                    url = '/chat_group/enter';
                } else if (api.pageParam.addUser == 2) {
                    // 减少群成员
                    url = '/chat_group/remove';
                } else {

                }
                paramObj = {
                    token: $api.getStorage('userToken'),
                    group_id: api.pageParam.groupInfo.group_info.group_id,
                    user_id_list: selectItemId.toString(),
                }
            } else {
                // 新建群
                url = '/chat_group/create';
                paramObj = {
                    token: $api.getStorage('userToken'),
                    user_id_list: selectItemId.toString()
                }
            }
            api.ajax({
                url: apiSite + url,
                method: 'post',
                headers: apiHeader,
                data: {
                    values: paramObj
                }
            }, function (ret, err) {
                if (ret) {
                    if (ret.code === 200) {
                        if (api.pageParam.key == 'createLabel') {

                        } else {
                            if (api.pageParam.groupInfo) {
                                api.sendEvent({
                                    name: 'addGroupUser'
                                });
                                // listContact.close();
                                setTimeout(function () {
                                    api.closeWin();
                                }, 500)
                            } else {
                                api.toast({
                                    msg: '新建成功',
                                    duration: 2000,
                                    location: 'bottom'
                                });
                                api.openWin({
                                    name: 'groupChat_win',
                                    url: './groupChat_win.html',
                                    bounces: false,
                                    pageParam: {
                                        group_id: ret.data.group_id,
                                        createGroup: 1
                                    }
                                });
                                setTimeout(function () {
                                    api.closeWin();
                                }, 500)
                            }
                        }

                    } else {
                        alert(ret.msg)
                    }
                } else {
                    alert(JSON.stringify(err))
                }
            })
        }
      
        
    }
</script>

</html>