<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="minimum-scale=1.0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
        html,body {
            background-color: #000;
        }

        img {
            width: 7.5rem;
            opacity: 0;
        }
        span {
            width: 0.51rem;
            height: 0.51rem;
            position: fixed;
            bottom: .36rem;
            right: .36rem;
            background: url(../../image/chatPage/icon_donwloadImg.png)no-repeat;
            background-size: .51rem .51rem;
            z-index: 1000;
        }
    </style>
</head>

<body class="flex-def flex-cCenter flex-zCenter" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()">
    <span tapmode onclick="downloadImg();event.stopPropagation();"></span>
    <img src="" >
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    apiready = function(){
        $api.attr($api.dom('img'), 'src', api.pageParam.imgUrl);
        setTimeout(function () {
            if ($api.offset($api.dom('img')).h < 667) {
                $api.css($api.dom('body'), 'height:13.34rem');
            }
            $api.css($api.dom('img'), 'opacity:1');
        },500)

    };
    function downloadImg(url) {
        if (api.pageParam.imgUrl[0]=='h') {
            api.download({
                url: api.pageParam.imgUrl,
                savePath: api.fsDir+ '/downloadImg/' + api.pageParam.imgUrl.substring(39,75) +'.jpg',
                report: true,
                cache: true,
                allowResume: true
            },function(ret,err){
                if (ret) {
                    if (ret.state == 1) {
                        saveImg(ret.savePath)
                    }
                } else{
                    alert('保存出错')
                }
            });
        } else {
            saveImg(api.pageParam.imgUrl);
        }
    }
    function saveImg(url) {
        api.saveMediaToAlbum({
            path: url
        },function(ret,err){
            if (ret.status) {
                api.toast({
                    msg: '保存成功',
                    duration: 2000,
                    location: 'bottom'
                });
            } else {
                alert(ret.msg)
            }
        });
    }
    var timeOutEvent=0;//定时器
    //开始按
    function gtouchstart(ele){
        timeOutEvent = setTimeout("longPress()",500);
        //这里设置定时器，定义长按500毫秒触发长按事件，时间可以自己改，个人感觉500毫秒非常合适
        return false;
    };
    //手释放，如果在500毫秒内就释放，则取消长按事件，此时可以执行onclick应该执行的事件
    function gtouchend(){
        clearTimeout(timeOutEvent);//清除定时器
        if(timeOutEvent!=0){
            //这里写要执行的内容（尤如onclick事件）
            api.closeFrame();
        }
        return false;
    };
    //如果手指有移动，则取消所有事件，此时说明用户只是要移动而不是长按
    function gtouchmove(){
        clearTimeout(timeOutEvent);//清除定时器
        timeOutEvent = 0;
    };
    //真正长按后应该执行的内容
    function longPress(){
        timeOutEvent = 0;
        // downloadImg(api.pageParam.imgUrl)
        api.actionSheet({
            // title: 'title',
            // cancelTitle: '取消',
            // destructiveTitle: 'destructivetitle',
            buttons: ['保存图片']
        },function(ret,err){
            console.log(JSON.stringify(ret))
            if (ret.buttonIndex === 1) {
                // 保存图片
                downloadImg(api.pageParam.imgUrl)
            }
        });
    }
</script>
</html>

