W<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"
    />
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <style>
        .newsTime {
            margin-bottom: .3rem;
            font-size: .2rem;
            text-align: center;
            color: #999;
        }

        .main {
            margin: .3rem .3rem;
            padding-bottom: 1.6rem;
        }

        .main .time {
            min-width: 1.1rem;
            /* max-width: 2rem; */
            height: .36rem;
            margin: 0 auto;
            margin-bottom: .1rem;
            padding: 0 .1rem;
            /* background-color: #CFCFCF; */
            font-size: .2rem;
            line-height: .36rem;
            text-align: center;
            color: #999;
            border-radius: .05rem;
        }

        .main .oneself,
        .main .other {
            margin-bottom: .3rem;

        }

        .main .oneself img.oneselfImg,
        .main .other img.otherImg {
            width: .72rem;
            height: .72rem;
        }

        .main .oneself p,
        .main .other p {
            position: relative;
            z-index: 2;
            box-sizing: border-box;
            min-width: .7rem;
            max-width: 4.7rem;
            min-height: .72rem;
            /* line-height: .42rem; */
            margin-right: .3rem;
            padding: .04rem .2rem;
            font-size: .28rem;
            word-break: break-all;
            color: #000;
            /*height: .72rem;*/
            border-radius: .1rem;
            background-color: #a0e75a;
        }

        .main .oneself p {
            border: .02rem solid #a0e75a;
        }

        .main .oneself p:after {
            content: "";
            position: absolute;
            z-index: 3;
            ;
            top: .25rem;
            right: -.20rem;
            display: inline-block;
            width: 0;
            height: 0;
            border-top: .15rem solid transparent;
            border-bottom: .15rem solid transparent;
            border-left: .22rem solid #a0e75a;
        }

        .main .oneself p:before {
            content: "";
            position: absolute;
            z-index: 1;
            top: .25rem;
            right: -.22rem;
            display: inline-block;
            width: 0;
            height: 0;
            border-top: .15rem solid transparent;
            border-bottom: .15rem solid transparent;
            border-left: .22rem solid #a0e75a;
        }

        .main .other p:after {
            content: "";
            position: absolute;
            top: .25rem;
            left: -.20rem;
            display: inline-block;
            width: 0;
            height: 0;
            border-top: .15rem solid transparent;
            border-right: .22rem solid #fff;
            border-bottom: .15rem solid transparent;
        }

        .main .other p:before {
            content: "";
            position: absolute;
            top: .25rem;
            left: -.22rem;
            display: inline-block;
            width: 0;
            height: 0;
            border-top: .15rem solid transparent;
            border-right: .22rem solid #e3e3e3;
            border-bottom: .15rem solid transparent;
        }

        .main .other p {
            margin-right: 0;
            margin-left: .3rem;
            border: .02rem solid #e3e3e3;
            background-color: #fff;
        }

        .supply_info {
            position: fixed;
            z-index: 999;
            top: 0;
            top: 0;
            left: 0;
            left: 0;
            overflow: hidden;
            box-sizing: border-box;
            width: 100%;
            height: .7rem;
            margin-bottom: .2rem;
            padding: 0 .36rem;
            border-bottom: .01rem solid #d9d9d9;
            font-size: 0;
            line-height: .7rem;
            background-color: #fff;
        }

        .hide {
            display: none;
        }

        .supply_info img {
            width: .5rem;
            height: .5rem;
            margin-right: .1rem;
            border-radius: 50%;
        }

        img.imgNews {
            width: 3rem;
            height: auto;
            max-height: 5rem;
            margin: .2rem 0;
        }

        .supply_info .zk {
            width: .15rem;
            height: .7rem;
            background: url(../../image/icon_zk.png)no-repeat;
            background-position: 0 center;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
        }

        .supply_info div.div {
            overflow: hidden;
            box-sizing: border-box;
            font-size: .26rem;
            color: #3f3f3f;
        }

        .supply_info div.div span.label {
            width: .1rem;
        }

        .supply_info div.div span {
            overflow: hidden;
            max-width: 1.8rem;
            line-height: .47rem;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .promptText {
            display: none;
            width: 4.463rem;
            height: .6rem;
            margin: 0 auto;
            margin-top: .2rem;
            font-size: .22rem;
            text-align: center;
            color: #fff;
            border-radius: .1rem;
            background-color: #cfcfcf;
        }

        .shadow {
            position: fixed;
            z-index: 1000;
            display: none;
            padding: .2rem .3rem;
            border: .01rem solid #d9d9d9;
            font-size: 0;
            line-height: .8rem;
            background-color: #fff;
            box-shadow: 2px 2px 20px #888;
        }

        .shadow p {
            font-size: .3rem;
        }

        .voiceTime {
            margin-right: .1rem;
            font-size: .2rem;
            line-height: .8rem;
            color: #999;
        }

        .voiceTimeOther {
            margin-left: .1rem;
        }

        /* 位置消息气泡 */

        .main .oneself p.positionNews,
        .main .other p.positionNews {
            position: relative;
            width: 4.43rem;
            height: 2.62rem;
            padding: .2rem 0 0 0;
            border: .02rem solid #e3e3e3;
            background: #fff;
        }

        .main .oneself p.positionNews span,
        .main .other p.positionNews span {
            padding: 0 .1rem;
        }

        .main .oneself p.positionNews:before {
            content: "";
            position: absolute;
            z-index: 1;
            top: .25rem;
            right: -.22rem;
            display: inline-block;
            width: 0;
            height: 0;
            border-top: .15rem solid transparent;
            border-bottom: .15rem solid transparent;
            border-left: .22rem solid #fff;
        }

        .main .oneself p.positionNews:after {
            content: "";
            position: absolute;
            z-index: 3;
            top: .25rem;
            right: -.20rem;
            display: inline-block;
            width: 0;
            height: 0;
            border-top: .15rem solid transparent;
            border-bottom: .15rem solid transparent;
            border-left: .22rem solid #fff;
        }

        .positionNews span {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .positionNews .posName {
            font-size: .28rem;
            line-height: .32rem;
        }

        .positionNews .posiDes {
            margin-top: .06rem;
            margin-bottom: .08rem;
            ;
            font-size: .22rem;
            line-height: .24rem;
            color: #999;
        }

        .positionNews img {
            width: 100%;
            height: 1.7rem;
            border-bottom-right-radius: .1rem;
            border-bottom-left-radius: .1rem;
            position: absolute;
            bottom: 0;
        }

        /* 位置消息气泡 */

        /* 拖消息气泡 */

        .main .imgwrap p {
            padding: 0;
            border: 0;
            background-color: transparent;
        }

        .main .imgwrap .imgNews {
            border-radius: .1rem;
        }

        .main .imgwrap p:before,
        .main .imgwrap p:after {
            content: "";
            position: absolute;
            z-index: 3;
            top: .25rem;
            right: -.20rem;
            display: inline-block;
            width: 0;
            height: 0;
            /* border-top: .15rem solid transparent;
        border-bottom: .15rem solid transparent;
        border-left: .22rem solid #a0e75a; */
            border: 0;

        }

        /* 拖消息气泡 */

        .recording {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url(../../image/chatPage/icon_recording.gif)no-repeat;

            background-size: 2.72rem 2.72rem;
            background-position: center;
            display: none;
            z-index: 9999;
        }

        .my-name {

            font-size: 0.14rem;
            color: #999;

        }

        .oneself .my-name {
            text-align: right;
            margin-right: 0.4rem;
        }

        .other .my-name {
            text-align: left;
            margin-left: 0.4rem;
        }
    </style>
</head>

<body id="body" ontouchstart="closeDiv1();">
    <div class="recording"></div>
    <div class="main">
        <!--  -->
        <!-- <div data-msgId="" class="oneself clearfix imgwrap">
            <img class="fr oneselfImg" src="../../image/tx_1.jpg">
            <p data-msgId="" class="fr flex-def flex-cCenter" tapmode onclick="previewImg(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()"
                ontouchend="gtouchend()">
                <img class="imgNews" src="../../image/tx_1.jpg"> </p>
        </div>
<div data-msgId="17" class="other clearfix imgwrap">
    <div class="time">上午10:42:52</div>
    <div class="flex-def">
        <img tapmode onclick="openMemberInfo(this)" data-id="102543" class="otherImg" src="http://img.iinnet.com/FkyGHXeVO8-N9JD69262-4p-gyYv">
        <div class="flag-def flex-zTopBottom">
            <div class="my-name">袁壮</div>
            <p data-msgId="17" class="flex-def flex-cCenter" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()"
                ontouchend="gtouchend()">
<img class="imgNews" src="https://rongcloud-image.cn.ronghub.com/image_jpeg__RC-2018-02-26_5641_1519612970688.jpg?e=2147483647&token=CddrKW5AbOMQaDRwc3ReDNvo3-sL_SO1fSUBKV3H:B83jHNcLeTnMjbIybSqNe8is4Dk=">
            </p>
        </div>
    </div>
</div>  
<div class="oneself clearfix">
    <div class="time">04:19</div>
    <img class="fr oneselfImg" src="../../image/icon_defaultHead.png">
    <p class="positionNews fr flex-def flex-zTopBottom">
        <span class="posName">清华大学清华大学清华大学清华大学清华大学清华大学清华大学清华大学清华大学</span>
        <span class="posiDes">清华大学清华大学清华大学清华大学清华大学清华大学清华大学清华大学清华大学</span>
        <img src="../../image/icon_defaultHead.png" alt="">
    </p>
</div>-->


        <div class="shadow">
            <p tapmode="" onclick="closeDiv(0);event.stopPropagation();">
                复制
            </p>
            <!-- <p tapmode onclick="closeDiv(1);event.stopPropagation();">发送给朋友</p> 
        <p tapmode onclick="closeDiv(2);event.stopPropagation();">收藏</p> 
        <p tapmode onclick="closeDiv(3);event.stopPropagation();">翻译</p>  -->
            <p tapmode="" onclick="closeDiv(4);event.stopPropagation();">
                删除
            </p>
            <!-- <p tapmode onclick="closeDiv(5);event.stopPropagation();">更多</p>  -->
        </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    var is_blacklist = 2;
    var user_name, user_head;
    var user_info = {};
    var emotionData;
    apiready = function () {
         // 处理群成员数据ß
        dataProcessing();
        // console.log('传来的数据:'+JSON.stringify(api.pageParam));
        moduleInit();
        chatTools();
        // 表情转换
        // 获取历史消息
        updatePage();
        
        // 事件监听
        eventListener();
        // 处理群数据
        dataProcessing()
       
    }
    // 时间监听以及数据处理
    function eventListener() {
        user_name = $api.getStorage('userName');
        user_head = $api.getStorage('imgCache');

        // 去除头像上的消息数量
        api.sendEvent({
            name: 'refurbish'
        });
        // 监听发送位置
        api.addEventListener({
            name: 'sendPosition'
        }, function (ret, err) {
            sendPosition(ret.value.positionObj);
        });
        // 接收消息
        api.addEventListener({
            name: 'receiveMsg'
        }, function (ret, err) {
            if (ret.value.msgContent.result.message.objectName == 'RC:TxtMsg') {
                sendTextCreate(ret.value.msgContent.result.message, ret.value.msgContent.result.message.messageDirection)
            } else if (ret.value.msgContent.result.message.objectName == 'RC:ImgMsg') {
                sendImgCreate(ret.value.msgContent.result.message, ret.value.msgContent.result.message.messageDirection)
            } else if (ret.value.msgContent.result.message.objectName == 'RC:LBSMsg') {
                sendPosCreate(ret.value.msgContent.result.message, ret.value.msgContent.result.message.messageDirection)
            } else if (ret.value.msgContent.result.message.objectName == 'RC:VcMsg') {
                sendVoiceCreate(ret.value.msgContent.result.message, ret.value.msgContent.result.message.messageDirection)
            }
            // 缓存消息
            saveMessage(ret.value.msgContent);
        });
    }
    // 处理群数据
    function dataProcessing() {
        for (var i = 0; i < api.pageParam.data.group_member_info.length; i++) {
            var element = api.pageParam.data.group_member_info[i];
            user_info[element.rongcloud_user_id] = element
        }
    }
    // 关闭浮成菜单
    function closeDiv1() {
        $api.css($api.dom('.shadow'), 'display:none');
    }
    // 发送文字消息
    function sendMsg(params) {
        var sendMsg;
        rong.sendTextMessage({
            conversationType: 'GROUP',
            targetId: api.pageParam.group_id,
            text: params,
            extra: ''
        }, function (ret, err) {
            if (ret.status == 'prepare') {
                sendMsg = ret;
            } else if (ret.status == 'success') {
                sendTextCreate(sendMsg.result.message, 'SEND');
                historicalNews();
                saveMessage(sendMsg, 'SEND');
            } else if (ret.status == 'error') {
                if (err.code == 405) {
                    api.toast({
                        msg: '你在对方的黑名单中',
                        duration: 2000,
                        location: 'bottom'
                    });
                } else {
                    api.toast({
                        msg: ret.msg,
                        duration: 2000,
                        location: 'bottom'
                    });
                }
            }

        });
    }
    // 发送位置
    function sendPosition(ret) {
        var paramData;
        rong.sendLocationMessage({
            conversationType: 'GROUP',
            targetId: api.pageParam.group_id,
            latitude: parseFloat(ret.lat),
            longitude: parseFloat(ret.lon),
            poi: ret.name + ',' + ret.address,
            imagePath: ret.imgPath,
            extra: ''
        }, function (ret, err) {
            if (ret.status == 'prepare') {
                paramData = ret;
                // console.log('发送准备:'+JSON.stringify(ret))
            } else if (ret.status == 'progress') {
                //console.log('发送准备222:'+JSON.stringify(ret))
            } else if (ret.status == 'success') {
                historicalNews();
                //console.log( JSON.stringify(ret));
                sendPosCreate(paramData.result.message, 'SEND');
                // 存入数据库
                saveMessage(paramData, 'sendMsg');
            } else if (ret.status == 'error') {
                // console.log( err.code);
            }

        });
    }
    // 聊天界面
    function chatTools() {
        UIChatBox.open({
            // placeholder: '请输入内容',
            maxRows: 6,
            emotionPath: 'widget://image/chatPage/emotion',
            texts: {
                recordBtn: {
                    normalTitle: '按住说话',
                    activeTitle: '松开结束'
                },
                sendBtn: {
                    title: '发送'
                }
            },
            styles: {
                inputBar: {
                    borderColor: '#d9d9d9',
                    bgColor: '#f2f2f2'
                },
                inputBox: {
                    borderColor: '#d9d9d9',
                    bgColor: '#FFFFFF'
                },
                emotionBtn: {
                    normalImg: 'widget://image/chatPage/face1.png'
                },
                // 加号按钮
                extrasBtn: {
                    normalImg: 'widget://image/chatPage/add1.png'
                },
                keyboardBtn: {
                    normalImg: 'widget://image/chatPage/key1.png'
                },
                // 录音按钮
                speechBtn: {
                    normalImg: 'widget://image/chatPage/cam1.png'
                },
                // “按住 录音”按钮的样式
                recordBtn: {
                    normalBg: 'widget://image/chatPage/suo1.png',
                    activeBg: 'widget://image/chatPage/suo2.png',
                    color: '#000',
                    size: 14
                },
                indicator: {
                    target: 'both',
                    color: '#c4c4c4',
                    activeColor: '#9e9e9e'
                },
                sendBtn: {
                    titleColor: '#fff',
                    bg: '#4cc518',
                    activeBg: '#46a91e',
                    titleSize: 14
                }
            },
            extras: {
                titleSize: 10,
                titleColor: '#a3a3a3',
                btns: [{
                    title: '图片',
                    normalImg: 'widget://image/chatPage/album1.png',
                    activeImg: 'widget://image/chatPage/album2.png'
                }, {
                    title: '拍照',
                    normalImg: 'widget://image/chatPage/camera1.png',
                    activeImg: 'widget://image/chatPage/camera2.png'
                }, {
                    title: '位置',
                    normalImg: 'widget://image/chatPage/position1.png',
                    activeImg: 'widget://image/chatPage/position2.png'
                }]
            }
        }, function (ret, err) {
            if (ret) {
                boxChatEventListener();
                changeHeight();
                if (ret.eventType == 'send') {
                    if (is_blacklist == 2) {
                        // msg: 发送的消息
                        if (ret.msg == '') {
                            // ios下输入框为空的时候不发送消息
                        } else {
                            sendMsg(ret.msg);
                        }
                        // 把聊天内容滑动到最下面
                    } else {
                        api.toast({
                            msg: '对方在你的黑名单列表中',
                            duration: 2000,
                            location: 'bottom'
                        });
                    }

                }

                if (ret.eventType === 'clickExtras') {
                    if (is_blacklist == 2) {
                        if (ret.index === 0) {
                            // 打开相册
                            openPicture('album');
                        } else if (ret.index === 1) {
                            // 打开相机
                            openPicture('camera');
                        } else if (ret.index === 2) {
                            // 发送位置
                            api.openWin({
                                name: 'winnmap_winame',
                                url: './map_win.html',
                                bounces: false,
                                pageParam: {
                                    key: 'value'
                                }
                            });
                        } else {

                        }
                    } else {
                        api.toast({
                            msg: '对方在你的黑名单列表中',
                            duration: 2000,
                            location: 'bottom'
                        });
                    }
                }
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }
    // 打开相册
    function openPicture(type) {
        api.getPicture({
            sourceType: type,
            mediaValue: 'pic',
            encodingType: 'jpg',
            destinationType: 'url',
            quality: 100,
            saveToPhotoAlbum: true
        }, function (ret, err) {
            if (ret) {
                if (ret.data) {
                    sendImg(ret);
                }
            } else {
                // alert(JSON.stringify(err));
            }
        });
    }
    // 发送图片消息
    function sendImg(img) {
        // console.log(JSON.stringify(ret))
        var retprepare;
        rong.sendImageMessage({
            conversationType: 'GROUP',
            targetId: api.pageParam.group_id,
            imagePath: img.data,
            extra: ''
        }, function (ret, err) {
            if (ret.status == 'prepare') {
                retprepare = ret;
                retprepare.result.message.content.imageUrl = img.data;
                sendImgCreate(retprepare.result.message, 'SEND');
            } else if (ret.status == 'progress') {} else if (ret.status == 'success') {
                historicalNews();
                // sendImgCreate(retprepare.result.message, headImg, 1);
                // 存入本地缓存
                saveMessage(retprepare, 'sendMsg');
                // 发送成功
            } else if (ret.status == 'error') {
                // 发送失败
                console.log(JSON.stringify(ret));
            } else {}
        });
    }
    // 监听录音按钮
    function boxChatEventListener() {
        UIChatBox.addEventListener({
            target: 'recordBtn',
            name: 'press'
        }, function (ret, err) {
            if (ret) {
                $api.css($api.dom('.recording'),
                    'background:  url(../../image/chatPage/icon_recording.gif)no-repeat;background-size: 2.72rem 2.72rem;background-position: center;'
                );
                $api.css($api.dom('.recording'), 'display: block');
                // 开始录音
                api.startRecord();
            } else {
                // alert(JSON.stringify(err));
            }
        });
        UIChatBox.addEventListener({
            target: 'recordBtn',
            name: 'move_out'
        }, function (ret, err) {
            // console.log( '按下录音按钮后，从按钮移出');
            $api.css($api.dom('.recording'),
                'background:  url(../../image/chatPage/icon_recording2.png)no-repeat;background-size: 2.72rem 2.72rem;background-position: center;'
            );
        });
        UIChatBox.addEventListener({
            target: 'recordBtn',
            name: 'move_out_cancel'
        }, function (ret, err) {
            // console.log( '按下录音按钮后，从按钮移出并松开按钮');
            $api.css($api.dom('.recording'), 'display: none');
            api.stopRecord();
        });
        UIChatBox.addEventListener({
            target: 'recordBtn',
            name: 'move_in'
        }, function (ret, err) {
            // console.log( 'ove_out 事件后，重新移入按钮区域');
            $api.css($api.dom('.recording'),
                'background:  url(../../image/chatPage/icon_recording.gif)no-repeat;background-size: 2.72rem 2.72rem;background-position: center;'
            );
        });
        UIChatBox.addEventListener({
            target: 'recordBtn',
            name: 'press_cancel'
        }, function (ret, err) {
            if (ret) {
                $api.css($api.dom('.recording'), 'display: none');
                $api.css($api.dom('.recording'),
                    'background:  url(../../image/chatPage/icon_recording.gif)no-repeat;background-size: 2.72rem 2.72rem;background-position: center;'
                );
                api.stopRecord(function (ret, err) {
                    if (ret) {
                        // 停止录音
                        // ret.path 录音路径
                        // ret.duration 录音时长
                        sendVicoe(ret);
                    } else {
                        // alert(JSON.stringify(err));
                    }
                });
            } else {
                // alert(JSON.stringify(err));
            }
        });
    }
    // 发送语音消息
    function sendVicoe(ret) {
        var retData = ret;
        var retprepare;
        rong.sendVoiceMessage({
            conversationType: 'GROUP',
            targetId: api.pageParam.group_id,
            voicePath: retData.path,
            duration: retData.duration,
            extra: ''
        }, function (ret, err) {
            if (ret.status == 'prepare') {
                // 发送准备
                retprepare = ret;
            } else if (ret.status == 'success') {
                historicalNews();
                // 发送成功
                sendVoiceCreate(retprepare.result.message, 'SEND');
                // 存储到表中
                saveMessage(retprepare, 'sendMsg');
            } else if (ret.status == 'error') {}

        });
    }
    // 监听键盘高度
    function changeHeight() {
        UIChatBox.addEventListener({
            target: 'inputBar',
            name: 'move'
        }, function (ret, err) {
            pushPageMove(ret.panelHeight, ret.inputBarHeight);
            window.setTimeout('slideBut()', 300);
        });
        UIChatBox.addEventListener({
            target: 'inputBar',
            name: 'change'
        }, function (ret, err) {
            pushPageMove(ret.panelHeight, ret.inputBarHeight);
            window.setTimeout('slideBut()', 300);
        });
    }
    // 修改聊天内容高度
    function pushPageMove(panelHeight, inputBarHeight) {
        var inputHeight = api.winHeight - (panelHeight + inputBarHeight);
        setTimeout(function () {
            api.setFrameAttr({
                name: 'chattContent',
                rect: {
                    x: 0,
                    y: api.pageParam.headerH,
                    h: inputHeight
                }
            });

        }, 10);
    }
    // 判断是否是黑名单
    function isBlackList() {
        api.ajax({
            url: apiSite + '/friendAuth/authUser',
            method: 'post',
            headers: apiHeader,
            data: {
                values: {
                    token: $api.getStorage('userToken'),
                    to_user: api.pageParam.userId
                }
            }
        }, function (ret, err) {
            if (ret) {
                if (ret.code === 200) {
                    // 1 是 2 否
                    //  console.log(JSON.stringify(ret))
                    if (ret.data.list.is_blacklist == 1) {
                        // 已把用户拉黑
                        is_blacklist = 1
                    } else {
                        is_blacklist = 2

                    }
                } else {
                    alert(ret.msg)
                }
            } else {
                alert(JSON.stringify(err))
            }
        })
    }
    // 滚动到页面底部
    function slideBut() {
        // scrollIntoView 滚动到可是界面的底部   true滚动到顶部
        $api.dom('.main').scrollIntoView(false);
    }
    // 获取历史消息
    function getHistoryNews() {

        var msgObj;
        // 本地历史消息
        db.selectSql({
            name: 'db_' + $api.getStorage('userToken'),
            sql: 'SELECT * FROM tb_chat_group_' + api.pageParam.group_id
        }, function (ret, err) {
            if (ret.status) {
                console.log('查询到的结果' + JSON.stringify(ret))
                if (ret.data.length > 0) {
                    msgObj = ret.data;
                    handleMsg(msgObj)
                } else {
                    // 网络获取消息
                     // 网络获取历史消息
                    rong.getHistoryMessages({
                        conversationType: 'GROUP',
                        targetId: api.pageParam.group_id,
                        oldestMessageId: -1,
                        count: 20
                    }, function (ret, err) {
                        if (ret.status == 'success') {
                            msgObj = ret.result
                            handleMsg(msgObj)
                        } else {

                        }
                    })
                }
            } else {
                alert('386');
            }
        });
        // rong.getHistoryMessages({
        //     conversationType: 'GROUP',
        //     targetId: api.pageParam.group_id,
        //     oldestMessageId: -1,
        //     count: 20
        // }, function (ret, err) {
        //     if (ret.status == 'success') {
        //         msgObj = ret.result
        //         handleMsg(msgObj)
        //     } else {

        //     }
        // })
        
    }
    // 处理历史消息
    function handleMsg(msg) {
        var rong_id_arr = [];
        for (var j = msg.length - 1; j >= 0; j--) {
            if (msg[j].messageDirection == 'RECEIVE') {
                rong_id_arr.push(msg[j].senderUserId)
            }
        }
        for (var i = msg.length - 1; i >= 0; i--) {
            var element = msg[i];
            // RC:TxtMsg 文字消息
            // RC:VcMsg 录音消息
            // RC:ImgMsg 图片消息
            // RC:LBSMsg 位置消息
            // element.messageDirection == 'RECEIVE'  接收的消息
            // element.messageDirection == 'SEND'  发送的消息
            if (element.objectName == 'RC:TxtMsg') {
                sendTextCreate(element, element.messageDirection)
            } else if (element.objectName == 'RC:ImgMsg') {
                sendImgCreate(element, element.messageDirection)
            } else if (element.objectName == 'RC:LBSMsg') {
                sendPosCreate(element, element.messageDirection)
            } else if (element.objectName == 'RC:VcMsg') {
                sendVoiceCreate(element, element.messageDirection)
            }
        }
    }
    // 新建文字消息
    function sendTextCreate(msg, flag) {
        var time;
        var str;
        var text,nickname,head_img,user_id;
        if (msg.group_id) {
            // 本地数据
            text = msg.content_text;
            head_img = msg.head_img_url;
            nickname = msg.nickname;
            user_id = msg.user_id;
        } else {
            // 网络数据
            text = msg.content.text
            head_img = (user_info[msg.senderUserId].remark_head_img_url?user_info[msg.senderUserId].remark_head_img_url:user_info[msg.senderUserId].head_img_url);
            nickname = (user_info[msg.senderUserId].remark_nickname?user_info[msg.senderUserId].remark_nickname:user_info[msg.senderUserId].nickname);
            user_id = user_info[msg.senderUserId].user_id;
        }
        if (text != ' ') {
            if (flag == 'SEND') {
                // 发送文字消息
                time = new Date(parseInt(msg.sentTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
                    new Date(parseInt(msg.sentTime, 10)).toLocaleTimeString():new Date(parseInt(msg.sentTime, 10)).toLocaleString();
                str = '<div data-msgId="' + msg.messageId + '" class="oneself clearfix"><div class="time">' + time +'</div><div class="flex-def flex-zEnd"><div class="flag-def flex-zTopBottom"><p data-msgId="' + msg.messageId +'" class="flex-def flex-cCenter" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()">' + transText(text) + '</p></div><img tapmode onclick="openMemberInfo(this)" data-id="1" class="oneselfImg" src="' + head_img + '"></div></div>'
                $api.append($api.dom('.main'), str);
                slideBut();
            } else {
                // 接收文字消息
                time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
                    new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString():new Date(parseInt(msg.receivedTime,
                        10))
                    .toLocaleString();
                str = '<div data-msgId="' + msg.messageId + '" class="other clearfix"><div class="time">' + time +
                    '</div><div class="flex-def"><img tapmode onclick="openMemberInfo(this)" data-id="' + user_id + '" class="otherImg" src="' + head_img +
                    '"> <div class="flag-def flex-zTopBottom"><div class="my-name">' + nickname +
                    '</div><p data-msgId="' + msg.messageId +
                    '" class="flex-def flex-cCenter" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()" >' +
                    transText(text) + '</p></div></div></div>'
                $api.append($api.dom('.main'), str);
                slideBut();
            }
        }

    }
    // 新建图片消息
    function sendImgCreate(msg, flag) {
        var time;
        var str;
        if (flag == 'SEND') {
            // 发送图片消息
            time = new Date(parseInt(msg.sentTime, 10)).toLocaleDateString() == new Date().toLocaleDateString()?new Date(
                parseInt(msg.sentTime, 10)).toLocaleTimeString():new Date(parseInt(msg.sentTime, 10)).toLocaleString();
            str = `
                <div data-msgId="` + msg.messageId +
                `" class="oneself clearfix imgwrap">
                    <div class="time">` + time +
                `</div>
                    <img class="fr oneselfImg" src="` + user_head +
                `">
                    <p data-msgId="" class="fr flex-def flex-cCenter" tapmode onclick="previewImg(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()"
                        ontouchend="gtouchend()">
                        <img class="imgNews" src="` +
                msg.content.imageUrl + `">
                    </p>
                </div>
            `
            $api.append($api.dom('.main'), str);
            slideBut();
        } else {
            // 接收图片消息
            time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
                new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString():new Date(parseInt(msg.receivedTime, 10))
                .toLocaleString();

            str = '<div data-msgId="' + msg.messageId + '" class="other imgwrap clearfix"><div class="time">' + time +
                '</div><div class="flex-def"><img tapmode onclick="openMemberInfo(this)" data-id="' + user_info[msg.senderUserId]
                .user_id + '" class="otherImg" src="' + (user_info[msg.senderUserId].remark_head_img_url?user_info[
                    msg.senderUserId].remark_head_img_url:user_info[msg.senderUserId].head_img_url) +
                '"><div class="flag-def flex-zTopBottom"><div class="my-name">' + (user_info[msg.senderUserId].remark_nickname ?
                    user_info[msg.senderUserId].remark_nickname:user_info[msg.senderUserId].nickname) +
                '</div><p data-msgId="' + msg.messageId +
                '" class="flex-def flex-cCenter" tapmode onclick="previewImg(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()"><img class="imgNews" src="' +
                msg.content.imageUrl + '"></p></div></div></div>'
            $api.append($api.dom('.main'), str);
            slideBut();
        }
    }
    // 新建位置消息
    function sendPosCreate(msg, flag) {
        var time;
        var str;
        var positionCount = msg.content.poi.indexOf(',');
        if (flag == 'SEND') {
            // 发送图片消息
            time = new Date(parseInt(msg.sentTime, 10)).toLocaleDateString() == new Date().toLocaleDateString()?new Date(
                parseInt(msg.sentTime, 10)).toLocaleTimeString():new Date(parseInt(msg.sentTime, 10)).toLocaleString();
            str = `
                <div class="oneself clearfix" data-msgId="` + msg.messageId +
                `">
                    <div class="time">` + time +
                `</div>
                    <img class="fr oneselfImg" src="` + user_head +
                `">
                    <p tapmode onclick="openPosiPage(this)"  data-address="` + msg.content.poi.substring(
                    positionCount + 1) + `" data-name="` + msg.content.poi.substring(0, positionCount) +
                `" data-lat="` + msg.content.latitude + `" data-lon="` + msg.content.longitude +
                `" class="positionNews fr flex-def flex-zTopBottom">
                        <span class="posName">` +
                msg.content.poi.substring(0, positionCount) + `</span>
                        <span class="posiDes">` +
                msg.content.poi.substring(positionCount + 1) + `</span>
                        <img src="` + msg.content
                .imagePath + `" alt="">
                    </p>
                </div>
            `
            $api.append($api.dom('.main'), str);
            slideBut();
        } else {
            // 接收图片消息
            time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
                new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString():new Date(parseInt(msg.receivedTime, 10))
                .toLocaleString();

            str = '<div data-msgId="' + msg.messageId + '" class="other clearfix"><div class="time">' + time +
                '</div><div class="flex-def"><img tapmode onclick="openMemberInfo(this)" data-id="' + user_info[msg.senderUserId]
                .user_id + '" class="otherImg" src="' + (user_info[msg.senderUserId].remark_head_img_url?user_info[
                    msg.senderUserId].remark_head_img_url:user_info[msg.senderUserId].head_img_url) +
                '"><div class="flag-def flex-zTopBottom"><div class="my-name">' + (user_info[msg.senderUserId].remark_nickname ?
                    user_info[msg.senderUserId].remark_nickname:user_info[msg.senderUserId].nickname) +
                '</div> <p tapmode onclick="openPosiPage(this)"  data-address="' + msg.content.poi.substring(
                    positionCount + 1) + '" data-name="' + msg.content.poi.substring(0, positionCount) + '" data-lat="' +
                msg.content.latitude + '" data-lon="' + msg.content.longitude +
                '"  class="positionNews fr flex-def flex-zTopBottom"><span class="posName" > ' + msg.content.poi.substring(
                    0, positionCount) + '</span ><span class="posiDes">' + msg.content.poi.substring(positionCount + 1) +
                '</span><img src="' + msg.content.imagePath + '" alt=""></p></div></div></div>'
            $api.append($api.dom('.main'), str);
            slideBut();
        }
    }
    // 新建录音消息
    function sendVoiceCreate(msg, flag) {
        var time;
        var str;
        var widthNum = msg.content.duration;
        if (flag == 'SEND') {
            // 发送录音消息
            time = new Date(parseInt(msg.sentTime, 10)).toLocaleDateString() == new Date().toLocaleDateString()?new Date(
                parseInt(msg.sentTime, 10)).toLocaleTimeString():new Date(parseInt(msg.sentTime, 10)).toLocaleString();
            str = `
                 <div class="oneself clearfix" data-msgId="` + msg.messageId +
                `">
                    <div class="time">` + time +
                `</div>
                    <img class="fr oneselfImg" src="`+ user_head +`">
                    <p class="fr flex-def flex-cCenter flex-zEnd" style="width:` +
                widthNum / 4 +
                `rem" ontouchstart="gtouchstart()" ontouchmove="gtouchmove()"
                        ontouchend="gtouchend()" tapmode onclick="playVoice(this)" data-voivePath= "` + msg.content.voicePath +
                `">
                        <img class="fr voiceMsg" src="../../image/chatPage/icon_break1.png" height="20">
                    </p>
                    <span class="voiceTime fr">` +
                msg.content.duration + `"</span>
                </div>
            `
            $api.append($api.dom('.main'), str);
            slideBut();
        } else {
            // 接收录音消息
            time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
                new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString():new Date(parseInt(msg.receivedTime, 10))
                .toLocaleString();
            str = '<div data-msgId="' + msg.messageId + '" class="other clearfix"><div class="time">' + time +
                '</div><div class="flex-def"><img tapmode onclick="openMemberInfo(this)" data-id="' + user_info[msg.senderUserId]
                .user_id + '" class="otherImg" src="' + (user_info[msg.senderUserId].remark_head_img_url?user_info[
                    msg.senderUserId].remark_head_img_url:user_info[msg.senderUserId].head_img_url) +
                '"><div class="flag-def flex-zTopBottom"><div class="my-name">' + (user_info[msg.senderUserId].remark_nickname?user_info[msg.senderUserId].remark_nickname:user_info[msg.senderUserId].nickname) +
                '</div><p class="fl flex-def flex-cCenter flex-zStart" style="width:' + widthNum / 4 +
                'rem" ontouchstart="gtouchstart()" ontouchmove="gtouchmove()"ontouchend = "gtouchend()" tapmode onclick="playVoice(this)" data-voivePath= "' + msg.content.voicePath + '"><img class="voiceMsg" src="../../image/chatPage/icon_break.png" height="20"></p><span class="voiceTime voiceTimeOther fl">' +
                msg.content.duration + '"</span></div></div></div>'
            $api.append($api.dom('.main'), str);
            slideBut();
        }
    }
    // 用户详情
    function openMemberInfo(ele) {
        var flag = $api.attr(ele, 'data-id');
        api.closeWin({
            name: 'txl_memberInfo_Win'
        });
        if (flag == 1) {
            api.openWin({
                name: 'txl_memberInfo_Win',
                url: '../addressList/txl_memberInfo_Win.html',
                pageParam: {
                    userId: 0
                }
            });
        } else {
            api.openWin({
                name: 'txl_memberInfo_Win',
                url: '../addressList/txl_memberInfo_Win.html',
                pageParam: {
                    userId: flag
                }
            });
        }
        // alert(userId +'--'+ api.pageParam.userId)
    }
    var timeOutEvent = 0; // 定时器
    // 开始按
    function gtouchstart(ele) {
        newsText = $api.attr(ele, 'data-newsText');
        msgId = $api.attr(ele, 'data-msgId');
        // console.log($api.text(ele))
        // console.log($api.html(ele))

        // console.log('id::'+msgId+'text::'+ newsText)
        var e = window.event;
        var x = e.touches[0].clientX;
        var y = e.touches[0].clientY;
        timeOutEvent = setTimeout('longPress(' + x + ',' + y + ')', 500);
        // 这里设置定时器，定义长按500毫秒触发长按事件，时间可以自己改，个人感觉500毫秒非常合适
        return false;
    }
    // 手释放，如果在500毫秒内就释放，则取消长按事件，此时可以执行onclick应该执行的事件
    function gtouchend() {
        clearTimeout(timeOutEvent); // 清除定时器
        if (timeOutEvent != 0) {
            // 这里写要执行的内容（尤如onclick事件）
        }

        return false;
    }
    // 如果手指有移动，则取消所有事件，此时说明用户只是要移动而不是长按
    function gtouchmove() {
        clearTimeout(timeOutEvent); // 清除定时器
        timeOutEvent = 0;
    }
    // 真正长按后应该执行的内容
    function longPress(x, y) {
        if (api.frameWidth - (x + 10) < api.frameWidth / 2) {
            x = x - 70;
        }

        if (api.winHeight - (y + 10) < api.winHeight / 2) {
            y = y - 110;
        }

        // console.log('坐标:'+x+','+y)
        timeOutEvent = 0;
        $api.css($api.dom('.shadow'), 'display:inline-block;top:' + 2 * y / 100 + 'rem;left:' + 2 * x / 100 + 'rem;');
        // console.log(JSON.stringify($api.offset($api.dom('.shadow'))))
        // 执行长按要执行的内容，如弹出菜单
    }
    // 表情转换第一步
    function updatePage() {
        nickname = api.pageParam.nickname;
        var sourcePath = 'widget://image/chatPage/emotion'; // 表情存放目录
        getImgsPaths(sourcePath, function (emotion) {
            emotionData = emotion;
            // 获取历史消息
            getHistoryNews();
        });
    }
    // 表情转换2
    function getImgsPaths(sourcePathOfChatBox, callback) {
        var jsonPath = 'widget://image/chatPage/emotion/emotion.json'; // 表情的JSON数组
        api.readFile({
            path: jsonPath
        }, function (ret, err) {
            if (ret.status) {
                var emotionArray = JSON.parse(ret.data);
                var emotion = {};
                for (var idx in emotionArray) {
                    var emotionItem = emotionArray[idx];
                    var emotionText = emotionItem.text;
                    var emotionUrl = '../../image/chatPage/emotion/' + emotionItem.name + '.png';
                    emotion[emotionText] = emotionUrl;
                }

                /*把emotion对象 回调出去*/
                if ('function' === typeof (callback)) {
                    callback(emotion);
                }
            }

        });
    }
    // 表情转换3
    function transText(text, imgWidth, imgHeight) {
        var imgWidth = imgWidth || 20;
        var imgHeight = imgHeight || 20;
        var regx = /\[(.*?)\]/gm;
        var textTransed = text.replace(regx, function (match) {
            var imgSrc = emotionData[match];
            if (!imgSrc) {
                // 说明不对应任何表情，直接返回
                return match;
            }
            var img = '<img src="' + imgSrc + '" width="' + imgWidth + '" height="' + imgHeight + '">';
            return img;
        });
        return textTransed;
    }
    // 预览图片
    function previewImg(ele) {
        api.openFrame({
            name: 'chat_previewImg',
            url: './chat_previewImg.html',
            rect: {
                x: 0,
                y: 0,
                w: 'auto',
                h: 'auto'
            },
            pageParam: {
                imgUrl: $api.attr($api.dom(ele, 'img'), 'src')
            },
            bounces: false,
            scaleEnabled: true
        });
    }
    // 点击地址
    function openPosiPage(ele) {
        var lat = $api.attr(ele, 'data-lat');
        var lon = $api.attr(ele, 'data-lon');
        var name = $api.attr(ele, 'data-name');
        var address = $api.attr(ele, 'data-address');
        //  console.log('lat:'+lat+', lon:'+ lon )
        api.openWin({
            name: 'positionInfoPage_win',
            url: './positionInfoPage_win.html',
            pageParam: {
                obj: {
                    lat: lat,
                    lon: lon,
                    name: name,
                    address: address
                }
            }
        });
    }
     // 播放语音
    function playVoice(ele) {
        // <img class="voiceMsg"  src="../../image/chatPage/icon_break.png"  height="20">
        // 有其他播放的语音暂停
        // 当前语音是否正在播放
        if ($api.hasCls($api.closest(ele, 'div'), 'oneself')) {
            // 自己
            if ($api.attr($api.dom(ele, '.voiceMsg'), 'src') == '../../image/chatPage/icon_play1.gif') {
                api.stopPlay();
                $api.attr($api.dom(ele, '.voiceMsg'), 'src', '../../image/chatPage/icon_break1.png');
            } else {
                playVoice2(ele);
            }
        } else {
            // other
            if ($api.attr($api.dom(ele, '.voiceMsg'), 'src') == '../../image/chatPage/icon_play.gif') {
                api.stopPlay();
                $api.attr($api.dom(ele, '.voiceMsg'), 'src', '../../image/chatPage/icon_break.png');
            } else {
                playVoice2(ele);
            }
        }
    }
    function playVoice2(ele) {
        // 暂停其他正在播放的语音
        var currentPlay = $api.dom('.voiceMsg[src="../../image/chatPage/icon_play1.gif"]');
        var currentPlay1 = $api.dom('.voiceMsg[src="../../image/chatPage/icon_play.gif"]');
        if (currentPlay) {
            api.stopPlay();
            // 自己
            $api.attr(currentPlay, 'src', '../../image/chatPage/icon_break1.png');
        }

        if (currentPlay1) {
            api.stopPlay();
            // other
            $api.attr(currentPlay1, 'src', '../../image/chatPage/icon_break.png');
        }

        // 更换播放图标
        if ($api.hasCls($api.closest(ele, 'div'), 'oneself')) {
            // 自己
            $api.attr($api.dom(ele, '.voiceMsg'), 'src', '../../image/chatPage/icon_play1.gif');
        } else {
            // other
            $api.attr($api.dom(ele, '.voiceMsg'), 'src', '../../image/chatPage/icon_play.gif');
        }
        // 播放语音
        api.startPlay({
            path: $api.attr(ele, 'data-voivePath')
        }, function (ret, err) {
            if (ret) {
                if ($api.hasCls($api.closest(ele, 'div'), 'oneself')) {
                    // 自己
                    $api.attr($api.dom(ele, '.voiceMsg'), 'src', '../../image/chatPage/icon_break1.png');
                } else {
                    // other
                    $api.attr($api.dom(ele, '.voiceMsg'), 'src', '../../image/chatPage/icon_break.png');
                }
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }
    // 缓存消息
    function saveMessage(msg) {
        // console.log('发送的消息');
        // console.log(JSON.stringify(msg));
        // console.log('发送的消息');
        var content = msg.result.message;
        var user_id=user_info[msg.result.message.senderUserId].user_id
        var head_img= user_info[msg.result.message.senderUserId].remark_head_img_url?user_info[msg.result.message.senderUserId].remark_head_img_url:user_info[msg.result.message.senderUserId].head_img_url
        var nickname =  user_info[msg.result.message.senderUserId].remark_nickname?user_info[msg.result.message.senderUserId].remark_nickname:user_info[msg.result.message.senderUserId].nickname
        // 缓存头像
        api.imageCache({
            url: head_img
        }, function (ret, err) {
            head_img = ret.url;
            var SQL = 'INSERT OR REPLACE INTO tb_chat_group_' + api.pageParam.group_id + '(user_id,nickname,head_img_url,messageId,receivedTime,sentTime,objectName,messageDirection,content_extra,content_text,content_lat,content_lon,content_imagePath,voicePath,duration,thumbPath) VALUES ("' + user_id + '","' + nickname + '","' + head_img + '",';
            // messageId, receivedTime, objectName, messageDirection, content_extra, content_text, content_lat, content_lon, content_imagePath, voicePath, duration, thumbPath
            if (content.objectName == 'RC:TxtMsg') {
                SQL += content.messageId + ',"' + content.receivedTime +'","'+ content.sentTime + '", "RC:TxtMsg","' + content.messageDirection + '","' + content.content.extra + '","' + content.content.text + '","content_lat","content_lon","content_imagePath","voicePath",5,"thumbPath")'
            } else if (content.objectName == 'RC:VcMsg') {
                SQL += content.messageId + ',"' + content.receivedTime + '","' + content.sentTime + '", "RC:VcMsg","' + content.messageDirection + '","' + content.content.extra + '","text","1","2","3","' + content.content.voicePath + '",' + content.content.duration + ',"6")'
            } else if (content.objectName == 'RC:ImgMsg') {
                // 缓存图片
                // api.imageCache({
                //     url: content.content.content_imagePath
                // }, function(ret, err){
                //     if (ret.status) {
                //         content.content.content_imagePath = ret.url
                        SQL += content.messageId + ',"' + content.receivedTime + '","' + content.sentTime + '", "RC:ImgMsg","' + content.messageDirection + '","' + content.content.extra + '","text","lat","lon","' + content.content.content_imagePath + '","voicePath",5,"' + content.content.thumbPath + '")'
                    // }
                // });
            } else if (content.objectName == 'RC:LBSMsg') {
                // 缓存图片
                // api.imageCache({
                //     url: content.content.imagePath
                // }, function(ret, err){
                //     if(ret.status) {
                //         content.content.imagePath = ret.url
                        SQL += content.messageId + ',"' + content.receivedTime + '","' + content.sentTime + '", "RC:TxtMsg","' + content.messageDirection + '","' + content.content.extra + '","' + content.content.poi + '","' + content.content.latitude + '","' + content.content.longitude + '","' + content.content.imagePath + '","voicePath",5,"thumbPath")'
                    // }
                // });
            }
            SQLStatement(SQL)
        });
        
    }
    // 执行sql语句
     function SQLStatement(SQL) {
         console.log('SQL语句:'+SQL);
         
            db.executeSql({
                name: 'db_' + $api.getStorage('userToken'),
                sql: SQL
            }, function (ret, err) {
                if (ret.status) {
                    // console.log('存入聊天记录表格成功');
                    db.selectSql({
                        name: 'db_'+$api.getStorage('userToken'),
                        sql: 'SELECT * FROM tb_chat_group_' + api.pageParam.group_id
                    },function(ret,err){
                        if (ret.status) {
                            console.log('查询到的结果'+JSON.stringify(ret))
                        }else {
                            alert('386');
                        }
                    });
                } else {
                    alert('390' + JSON.stringify(err) + JSON.stringify(ret));
                }
            });
        }
</script>

</html>