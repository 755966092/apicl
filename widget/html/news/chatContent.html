<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>title</title>
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <link rel="stylesheet" href="../../css/api.css">
    <style>
    .newsTime {
        margin-bottom: .3rem;
        font-size: .2rem;
        text-align: center;
        color: #999;
    }

    .main {
        margin: .3rem .3rem;
        padding-bottom: 1.6rem;
    }

    .main .time {
        min-width: 1.1rem;
        max-width: 2rem;
        height: .36rem;
        margin: 0 auto;
        margin-bottom: .3rem;
        padding: 0 .1rem;
        /* background-color: #CFCFCF; */
        font-size: .2rem;
        line-height: .36rem;
        text-align: center;
        color: #999;
        border-radius: .05rem;
    }

    .main .oneself,
    .main .other {
        margin-bottom: .3rem;
    }

    .main .oneself img.oneselfImg,
    .main .other img.otherImg {
        width: .72rem;
        height: .72rem;
    }

    .main .oneself p,
    .main .other p {
        position: relative;
        z-index: 2;
        box-sizing: border-box;
        min-width: .7rem;
        max-width: 4.7rem;
        min-height: .72rem;
        /* line-height: .42rem; */
        margin-right: .3rem;
        padding: .04rem .2rem;
        font-size: .28rem;
        word-break: break-all;
        color: #000;
        /*height: .72rem;*/
        border-radius: .1rem;
        background-color: #a0e75a;
    }

    .main .oneself p {
        border: .02rem solid #a0e75a;
    }

    .main .oneself p:after {
        content: "";
        position: absolute;
        z-index: 3;;
        top: .25rem;
        right: -.20rem;
        display: inline-block;
        width: 0;
        height: 0;
        border-top: .15rem solid transparent;
        border-bottom: .15rem solid transparent;
        border-left: .22rem solid #a0e75a;
    }

    .main .oneself p:before {
        content: "";
        position: absolute;
        z-index: 1;
        top: .25rem;
        right: -.22rem;
        display: inline-block;
        width: 0;
        height: 0;
        border-top: .15rem solid transparent;
        border-bottom: .15rem solid transparent;
        border-left: .22rem solid #a0e75a;
    }

    .main .other p:after {
        content: "";
        position: absolute;
        top: .25rem;
        left: -.20rem;
        display: inline-block;
        width: 0;
        height: 0;
        border-top: .15rem solid transparent;
        border-right: .22rem solid #fff;
        border-bottom: .15rem solid transparent;
    }

    .main .other p:before {
        content: "";
        position: absolute;
        top: .25rem;
        left: -.22rem;
        display: inline-block;
        width: 0;
        height: 0;
        border-top: .15rem solid transparent;
        border-right: .22rem solid #e3e3e3;
        border-bottom: .15rem solid transparent;
    }

    .main .other p {
        margin-right: 0;
        margin-left: .3rem;
        border: .02rem solid #e3e3e3;
        background-color: #fff;
    }

    .supply_info {
        position: fixed;
        z-index: 999;
        top: 0;
        top: 0;
        left: 0;
        left: 0;
        overflow: hidden;
        box-sizing: border-box;
        width: 7.5rem;
        height: .7rem;
        margin-bottom: .2rem;
        padding: 0 .36rem;
        border-bottom: .01rem solid #d9d9d9;
        font-size: 0;
        line-height: .7rem;
        background-color: #fff;
    }

    .hide {
        display: none;
    }

    .supply_info img {
        width: .5rem;
        height: .5rem;
        margin-right: .1rem;
        border-radius: 50%;
    }

    img.imgNews {
        width: 3rem;
        height: auto;
        max-height: 5rem;
        margin: .2rem 0;
    }

    .supply_info .zk {
        width: .15rem;
        height: .7rem;
        background: url(../../image/icon_zk.png)no-repeat;
        background-position: 0 center;
        -webkit-background-size: .15rem .25rem;
                background-size: .15rem .25rem;
    }

    .supply_info div.div {
        overflow: hidden;
        box-sizing: border-box;
        font-size: .26rem;
        color: #3f3f3f;
    }

    .supply_info div.div span.label {
        width: .1rem;
    }

    .supply_info div.div span {
        overflow: hidden;
        max-width: 1.8rem;
        line-height: .47rem;
        white-space: nowrap;
        text-overflow: ellipsis;
    }

    .promptText {
        display: none;
        width: 4.463rem;
        height: .6rem;
        margin: 0 auto;
        margin-top: .2rem;
        font-size: .22rem;
        text-align: center;
        color: #fff;
        border-radius: .1rem;
        background-color: #cfcfcf;
    }

    .shadow {
        position: fixed;
        z-index: 1000;
        display: none;
        padding: .2rem .3rem;
        border: .01rem solid #d9d9d9;
        font-size: 0;
        line-height: .8rem;
        background-color: #fff;
        box-shadow: 2px 2px 20px #888;
    }

    .shadow p {
        font-size: .3rem;
    }

    .voiceTime {
        margin-right: .1rem;
        font-size: .2rem;
        line-height: .8rem;
        color: #999;
    }

    .voiceTimeOther {
        margin-left: .1rem;
    }
    /* 位置消息气泡 */

    .main .oneself p.positionNews,
    .main .other p.positionNews {
        position: relative;
        width: 4.43rem;
        height: 2.62rem;
        padding: .2rem 0 0 0;
        border: .02rem solid #e3e3e3;
        background: #fff;
    }

    .main .oneself p.positionNews span,
    .main .other p.positionNews span {
        padding: 0 .1rem;
    }

    .main .oneself p.positionNews:before {
        content: "";
        position: absolute;
        z-index: 1;
        top: .25rem;
        right: -.22rem;
        display: inline-block;
        width: 0;
        height: 0;
        border-top: .15rem solid transparent;
        border-bottom: .15rem solid transparent;
        border-left: .22rem solid #fff;
    }

    .main .oneself p.positionNews:after {
        content: "";
        position: absolute;
        z-index: 3;
        top: .25rem;
        right: -.20rem;
        display: inline-block;
        width: 0;
        height: 0;
        border-top: .15rem solid transparent;
        border-bottom: .15rem solid transparent;
        border-left: .22rem solid #fff;
    }

    .positionNews span {
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }

    .positionNews .posName {
        font-size: .28rem;
        line-height: .32rem;
    }

    .positionNews .posiDes {
        margin-top: .06rem;
        margin-bottom: .08rem;;
        font-size: .22rem;
        line-height: .24rem;
        color: #999;
    }

    .positionNews img {
        width: 100%;
        height: 1.7rem;
        border-bottom-right-radius: .1rem;
        border-bottom-left-radius: .1rem;
        position: absolute;
        bottom: 0;
    }
    /* 位置消息气泡 */

    /* 拖消息气泡 */
    .main .imgwrap p {
        padding: 0;
        border: 0;
        background-color: transparent;
    }
    .main .imgwrap .imgNews {
        border-radius: .1rem;
    }
    .main .imgwrap p:before,
    .main .imgwrap p:after {
        content: "";
        position: absolute;
        z-index: 3;
        top: .25rem;
        right: -.20rem;
        display: inline-block;
        width: 0;
        height: 0;
        /* border-top: .15rem solid transparent;
        border-bottom: .15rem solid transparent;
        border-left: .22rem solid #a0e75a; */
        border: 0;
    }
    /* 拖消息气泡 */
    .recording {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;height: 100%;
        background:  url(../../image/chatPage/icon_recording.gif)no-repeat;
        
        background-size: 2.72rem 2.72rem;background-position: center;
        display: none;
        z-index: 9999;
    }
    </style>
</head>

<body id="body" ontouchstart="closeDiv1();">
    <div class="supply_info hide flex-def flex-cCenter" tapmode="" onclick="openSupplyPage(this)">
        <img id="userImgUrl" src="../../image/noimage.jpg">
        <div class="flex-item flex-def">
            <div class="div flex-def flex-item flex-cCenter">
                <span id="userName"></span>
                <span class="label">(</span>
                <span id="supplyName"></span>
                <span id="price"></span>
                <span class="label">)</span>
            </div>
            <span class="zk"></span>
        </div>
    </div>
    <p class="promptText">
        请勿发布违法违规内容，共同营造文明和谐的聊天环境
    </p>
    <div class="recording"></div>
    <div class="main">
        <!-- <div class="oneself clearfix">
            <div class="time">04:19</div>
            <img class="fr oneselfImg" src="../../image/icon_defaultHead.png">
            <p class="fr flex-def flex-cCenter flex-zEnd" style="width:5rem" ontouchstart="gtouchstart()" ontouchmove="gtouchmove()"
                ontouchend="gtouchend()">
                <img class="fr" src="../../image/chatPage/icon_play1.gif" height="20"> </p>
            <span class="voiceTime fr">20"</span>
        </div>
        <div data-msgId="' + msg.messageId + '" class="other clearfix">
            <div class="time">04:19</div>
            <img tapmode onclick="openMemberInfo(this)" data-id="' + api.pageParam.targetUserId + '" class="fl otherImg" src="../../image/icon_defaultHead.png">
            <p data-msgId="' + msg.messageId + '" class="fl flex-def flex-cCenter" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()"
                ontouchend="gtouchend()" data-newsText="' + msg.content_text + '">asdasdasdasdasdasdasdasasdasdasdasdasdasdasdasasdasdasdasdasdasdasdasasdasdasdasdasdasdasdasasdasdasdasdasdasdasdas</p>
        </div>
        <div data-msgId="' + msg.messageId + '" class="other clearfix">
                <div class="time">04:19</div>
                <img tapmode onclick="openMemberInfo(this)" data-id="' + api.pageParam.targetUserId + '" class="fl otherImg" src="../../image/icon_defaultHead.png">
                <p data-msgId="' + msg.messageId + '" class="fl flex-def flex-cCenter" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()"
                    ontouchend="gtouchend()" data-newsText="' + msg.content_text + '">asdasdasdasdasdasdasdasasdasdasdasdasdasdasdasas</p>
            </div>

        <div class="other clearfix">
            <img class="fl otherImg" src="../../image/icon_defaultHead.png">
            <p class="fl flex-def flex-cCenter">
                <img src="../../image/chatPage/icon_play.gif" height="20">
            </p>
            <span class="voiceTime voiceTimeOther fl">20"</span>
        </div>
        <div class="other clearfix">
            <img class="fl otherImg" src="../../image/icon_defaultHead.png">
            <p class="positionNews fl flex-def flex-zTopBottom">
                <span class="posName">清华大学清华大学清华大学清华大学清华大学清华大学清华大学清华大学清华大学</span>
                <span class="posiDes">清华大学清华大学清华大学清华大学清华大学清华大学清华大学清华大学清华大学</span>
                <img src="../../image/icon_defaultHead.png" alt="">
            </p>
        </div>
        <p class="newsTime" data-msgId="' + msg.messageId + '">' + time + '
        </p>
        <div data-msgId="" class="other clearfix imgwrap">
            <img class="fl otherImg"  src="../../image/tx_1.jpg">
            <p data-msgId="" class="fl flex-def flex-cCenter" tapmode onclick="previewImg(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()"
                ontouchend="gtouchend()">
                <img class="imgNews" src="../../image/tx_1.jpg"> </p>
        </div>
        <div data-msgId="" class="oneself clearfix imgwrap">
            <img class="fr oneselfImg" src="../../image/tx_1.jpg">
            <p data-msgId="" class="fr flex-def flex-cCenter" tapmode onclick="previewImg(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()"
                ontouchend="gtouchend()">
                <img class="imgNews" src="../../image/tx_1.jpg"> </p>
        </div> -->
        <!-- <div class="oneself clearfix">
            <div class="time">04:19</div>
            <img class="fr oneselfImg" src="../../image/icon_defaultHead.png">
            <p class="positionNews fr flex-def flex-zTopBottom">
                 <span class="posName">清华大学清华大学清华大学清华大学清华大学清华大学清华大学清华大学清华大学</span>
                <span class="posiDes">清华大学清华大学清华大学清华大学清华大学清华大学清华大学清华大学清华大学</span>
                <img class="" src="../../image/icon_defaultHead.png" alt="">
            </p>
        </div> 
    </div>
    <div class="shadow">
        <p tapmode="" onclick="closeDiv(0);event.stopPropagation();">
            复制
        </p>-->
        <!-- <p tapmode onclick="closeDiv(1);event.stopPropagation();">发送给朋友</p> -->
        <!-- <p tapmode onclick="closeDiv(2);event.stopPropagation();">收藏</p> -->
        <!-- <p tapmode onclick="closeDiv(3);event.stopPropagation();">翻译</p> -->
        <!-- <p tapmode="" onclick="closeDiv(4);event.stopPropagation();">
            删除
        </p> -->
        <!-- <p tapmode onclick="closeDiv(5);event.stopPropagation();">更多</p> -->
    </div>
</body>
<script src="../../script/api.js"></script>
<script src="../../script/common.js"></script>
<script src="../../script/doT.min.js"></script>
<script>
// var rongToken, userToken;
var name;
var headImg = $api.getStorage('imgCache');
var youHeadImg;
var messageId;
var targetRongId;
var emotionData;
var userId;
var newsText;
var msgId;
var mainH;
var _main = 0;
var scrollH;
apiready = function () {
    moduleInit();
    if (api.pageParam.supplyName) {
        // console.log(JSON.stringify(api.pageParam))
        $api.removeCls($api.dom('.supply_info'), 'hide');
        $api.text($api.byId('userName'), api.pageParam.nickname);
        $api.text($api.byId('supplyName'), api.pageParam.supplyName);
        $api.text($api.byId('price'), api.pageParam.priceUint);
        $api.attr($api.dom('.supply_info img'), 'src', api.pageParam.headImg);
        $api.css($api.dom('.main'), 'margin-top: .7rem');
        $api.css($api.dom('.promptText'), 'margin-top: .9rem');
    }

    targetRongId = api.pageParam.targetRongId;
    // editUserInfo
    updatePage();
    api.addEventListener({
        name: 'editUserInfoList'
    }, function (ret,err) {
        // db.selectSql({
        //     name: 'db_' + $api.getStorage('userToken'),
        //     sql: 'SELECT * FROM  tb_chat_' + api.pageParam.userId
        // }, function (ret, err) {
        //     if (ret.status) {
        //     // console.log('修改默认头像');
        //     // console.log(JSON.stringify(ret));
        //     } else {
        //         api.alert({ msg: err.msg });
        //     }
        // });
    // console.log(JSON.stringify(ret));
        
        // youHeadImg = ret.value.you_head_img;
        updatePage();
        // console.log('更新成功更新成功')
    });

    // 调整页面到输入框的后面

    // 滚动到底部
    slideBut();
    api.addEventListener({
        name: 'sendMsg'
    }, function (ret, err) {
        //console.log('发送消息后:'+JSON.stringify(ret))
        chatRecordingSql(ret.value.msg, 'sendMsg', headImg);
        // 发送消息后, 添加消息内容到页面
        addSendMsg(ret.value.msg.result.message.content.text, headImg, 0);
        // 聊天列表获取
        var news = historicalNews();
        api.execScript({
            name: 'main',
            frameName: 'frame0',
            script: news
        });
    });
    // 接收消息
    api.addEventListener({
        name: 'receiveMsg'
    }, function (ret, err) {
        var value = ret.value;
        if (value.targetId == targetRongId) {
            // addReceMsg(ret.value.msg, youHeadImg,0);
            if (value.msgContent.result.message.objectName == 'RC:VcMsg') {
                addReceVoiceMessages(value.msgContent.result, 0);
            }
            else if (value.msgContent.result.message.objectName == 'RC:TxtMsg') {
                addReceMsg(value.msg, 0);
            }
            else if (value.msgContent.result.message.objectName == 'RC:ImgMsg') {
                addReceImgMessages(value.msgContent.result, 0);
            }
            else if (value.msgContent.result.message.objectName == 'RC:LBSMsg') {
                createReceivePositionLabel(value);
            }
        }

        chatRecordingSql(ret.value, 'receiveMsg', youHeadImg);
        // 收到消息后, 添加消息内容到页面

    });
    xiala(messageId);

    api.setFrameAttr({
        softInputMode: 'resize'
    });

    changeHeight();
    // 初始化聊天窗口
    window.setTimeout(function () {
        chatTools();
        slideBut();
    }, 500);

    // 去除头像上的消息数量
    api.sendEvent({
        name: 'refurbish'
    });

    // 监听发送位置
    api.addEventListener({
        name: 'sendPosition'
    }, function (ret, err) {
        sendPosition(ret.value.positionObj);
    });
};
// 发送位置
function sendPosition(ret) {
    var paramData;
    rong.sendLocationMessage({
        conversationType: 'PRIVATE',
        targetId: targetRongId,
        latitude: parseFloat(ret.lat),
        longitude: parseFloat(ret.lon),
        poi: ret.name + ',' + ret.address,
        imagePath: ret.imgPath,
        extra: ''
    }, function (ret, err) {

        if (ret.status == 'prepare') {
            paramData = ret;
        // console.log('发送准备:'+JSON.stringify(ret))
        }
        else if (ret.status == 'progress') {
        //console.log('发送准备222:'+JSON.stringify(ret))
        }
        else if (ret.status == 'success') {
            //console.log( JSON.stringify(ret));
            createSendPositionLabel(paramData);
            // 存入数据库
            chatRecordingSql(paramData, 'sendMsg', headImg);
        }
        else if (ret.status == 'error') {
            // console.log( err.code);
        }

    });
}

function createSendPositionLabel(msg) {
    // console.log('新建标签参数:'+JSON.stringify(msg));
    var time = new Date(msg.result.message.sentTime).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(
        msg.result.message.sentTime).toLocaleTimeString() : new Date(msg.result.message.sentTime).toLocaleString();
    var positionCount = msg.result.message.content.poi.indexOf(',');
    var str = '<div tapmode onclick="openPosiPage(this)" class="oneself clearfix" data-address="' + msg.result.message.content.poi.substring(positionCount + 1) + '" data-name="' + msg.result.message.content.poi.substring(0, positionCount) + '" data-lat="' + msg.result.message.content.latitude + '" data-lon="' + msg.result.message.content.longitude + '" ><div class="time">' + time + '</div><img class="fr oneselfImg" src="' + headImg + '"><p class="positionNews fr flex-def flex-zTopBottom" ><span class="posName">' + msg.result.message.content.poi.substring(0, positionCount) + '</span><span class="posiDes">' + msg.result.message.content.poi.substring(positionCount + 1) + '</span> <img src="' + msg.result.message.content.imagePath + '" alt="1111"></p></div>';
    $api.append($api.dom('.main'), str);
    slideBut();
}

function createReceivePositionLabel(msg) {
    var time = new Date(msg.msgContent.result.message.receivedTime).toLocaleDateString() == new Date().toLocaleDateString() ?
        new Date(msg.msgContent.result.message.receivedTime).toLocaleTimeString() : new Date(msg.msgContent.result.message
            .receivedTime).toLocaleString();
    var positionCount = msg.msgContent.result.message.content.poi.indexOf(',');
    var str = '<div  tapmode onclick="openPosiPage(this)" data-address="' + msg.msgContent.result.message.content.poi.substring(positionCount + 1) + '" data-name="' + msg.msgContent.result.message.content.poi.substring(0, positionCount) + '" data-lat="' + msg.msgContent.result.message.content.latitude + '" data-lon="' + msg.msgContent.result.message.content.longitude + '" class="other clearfix"><div class="time">' + time + '</div><img class="fl otherImg" src="' + youHeadImg + '"><p class="positionNews fl flex-def flex-zTopBottom" ><span class="posName">' + msg.msgContent.result.message.content.poi.substring(0, positionCount) + '</span> <span class="posiDes">' + msg.msgContent.result.message.content.poi.substring(positionCount + 1) + '</span> <img src="' + msg.msgContent.result.message.content.imagePath + '" alt=""></p></div>';
    $api.append($api.dom('.main'), str);
    slideBut();
}

function createSendPositionLabelSql(msg, flag) {
    // console.log('新建标签参数:'+JSON.stringify(msg));
    var time;
    var positionCount;
    var str;
    if (flag == 'sql') {
        positionCount = msg.content_text.indexOf(',');
        time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        str = '<div class="oneself clearfix"  tapmode onclick="openPosiPage(this)" data-lat="' + msg.content_lat + '" data-lon="' + msg.content_lon + '" data-name="' + msg.content_text.substring(0, positionCount) + '" data-address="' + msg.content_text.substring(positionCount + 1) + '" ><div class="time">' + time + '</div><img class="fr oneselfImg" src="' + headImg + '"><p class="positionNews fr flex-def flex-zTopBottom" ><span class="posName">' + msg.content_text.substring(0, positionCount) + '</span> <span class="posiDes">' + msg.content_text.substring(positionCount + 1) + '</span> <img src="' + msg.content_imagePath + '" alt="1111"></p></div>';
    }
    else {
        time = new Date(parseInt(msg.sentTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(parseInt(msg.sentTime, 10))
            .toLocaleTimeString() : new Date(parseInt(msg.sentTime, 10)).toLocaleString();
        positionCount = msg.content.poi.indexOf(',');
        str = '<div class="oneself clearfix"  tapmode onclick="openPosiPage(this)" data-lat="' + msg.content.lat + '" data-lon="' + msg.content.lon + '" data-name="' + msg.content.poi.substring(0, positionCount) + '" data-address="' + msg.content.poi.substring(positionCount + 1) + '" ><div class="time">' + time + '</div><img class="fr oneselfImg" src="' + headImg + '"><p class="positionNews fr flex-def flex-zTopBottom" ><span class="posName">' + msg.content.poi.substring(0, positionCount) + '</span> <span class="posiDes">' + msg.content.poi.substring(positionCount + 1) + '</span><img src="' + msg.content.imagePath + '" alt="1111"></p></div>';
    }
    
    $api.append($api.dom('.main'), str);
    slideBut();
}

function createReceivePositionLabelSql(msg, flag) {
    var time;
    var positionCount;
    var str;
    if (flag == 'sql') {
        positionCount = msg.content_text.indexOf(',');
        time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(parseInt(msg.receivedTime, 10))
            .toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        // str = '<div class="other clearfix"  tapmode onclick="openPosiPage(this)" data-lat="' + msg.content_lat + '" data-lon="' + msg.content_lon + '" data-name="实打实" data-address="安达市"><div class="time">' + time + '</div><img class="fl otherImg" src="' + youHeadImg + '"><p class="positionNews fl flex-def flex-zTopBottom" ><span class="posName">名字</span> <span class="posiDes">按时 </span><img src="' + msg.conten_imagePath + '" alt=""></p></div>';
        str = '<div class="other clearfix"  tapmode onclick="openPosiPage(this)" data-lat="' + msg.content_lat + '" data-lon="' + msg.content_lon + '" data-name="' + msg.content_text.substring(0, positionCount) + '" data-address="' + msg.content_text.substring(positionCount + 1) + '"><div class="time">' + time + '</div><img class="fl otherImg" src="' + youHeadImg + '"><p class="positionNews fl flex-def flex-zTopBottom" ><span class="posName">' + msg.content_text.substring(0, positionCount) + '</span> <span class="posiDes">' + msg.content_text.substring(positionCount + 1) + '</span><img src="' + msg.content_imagePath + '" alt=""></p></div>';
    }
    else {
        time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(parseInt(msg.receivedTime, 10))
            .toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        positionCount = msg.content.poi.indexOf(',');
        str = '<div class="other clearfix"><div class="time" tapmode onclick="openPosiPage(this)" data-lat="' + msg.content.lat + '" data-lon="' + msg.content.lon + '" data-name="' + msg.content.poi.substring(0, positionCount) + '" data-address="' + msg.content.poi.substring(positionCount + 1) + '">' + time + '</div><img class="fl otherImg" src="' + youHeadImg + '"><p class="positionNews fl flex-def flex-zTopBottom" ><span class="posName">' + msg.content.poi.substring(0, positionCount) + '</span> <span class="posiDes">' + msg.content.poi.substring(positionCount + 1) + '</span> <img src="' + msg.content.imagePath + '" alt=""></p></div>';
    } 
    $api.append($api.dom('.main'), str);
    slideBut();
}
// 点击地址
function openPosiPage(ele) {
    var lat = $api.attr(ele, 'data-lat');
    var lon = $api.attr(ele, 'data-lon');
    var name = $api.attr(ele, 'data-name');
    var address = $api.attr(ele, 'data-address');
    api.openWin({
        name: 'positionInfoPage_win',
        url: './positionInfoPage_win.html',
        pageParam: {
            obj: {
                lat:lat,
                lon:lon,
                name:name,
                address:address
            }
        }
    });
}
function updatePage() {
    nickname = api.pageParam.nickname;
    var sourcePath = 'widget://image/chatPage/emotion'; // 表情存放目录
    // if ($api.getStorage('youHeadImg_' + targetRongId)) {
    //     // userId = $api.getStorage('userId_' + targetRongId);
    //     // youHeadImg = $api.getStorage('youHeadImg_' + targetRongId);
    //     api.sendEvent({
    //         name: 'getUserId',
    //         extra: {
    //             userId: userId
    //         }
    //     });
    //     getImgsPaths(sourcePath, function (emotion) {
    //         emotionData = emotion;
    //         getNews();
    //     });
    // }
    // else {
        getImgsPaths(sourcePath, function (emotion) {
            emotionData = emotion;
            getSideInfo(targetRongId);
        });
    // }
}
// 查询数据库
// 查询网络
// 聊天记录插入到数据库

/**

    */

function chatRecordingSql(params, flagStr, headImgUrl) {
// console.log('接受消息'+JSON.stringify(params)+headImgUrl);
    var user_id = flagStr === 'sendMsg' ? 1 : api.pageParam.userId
    var myHeadImg = $api.getStorage('imgCache');
    // var youHeadImg = api.pageParam.headImg;
    var SQL = 'INSERT OR REPLACE INTO tb_chat_' + api.pageParam.userId +
        '(messageId, receivedTime, user_id, objectName, messageDirection, content_extra, content_text, content_lat, content_lon, content_imagePath, head_img_url, filePath, duration, thumbPath) VALUES ';
    if (flagStr === 'sendMsg') {
        // 自己头像
        if (params.result.message.objectName == 'RC:VcMsg') {
            SQL += '(' + params.result.message.messageId + ',"' + params.result.message.sentTime + '","' + user_id + '","' + params.result
                    .message.objectName   + '","' + params.result.message.messageDirection + '","' + params.result.message
                    .content.extra.replace(/"/g, '') + '","' + (params.result.message.content.text || '') +
                '",0,0,"","' + myHeadImg + '","' + params.result.message.content.voicePath + '","' + params.result.message
                    .content.duration + '","")';;
        }
        else if (params.result.message.objectName == 'RC:ImgMsg') {
            SQL += '(' + params.result.message.messageId + ',"' + params.result.message.sentTime + '","' + user_id + '","' + params.result
                    .message.objectName  + '","' + params.result.message.messageDirection + '","' + params.result.message
                    .content.extra.replace(/"/g, '') + '","' + (params.result.message.content.text || '') +
                '",0,0,"","' + myHeadImg + '","' + params.result.message.content.imageUrl + '","","' + params.result
                    .message.content.thumbPath + '")';
        }
        else if (params.result.message.objectName == 'RC:LBSMsg') {
            SQL += '(' + params.result.message.messageId + ',"' + params.result.message.sentTime + '","' + user_id + '","' + params.result
                    .message.objectName  + '","' + params.result.message.messageDirection + '","' + params.result.message
                    .content.extra.replace(/"/g, '') + '","' + (params.result.message.content.poi || '') + '",' +
                params.result.message.content.latitude + ',' + params.result.message.content.longitude + ',"' +
                params.result.message.content.imagePath + '","' + myHeadImg + '","' + params.result.message.content
                    .imageUrl + '","","' + params.result.message.content.thumbPath + '")';
                    // console.log(SQL)
        }
        else {
            SQL += '(' + params.result.message.messageId + ',"' + params.result.message.sentTime + '","' + user_id + '","' + params.result
                    .message.objectName  + '","' + params.result.message.messageDirection + '","' + params.result.message
                    .content.extra.replace(/"/g, '') + '","' + (params.result.message.content.text || '') +
                '",0,0,"","' + myHeadImg + '","","","")';
        }
    }
    else if (flagStr === 'receiveMsg') {
        // filePath
        // duration
        // 对方情况
        if (params.msgContent.result.message.objectName == 'RC:VcMsg') {
            // 语音消息
            SQL += '(' + params.msgContent.result.message.messageId + ',"' + params.msgContent.result.message.receivedTime +
                '","' + user_id + '","' + params.msgContent.result.message.objectName + '","' +  params.msgContent.result.message.messageDirection +
                '","' + params.msgContent.result.message.content.extra.replace(/"/g, '') + '","' + (params.msgContent
                    .result.message.content.text || '') + '",0,0,"","' + youHeadImg + '","' + params.msgContent.result
                    .message.content.voicePath + '","' + params.msgContent.result.message.content.duration + '","")';
        }
        else if (params.msgContent.result.message.objectName == 'RC:ImgMsg') {
            // 图片消息
            SQL += '(' + params.msgContent.result.message.messageId + ',"' + params.msgContent.result.message.receivedTime +
                '","' + user_id + '","' + params.msgContent.result.message.objectName + '","' +  params.msgContent.result.message.messageDirection +
                '","' + params.msgContent.result.message.content.extra.replace(/"/g, '') + '","' + (params.msgContent
                    .result.message.content.text || '') + '",0,0,"","' + youHeadImg + '","' + params.msgContent.result
                    .message.content.imageUrl + '","","' + params.msgContent.result.message.content.thumbPath + '")';
        }
        else if (params.msgContent.result.message.objectName == 'RC:LBSMsg') {
            // 位置消息

            SQL += '(' + params.msgContent.result.message.messageId + ',"' + params.msgContent.result.message.receivedTime +
                '","' + user_id + '","' + params.msgContent.result.message.objectName + '","' +  params.msgContent.result.message.messageDirection +
                '","' + params.msgContent.result.message.content.extra.replace(/"/g, '') + '","' + (params.msgContent
                    .result.message.content.poi || '') + '",' + params.msgContent.result.message.content.longitude +
                ',' + params.msgContent.result.message.content.longitude + ',"' + params.msgContent.result.message.content
                    .imagePath + '","' + youHeadImg + '","' + params.msgContent.result.message.content.imageUrl +
                '","","' + params.msgContent.result.message.content.thumbPath + '")';
                // console.log(SQL)
        }
        else {
            // 文字消息
            SQL += '(' + params.msgContent.result.message.messageId + ',"' + params.msgContent.result.message.receivedTime +
                '","' + user_id + '","' + params.msgContent.result.message.objectName + '","' +  params.msgContent.result.message.messageDirection +
                '","' + params.msgContent.result.message.content.extra.replace(/"/g, '') + '","' + (params.msgContent
                    .result.message.content.text || '') + '",0,0,"","' + youHeadImg + '","","","")';
        }
    }
    else {
    }
    SQLStatement(SQL);
}

function allCahtSql(ret) {
    if (ret.length > 0) {
        // 自己头像
        var myHeadImg = $api.getStorage('imgCache');
        // var youHeadImg = api.pageParam.headImg;
        var SQL = 'INSERT OR REPLACE INTO tb_chat_' + api.pageParam.userId +
            '(messageId, receivedTime, objectName, messageDirection, content_extra, content_text, content_lat, content_lon, content_imagePath, head_img_url, filePath, duration, thumbPath) VALUES ';
        for (var i = 0; i < ret.length; i++) {
            var element = ret[i];
            if (element.messageDirection == 'SEND') {
                // 发送的消息, 自己的头像
                if (element.objectName === 'RC:VcMsg') {
                    // 录音
                    SQL += '(' + element.messageId + ',"' + element.receivedTime + '","' + element.objectName +
                        '","' + element.messageDirection + '","' + element.content.extra.replace(/"/g, '') + '","' +
                        (element.content.text || '') + '",0,0,"","' + myHeadImg + '","' + element.content.voicePath +
                        '","' + element.content.duration + '",""),';
                }
                else if (element.objectName === 'RC:ImgMsg') {
                    // 图片
                    SQL += '(' + element.messageId + ',"' + element.sentTime + '","' + element.objectName + '","' +
                        element.messageDirection + '","' + element.content.extra.replace(/"/g, '') + '","' + (
                        element.content.text || '') + '",0,0,"","' + myHeadImg + '","' + element.content.imageUrl +
                        '","","' + element.content.thumbPath + '"),';
                }
                else if (element.objectName === 'RC:LBSMsg') {
                    // 位置
                    SQL += '(' + element.messageId + ',"' + element.sentTime + '","' + element.objectName + '","' +
                        element.messageDirection + '","' + element.content.extra.replace(/"/g, '') + '","' + (
                        element.content.poi || '') + '",' + element.content.latitude + ',' + element.content.longitude +
                        ',"' + element.content.imagePath + '","' + myHeadImg + '","' + element.content.imageUrl +
                        '","","' + element.content.thumbPath + '"),';
                // console.log(SQL)
                }
                else {
                    // 文字
                    SQL += '(' + element.messageId + ',"' + element.sentTime + '","' + element.objectName + '","' +
                        element.messageDirection + '","' + element.content.extra.replace(/"/g, '').replace(/"/g, '') +
                        '","' + (element.content.text || '') + '",0,0,"","' + myHeadImg + '","","",""),';
                }
            }
            else {
                // 接收的消息, 对方的头像 api.pageParam.headImg
                if (element.objectName === 'RC:VcMsg') {
                    // 录音
                    SQL += '(' + element.messageId + ',"' + element.receivedTime + '","' + element.objectName +
                        '","' + element.messageDirection + '","' + element.content.extra.replace(/"/g, '') + '","' +
                        (element.content.text || '') + '",0,0,"","' + youHeadImg + '","' + element.content.voicePath +
                        '","' + element.content.duration + '",""),';
                }
                else if (element.objectName === 'RC:ImgMsg') {
                    // 图片
                    SQL += '(' + element.messageId + ',"' + element.sentTime + '","' + element.objectName + '","' +
                        element.messageDirection + '","' + element.content.extra.replace(/"/g, '') + '","' + (
                        element.content.text || '') + '",0,0,"","' + youHeadImg + '","' + element.content.imageUrl +
                        '","","' + element.content.thumbPath + '"),';
                }
                else if (element.objectName === 'RC:LBSMsg') {
                    // 位置
                    SQL += '(' + element.messageId + ',"' + element.sentTime + '","' + element.objectName + '","' +
                        element.messageDirection + '","' + element.content.extra.replace(/"/g, '') + '","' + (
                        element.content.poi || '') + '",' + element.content.latitude + ',' + element.content.longitude +
                        ',"' + element.content.imagePath + '","' + youHeadImg + '","' + element.content.imageUrl +
                        '","","' + element.content.thumbPath + '"),';
            // console.log(JSON.stringify(params));
                        
                }   
                else {
                    // 文字
                    // console.log(element.content.extra.replace(/"/g, ''))
                    // console.log(element.content.extra.replace(/"/g, '').replace(/"/g, ''))
                    SQL += '(' + element.messageId + ',"' + element.sentTime + '","' + element.objectName + '","' +
                        element.messageDirection + '","' + element.content.extra.replace(/"/g, '').replace(/"/g, '') +
                        '","' + (element.content.text || '') + '",0,0,"","' + youHeadImg + '","","",""),';
                }
            }
        }
        SQL = SQL.substring(0, SQL.length - 1);
        SQLStatement(SQL);
    }
}

function SQLStatement(SQL) {
    // console.log(SQL);
    db.executeSql({
        name: 'db_' + $api.getStorage('userToken'),
        sql: SQL
    }, function (ret, err) {
        if (ret.status) {
        // console.log('存入聊天记录表格成功');
            // db.selectSql({
            //     name: 'db_'+$api.getStorage('userToken'),
            //     sql: 'SELECT * FROM tb_chat_'+ api.pageParam.userId
            // },function(ret,err){
            //     if (ret.status) {
            //         // console.log('查询到的结果'+JSON.stringify(ret))
            //     }else {
            //         alert('386');
            //     }
            // });
        }
        else {
            alert('390' + JSON.stringify(err) + JSON.stringify(ret));
        }
    });
}
// 打开订单详情
function openSupplyPage(ele) {
    var url;
    if (api.pageParam.type == 'supplyInfo') {
        api.closeWin();
    }
    else {
        if (api.pageParam.type == 'supply') {
            url = '../me/me_gdd_info.html';
        }
        else {
            url = '../me/me_qdd_info.html';
        }
        api.openWin({
            name: 'winName' + url,
            url: url,
            pageParam: {
                order_id: api.pageParam.order_id
            }
        });
    }
}

function closeDiv1() {
    $api.css($api.dom('.shadow'), 'display:none');
}

function closeDiv(n) {
    $api.css($api.dom('.shadow'), 'display:none');
    // alert('292'+newsText)
    if (n === 4) {
        var domRem = $api.dom('div[data-msgId="' + msgId + '"]');
        var domRemTime = $api.dom('.newsTime[data-msgId="' + msgId + '"]');
        $api.remove(domRemTime);
        $api.remove(domRem);
        var arrid = [];
        arrid[0] = parseInt(msgId, 10);
        rong.deleteMessages({
            messageIds: arrid
        }, function (ret, err) {
            if (ret.status) {
                api.toast({
                    msg: '刪除成功'
                });
                $api.rmStorage('chatRecord_' + targetRongId);
                var news = historicalNews();
                // 删除数据库内容
                delSql(msgId);
                api.execScript({
                    name: 'main',
                    frameName: 'frame0',
                    script: news
                });
            }
            else {
                api.toast({
                    msg: '刪除失败'
                });
            }

        });
    }
    else {
        clipBoard.set({
            value: newsText
        }, function (ret, err) {
            if (ret) {
                // alert('294'+JSON.stringify(ret));
                api.toast({
                    msg: '复制成功'
                });
            }
            else {
                alert(JSON.stringify(err));
            }
        });
    }
}
// 删除数据库内容
function delSql(msgId) {
    db.executeSql({
        name: 'db_' + $api.getStorage('userToken'),
        sql: 'DELETE FROM tb_chat_' + api.pageParam.userId + ' WHERE messageId=' + msgId
    }, function (ret, err) {
        if (ret.status) {
        }
        else {
        }
    });
}
// 用户详情
function openMemberInfo(ele) {
    var flag = $api.attr(ele, 'data-id');
    // console.log('执行用户详情' + flag)
    api.closeWin({
        name: 'txl_memberInfo_Win'
    });
    if (flag == 1) {
        api.openWin({
            name: 'txl_memberInfo_Win',
            url: '../addressList/txl_memberInfo_Win.html',
            pageParam: {
                userId: 0
            }
        });
    }
    else {
        api.openWin({
            name: 'txl_memberInfo_Win',
            url: '../addressList/txl_memberInfo_Win.html',
            pageParam: {
                userId: userId
            }
        });
    }
    // alert(userId +'--'+ api.pageParam.userId)
}
// 表情转换
function getImgsPaths(sourcePathOfChatBox, callback) {
    var jsonPath = 'widget://image/chatPage/emotion/emotion.json'; // 表情的JSON数组
    api.readFile({
        path: jsonPath
    }, function (ret, err) {
        if (ret.status) {
            var emotionArray = JSON.parse(ret.data);
            var emotion = {};
            for (var idx in emotionArray) {
                var emotionItem = emotionArray[idx];
                var emotionText = emotionItem.text;
                var emotionUrl = '../../image/chatPage/emotion/' + emotionItem.name + '.png';
                emotion[emotionText] = emotionUrl;
            }

            /*把emotion对象 回调出去*/
            if ('function' === typeof (callback)) {
                callback(emotion);
            }
        }

    });
}
// 表情转换
function transText(text, imgWidth, imgHeight) {
    var imgWidth = imgWidth || 20;
    var imgHeight = imgHeight || 20;
    var regx = /\[(.*?)\]/gm;
    var textTransed = text.replace(regx, function (match) {
        var imgSrc = emotionData[match];
        if (!imgSrc) {
            // 说明不对应任何表情，直接返回
            return match;
        }

        var img = '<img src="' + imgSrc + '" width="' + imgWidth + '" height="' + imgHeight + '">';
        return img;
    });
    return textTransed;
}
// 监听键盘高度改变事件
function changeHeight() {
    UIChatBox.addEventListener({
        target: 'inputBar',
        name: 'move'
    }, function (ret, err) {
        pushPageMove(ret.panelHeight, ret.inputBarHeight);
        window.setTimeout('slideBut()', 300);
    });
    UIChatBox.addEventListener({
        target: 'inputBar',
        name: 'change'
    }, function (ret, err) {
        pushPageMove(ret.panelHeight, ret.inputBarHeight);
        window.setTimeout('slideBut()', 300);
    });
}
// 修改聊天内容高度
function pushPageMove(panelHeight, inputBarHeight) {
    var inputHeight = api.winHeight - (panelHeight + inputBarHeight);
    setTimeout(function () {
        api.setFrameAttr({
            name: 'chattContent',
            rect: {
                x: 0,
                y: api.pageParam.headerH,
                h: inputHeight
            }
        });

    }, 10);
}
// 聊天界面
function chatTools() {
    UIChatBox.open({
        // placeholder: '请输入内容',
        maxRows: 6,
        emotionPath: 'widget://image/chatPage/emotion',
        texts: {
            recordBtn: {
                normalTitle: '按住说话',
                activeTitle: '松开结束'
            },
            sendBtn: {
                title: '发送'
            }
        },
        styles: {
            inputBar: {
                borderColor: '#d9d9d9',
                bgColor: '#f2f2f2'
            },
            inputBox: {
                borderColor: '#d9d9d9',
                bgColor: '#FFFFFF'
            },
            emotionBtn: {
                normalImg: 'widget://image/chatPage/face1.png'
            },
            // 加号按钮
            extrasBtn: {
                normalImg: 'widget://image/chatPage/add1.png'
            },
            keyboardBtn: {
                normalImg: 'widget://image/chatPage/key1.png'
            },
            // 录音按钮
            speechBtn: {
                normalImg: 'widget://image/chatPage/cam1.png'
            },
            // “按住 录音”按钮的样式
            recordBtn: {
                normalBg: 'widget://image/chatPage/suo1.png',
                activeBg: 'widget://image/chatPage/suo2.png',
                color: '#000',
                size: 14
            },
            indicator: {
                target: 'both',
                color: '#c4c4c4',
                activeColor: '#9e9e9e'
            }, 
            sendBtn: {
                titleColor: '#fff',
                bg: '#4cc518',
                activeBg: '#46a91e',
                titleSize: 14
            }
        },
        extras: {
            titleSize: 10,
            titleColor: '#a3a3a3',
            btns: [{
                title: '图片',
                normalImg: 'widget://image/chatPage/album1.png',
                activeImg: 'widget://image/chatPage/album2.png'
            }, {
                title: '拍照',
                normalImg: 'widget://image/chatPage/camera1.png',
                activeImg: 'widget://image/chatPage/camera2.png'
            }, {
                title: '位置',
                normalImg: 'widget://image/chatPage/position1.png',
                activeImg: 'widget://image/chatPage/position2.png'
            }]
        }
    }, function (ret, err) {
        if (ret) {
            boxChatEventListener();
            changeHeight();
            if (ret.eventType == 'send') {
                // msg: 发送的消息
                if (ret.msg == '') {
                // ios下输入框为空的时候不发送消息
                }
                else {
                    sendMsg(ret.msg);
                }

                // 把聊天内容滑动到最下面
            }

            if (ret.eventType === 'clickExtras') {
                if (ret.index === 0) {
                    // 打开相册
                    openPicture('album');
                }
                else if (ret.index === 1) {
                    // 打开相机
                    openPicture('camera');
                }
                else if (ret.index === 2) {
                    // 发送位置
                    api.openWin({
                        name: 'winnmap_winame',
                        url: './map_win.html',
                        bounces: false,
                        pageParam: {
                            key: 'value'
                        }
                    });
                }
            }
        }
        else {
            alert(JSON.stringify(err.msg));
        }
    });
}
// 打开相册
function openPicture(type) {
    api.getPicture({
        sourceType: type,
        mediaValue: 'pic',
        encodingType: 'jpg',
        destinationType: 'url',
        quality: 100,
        saveToPhotoAlbum: true
    }, function (ret, err) {
        if (ret) {
            if (ret.data) {
                sendImg(ret);
            }
        }
        else {
            // alert(JSON.stringify(err));
        }
    });
}
// 发送图片消息
function sendImg(img) {
  // console.log(JSON.stringify(ret))
    var retprepare;
    rong.sendImageMessage({
        conversationType: 'PRIVATE',
        targetId: targetRongId,
        imagePath: img.data,
        extra: ''
    }, function (ret, err) {
        if (ret.status == 'prepare') {
            console.log('1237:'+JSON.stringify(ret))
            retprepare = ret;
            retprepare.result.message.content.imageUrl  =  img.data;
            addSendImgMessages(retprepare.result.message, headImg, 1);
        } else if (ret.status == 'progress') {
        } else if (ret.status == 'success') {
            console.log("1242:"+JSON.stringify(ret));
            
            chatRecordingSql(retprepare, 'sendMsg', headImg);
            // 发送成功
        } else if (ret.status == 'error') {
            // 发送失败
        } else {
        }
    });
}
// 监听录音按钮
function boxChatEventListener() {
    
    UIChatBox.addEventListener({
        target: 'recordBtn',
        name: 'press'
    }, function (ret, err) {
        if (ret) {
            $api.css($api.dom('.recording'), 'background:  url(../../image/chatPage/icon_recording.gif)no-repeat;background-size: 2.72rem 2.72rem;background-position: center;');
            $api.css($api.dom('.recording'), 'display: block');
            // 开始录音
            api.startRecord();
        }
        else {
            // alert(JSON.stringify(err));
        }
    });
    UIChatBox.addEventListener({
        target: 'recordBtn',
        name: 'move_out'
    }, function(ret,err){
        // console.log( '按下录音按钮后，从按钮移出');
        $api.css($api.dom('.recording'), 'background:  url(../../image/chatPage/icon_recording2.png)no-repeat;background-size: 2.72rem 2.72rem;background-position: center;');
    });
    UIChatBox.addEventListener({
        target: 'recordBtn',
        name: 'move_out_cancel'
    }, function(ret,err){
        // console.log( '按下录音按钮后，从按钮移出并松开按钮');
        $api.css($api.dom('.recording'), 'display: none');
        api.stopRecord();
    });
    UIChatBox.addEventListener({
        target: 'recordBtn',
        name: 'move_in'
    }, function(ret,err){
        // console.log( 'ove_out 事件后，重新移入按钮区域');
        $api.css($api.dom('.recording'), 'background:  url(../../image/chatPage/icon_recording.gif)no-repeat;background-size: 2.72rem 2.72rem;background-position: center;');
    });
    UIChatBox.addEventListener({
        target: 'recordBtn',
        name: 'press_cancel'
    }, function (ret, err) {
        if (ret) {
            $api.css($api.dom('.recording'), 'display: none');
            $api.css($api.dom('.recording'), 'background:  url(../../image/chatPage/icon_recording.gif)no-repeat;background-size: 2.72rem 2.72rem;background-position: center;');
            api.stopRecord(function (ret, err) {
                if (ret) {
                    // 停止录音
                    // ret.path 录音路径
                    // ret.duration 录音时长
                    sendVicoe(ret);
                }
                else {
                    // alert(JSON.stringify(err));
                }
            });
        }
        else {
            // alert(JSON.stringify(err));
        }
    });
}
// 发送语音消息
function sendVicoe(ret) {
    var retData = ret;
    var retprepare;
    rong.sendVoiceMessage({
        conversationType: 'PRIVATE',
        targetId: targetRongId,
        voicePath: retData.path,
        duration: retData.duration,
        extra: ''
    }, function (ret, err) {

        if (ret.status == 'prepare') {
            // 发送准备
            retprepare = ret;
        }
        else if (ret.status == 'success') {
            // 发送成功
            addSendVoiceMessages(retData, headImg, 0);
            // 存储到表中
            chatRecordingSql(retprepare, 'sendMsg', headImg);
        }
        else if (ret.status == 'error') {
        }

    });
}
// 文字表情转换
function transEmo(emoMsg) {
    var emoPath;
    var transMsg;
    var reg = /\[(.*?)\]/gm;
    transMsg = emoMsg.replace(reg, function (match) {
        for (var i = 0, len = emoData.length; i < len; i++) {
            if (emoData[i].text === match) {
                emoPath = 'image/emotion/' + emoData[i].name + '.png';
                return '<img width="20" height="20" src="' + emoPath + '" />';
            }

        }
        return match;
    });
    return transMsg;
}
// 获取聊天对方信息
function getSideInfo(rongUserId) {
    // console.log('第一步')
    rongUserIdArr = rongUserId.split();
    api.ajax({
        url: apiSite + '/user/chatUserInfo',
        method: 'post',
        headers: apiHeader,
        data: {
            values: {
                token: $api.getStorage('userToken'),
                id_json: rongUserIdArr
            }
        }
    }, function (ret, err) {
        if (ret) {
            youHeadImg = (ret.data.list[rongUserId].remark_head_img_url === "" ? ret.data.list[rongUserId].head_img_url : ret.data.list[rongUserId].remark_head_img_url ) + 
                '?imageView2/1/w/150/h/150/interlace/1/q/100|imageslim';
            
            userId = ret.data.list[rongUserId].user_id;
            // $api.setStorage('youHeadImg_' + targetRongId, youHeadImg);
            $api.setStorage('userId_' + targetRongId, userId);
            api.sendEvent({
                name: 'getUserId',
                extra: {
                    userId: ret.data.list[rongUserId].user_id
                }
            });
            // 获取最新消息
            getNews();
        }
        else {
            alert(JSON.stringify(err.msg));
        }
    });
}

// 获取最新消息
function getNews() {
    db.selectSql({
        name: 'db_' + $api.getStorage('userToken'),
        sql: 'SELECT * FROM tb_chat_' + api.pageParam.userId + '  ORDER BY receivedTime DESC  LIMIT 20'
    }, function (ret, err) {
        if (ret.status) {
            if (ret.data.length > 0) {
                renderPageSql(ret.data, 1);
                contrastMessage(ret.data);
                _main = $api.offset($api.dom('.main')).h;
            }
            else {
                contrastMessage();
            }
        }
        else {
            // alert('386');
        }
    });
    // 获取缓存字段
    // var messageCache = $api.getStorage('chatRecord_'+targetRongId);
    // if (messageCache) {
    //     renderPage(messageCache);
    //     contrastMessage(messageCache);
    // } else {
    //     contrastMessage()
    // }

}

function contrastMessage(argument) {
    rong.getLatestMessages({
        conversationType: 'PRIVATE',
        // 目标rongyun用户名
        targetId: targetRongId,
        count: 20
    }, function (ret, err) {
        if (ret) {
            if (argument) {
                if (argument.length > 0) {
                    if (argument[0].messageId == ret.result[0].messageId) {
                        // 无更新
                    } else {
                        // 有更新
                        $api.html($api.dom('.main'), '');
                        allCahtSql(ret.result);
                        renderPage(ret);
                    }
                }
                else {
                    $api.html($api.dom('.main'), '');
                    allCahtSql(ret.result);
                    renderPage(ret);
                }
            }
            else {
                $api.html($api.dom('.main'), '');
                allCahtSql(ret.result);
                renderPage(ret);
            }
        } else {
            // err
        }
    });
}
// 渲染页面
function renderPageSql(ret, n) {
    if (n == 2) {
        // 查看历史记录
        for (var i = 0; i < ret.length; i++) {
            if (ret[i].messageDirection == 'RECEIVE') {
                // 消息方向：SEND(发送) 或者 RECEIVE(接受)
                if (ret[i].objectName == 'RC:VcMsg') {
                    // 语音
                    sqlAddReceVoiceMessages(ret[i], n);
                }
                else if (ret[i].objectName == 'RC:TxtMsg') {
                    // 文字
                    sqlAddReceMsg(ret[i], n);
                }
                else if (ret[i].objectName == 'RC:ImgMsg') {
                    // 图片
                    sqlAddReceImgMessages(ret[i], n);
                }
                else {
                }
            }
            else {
                if (ret[i].objectName == 'RC:VcMsg') {
                    // 语音
                    sqlAddSendVoiceMessages(ret[i], n);
                }
                else if (ret[i].objectName == 'RC:TxtMsg') {
                    // 文字
                    sqlAddSendMsg(ret[i], n);
                }
                else if (ret[i].objectName == 'RC:ImgMsg') {
                    // 图片
                    sqlAddSendImgMessages(ret[i], n);
                }
                else {
                }
            }
            messageId = ret[0].messageId;
        }
        if (api.systemType == 'ios') {
            scrollTopPage();
        }
    }
    else {
        // 最新消息
        for (var i = ret.length - 1; i >= 0; i--) {
            //console.log(ret[i].messageId)
            if (ret[i].messageDirection == 'RECEIVE') {
                // 消息方向：SEND(发送) 或者 RECEIVE(接受)
                if (ret[i].objectName == 'RC:VcMsg') {
                    // 语音
                    sqlAddReceVoiceMessages(ret[i], n);
                }
                else if (ret[i].objectName == 'RC:TxtMsg') {
                    // 文字
                    sqlAddReceMsg(ret[i], n);
                }
                else if (ret[i].objectName == 'RC:ImgMsg') {
                    // 图片
                    sqlAddReceImgMessages(ret[i], n);
                }
                else if (ret[i].objectName == 'RC:LBSMsg') {
                    // 图片
                    // console.log(JSON.stringify(ret[i]));
                    createReceivePositionLabelSql(ret[i], 'sql');
                }
                else {
                }
            }
            else {
                if (ret[i].objectName == 'RC:VcMsg') {
                    // 语音
                    sqlAddSendVoiceMessages(ret[i], n);
                }
                else if (ret[i].objectName == 'RC:TxtMsg') {
                    // 文字
                    sqlAddSendMsg(ret[i], n);
                }
                else if (ret[i].objectName == 'RC:ImgMsg') {
                    // 图片
                    sqlAddSendImgMessages(ret[i], n);
                }
                else if (ret[i].objectName == 'RC:LBSMsg') {
                    // 图片
                    // console.log(JSON.stringify(ret[i]));
                    createSendPositionLabelSql(ret[i], 'sql');
                }
                else {
                }
            }
        }
        messageId = ret[ret.length - 1].messageId;
    }

    // 获取历史聊天记录后 页面不想上滚动
    // mainH=$api.offset($api.dom('.main')).h;
    // _main = mainH
    if (n == 1) {
        slideBut();
    }
}
// 渲染页面
function renderPage(ret) {
    for (var i = ret.result.length - 1; i >= 0; i--) {
        if (ret.result[i].messageDirection == 'RECEIVE') {
            // chatRecordingSql(ret, 'receiveMsg', youHeadImg)
            // 消息方向：SEND(发送) 或者 RECEIVE(接受)
            if (ret.result[i].objectName == 'RC:VcMsg') {
                // 语音
                addReceVoiceMessages(ret.result[i], 1);
            }
            else if (ret.result[i].objectName == 'RC:TxtMsg') {
                // 文字
                addReceMsg(ret.result[i], 1);
            }
            else if (ret.result[i].objectName == 'RC:ImgMsg') {
                // 图片
                addReceImgMessages(ret.result[i], 1);
            }
            else if (ret.result[i].objectName == 'RC:LBSMsg') {
                // 位置
                // addReceImgMessages(ret.result[i], youHeadImg, 1)
                createReceivePositionLabelSql(ret.result[i]);
            }
            else {
            }
        }
        else {
            // 发送信息
            if (ret.result[i].objectName == 'RC:VcMsg') {
                // 语音
                addSendVoiceMessages(ret.result[i], headImg, 1);
            }
            else if (ret.result[i].objectName == 'RC:TxtMsg') {
                // 文字
                addSendMsg(ret.result[i], headImg, 1);
            }
            else if (ret.result[i].objectName == 'RC:ImgMsg') {
                // 图片
                addSendImgMessages(ret.result[i], headImg, 1);
            }
            else if (ret.result[i].objectName == 'RC:LBSMsg') {
                // 位置
                // addSendImgMessages(ret.result[i], headImg, 1)
                // console.log('发送消息的JSON:'+JSON.stringify(ret));
                createSendPositionLabelSql(ret.result[i]);
            }
            else {
            }
        }
        // 获取历史聊天记录后 页面不想上滚动
        // mainH=$api.offset($api.dom('.main')).h;
        // _main = mainH
        // 最新的消息的messageId,获取历史记录函数内部-20处理
        messageId = ret.result[ret.result.length - 1].messageId;
        slideBut();
    }
}
// 预览图片
function previewImg(ele) {
    api.openFrame({
        name: 'chat_previewImg',
        url: './chat_previewImg.html',
        rect: {
            x: 0,
            y: 0,
            w: 'auto',
            h: 'auto'
        },
        pageParam: {
            imgUrl: $api.attr($api.dom(ele, 'img'), 'src')
        },
        bounces: false,
        scaleEnabled: true
    });
}
// 接收图片消息后新建消息
function addReceImgMessages(msg, n) {
// function addReceImgMessages(msg, youHeadImg, n) {
    if (n == 1) {
        // console.log('历史消息::'+JSON.stringify(msg))
        // 历史消息
        // 当天显示时间
        // 不是当天显示年月日 时分秒
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(
            msg.receivedTime).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="other imgwrap clearfix"><img tapmode onclick="openMemberInfo(this)" data-id="' + api.pageParam.targetUserId +
            '" class="fl otherImg" src="' + youHeadImg + '"><p data-msgId="' + msg.messageId +
            '" class="fl flex-def flex-cCenter" data-img="'+ msg.content.imageUrl +'" tapmode onclick="previewImg(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()"><img class="imgNews" src="' +
            msg.content.imageUrl + '"> </p></div>');
        slideBut();
    }
    else if (n == 2) {
        // console.log('历史消息::'+JSON.stringify(msg))
        // 历史消息
        // 当天显示时间
        // 不是当天显示年月日 时分秒
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(
            msg.receivedTime).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        $api.prepend($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="other imgwrap clearfix"><img tapmode onclick="openMemberInfo(this)" data-id="' + api.pageParam.targetUserId +
            '" class="fl otherImg" src="' + youHeadImg + '"><p data-msgId="' + msg.messageId +
            '" class="fl flex-def flex-cCenter" tapmode data-img="' + msg.content.imageUrl +'" onclick="previewImg(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()"><img class="imgNews" src="' +
            msg.content.imageUrl + '"> </p></div>');
            slideBut()
    }
    else {
        // console.log('接受到的图片' + JSON.stringify(msg))
        // 当前接收的消息
        var time = new Date(msg.message.receivedTime).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(
            msg.message.receivedTime).toLocaleTimeString() : new Date(msg.message.receivedTime).toLocaleString();
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.message.messageId + '">' + time +
            '</p><div data-msgId="' + msg.message.messageId +
            '" class="other imgwrap clearfix"><img tapmode onclick="openMemberInfo(this)" data-id="' + api.pageParam.targetUserId +
            '" class="fl otherImg" src="' + youHeadImg+ '"><p data-msgId="' + msg.message.messageId +
            '" class="fl flex-def flex-cCenter" data-img="' + msg.message.content.imageUrl +'" tapmode onclick="previewImg(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()" > <img class="imgNews" src="' +
            msg.message.content.imageUrl + '"></p></div>');
        slideBut();
    }
}
// 发送图片消息后新建
function addSendImgMessages(msg, headImg, n) {
    // msg.content.imageUrl = msg.content.thumbPath 缩略图;
    // if (api.systemType==='ios') {
    //     msg.content.imageUrl = msg.content.thumbPath;
    // }
    // thumbPath 缩略图
    if (n == 1) {
        // 历史消息
        var time = new Date(parseInt(msg.sentTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(parseInt(msg.sentTime, 10))
            .toLocaleTimeString() : new Date(parseInt(msg.sentTime, 10)).toLocaleString();
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="oneself imgwrap clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            headImg +
            '"><p class="fr flex-def flex-cCenter" tapmode data-img="'+ msg.content.imageUrl +'" onclick="previewImg(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" data-msgId="' +
            msg.messageId + '" ontouchend="gtouchend()"  ><img class="imgNews" src="' + msg.content.imageUrl +
            '"> </p></div>');
        slideBut();
    }
    else if (n == 2) {
        // 历史消息
        var time = new Date(parseInt(msg.sentTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(parseInt(msg.sentTime, 10))
            .toLocaleTimeString() : new Date(parseInt(msg.sentTime, 10)).toLocaleString();
        $api.prepend($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="oneself imgwrap clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            headImg +
            '"><p class="fr flex-def flex-cCenter" data-img="'+ msg.content.imageUrl +'" tapmode onclick="previewImg(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" data-msgId="' +
            msg.messageId + '" ontouchend="gtouchend()"  ><img class="imgNews" src="' + msg.content.imageUrl +
            '"> </p></div>');
            slideBut()
    }
    else {
        // console.log(JSON.stringify(msg))
        // 当前发送的消息
        $api.append($api.dom('.main'), '<p class="newsTime" >' + new Date().toLocaleTimeString() +
            '</p><div data-msgId="" class="oneself imgwrap clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            headImg +
            '"><p class="fr flex-def flex-cCenter" tapmode onclick="previewImg(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" data-msgId="" ontouchend="gtouchend()" d><img class="imgNews" src="../../image/icon_defaultHead.png"> </p></div>'
        );
        slideBut();
    }
}
// 接收语音消息后新建消息
function addReceVoiceMessages(msg, n) {
    // 当天显示时间
    // 不是当天显示年月日 时分秒
    if (n == 1) {
        // 历史消息
        // 当天显示时间
        // 不是当天显示年月日 时分秒
        var time = new Date(parseInt(msg.sentTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(parseInt(msg.sentTime, 10))
            .toLocaleTimeString() : new Date(parseInt(msg.sentTime, 10)).toLocaleString();
        var widthNum = msg.content.duration;
        // widthNum = widthNum > 7 ? widthNum : 7;
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="other clearfix"><img tapmode onclick="openMemberInfo(this)" data-id="' + api.pageParam.targetUserId +
            '" class="fl otherImg" src="' + youHeadImg + '"><p data-msgId="' + msg.messageId +
            '" class="fl flex-def flex-cCenter" tapmode onclick="playVoice(this)" ontouchstart="gtouchstart(this)" style="width:' +
            widthNum / 4 + 'rem" ontouchmove="gtouchmove()" ontouchend="gtouchend()" data-voivePath= "' + msg.content
                .voicePath +
            '"><img class="voiceMsg fl"  src="../../image/chatPage/icon_break.png"  height="20"></p><span class="voiceTime voiceTimeOther fl">' +
            msg.content.duration + '"</span></div>');
        slideBut();
    }
    else if (n == 2) {
        var time = new Date(parseInt(msg.sentTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(parseInt(msg.sentTime, 10))
            .toLocaleTimeString() : new Date(parseInt(msg.sentTime, 10)).toLocaleString();
        var widthNum = msg.content.duration;
        // widthNum = widthNum > 7 ? widthNum : 7;
        $api.prepend($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="oneself clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            headImg +
            '"><p class="fr flex-def flex-cCenter flex-zEnd" tapmode onclick="playVoice(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" data-msgId="' +
            msg.messageId + '" ontouchend="gtouchend()" style="width:' + widthNum / 4 +
            'rem" data-voivePath= "' + msg.content.voicePath +
            '" ><img class="voiceMsg fr"  src="../../image/chatPage/icon_break1.png"  height="20"></p><span class="voiceTime fr">' +
            msg.content.duration + '"</span></div>');
    }
    else {
        // 当前接收的消息
        var time = new Date(msg.message.sentTime).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(
            msg.message.sentTime).toLocaleTimeString() : new Date(msg.message.sentTime).toLocaleString();
        var widthNum = msg.message.content.duration;
        // widthNum = widthNum > 7 ? widthNum : 7;
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.message.messageId + '">' + time +
            '</p><div data-msgId="' + msg.message.messageId +
            '" class="other clearfix"><img tapmode onclick="openMemberInfo(this)" data-id="' + api.pageParam.targetUserId +
            '" class="fl otherImg" src="' + youHeadImg + '"><p data-msgId="' + msg.message.messageId +
            '" class="fl flex-def flex-cCenter" tapmode onclick="playVoice(this)" style="width:' + widthNum / 4 +
            'rem" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()" data-voivePath= "' +
            msg.message.content.voicePath +
            '"><img class="voiceMsg fl"  src="../../image/chatPage/icon_break.png"  height="20"></p><span class="voiceTime voiceTimeOther fl">' +
            msg.message.content.duration + '"</span></div>');
        slideBut();
    }
}
// 发送语音消息后新建
function addSendVoiceMessages(msg, headImg, n) {
    if (n == 1) {
        // 历史消息
        var time = new Date(parseInt(msg.sentTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(parseInt(msg.sentTime, 10))
            .toLocaleTimeString() : new Date(parseInt(msg.sentTime, 10)).toLocaleString();
        var widthNum = msg.content.duration;
        // widthNum = widthNum > 7 ? widthNum : 7;
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="oneself clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            headImg +
            '"><p class="fr flex-def flex-cCenter flex-zEnd" tapmode onclick="playVoice(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" data-msgId="' +
            msg.messageId + '" ontouchend="gtouchend()" style="width:' + widthNum / 4 +
            'rem" data-voivePath= "' + msg.content.voicePath +
            '" ><img class="voiceMsg fr"  src="../../image/chatPage/icon_break1.png"  height="20"></p><span class="voiceTime fr">' +
            msg.content.duration + '"</span></div>');
        slideBut();
    }
    else if (n == 2) {
        var time = new Date(parseInt(msg.sentTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(parseInt(msg.sentTime, 10))
            .toLocaleTimeString() : new Date(parseInt(msg.sentTime, 10)).toLocaleString();
        var widthNum = msg.content.duration;
        // widthNum = widthNum > 7 ? widthNum : 7;
        $api.prepend($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="oneself clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            headImg +
            '"><p class="fr flex-def flex-cCenter flex-zEnd" tapmode onclick="playVoice(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" data-msgId="' +
            msg.messageId + '" ontouchend="gtouchend()" style="width:' + widthNum / 4 +
            'rem" data-voivePath= "' + msg.content.voicePath +
            '" ><img class="voiceMsg fr"  src="../../image/chatPage/icon_break1.png"  height="20"></p><span class="voiceTime fr">' +
            msg.content.duration + '"</span></div>');
    }
    else {
        var widthNum = msg.duration;
        // widthNum = widthNum > 7 ? widthNum : 7;
        // console.log(JSON.stringify(msg))
        // 当前发送的消息
        $api.append($api.dom('.main'), '<p class="newsTime" >' + new Date().toLocaleTimeString() +
            '</p><div data-msgId="" class="oneself clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            headImg +
            '"><p class="fr flex-def flex-cCenter flex-zEnd" tapmode onclick="playVoice(this)" ontouchstart="gtouchstart(this)" style="width:' +
            widthNum / 4 +
            'rem" ontouchmove="gtouchmove()" data-msgId="" ontouchend="gtouchend()" data-voivePath= "' + msg.path +
            '" ><img class="voiceMsg fr"  src="../../image/chatPage/icon_break1.png"  height="20"></p><span class="voiceTime fr">' +
            msg.duration + '"</span></div>');
        slideBut();
    }
}
// 播放语音
function playVoice(ele) {
    // <img class="voiceMsg"  src="../../image/chatPage/icon_break.png"  height="20">
    // 有其他播放的语音暂停
    // 当前语音是否正在播放
    if ($api.hasCls($api.closest(ele, 'div'), 'oneself')) {
        // 自己
        if ($api.attr($api.dom(ele, '.voiceMsg'), 'src') == '../../image/chatPage/icon_play1.gif') {
            api.stopPlay();
            $api.attr($api.dom(ele, '.voiceMsg'), 'src', '../../image/chatPage/icon_break1.png');
        }
        else {
            playVoice2(ele);
        }
    }
    else {
        // other
        if ($api.attr($api.dom(ele, '.voiceMsg'), 'src') == '../../image/chatPage/icon_play.gif') {
            api.stopPlay();
            $api.attr($api.dom(ele, '.voiceMsg'), 'src', '../../image/chatPage/icon_break.png');
        }
        else {
            playVoice2(ele);
        }
    }
}

function playVoice2(ele) {
    // 暂停其他正在播放的语音
    var currentPlay = $api.dom('.voiceMsg[src="../../image/chatPage/icon_play1.gif"]');
    var currentPlay1 = $api.dom('.voiceMsg[src="../../image/chatPage/icon_play.gif"]');
    if (currentPlay) {
        api.stopPlay();
        // 自己
        $api.attr(currentPlay, 'src', '../../image/chatPage/icon_break1.png');
    }

    if (currentPlay1) {
        api.stopPlay();
        // other
        $api.attr(currentPlay1, 'src', '../../image/chatPage/icon_break.png');
    }

    // 更换播放图标
    if ($api.hasCls($api.closest(ele, 'div'), 'oneself')) {
        // 自己
        $api.attr($api.dom(ele, '.voiceMsg'), 'src', '../../image/chatPage/icon_play1.gif');
    }
    else {
        // other
        $api.attr($api.dom(ele, '.voiceMsg'), 'src', '../../image/chatPage/icon_play.gif');
    }
    // 播放语音
    api.startPlay({
        path: $api.attr(ele, 'data-voivePath')
    }, function (ret, err) {
        if (ret) {
            if ($api.hasCls($api.closest(ele, 'div'), 'oneself')) {
                // 自己
                $api.attr($api.dom(ele, '.voiceMsg'), 'src', '../../image/chatPage/icon_break1.png');
            }
            else {
                // other
                $api.attr($api.dom(ele, '.voiceMsg'), 'src', '../../image/chatPage/icon_break.png');
            }
        }
        else {
            alert(JSON.stringify(err));
        }
    });
}
// 接收消息后新建消息
function addReceMsg(msg, n) {
    // 当天显示时间
    // 不是当天显示年月日 时分秒
    // console.log('新建文字消息:'+youHeadImg)
    if (n == 1) {
        // 历史消息
        // 当天显示时间
        // 不是当天显示年月日 时分秒
        var time = new Date(parseInt(msg.sentTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(parseInt(msg.sentTime, 10))
            .toLocaleTimeString() : new Date(parseInt(msg.sentTime, 10)).toLocaleString();
        var str = '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="other clearfix"><img tapmode onclick="openMemberInfo(this)" data-id="' + api.pageParam.targetUserId +
            '" class="fl otherImg" src="' + youHeadImg + '"><p data-msgId="' + msg.messageId +
            '" class="fl flex-def flex-cCenter" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()" data-newsText= "' +
            msg.content.text + '"> ' + transText(msg.content.text) + '</p></div>'
        $api.append($api.dom('.main'), str);
    }
    else {
        // 当前发送的消息
        var  str2 = '<p class="newsTime" data-msgId="' + msg.messageId + '">' + new Date().toLocaleTimeString() +
            '</p><div data-msgId="" class="other clearfix"><img tapmode onclick="openMemberInfo(this)" data-id="' +
            api.pageParam.targetUserId + '" class="fl otherImg" src="' + youHeadImg +
            '"><p data-msgId="" class="fl flex-def flex-cCenter" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()" data-newsText= "' +
            msg + '"> ' + transText(msg) + '</p></div>'
        $api.append($api.dom('.main'), str2);
        
    }
    slideBut();
}

// 发送消息后新建消息
function addSendMsg(msg, headImg, n) {
    if (n == 1) {
        // 历史消息
        var time = new Date(parseInt(msg.sentTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(parseInt(msg.sentTime, 10))
            .toLocaleTimeString() : new Date(parseInt(msg.sentTime, 10)).toLocaleString();
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="oneself clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            headImg +
            '"><p class="fr flex-def flex-cCenter" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" data-msgId="' +
            msg.messageId + '" ontouchend="gtouchend()" data-newsText= "' + msg.content.text + '" > ' +
            transText(msg.content.text) + ' </p></div>');
    }
    else {
        // 当前发送的消息
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + new Date().toLocaleTimeString() +
            '</p><div data-msgId="" class="oneself clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            headImg +
            '"><p class="fr flex-def flex-cCenter" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" data-msgId="" ontouchend="gtouchend()" data-newsText= "' +
            msg + '" > ' + transText(msg) + ' </p></div>');
    }
    slideBut();
}
// 查看历史记录 往上面添加消息
function addSendMsgTop(msg, headImg) {
    // console.log('历史消息1'+JSON.stringify(msg))
    var time = new Date(parseInt(msg.sentTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(parseInt(msg.sentTime, 10))
        .toLocaleTimeString() : new Date(parseInt(msg.sentTime, 10)).toLocaleString();
    $api.prepend($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
        '</p><div data-msgId="' + msg.messageId + '" class="oneself clearfix"><img class="fr oneselfImg" src="' +
        headImg +
        '" tapmode data-id="1" onclick="openMemberInfo(this)"><p class="fr flex-def flex-cCenter" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()" data-msgId="' +
        msg.messageId + '" data-newsText= "' + msg.content.text + '"> ' + transText(msg.content.text) +
        ' </p></div>');
}

function addReceMsgTop(msg) {
    // console.log('历史消息2'+JSON.stringify(msg))
    var time = new Date(parseInt(msg.sentTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ? new Date(parseInt(msg.sentTime, 10))
        .toLocaleTimeString() : new Date(parseInt(msg.sentTime, 10)).toLocaleString();
    $api.prepend($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
        '</p><div data-msgId="' + msg.messageId +
        '" class="other clearfix"><img class="fl otherImg" tapmode onclick="openMemberInfo(this)" data-id="' +
        api.pageParam.targetUserId + '" src="' + youHeadImg +
        '"><p class="fl flex-def flex-cCenter" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()" data-msgId="' +
        msg.messageId + '" data-newsText= "' + msg.content.text + '">' + transText(msg.content.text) +
        '</p></div>');
}

// 滚动到页面底部
function slideBut() {
    // scrollIntoView 滚动到可是界面的底部   true滚动到顶部
    $api.dom('.main').scrollIntoView(false);
    // api.pageDown(function(ret,err){

    // });
}

var countId = 20;
// 查看历史记录
function chatHis() {
    // messageId -= 20;
    var count = messageId > 20 ? 20 : messageId;
    console.log(messageId);
    if (messageId > 1) {
        db.selectSql({
            name: 'db_' + $api.getStorage('userToken'),
            sql: 'SELECT * FROM tb_chat_' + api.pageParam.userId + '  ORDER BY receivedTime DESC LIMIT ' +
                (countId) + ',20'
        }, function (ret, err) {
            if (ret.status) {
                console.log('数据库聊天记录:'+JSON.stringify(ret));
                countId += 20;
                if (ret.data.length > 0) {
                    renderPageSql(ret.data, 2);
                    messageId = ret.data[ret.data.length - 1].messageId;
                }
                else {
                    rong.getHistoryMessages({
                        conversationType: 'PRIVATE',
                        // 目标rongyun用户名
                        targetId: targetRongId,
                        oldestMessageId: messageId,
                        count: count
                    }, function (ret, err) {
                        console.log('网路聊天记录:'+JSON.stringify(ret));
                        
                        allCahtSql(ret.result);
                        for (var i = 0; i < ret.result.length; i++) {
                            if (ret.result[i].messageDirection == 'RECEIVE') {
                                // 消息方向：SEND(发送) 或者 RECEIVE(接受)
                                if (ret.result[i].objectName == 'RC:VcMsg') {
                                    // 语音
                                    addReceVoiceMessages(ret.result[i], 2);
                                }
                                else if (ret.result[i].objectName == 'RC:TxtMsg') {
                                    // 文字
                                    addReceMsgTop(ret.result[i], 2);
                                }
                                else if (ret.result[i].objectName == 'RC:ImgMsg') {
                                    addReceImgMessages(ret.result[i], 2);
                                }
                                else {
                                }
                            }
                            else {
                                if (ret.result[i].objectName == 'RC:VcMsg') {
                                    // 语音
                                    addSendVoiceMessages(ret.result[i], headImg, 2);
                                }
                                else if (ret.result[i].objectName == 'RC:TxtMsg') {
                                    // 文字
                                    addSendMsgTop(ret.result[i], headImg, 2);
                                }
                                else if (ret.result[i].objectName == 'RC:ImgMsg') {
                                    addSendImgMessages(ret.result[i], headImg, 2);
                                }
                                else {
                                }
                            }
                        }
                        messageId = ret.result[ret.result.length - 1].messageId;
                        if (api.systemType == 'ios') {
                            scrollTopPage();
                        }

                    });
                }
            }
            else {
                // api.alert({msg:err.msg});
            }
        });
        // 修改获取聊天记录后的页面高度
        // mainH = $api.offset($api.dom('.main')).h;
        // scrollH = mainH - _main;
        // _main =  mainH;
        if (api.systemType !== 'ios') {
            // console.log('安卓')
            window.scrollTo(0, 1);
        }

        return 1;
    }
    else {
        api.toast({
            msg: '无更多记录'
        });
        return 1;
    }
}

function scrollTopPage() {
    mainH = $api.offset($api.dom('.main')).h;
    scrollH = mainH - _main;
    _main = mainH;
    window.scrollTo(0, scrollH);
}
// 下拉刷新后 执行函数chatHis(messageId)

function xiala() {
    api.setCustomRefreshHeaderInfo({
        bgColor: '#C0C0C0',
        isScale: true,
        // image: {
        //     pull: [
        //         'widget://image/refresh/dropdown0.png',
        //         'widget://image/refresh/dropdown1.png',
        //         'widget://image/refresh/dropdown2.png',
        //         'widget://image/refresh/dropdown3.png',
        //         'widget://image/refresh/dropdown4.png',
        //         'widget://image/refresh/dropdown5.png',
        //         'widget://image/refresh/dropdown6.png'
        //     ],
        //     load: [
        //         'widget://image/refresh/loading0.png',
        //         'widget://image/refresh/loading1.png',
        //         'widget://image/refresh/loading2.png',
        //         'widget://image/refresh/loading3.png',
        //         'widget://image/refresh/loading4.png'
        //     ]
        // }
    }, function () {
        if (chatHis()) {
            // 停止刷新
            api.refreshHeaderLoadDone();
        }

    });
}

/**
     * 发送消息
     * sendMsg(msg)
     * msg: 发送的消息
     */
function sendMsg(msg) {
    var sendMsg;
    rong.sendTextMessage({
        conversationType: 'PRIVATE',
        // 目标rongyun用户名
        targetId: targetRongId,
        // targetId: name,
        text: msg,
        extra: ''
    }, function (ret, err) {
        if (ret.status == 'prepare') {
            sendMsg = ret;
        // alert(JSON.stringify(ret));
        }
        else if (ret.status == 'success') {

            api.sendEvent({
                name: 'sendMsg',
                extra: {
                    msg: sendMsg
                }
            });
        }
        else if (ret.status == 'error') {
            // api.alert({
            //     title: 'title',
            //     msg: '第三个message' + err.code,
            // }, function(ret, err) {
            //     if (ret) {
            //         alert(JSON.stringify(ret));
            //     } else {
            //         alert(JSON.stringify(err.msg));
            //     }
            // });
        }

    });
}

var timeOutEvent = 0; // 定时器
// 开始按
function gtouchstart(ele) {
    newsText = $api.attr(ele, 'data-newsText');
    msgId = $api.attr(ele, 'data-msgId');
    // console.log($api.text(ele))
    // console.log($api.html(ele))

    // console.log('id::'+msgId+'text::'+ newsText)
    var e = window.event;
    var x = e.touches[0].clientX;
    var y = e.touches[0].clientY;
    timeOutEvent = setTimeout('longPress(' + x + ',' + y + ')', 500);
    // 这里设置定时器，定义长按500毫秒触发长按事件，时间可以自己改，个人感觉500毫秒非常合适
    return false;
}
// 手释放，如果在500毫秒内就释放，则取消长按事件，此时可以执行onclick应该执行的事件
function gtouchend() {
    clearTimeout(timeOutEvent); // 清除定时器
    if (timeOutEvent != 0) {
        // 这里写要执行的内容（尤如onclick事件）
    }

    return false;
}
// 如果手指有移动，则取消所有事件，此时说明用户只是要移动而不是长按
function gtouchmove() {
    clearTimeout(timeOutEvent); // 清除定时器
    timeOutEvent = 0;
}
// 真正长按后应该执行的内容
function longPress(x, y) {
    if (api.frameWidth - (x + 10) < api.frameWidth / 2) {
        x = x - 70;
    }

    if (api.winHeight - (y + 10) < api.winHeight / 2) {
        y = y - 110;
    }

    // console.log('坐标:'+x+','+y)
    timeOutEvent = 0;
    $api.css($api.dom('.shadow'), 'display:inline-block;top:' + 2 * y / 100 + 'rem;left:' + 2 * x / 100 + 'rem;');
    // console.log(JSON.stringify($api.offset($api.dom('.shadow'))))
    // 执行长按要执行的内容，如弹出菜单
}
// 数据库查询 接受图片消息后新建
function sqlAddReceImgMessages(msg, n) {
    if (n == 1) {
        // 当天显示时间
        // 不是当天显示年月日 时分秒
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
            new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="other imgwrap clearfix"><img tapmode onclick="openMemberInfo(this)" data-id="' + api.pageParam.targetUserId +
            '" class="fl otherImg" src="' + msg.head_img_url + '"><p data-msgId="' + msg.messageId +
            '" class="fl flex-def flex-cCenter" data-img="'+ msg.filePath +'" tapmode onclick="previewImg(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()"><img class="imgNews" src="' +
            msg.filePath + '"> </p></div>');
        slideBut();
    }
    else if (n == 2) {
        // 历史消息
        // 当天显示时间
        // 不是当天显示年月日 时分秒
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
            new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        $api.prepend($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="other imgwrap clearfix"><img tapmode onclick="openMemberInfo(this)" data-id="' + api.pageParam.targetUserId +
            '" class="fl otherImg" src="' + msg.head_img_url + '"><p data-msgId="' + msg.messageId +
            '" class="fl flex-def flex-cCenter" data-img="'+ msg.filePath +'" tapmode onclick="previewImg(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()"><img class="imgNews" src="' +
            msg.filePath + '"> </p></div>');
            slideBut()
    }
    else {
        // 当前接收的消息
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
            new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.message.messageId + '">' + time +
            '</p><div data-msgId="' + msg.message.messageId +
            '" class="other imgwrap clearfix"><img tapmode onclick="openMemberInfo(this)" data-id="' + api.pageParam.targetUserId +
            '" class="fl otherImg" src="' + msg.head_img_url + '"><p data-msgId="' + msg.messageId +
            '" class="fl flex-def flex-cCenter" data-img="'+ msg.filePath +'" tapmode onclick="previewImg(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()" > <img class="imgNews" src="' +
            msg.filePath + '"></p></div>');
        slideBut();
    }
    slideBut();
}
// 数据库查询 发送图片消息后新建
function sqlAddSendImgMessages(msg, n) {
    
    if (n == 1) {
        // 历史消息
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
            new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="oneself imgwrap clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            msg.head_img_url +
            '"><p class="fr flex-def flex-cCenter" data-img="'+ msg.filePath +'" tapmode onclick="previewImg(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" data-msgId="' +
            msg.messageId + '" ontouchend="gtouchend()"  ><img class="imgNews" src="' + msg.filePath +
            '"> </p></div>');
        slideBut();
    }
    else if (n == 2) {
        // 历史消息
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
            new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        $api.prepend($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="oneself imgwrap clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            msg.head_img_url +
            '"><p class="fr flex-def flex-cCenter" tapmode onclick="previewImg(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" data-msgId="' +
            msg.messageId + '" ontouchend="gtouchend()"  ><img class="imgNews" src="' + msg.filePath +
            '"> </p></div>');
            slideBut()
    }
    else {
        // console.log(JSON.stringify(msg))
        // 当前发送的消息
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
            new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="oneself imgwrap clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            msg.head_img_url +
            '"><p class="fr flex-def flex-cCenter" data-img="'+ msg.filePath +'" tapmode onclick="previewImg(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" data-msgId="' +
            msg.messageId + '" ontouchend="gtouchend()"  ><img class="imgNews" src="' + msg.filePath +
            '"> </p></div>');
        slideBut();
    }
    slideBut();
}
// 数据库查询 接收语音消息后新建消息
function sqlAddReceVoiceMessages(msg, n) {
    // 当天显示时间
    // 不是当天显示年月日 时分秒
    if (n == 1) {
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
            new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        var widthNum = msg.duration;
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="other clearfix"><img tapmode onclick="openMemberInfo(this)" data-id="' + api.pageParam.targetUserId +
            '" class="fl otherImg" src="' + msg.head_img_url + '"><p data-msgId="' + msg.messageId +
            '" class="fl flex-def flex-cCenter" tapmode onclick="playVoice(this)" ontouchstart="gtouchstart(this)" style="width:' +
            widthNum / 4 + 'rem" ontouchmove="gtouchmove()" ontouchend="gtouchend()" data-voivePath= "' + msg.filePath +
            '"><img class="voiceMsg fl"  src="../../image/chatPage/icon_break.png"  height="20"></p><span class="voiceTime voiceTimeOther fl">' +
            msg.duration + '"</span></div>');
        slideBut();
    }
    else if (n == 2) {
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
            new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        var widthNum = msg.duration;
        $api.prepend($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="oneself clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            msg.head_img_url +
            '"><p class="fr flex-def flex-cCenter flex-zEnd" tapmode onclick="playVoice(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" data-msgId="' +
            msg.messageId + '" ontouchend="gtouchend()" style="width:' + widthNum / 4 +
            'rem" data-voivePath= "' + msg.filePath +
            '" ><img class="voiceMsg fr"  src="../../image/chatPage/icon_break1.png"  height="20"></p><span class="voiceTime fr">' +
            msg.duration + '"</span></div>');
    }
    else {
        // 当前接收的消息
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
            new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        var widthNum = msg.duration;
        // widthNum = widthNum > 7 ? widthNum : 7;
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="other clearfix"><img tapmode onclick="openMemberInfo(this)" data-id="' + api.pageParam.targetUserId +
            '" class="fl otherImg" src="' + msg.head_img_url + '"><p data-msgId="' + msg.messageId +
            '" class="fl flex-def flex-cCenter" tapmode onclick="playVoice(this)" style="width:' + widthNum / 4 +
            'rem" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()" data-voivePath= "' +
            msg.filePath +
            '"><img class="voiceMsg fl"  src="../../image/chatPage/icon_break.png"  height="20"></p><span class="voiceTime voiceTimeOther fl">' +
            msg.duration + '"</span></div>');
        slideBut();
    }
    slideBut();
}
// 数据库查询 发送语音消息后新建
function sqlAddSendVoiceMessages(msg, n) {
    if (n == 1) {
        // 历史消息
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
            new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        var widthNum = msg.duration;
        // widthNum = widthNum > 7 ? widthNum : 7;
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="oneself clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            msg.head_img_url +
            '"><p class="fr flex-def flex-cCenter flex-zEnd" tapmode onclick="playVoice(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" data-msgId="' +
            msg.messageId + '" ontouchend="gtouchend()" style="width:' + widthNum / 4 +
            'rem" data-voivePath= "' + msg.filePath +
            '" ><img class="voiceMsg fr"  src="../../image/chatPage/icon_break1.png"  height="20"></p><span class="voiceTime fr">' +
            msg.duration + '"</span></div>');
        slideBut();
    }
    else if (n == 2) {
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
            new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        var widthNum = msg.duration;
        // widthNum = widthNum > 7 ? widthNum : 7;
        $api.prepend($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="oneself clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            msg.head_img_url +
            '"><p class="fr flex-def flex-cCenter flex-zEnd" tapmode onclick="playVoice(this)" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" data-msgId="' +
            msg.messageId + '" ontouchend="gtouchend()" style="width:' + widthNum / 4 +
            'rem" data-voivePath= "' + msg.filePath +
            '" ><img class="voiceMsg fr"  src="../../image/chatPage/icon_break1.png"  height="20"></p><span class="voiceTime fr">' +
            msg.duration + '"</span></div>');
    }
    else {
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
            new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        var widthNum = msg.duration;
        // widthNum = widthNum > 7 ? widthNum : 7;
        // console.log(JSON.stringify(msg))
        // 当前发送的消息
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="oneself clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            msg.head_img_url +
            '"><p class="fr flex-def flex-cCenter flex-zEnd" tapmode onclick="playVoice(this)" ontouchstart="gtouchstart(this)"  ontouchmove="gtouchmove()" data-msgId="' +
            msg.messageId + '" ontouchend="gtouchend()" style="width:' + widthNum / 4 +
            'rem" data-voivePath= "' + msg.filePath +
            '" ><img class="voiceMsg fr"  src="../../image/chatPage/icon_break1.png"  height="20"></p><span class="voiceTime fr">' +
            msg.duration + '"</span></div>');
        slideBut();
    }
    slideBut();
}
// 数据库查询 接收消息后新建消息
function sqlAddReceMsg(msg, n) {
    // 当天显示时间
    // 不是当天显示年月日 时分秒
    // 历史消息
    // 当天显示时间
    // 不是当天显示年月日 时分秒
    if (n == 1) {
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
            new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="other clearfix"><img tapmode onclick="openMemberInfo(this)" data-id="' + api.pageParam.targetUserId +
            '" class="fl otherImg" src="' + msg.head_img_url + '"><p data-msgId="' + msg.messageId +
            '" class="fl flex-def flex-cCenter" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()" data-newsText= "' +
            msg.content_text + '"> ' + transText(msg.content_text) + '</p></div>');
        slideBut();
    }
    else {
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
            new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        $api.prepend($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="other clearfix"><img tapmode onclick="openMemberInfo(this)" data-id="' + api.pageParam.targetUserId +
            '" class="fl otherImg" src="' + msg.head_img_url + '"><p data-msgId="' + msg.messageId +
            '" class="fl flex-def flex-cCenter" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" ontouchend="gtouchend()" data-newsText= "' +
            msg.content_text + '"> ' + transText(msg.content_text) + '</p></div>');
    }
    slideBut();
}

// 数据库查询 发送消息后新建消息
function sqlAddSendMsg(msg, n) {
    // 历史消息
    if (n == 1) {
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
            new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        $api.append($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="oneself clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            msg.head_img_url +
            '"><p class="fr flex-def flex-cCenter" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" data-msgId="' +
            msg.messageId + '" ontouchend="gtouchend()" data-newsText= "' + msg.content_text + '" > ' +
            transText(msg.content_text) + ' </p></div>');
        slideBut();
    }
    else {
        var time = new Date(parseInt(msg.receivedTime, 10)).toLocaleDateString() == new Date().toLocaleDateString() ?
            new Date(parseInt(msg.receivedTime, 10)).toLocaleTimeString() : new Date(parseInt(msg.receivedTime, 10)).toLocaleString();
        $api.prepend($api.dom('.main'), '<p class="newsTime" data-msgId="' + msg.messageId + '">' + time +
            '</p><div data-msgId="' + msg.messageId +
            '" class="oneself clearfix"><img tapmode data-id="1" onclick="openMemberInfo(this)"  class="fr oneselfImg" src="' +
            msg.head_img_url +
            '"><p class="fr flex-def flex-cCenter" ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove()" data-msgId="' +
            msg.messageId + '" ontouchend="gtouchend()" data-newsText= "' + msg.content_text + '" > ' +
            transText(msg.content_text) + ' </p></div>');
    }
    // 滚动到底部
    slideBut();
}
</script>
</html>