<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
         .bbottomLoading {
            text-align: center;
            font-size: .24rem;
            color: #999;
            line-height: .8rem;
            display: none;
        }

        .item {
            width: 7.5rem;
            /* height: 5.7rem; */
            background-color: #fff;
            padding: 0.2rem;
            box-sizing: border-box;
            margin-bottom: 0.1rem;
            border-bottom: .01rem solid #d9d9d9;
        }

        .firstImg {
            display: inline-block;
            width: 100%;
            height: 4.04rem;
            margin-top: 0.2rem;
            border-radius: .1rem;
            position: relative;
        }

        .price {
            display: inline-block;
            border-bottom-left-radius: .1rem;
            border-bottom-right-radius: .1rem;
            box-sizing: border-box;
            padding: 0 .2rem;
            height: 0.5rem;
            line-height: 0.5rem;
            background-color: rgba(0,0,0,.4);
            width: 100%;
            font-size: 0;
            position: absolute;
            bottom: 0;
            left: 0;
            color: #fff;
            text-align: right
        }
        .price span {
            font-size: 0.24rem;
        }

        .name,
        .user {
            height: 0.48rem;
            font-size: 0;
            margin-bottom: 0.2rem;
        }
        .user {
            margin: 0;
            /* box-sizing: border-box; */
            padding: 0.02rem 0;
        }
        .createTime {
            margin-bottom: 0.24rem;
        }
        .title {
            font-weight: bolder;
            /*font-weight: 700;*/
            font-size: 0.3rem;
            max-width: 5rem;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }

        .announcer {
            font-size: 0.26rem;
        }

        .announcerHead {
            width: 0.72rem;
            height: 0.72rem;
            border-radius: 50%;
        }



        .name .icon {
            width: 1rem;
            height: 0.48rem;
            background: url(../../image/icon_supply/icon_collecr03.png)no-repeat;
            background-size: .36rem .31rem;
            background-position: right center;
        }

        .name .collect {
            background: url(../../image/icon_supply/icon_collecr04.png)no-repeat;
            background-size: .36rem .31rem;
            background-position: right center;
        }

        .user .icon {
            padding-left: 0.35rem;
            height: 0.48rem;
            background: url(../../image/icon_supply/icon_pageviews.png)no-repeat;
            background-size: .26rem .16rem;
            background-position: left center;
            font-size: .18rem;
            color: #999;
        }

        .icon .count {
            font-size: 0.18rem;
            color: #999;
        }

        .company {
            color: #999;
            font-size: 0.22rem;
        }
        .price2 {
            font-weight: 500;
            font-size: 0.28rem;
            color: #CC0019;
        }
        .username {
            margin-left: 0.2rem;
        }
        .label {
            font-size: 0.2rem;
            color: #CC0019;
        }
        .createTime {
            font-size: 0.24rem;
        }
        .classifyLabel {
            border: .01rem solid #0ABB07;
            color: #0ABB07;
            font-size: 0.24rem;
            border-radius: .17rem;
            padding: 0 .12rem;
        }
        .position {
            padding-left: 0.3rem;
            background: url(../../image/icon_supply/icon_position.png)no-repeat;
            background-size: .18rem .24rem;
            background-position: left center
        }
        .distance {
            padding-left: 0.3rem;

            background: url(../../image/icon_supply/icon_distance.png)no-repeat;
            background-size: .2rem .2rem;
            background-position: left center
        }

    </style>
</head>
<body>
    <div class="main resultList"></div>
    <script type="text/x-dot-template" id="listT">
            {{?it.length == 0}}
                <p class="no_data">暂无数据</p>
            {{??}}
                {{ for (var i = 0; i < it.length; i++) { }}
                    <div class="item"  data-id="{{=it[i].supply_id}}" data-company="{{=it[i].company_name}}" tapmode onclick="info(this)">
                        <div class="userLeft flex-def flex-cCenter flex-zBetween" tapmode data-id="{{=it[i].user_id}}" onclick="openUserInfoPage(this);event.stopPropagation(); ">
                            <img src="{{=it[i].head_img_url}}?imageView2/1/w/150/h/150/interlace/1/q/100|imageslim" class="announcerHead" >
                            <div class="username flex-item">
                                <p class="announcer">{{=it[i].nickname}}</p>
                                <p class="company">{{=it[i].company_name}}</p>
                            </div>
                            <p class="price2">{{=it[i].price}}元/{{=it[i].unit}}</p>
                        </div>
                        <span class="firstImg" style="background: url({{=it[i].image_json[0]?it[i].image_json[0]:'../../image/icon_supply/supply_noImg.png'}})no-repeat;background-size: 7.1rem auto;background-position: center center;">
                           <span class="price ">
                                    <!-- <span class="position fl">清华大学</span> -->
                                    <span class="distance">距离我{{=it[i].distance}}km</span>
                            </span>
                        </span>
                        <div class="name flex-def flex-cCenter flex-zBetween ">
                                <span class="title  flex-def flex-cCenter"><span>{{=it[i].title}}</span>&nbsp;<span class="label">[{{=it[i].type == 2?'公司':'个人'}}]</span></span>
                            <span tapmode data-id="{{=it[i].supply_id}}" onclick="collect(this);event.stopPropagation();" class=" {{=it[i].is_collect==true?"collect icon":"icon"}}"></span>
                        </div>
                        <p class="createTime">{{=it[i].create_time}}</p>
                        <div class="user flex-def flex-cCenter flex-zBetween ">
                            <!-- <div class="userLeft flex-def flex-cCenter " tapmode data-id="{{=it[i].user_id}}" onclick="openUserInfoPage(this);event.stopPropagation(); ">
                                <img src="{{=it[i].head_img_url}}?imageView2/1/w/150/h/150/interlace/1/q/100|imageslim" class="announcerHead" >
                                <span class="announcer">{{=it[i].nickname}}</span>
                                <span class="company">{{=it[i].company_name}}</span>
                            </div> -->
                            <span class="classifyLabel">{{=it[i].category_name}}</span>
                            <span class="icon flex-def flex-cCenter "><span class="count">{{=it[i].browse_count}}</span></span>
                        </div>
                    </div>
                {{ }; }}
            {{?}}
    </script>


</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>

<script type="text/javascript">
    var _dataSource = ["次","幅","单","小时","分钟","天","周","月","份", "个", "扇", "课时", "面议","其他","未定义"];
    var keyword;
    var url;
    apiready = function(){
        moduleInit();
        // 请求数据
        if (api.pageParam.typePage == 0) {
            // 供
            url = '/supply/index';
        } else if (api.pageParam.typePage == 1) {
            // 求
             url = '/demand/index';

        } else {
            // 圈
        }
        requireData(api.pageParam);
        keyword = api.pageParam.keyword;
        // 筛选后的结果
        bySelect();
        // 下拉刷新
        api.setCustomRefreshHeaderInfo({
            bgColor: '#EFEFF4',
        }, function(ret, err) {
            //在这里从服务器加载数据，加载完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
            requireData();
        });
    };



    // 根据上传图片的多少自适应图片的大小
    function selfAdaption() {
        var listContent = $api.domAll('.item');

        for (var i = 0; i < listContent.length; i++) {
            var imgArr = listContent[i].getElementsByClassName('content_img');
            var imgCount = imgArr.length;
            if (imgCount == 1) {
             $api.css(listContent[i].getElementsByClassName('content_img')[0], 'width:3.26rem;height:2.86rem;margin-top:.1rem');

            }  else {
                for (var j = 0; j < imgCount; j++) {
                    $api.css(listContent[i].getElementsByClassName('content_img')[j], 'width:1.56rem;height:1.56rem');
                }
            }
        }
    }


    // 筛选后结果
    function bySelect() {
        var obj = {
            keyword: keyword,
            type: '',
            sub_type: '',
            category_ids: '',
            order: '',
        };

        api.addEventListener({
           name: 'searchSupply3'
        }, function(ret, err) {
           // // alert(JSON.stringify(ret))
                obj.type = ret.value.parameter.type;
                obj.sub_type = ret.value.parameter.sub_type;
                obj.category_ids = ret.value.parameter.category_ids;
                obj.order = ret.value.parameter.order;
                // // console.log(keyword)
                // // console.log('筛选'+JSON.stringify(obj))
                // alert('33333:::'+JSON.stringify(obj));
                if (ret.value.type == 1) {
                    // 供
                    url = '/supply/index';
                } else if (ret.value.type == 2) {
                    // 求
                     url = '/demand/index';
                } else {
                    // 圈
                }
                requireData(obj)
        })
        api.addEventListener({
           name: 'searchSupply2'
        }, function(ret, err) {
            keyword = ret.value.keyword
            obj.keyword = ret.value.keyword;
            // // console.log('搜索'+JSON.stringify(obj))
            requireData({keyword : ret.value.keyword});
            // alert('22222:::'+JSON.stringify(obj));
        });
        api.addEventListener({
           name: 'addPublish'
        }, function(ret, err) {
          api.openFrame({
              name: 'supply_addSupply',
              url: 'supply_addSupply.html',
              rect: {
                  x: 0,
                  y: api.pageParam.headerH,
                  w: api.winWidth,
                  h: api.winHeight
              },
              bounces: false
          });
       });
    }
    // // 筛选后页面变化
    // function viewResults(ele) {

    //     $api.css($api.dom('.results'), 'background: #fff url(../../image/icon_zk.png)no-repeat;background-position: right center;-webkit-background-size: .15rem .25rem;background-size: .15rem .25rem;');

    //     if ($api.text(ele) == '查看订阅的筛选结果') {
    //         api.openWin({
    //             name: 'supply_subscribeWin',
    //             url: './supply_subscribeWin.html',
    //             pageParam: {
    //                 name: 'value'
    //             }
    //         });
    //     }
    //      $api.html(ele, '查看订阅的筛选结果');
    // }

    // 请求数据
    function requireData (data) {
        // // console.log('函数内:'+JSON.stringify(data))
        // // console.log('函数内:'+JSON.stringify(url))
        var data = data || 1;
        var latitude,longitude;
        if (data !== 1) {
                bMap.getLocation({
                    accuracy: '100m',
                    autoStop: true,
                    filter: 1
                }, function(ret, err) {
                    if (ret.status) {
                        latitude = ret.lat;
                        longitude = ret.lon;
                        // // console.log(latitude+'--------'+longitude)
                        api.ajax({
                            url: apiSite + url,
                            method: 'post',
                            headers: apiHeader,
                            data: {
                            values: {
                                    token: $api.getStorage('userToken'),
                                    keyword: data.keyword,
                                    type: data.type || '',
                                    sub_type: data.sub_type || '',
                                    category_ids: data.category_ids || '',
                                    order: data.order || '',
                                    latitude: latitude || '',
                                    longitude: longitude || ''
                            }
                            }
                        }, function(ret, err) {
                            if(ret) {
                                // // console.log(JSON.stringify(ret))
                                // 停止下拉刷新
                                api.refreshHeaderLoadDone()
                                for (var i = 0; i < ret.data.list.length; i++) {
                                    // 解析图片json
                                    ret.data.list[i].image_json = eval(ret.data.list[i].image_json);
                                    for (var j = 0; j < ret.data.list[i].image_json.length; j++) {
                                        ret.data.list[i].image_json[j] = ret.data.list[i].image_json[j]+'?imageView2/1/w/200/h/200/q/75|imageslim'
                                    }
                                    if(ret.data.list[i].unit == 0) {
                                        ret.data.list[i].unit = _dataSource[_dataSource.length-1]
                                    } else if (ret.data.list[i].unit == undefined) {
                                        ret.data.list[i].unit = '未定义'
                                    } else {
                                        ret.data.list[i].unit = _dataSource[ret.data.list[i].unit-1]
                                    }
                                    ret.data.list[i].company_name = ret.data.list[i].company_name == null ? '' : ret.data.list[i].company_name;
                                    // 处理时间
                                    // 1. 如果是今天， 显示时间
                                    // 2. 如果是昨天显示昨天，
                                    // 3. 大于昨天显示天数
                                }
                                getData(ret.data.list);
                                selfAdaption();
                            } else {
                                alert(JSON.stringify(err.msg))
                            }
                        })
                    } else {
                        alert(err.code);
                    }
                });
            }
        }


    // 进入详情
    function info(ele) {
        var flag = 0;


        var compaby_name = $api.attr(ele, 'data-company'),
            supply_id = $api.attr(ele, 'data-id');
        if (compaby_name != '') {
            flag = 1;
        }
        // alert(flag +'---'+ compaby_name)
        api.openWin({
            name: 'supply_info',
            url: './supply_info.html',
            pageParam: {
                flag: flag,
                compaby_name: compaby_name,
                supply_id: supply_id
            }
        });

    }

</script>
</html>