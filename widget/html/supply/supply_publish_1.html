<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
        .no_data {
         background-color: #f8f8f8; 
         text-align: center;
         color: #999;  
         font-size: .3rem;
         margin-top: .5rem;
        }
         .item {
            background-color: #fff;
            padding: .2rem .3rem;
            box-sizing: border-box;
            border-bottom: 1px solid #ECECEA;
        }
        .main {
            /*padding: 0 .3rem;*/
            background-color: #fff;
        }
        .commentIcon {
            display: inline-block;
            width: .34rem;
            float: right;
            height: .26rem;
            background: url(../../image/icon_supply/icon_comment.png)no-repeat;
            -webkit-background-size: .34rem .26rem;
            background-size: .34rem .26rem;
        }
        .commentText {
            font-size: 0;
            margin-top: .2rem;
        }
        .commentText ul {
            position: relative;
        }
        .commentText ul:before {
            position: absolute;
            left: .2rem;
            top: -.1rem;
            content: "";
            display: inline-block;
            width: 0rem;
            height: 0rem;
            border-right: .1rem solid transparent;
            border-left: .1rem solid transparent;
            border-bottom: .1rem solid #F3F3F5;
        }
        .commentText li {
            font-size: .24rem;
            background: #F3F3F5;
            padding: .05rem .2rem;
        }
        .headImg {
            font-size: 0;
        }
        .headImg img {
            width: .785rem;
            height: .785rem;
        }
        .content {
            font-size: 0;
            margin-left: .2rem;
        }
        
        .titleLeft {
            width: 3.5rem;
            margin-bottom: .1rem;
        }
        .titleLeft .name {
            font-size: .26rem;
            color: #333;
            font-weight: 600;
        }
        
        .titleRight {
            color: #0ABB07;
            font-size: .28rem;
        }

        .info {
            font-size: 0;
        }
        .info {
            font-size: .24rem;
            color: #555;
        }
        .content_text {
            margin-top: .1rem;
            margin-bottom: .17rem;
        }
        .content_text .text {
            font-size: .28rem;
            color: #000;
            margin-top: .1rem;
            line-height: .28rem;

        }
        .info .comIcon {
            width: .41rem;
            height: .24rem;
            background: url(../../image/icon_supply/icon_gs2.png)no-repeat;
            -webkit-background-size: .41rem .24rem;
            background-size: .41rem .24rem;
            margin-right: .1rem;
        }

        .comment .time {
            font-size: .2rem;
            color: #999;
        }
       
        .results {
            font-size: .24rem;
            color: #2BD242;
            text-align: center;
            height: .8rem;
            line-height: .8rem;
            
        }
        .results span {
            display: inline-block;
            background:url(../../image/icon_supply/icon_person.png)no-repeat ;
            -webkit-background-size: .3rem .3rem;
            background-size: .3rem .3rem;
            width: .3rem;
            height: .3rem;
            vertical-align: text-top;
            margin-right: .2rem;
            
        }
        .title1 {
            /*margin-top: .2rem;*/
            padding: 0 .3rem;
            border-bottom: 1px solid #ddd;
            background-color: #fff;
            display: none;
        }
        .content_img {
            margin: .1rem .1rem 0 0;
        }
        .sexIcon {
            width: .24rem;
            height: .24rem;
            background: url(../../image/icon_supply/icon_person.png)no-repeat;
            -webkit-background-size: .24rem .24rem;
            background-size: .24rem .24rem;
            margin-left: .06rem;
        }

        .comment_name {
            color: #576B95;
        }
    </style>
</head>
<body>
    <div class="title1">
        <p class="results"   tapmode="hover"   onclick="viewResults(this)">
            <span></span>
           当筛选结果有变动时通知我
        </p>
    </div>
    <div class="main resultList"></div>
    <script type="text/x-dot-template" id="listT">
            {{?it.length === 0}}
            <p class="no_data">暂无数据</p>
            {{??}}
                {{ for (var i = 0; i < it.length; i++) { }} 
                    <div class="item flex-def" data-id="{{=it[i].supply_id}}" data-company="{{=it[i].company_name}}"   tapmode="hover"   onclick="info(this)">
                        <div class="headImg">
                            <img src="{{=it[i].head_img_url}}">
                        </div>
                        <div class="content flex-def flex-zTopBottom flex-item">
                            <div class="title flex-def flex-zBetween">
                                <div class="titleLeft flex-def flex-zLeftRight flex-cCenter">
                                    <h3 class="name">{{=it[i].title}}</h3>
                                    <!-- <h3 class="name">{{=it[i].nickname}}</h3> -->
                                    <span class="sexIcon"></span>
                                    <span class="zmfIcon"></span>
                                    <!-- <span class="zmfText">700分</span> -->
                                </div>
                                <div class="titleRight">
                                    {{=it[i].price}}元/{{=it[i].unit}}
                                </div>
                            </div>
                            {{?it[i].company_name}}
                                <div class="info">
                                    <p class="commanyName flex-def flex-cCenter">
                                        <span class="comIcon"></span>
                                        <span>{{=it[i].company_name}}</span>
                                    </p>
                                </div>
                            {{?}}
                            <div class="content_text">
                                <p class="text">{{=it[i].description}}</p>
                                {{?it[i].image_json!=null}}
                                    {{ for (var j = 0; j < it[i].image_json.length; j++) { }} 
                                        <img class="content_img" src="{{=it[i].image_json[j]}}">
                                    {{ } }}
                               {{?}}
                            </div>
                            <div class="comment">
                                <div class="time">
                                    <span>{{=it[i].create_time}}</span>
                                    <div class="commentIcon"></div>
                                </div>
                                <!-- <div class="commentText">
                                    <ul>
                                        <li>
                                            <span class="comment_name">李志超:</span>
                                            <span class="comment_content">我是一条评论</span>
                                        </li>
                                    </ul>
                                </div> -->
                            </div>
                        </div>
                </div>
                {{ }; }}
            {{?}}
    </script>
  
   
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>

<script type="text/javascript">
    var _dataSource = ["次","幅","单","小时","分钟","天","周","月","份", "个", "扇", "课时", "面议","其他","未定义"];
    apiready = function(){
        moduleInit();
        // 请求数据
        requireData();
        // 筛选后的结果
        bySelect();
        // 下拉刷新
        api.setCustomRefreshHeaderInfo({
            bgColor: '#EFEFF4',
        }, function(ret, err) {
            //在这里从服务器加载数据，加载完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
            requireData();
        });
        api.addEventListener({
            name: 'editSupplyAfter'
        }, function(ret, err) {
            if (ret) {
                requireData();
            } else {
                alert(JSON.stringify(err));
            }
        });
    };


    
    // 根据上传图片的多少自适应图片的大小
    function selfAdaption() {
        var listContent = $api.domAll('.item');

        for (var i = 0; i < listContent.length; i++) {
            var imgArr = listContent[i].getElementsByClassName('content_img');
            console.log(imgArr)
            var imgCount = imgArr.length
            if (imgCount == 1) {
                    $api.css(listContent[i].getElementsByClassName('content_img')[i], 'width:3.26rem;height:2.86rem;margin-top:.1rem');

            }  else {
                for (var j = 0; j < imgCount; j++) {
                    $api.css(listContent[i].getElementsByClassName('content_img')[j], 'height:1.56rem');
                }
            }
        }
    }
    
    
    // doT模版获取数据
    function getData(data) {
        
        var listTText = $api.byId('listT').text;
        
        var fnListT = doT.template(listTText);
        
        var html = fnListT(data);
        
        var list = $api.dom('.resultList');
        
        // 替换resultList所有内容
        $api.html(list, html);
        // alert('getData:' + JSON.stringify(data))
    }

    // 筛选后结果
    function bySelect() {
        api.addEventListener({
           name: 'screeningResults'
        }, function(ret, err) {
           
           if (ret.value.flag) {
            $api.css($api.dom('.title1'), 'display:block');
           }
           requireData(ret.value.condition)
           selfAdaption();
        })

        api.addEventListener({
           name: 'addPublish'
        }, function(ret, err) {
          api.openFrame({
              name: 'supply_addSupply',
              url: 'supply_addSupply.html',
              rect: {
                  x: 0,
                  y: api.pageParam.headerH,
                  w: api.winWidth,
                  h: api.winHeight
              },
              bounces: false
          });
       });
    }
    // 筛选后页面变化
    function viewResults(ele) {
        $api.css($api.dom('.results'), 'background: #fff url(../../image/icon_zk.png)no-repeat;background-position: right center;-webkit-background-size: .15rem .25rem;background-size: .15rem .25rem;');
        // $api.css(ele, 'b');
        // getData(data2);
        // selfAdaption();
        if ($api.text(ele) == '查看订阅的筛选结果') {
            // getData(data3);
            // selfAdaption();
            api.openWin({
                name: 'supply_subscribeWin',
                url: './supply_subscribeWin.html',
                pageParam: {
                    name: 'value'
                }
            });
        }
         $api.html(ele, '查看订阅的筛选结果');
    }
    
    // 请求数据
    function requireData (data) {
        var data = data || 1;
        var latitude,longitude;
        if (data !== 1) {
            if (data.order == 'distance') {
                bMap.getLocation({
                    accuracy: '100m',
                    autoStop: true,
                    filter: 1
                }, function(ret, err) {
                    if (ret.status) {
                        data.latitude = ret.lat;
                        data.longitude = ret.lon;
                    } else {
                        alert(err.code);
                    }
                });
            }
        }
        // 缓存字段  supply_publish_1
        var supplyCache = $api.getStorage('supply_publish_1');
        if (supplyCache) {
            getData(supplyCache);
        }
        api.ajax({
            url: apiSite + '/api/supply/index',
            method: 'post',
            headers: apiHeader,
            data: {
               values: { 
                    token: $api.getStorage('userToken'),
                    // keyword: '',
                    type: data.type || '', 
                    sub_type: data.sub_type || '',
                    // category_ids: '',     
                    order: data.order || '',
                    latitude: data.latitude || '',      
                    longitude: data.longitude || ''     
               }
            }
        }, function(ret, err) {
            if(ret) {
                // 停止下拉刷新
                api.refreshHeaderLoadDone()
                if (supplyCache === ret.data.list) {

                } else {
                    for (var i = 0; i < ret.data.list.length; i++) {
                        // 解析图片json
                        ret.data.list[i].image_json = eval(ret.data.list[i].image_json);

                        if(ret.data.list[i].unit == 0) {
                            ret.data.list[i].unit = _dataSource[_dataSource.length-1]
                        } else {
                            ret.data.list[i].unit = _dataSource[ret.data.list[i].unit-1]
                        }
                        ret.data.list[i].company_name = ret.data.list[i].company_name == null ? '' : ret.data.list[i].company_name;
                        
                    }
                    $api.setStorage('supply_publish_1', ret.data.list);
                    getData(ret.data.list);
                    selfAdaption();
                }
                
            } else {
                alert(JSON.stringify(err.msg))
            }
        })
    }
    
    // 进入详情
    function info(ele) {
        var flag = 0;

        
        var compaby_name = $api.attr(ele, 'data-company'),
            supply_id = $api.attr(ele, 'data-id');
        if (compaby_name != '') {
            flag = 1;
        } 
        // alert(flag +'---'+ compaby_name)
        api.openWin({
            name: 'supply_info',
            url: './supply_info.html',
            pageParam: {
                flag: flag,
                compaby_name: compaby_name,
                supply_id: supply_id
            }
        });
        
    }

</script>
</html>