<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"
    />
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <style>
        .no_data {
            background-color: #EDECF3;
            text-align: center;
            color: #999;
            font-size: .3rem;
            margin-top: .5rem;
        }

        .bbottomLoading {
            text-align: center;
            font-size: .24rem;
            color: #999;
            line-height: .8rem;
            display: none;
        }

        .item {
            width: 7.5rem;
            height: 5.7rem;
            background-color: #fff;
            padding: 0.2rem;
            box-sizing: border-box;
            margin-bottom: 0.1rem;
            border-bottom: .01rem solid #d9d9d9;
        }

        .firstImg {
            display: inline-block;
            width: 100%;
            height: 3.8rem;

            border-radius: .1rem;
            position: relative;
        }

        .price {
            display: inline-block;
            padding: 0 .2rem;
            height: 0.36rem;
            line-height: 0.36rem;
            background-color: #CFAA7F;
            font-size: 0.3rem;
            position: absolute;
            bottom: 0.26rem;
            left: 0;
            color: #fff;
            text-align: right
        }

        .name,
        .user {
            height: 0.48rem;
            font-size: 0;
            margin-bottom: 0.2rem;
        }

        .title {
            font-size: 0.34rem;
            max-width: 5rem;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }

        .announcer {
            margin: 0 .1rem;
        }

        .announcerHead {
            width: 0.48rem;
            height: 0.48rem;
            border-radius: 50%;
        }

        .user span {
            font-size: 0.26rem;
        }

        .name .icon {
            width: 1rem;
            height: 0.48rem;
            background: url(../../image/icon_supply/icon_collecr03.png)no-repeat;
            background-size: .36rem .31rem;
            background-position: right center;
        }

        .name .collect {
            background: url(../../image/icon_supply/icon_collecr04.png)no-repeat;
            background-size: .36rem .31rem;
            background-position: right center;
        }

        .user .icon {
            padding-left: 0.35rem;
            height: 0.16rem;
            line-height: 0.16rem;
            background: url(../../image/icon_supply/icon_pageviews.png)no-repeat;
            background-size: .26rem .16rem;
            background-position: left center;
            font-size: 0rem;
        }

        .icon .count {
            font-size: 0.18rem;
            color: #999;
        }

        .company {
            color: #999;
        }
    </style>
</head>

<body>

    <!--  <div class="title1">
        <p class="results"   tapmode   onclick="viewResults(this)">
            <span></span>
           当筛选结果有变动时通知我
        </p>
    </div> -->

    <!-- <div class="item">
        <span class="firstImg" style="display:inline-block;width:100%;height:3.8rem;background:url(../../image/tx_1.jpg)no-repeat;background-size:7.1rem 3.8rem;background-position: center center;border-radius:.1rem;">
            <span class="price">$140/小时</span>
        </span>
        <div class="name flex-def flex-cCenter flex-zBetween">
            <span class="title">陪跑</span>
            <span tapmode onclick="collect(this)" class="icon"></span>
        </div>
        <div class="user flex-def flex-cCenter flex-zBetween">
            <div class="userLeft flex-def flex-cCenter">
                <img src="../../image/tx_1.jpg" class="announcerHead">
                <span class="announcer">人鱼</span>
                <span class="company">人鱼</span>
            </div>
            <span class="icon flex-def flex-cCenter"><span class="count">66人</span></span>
        </div>
    </div> -->
    <!-- <div class="loading"></div> -->
    <div class="resultList"></div>
    <script type="text/x-dot-template" id="listT">
        {{?it.length === 0}}
        <p class="no_data">暂无数据</p>
        {{??}}
            {{ for (var i = 0; i < it.length; i++) { }}
                <div class="item"  data-id="{{=it[i].supply_id}}" data-company="{{=it[i].company_name}}" tapmode onclick="info(this)">
                    <span class="firstImg" style="background: url({{=it[i].image_json[0]?it[i].image_json[0]:'../../image/tx_1.jpg'}})no-repeat;background-size: 7.1rem auto;background-position: center center;">
                        <span class="price ">{{=it[i].price}}元/{{=it[i].unit}}</span>
                    </span>
                    <div class="name flex-def flex-cCenter flex-zBetween ">
                        <span class="title ">{{=it[i].title}}</span>
                        <span tapmode data-id="{{=it[i].supply_id}}" onclick="collect(this);event.stopPropagation();" class="icon "></span>
                    </div>
                    <div class="user flex-def flex-cCenter flex-zBetween ">
                        <div class="userLeft flex-def flex-cCenter " tapmode data-id="{{=it[i].user_id}}" onclick="openUserInfoPage(this);event.stopPropagation(); ">
                            <img src="{{=it[i].head_img_url}}?imageView2/1/w/150/h/150/interlace/1/q/100|imageslim" class="announcerHead" >
                            <span class="announcer">{{=it[i].nickname}}</span>
                            <span class="company">{{=it[i].company_name}}</span>
                        </div>
                        <span class="icon flex-def flex-cCenter "><span class="count ">66人</span></span>
                    </div>
                </div>
            {{ }; }}
        {{?}}
    </script>
    <p class="bbottomLoading ">正在加载...</p>

</body>
<script type="text/javascript " src="../../script/api.js "></script>
<script type="text/javascript " src="../../script/common.js "></script>
<script type="text/javascript " src="../../script/doT.min.js "></script>

<script type="text/javascript ">
    var _dataSource = ["次 ","幅 ","单 ","小时 ","分钟 ","天 ","周 ","月 ","份 ", "个 ", "扇 ", "课时 ", "面议 ","其他 ","未定义 "];
    var dataList = [], page_num = 1, dataListFlag = [],selectedObj,condition,parameter,flag;
    apiready = function(){
        moduleInit();
        // 请求数据
        requireData();
        // 筛选后的结果
        bySelect();
        // 下拉刷新
        api.setCustomRefreshHeaderInfo({
            bgColor: '#EFEFF4',
        }, function(ret, err) {
            page_num = 1;
            $api.css($api.dom('.loading'), 'display: none');
            $api.text($api.dom('.bbottomLoading'), '正在加载...');
            //在这里从服务器加载数据，加载完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
            if (flag) {
                requireData(condition);
            } else {
                requireData();
            }
        });
        api.addEventListener({
            name: 'editSupplyAfter'
        }, function(ret, err) {
            if (ret) {
                    page_num = 1;
                    requireData();
            } else {
                alert(JSON.stringify(err));
            }
        });
         // 上啦加载
        scrollBotton()

    };
    // 收藏
    function collect(ele) {
        var url;
        if ($api.hasCls(ele, 'collect')) {
            // 已收藏
            // $api.removeCls(ele, 'collect');
            url = '/supply/cancelCollect';
        } else {
            // 未收藏
            // $api.addCls(ele, 'collect');
            url = '/supply/collect';
        }
        api.ajax({
            url: apiSite + url,
            method: 'post',
            headers: apiHeader,
            data: {
                   values: {
                       token: $api.getStorage('userToken'),
                       supply_id: $api.attr(ele, 'data-id')
                   }
            }
        }, function(ret, err) {
            if(ret) {
                if ($api.hasCls(ele, 'collect')) {
                    // 已收藏
                    $api.removeCls(ele, 'collect');
                    api.toast({
                        msg: '取消收藏成功'
                    });
                } else {
                    // 未收藏
                    $api.addCls(ele, 'collect');
                    api.toast({
                        msg: '收藏供应成功'
                    });
                }
            } else {
                alert(JSON.stringify(err.msg))
            }
        })
    }

    // 用户详情页面
    function openUserInfoPage(ele){
        var userId = $api.attr(ele, 'data-id');
        api.openWin({
            name: 'winName',
            url: '../addressList/txl_memberInfo_Win.html',
            pageParam: {
                userId: userId
            }
        });
    }
    var scrollFlag = 1;
    // 滚动到底部触发的事件
    function scrollBotton() {

        // 滚动到底部触发的事件
        api.addEventListener({
            name:'scrolltobottom',
            extra:{
                threshold:0            //设置距离底部多少距离时触发，默认值为0，数字类型
            }
        }, function(ret, err){
            // // console.log('已滚动到底部')
            // alert('已滚动到底部');
            if ($api.text($api.dom('.bbottomLoading')) == '暂无更多供求') {

            } else {
                if(scrollFlag) {
                    scrollFlag = 0;
                    $api.css($api.dom('.bbottomLoading'), 'display: block');
                    if (page_num == 1) {
                        page_num = 2;
                    }
                    requireData2(condition);
                }
            }

        });
    }


    // 根据上传图片的多少自适应图片的大小
    function selfAdaption() {
        var listContent = $api.domAll('.item');

        for (var i = 0; i < listContent.length; i++) {
            var imgArr = listContent[i].getElementsByClassName('content_img');
            var imgCount = imgArr.length;
            if (imgCount == 1) {
             $api.css(listContent[i].getElementsByClassName('content_img')[0], 'width:3.26rem;height:2.86rem;margin-top:.1rem');

            }  else {
                for (var j = 0; j < imgCount; j++) {
                    $api.css(listContent[i].getElementsByClassName('content_img')[j], 'width:1.56rem;height:1.56rem');
                }
            }
        }
    }
    // 筛选后结果
    function bySelect() {
        api.addEventListener({
           name: 'screeningResults'
        }, function(ret, err) {
           if (ret.value.flag) {
            $api.css($api.dom('.loading'), 'display: block');
            // // console.log('监听结果::'+JSON.stringify(ret))
            // $api.css($api.dom('.title1'), 'display:block');
            // parameter = ret.value.parameter
           }
           if (ret.value.condition) {
            flag = 1
           }
           condition = ret.value.condition;
           page_num = 1;
           requireData(ret.value.condition)
           // selfAdaption();
        })
        api.addEventListener({
           name: 'addPublish'
        }, function(ret, err) {
          api.openFrame({
              name: 'supply_addSupply',
              url: 'supply_addSupply.html',
              rect: {
                  x: 0,
                  y: api.pageParam.headerH,
                  w: api.winWidth,
                  h: api.winHeight
              },
              bounces: false
          });
       });
    }
    // 筛选后页面变化
    function viewResults(ele) {
        $api.css($api.dom('.results'), 'background: #fff url(../../image/icon_zk.png)no-repeat;background-position: right center;-webkit-background-size: .15rem .25rem;background-size: .15rem .25rem;');
        // $api.css(ele, 'b');
        // getData(data2);
        // selfAdaption();
        if ($api.text(ele) == '查看订阅的筛选结果') {
            // getData(data3);
            // selfAdaption();
            api.openWin({
                name: 'supply_subscribeWin',
                url: './supply_subscribeWin.html',
                pageParam: {
                    name: 'value'
                }
            });
        }
         $api.html(ele, '查看订阅的筛选结果');
    }

    // 请求数据
    function requireData (data) {
        // // // console.log('参数:::'+JSON.stringify(data))
        var data = data || {};
        var latitude,longitude;
        if (data !== {}) {
            if (data.order == 'distance') {
                bMap.getLocation({
                    accuracy: '100m',
                    autoStop: true,
                    filter: 1
                }, function(ret, err) {
                    if (ret.status) {
                        data.latitude = ret.lat;
                        data.longitude = ret.lon;
                        fliderSupply(data)
                    } else {
                        alert(err.code);
                    }
                });
            } else {
                // 缓存字段  supply_publish_1
                var supplyCache = $api.getStorage('supply_publish_1');
                if (supplyCache) {
                    console.log(JSON.stringify(supplyCache))
                    getData(supplyCache);
                    // console.log($api.attr($api.dom('.firstImg'), 'style'))
                    // selfAdaption();
                }
                fliderSupply(data,supplyCache)
            }
        }

    }
    function fliderSupply(data,supplyCache) {
        // // // console.log('参数2:::'+JSON.stringify(data))
        api.ajax({
            url: apiSite + '/supply/index',
            method: 'post',
            headers: apiHeader,
            data: {
               values: {
                    token: $api.getStorage('userToken'),
                    // keyword: '',
                    type: data.type || '',
                    sub_type: data.sub_type || '',
                    category_ids: data.category_ids || '',
                    order: data.order || '',
                    latitude: data.latitude || '',
                    longitude: data.longitude || '',
                    page_num: page_num
               }
            }
        }, function(ret, err) {
            if(ret) {
                // // // console.log(page_num)
                // // // console.log('数据:::'+JSON.stringify(ret.data.list.length))
                // // // console.log('页数:::'+JSON.stringify(page_num))
                // $api.css($api.dom('.loading'), 'display: none');
                // 停止下拉刷新
                api.refreshHeaderLoadDone()
                // if (supplyCache === ret.data.list) {

                // } else {
                    for (var i = 0; i < ret.data.list.length; i++) {
                        // 解析图片json
                        ret.data.list[i].image_json = eval(ret.data.list[i].image_json);
                        // 处理七牛云返回的url, 加参数是返回的缩略图
                        for (var j = 0; j < ret.data.list[i].image_json.length; j++) {
                            ret.data.list[i].image_json[j] = ret.data.list[i].image_json[j]+'?imageView2/1/w/310/h/190/interlace/1/q/50|imageslim'
                        }
                        // 处理时间显示
                        ret.data.list[i].create_time = initTime(ret.data.list[i].create_time)
                        if(ret.data.list[i].unit == 0) {
                            ret.data.list[i].unit = _dataSource[_dataSource.length-1]
                        } else {
                            ret.data.list[i].unit = _dataSource[ret.data.list[i].unit-1]
                        }
                        ret.data.list[i].company_name = ret.data.list[i].company_name == null ? '' : ret.data.list[i].company_name;

                    }
                    $api.setStorage('supply_publish_1', ret.data.list);
                    dataList = ret.data.list;
                    // // // console.log('447:::'+JSON.stringify(ret.data.list))

                    getData(ret.data.list);
                    if (ret.data.list.length < 15) {
                        $api.css($api.dom('.bbottomLoading'), 'display: none');
                    }
                    // selfAdaption();
                // }

            } else {
                alert(JSON.stringify(err.msg))
            }
        })
    }
    function requireData2 (data) {
        var data = data || {};
        var latitude,longitude;
        if (data !== {}) {
            if (data.order == 'distance') {
                bMap.getLocation({
                    accuracy: '100m',
                    autoStop: true,
                    filter: 1
                }, function(ret, err) {
                    if (ret.status) {
                        data.latitude = ret.lat;
                        data.longitude = ret.lon;
                    } else {
                        alert(err.code);
                    }
                });
            }
        }
        api.ajax({
            url: apiSite + '/supply/index',
            method: 'post',
            headers: apiHeader,
            data: {
               values: {
                    token: $api.getStorage('userToken'),
                    // keyword: '',
                    type: data.type || '',
                    sub_type: data.sub_type || '',
                    category_ids: data.category_ids || '',
                    order: data.order || '',
                    latitude: data.latitude || '',
                    longitude: data.longitude || '',
                    page_num: page_num
               }
            }
        }, function(ret, err) {
            if(ret) {
                if (ret.code == 200) {
                    scrollFlag = 1;
                    page_num++;
                    if (ret.data.list<20) {
                        $api.text($api.dom('.bbottomLoading'), '暂无更多供求');
                    } else {
                        $api.css($api.dom('.bbottomLoading'), 'display: none');
                    }
                    renderPage(ret)
                } else {
                    alert(ret.msg)
                }
            } else {
                alert(JSON.stringify(err.msg))
            }
        })
    }
     // 渲染页面
     function renderPage(ret) {
        for (var i = 0; i < ret.data.list.length; i++) {
            // 解析图片json
            ret.data.list[i].image_json = eval(ret.data.list[i].image_json);

            if(ret.data.list[i].unit == 0) {
                ret.data.list[i].unit = _dataSource[_dataSource.length-1]
            } else {
                ret.data.list[i].unit = _dataSource[ret.data.list[i].unit-1]
            }
            ret.data.list[i].company_name = ret.data.list[i].company_name == null ? '' : ret.data.list[i].company_name;
        }
        for (var i = 0; i < ret.data.list.length; i++) {
            dataList.push(ret.data.list[i])
        }
        getData(dataList);
        selfAdaption();
    }
    // 进入详情
    function info(ele) {
        var flag = 0;


        var compaby_name = $api.attr(ele, 'data-company'),
            supply_id = $api.attr(ele, 'data-id');
        if (compaby_name != '') {
            flag = 1;
        }
        // alert(flag +'---'+ compaby_name)
        api.openWin({
            name: 'supply_info',
            url: './supply_info.html',
            pageParam: {
                flag: flag,
                compaby_name: compaby_name,
                supply_id: supply_id
            }
        });
    }

</script>
</html>