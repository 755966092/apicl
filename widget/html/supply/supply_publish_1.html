<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
        body,html{
            background-color: #EFEFF4;
        }
       
        .main .listContent {
            width: 100%;
            box-sizing: border-box;
            border-bottom: 1px solid #E0E0E0;
            background-color: #fff;
            padding:  .3rem .3rem; 
            /*margin-top: .2rem;*/  
            font-size: 0;
            position: relative;
        }
        .main .listContent .img {
            width: .785rem;
            margin-right: .2rem;
        }
        .listContent .title {
            width: 100%;
        }
        .title_name {
            font-size: 0;
        }
        .title_name  span{
            display: inline-block;
            font-size: .34rem;
        }
        .title_name .name {
            height: .34rem;
        }
        .title_name .person {
           
            width: .24rem;
            height: .24rem;
            background: url(../../image/icon_supply/icon_person.png)no-repeat;
            background-size: .24rem .24rem;
            margin: 0 .2rem;
        }
        .title_name .bitmap {
            height: .24rem;
            width: .21rem;
            background: url(../../image/icon_supply/icon_bitmap.png)no-repeat;
            background-size: .21rem .24rem;
        }
        .title_name .score {
            height: .24rem;
            font-size: .2rem;
            margin-left: .1rem;
            color: #1783FF;
            vertical-align:bottom;
        }
        .title_name .position {
           font-size: .24rem;
           margin-top: .1rem;
        }
         .title_name .position span {
            display: inline-block;
            width: .63rem;
            height: .28rem;
            background: url(../../image/icon_supply/icon_gs.png)no-repeat;
            -webkit-background-size: .62rem .28rem;
            background-size: .62rem .28rem;
           /* text-align: center;
            font-size: .2rem;
            line-height: .26rem;
            border: 1px solid #1783FF;
            border-radius: .01rem;
            color: #1783FF;*/
         }
        .title .price {
            font-size: .34rem;
            color: #0ABB07;
         }
         .company {
            font-size: .24rem;
            color: #555;
         }
        .content {
            /*padding-top: 1.2rem;*/
            padding-left: 1rem;
        }
        .content  img {
            height: 2.86rem;
            margin-top: .1rem;
            margin-right: .1rem;
        }
        .content  img:nth-child(4),
        .content  img:nth-child(7),
        .content  img:first-child {
            margin-left: 0;
        }
        .content  img:nth-child(3n) {
            margin-right: 0;
        }
        .content  img:last-child {
            margin-right: 0;
        }
        .content .time {
            margin-top: .2rem;
            font-size: .2rem;
            color: #999;
        }
        .content .icon_comment {
            display: inline-block;
            width: .34rem;
            float: right;
            height: .26rem;
            background: url(../../image/icon_supply/icon_comment.png)no-repeat;
            -webkit-background-size: .34rem .26rem;
            background-size: .34rem .26rem;
        }
        .comment {
            font-size: 0;
            padding-left: 1rem;
            margin-top: .2rem;

        }
        .comment li {
            font-size: .24rem;
            background: #F3F3F5;
            padding: .05rem .2rem;
        }
        .content_text {
            font-size: .28rem;
        }
        .results {
            font-size: .24rem;
            color: #2BD242;
            text-align: center;
            height: .8rem;
            line-height: .8rem;
            
        }
        .results span {
            display: inline-block;
            background:url(../../image/icon_supply/icon_person.png)no-repeat ;
            -webkit-background-size: .3rem .3rem;
            background-size: .3rem .3rem;
            width: .3rem;
            height: .3rem;
            vertical-align: text-top;
            margin-right: .2rem;
            
        }
        .title1 {
            margin-top: .2rem;
            padding: 0 .3rem;
            background-color: #fff;
            display: none;
        }
    </style>
</head>
<body>
    <div class="title1">
        <p class="results"   tapmode="hover"   onclick="viewResults(this)">
            <span></span>
           当筛选结果有变动时通知我
            
        </p>
    </div>
    <div class="main">  
        <ul class="resultList">  </ul>
        <script type="text/x-dot-template" id="listT">
            {{ for (var i = 0; i < it.length; i++) { }} 
                <li class="listContent clearfix" data-company="{{=it[i].company_name}}"   tapmode="hover"   onclick="info(this)">
                        <div class="title clearfix fl">
                            <img class="img fl" src="{{=it[i].head_img_url}}">
                            <div class="title_name fl">
                                <span class="name">{{=it[i].title}}</span>
                                <span class="person"></span>
                                <span class="bitmap"></span>
                                <span class="score">700分</span>
                                <p class="position">
                                    <span></span>
                                    {{=it[i].nickname}}
                                </p>
                                <p class="company">{{=it[i].company_name}}</p>
                            </div>
                            <p class=   "fr price">1000元/单</p>
                        </div>
                        <div class="content clearfix">

                           <div class="content_text">
                                <p>{{=it[i].description}}</p>
                                {{ for (var j = 0; j < it[i].image_json.length; j++) { }} 
                                    <img class="content_img" src="{{=it[i].image_json[j]}}">
                                {{ } }}
                           </div>
                           <p class="time">
                               {{=it[i].create_time}}
                               <span class="icon_comment"></span>
                           </p>
                        </div>
                        <!-- <ul class="comment">
                            <li>
                                <span .comment_name>李志超:</span>
                                <span class="comment_content">我是一条评论</span>
                            </li>
                        </ul> -->
                </li>   
            {{ }; }}
        </script>
    </div>
   
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>

<script type="text/javascript">
    
    apiready = function(){
        // 请求数据
        requireData();
        // 筛选后的结果
        bySelect()
    };



    // 根据上传图片的多少自适应图片的大小
    function selfAdaption() {
        var listContent = $api.domAll('.listContent');

        for (var i = 0; i < listContent.length; i++) {
            var imgArr = listContent[i].getElementsByClassName('content_img');
            console.log(imgArr)
            var imgCount = imgArr.length
            if (imgCount == 1) {
                    $api.css(listContent[i].getElementsByClassName('content_img')[i], 'width:2.86rem;height:3.26rem;margin:0');

            }  else {
                for (var j = 0; j < imgCount; j++) {
                    $api.css(listContent[i].getElementsByClassName('content_img')[j], 'height:1.56rem');
                }
            }
        }
    }
    

     // doT模版获取数据
    function getData(data) {
        
        var listTText = $api.byId('listT').text;
        
        var fnListT = doT.template(listTText);
        
        var html = fnListT(data);
        
        var list = $api.dom('.resultList');
        
        // 替换resultList所有内容
        $api.html(list, html);
        // alert('getData:' + JSON.stringify(data))
    }

    // 筛选后结果
    function bySelect() {
        api.addEventListener({
           name: 'screeningResults'
        }, function(ret, err) {
           $api.css($api.dom('.title1'), 'display:block');
           getData(data);
           selfAdaption();
        })

        api.addEventListener({
           name: 'addPublish'
        }, function(ret, err) {
          api.openFrame({
              name: 'supply_addSupply',
              url: 'supply_addSupply.html',
              rect: {
                  x: 0,
                  y: api.pageParam.headerH,
                  w: api.winWidth,
                  h: api.winHeight
              },
              bounces: false
          });
       });
    }
    // 筛选后页面变化
    function viewResults(ele) {
       
        $api.css($api.dom('.results'), 'background: #fff url(../../image/icon_zk.png)no-repeat;background-position: right center;-webkit-background-size: .15rem .25rem;background-size: .15rem .25rem;');
        // $api.css(ele, 'b');
        // getData(data2);
        // selfAdaption();
        if ($api.text(ele) == '查看订阅的筛选结果') {
            // getData(data3);
            // selfAdaption();
            api.openWin({
                name: 'supply_subscribeWin',
                url: './supply_subscribeWin.html',
                pageParam: {
                    name: 'value'
                }
            });
        }
         $api.html(ele, '查看订阅的筛选结果');
    }

    // 请求数据
    function requireData () {
        api.ajax({
            url: apiSite + '/api/supply/index',
            method: 'post',
            headers: apiHeader,
            data: {
               values: { 
                   token: $api.getStorage('userToken')
               }
            }
        }, function(ret, err) {
            if(ret) {
                for (var i = 0; i < ret.data.list.length; i++) {
                    // 解析图片json
                    ret.data.list[i].image_json = eval(ret.data.list[i].image_json);

                   ret.data.list[i].company_name = ret.data.list[i].company_name == null ? '' : ret.data.list[i].company_name;
                    // 处理时间
                    // 1. 如果是今天， 显示时间
                    // 2. 如果是昨天显示昨天，
                    // 3. 大于昨天显示天数
                   
                    
                }
                getData(ret.data.list);
                selfAdaption();
            } else {
                alert(JSON.stringify(err))
            }
        })
    }
    
    // 进入详情
    function info(ele) {
        var flag = 0;
        var compaby_name = $api.attr(ele, 'data-company')
        if (compaby_name != 'null') {
            flag = 1;
        } 
        api.openWin({
            name: 'supply_info',
            url: './supply_info.html',
            pageParam: {
                flag: flag,
                compaby_name: compaby_name
            }
        });
        
    }

</script>
</html>