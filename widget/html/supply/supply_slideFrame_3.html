<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
        html,body {
            height: 100%;
            width: 100%;    
            background-color: rgba(0,0,0,0.4);
        }
        .warp1 {
            position: relative;
            height: 100%;
             display: -webkit-box; 
            display: flex; 
            -webkit-box-direction: normal;
            -webkit-box-orient: vertical;
            flex-direction: column;
            -webkit-box-align:  end;
            align-items: flex-end;
        }
        .warp {
            margin-left: 1.5rem;
            width: 6rem;
            background-color: #fff;
        }
        .main {
            background-color: #fff;
            position: relative;
            height: 100%;
            box-sizing: border-box;
        }
        .main>div:first-child {
            padding: .15rem .2rem;
            padding-right: 0;
        }

       
          .main ul.no2 {
            font-size: .24rem;
            /*margin-top: .37rem;*/

        }
        .main ul.no2 p {
            line-height: .79rem;
            color: #555;
            /*border-bottom: .01rem solid #cbcbcb;*/
        }
        .main ul.no2 li {
            /*height: .84rem;*/
            line-height: .79rem;
            border-top: .01rem solid #d9d9d9;
            font-size: 0;
            padding-right: .36rem;
        }
        .main ul.no2 li p {
            font-size: .28rem;
            color: #333;
            background: url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: right center;
        }
        
        .footer {
            height: .78rem;
            width: 6rem;
            font-size: 0;
            z-index: 999;
            position: fixed;
            box-sizing: border-box;
            bottom: 0;
        }
        .footer span {
            box-sizing: border-box;
            height: .9rem;
            width: 3rem;    
            font-size: .34rem;
            text-align: center;
            line-height: .9rem;
            float: left;
            background-color: #F8F8F8;
        }
        .footer span:last-child {
            background-color: #27B24A;
            color: #fff;
        }
        
        header.header {
            opacity: 0;
        }
        .no2Icon {
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            text-align: right;
            width: 3rem;
            color: #999999;
            float: right;
            font-size: .24rem;
            margin-right: .25rem;
        }
        .no1,
        .no3,
        .no4,
        .no5 {
            font-size: 0;
            border-bottom: .01rem solid #d9d9d9;
            padding-bottom: .26rem;
            margin-bottom: .23rem;
        }
        .no1 p,
        .no3 p,
        .no4 p,
        .no5 p {
            font-size: .26rem;
            line-height: .37rem;
            margin-bottom: .13rem;
        }
        .no1 li,
        .no3 li,
        .no4 li,
        .no5 li {
            display: inline-block;
            width: 1.78rem;
            height: .79rem;
            text-align: center;
            line-height: .79rem;
            background-color: #F3F3F3;
            font-size: .24rem;
            color: #555;
            margin-right: .12rem;
            margin-bottom: .12rem;
        }
        h3 {
            font-size: .26rem;
            line-height: .37rem;
            margin-bottom: .22rem;
        }
        .no1 .sel,
        .no3 .sel,
        .no4 .sel,
        .no5 .sel {
             background-color: #E6FFE6;
            color: #27B24A;
        }
    </style>
</head>
<body   tapmode class=""   onclick="api.closeFrame()">
   
    <div class="warp1 flex-def flex-zBetween">
         <header class="header">
        <div class="head"></div>
    </header>
        <div class="warp flex-item"   tapmode   onclick="api.closeFrame()">
            <div class="main"   tapmode   onclick="event.cancelBubble=true;">
                <div>
                    <ul class="no1">
                        <p>类别</p>
                        <li tapmode data-id='1' id="supply" onclick="selClassify(this)"   class="sel">供</li>
                        <li tapmode data-id='2' id="ask" onclick="selClassify(this)" >求</li>
                    </ul>  
                    <ul class="no3">
                        <p>排序</p>
                        <!-- <li tapmode data-order="" onclick="selSort(this)"  >智能排序</li> -->
                        <li tapmode data-order="distance" onclick="selSort(this)" >距离最近</li>
                        <li tapmode data-order="price" onclick="selSort(this)" >价格最低</li>
                        <li tapmode data-order="create_time" onclick="selSort(this)" >最新发布</li>
                    </ul> 
                    <ul class="no4">
                        <p>类型</p>
                        <li tapmode onclick="selType(this)" data-id="1">我卖</li>
                        <li tapmode onclick="selType(this)" data-id="2">我公司卖</li>
                    </ul>
                    <ul class="no5">
                        <p>类别</p>
                        <li tapmode onclick="selSubType(this)" data-id="1">自产自销</li>
                        <li tapmode onclick="selSubType(this)" data-id="2">代理</li>
                    </ul>
                    <h3>分类</h3>
                    <ul class="no2">
                        <li tapmode data-val="school" onclick="li_spanP(this);event.cancelBubble=true;" >
                            <p>已选择<span class="no2Icon school"></span></p>
                        </li>
                      <!--   <li tapmode data-val="commpany" onclick="li_spanP(this);event.cancelBubble=true;">
                            <p>TA代理的<span class="no2Icon commpany"></span></p>
                        </li>
                        <li tapmode data-val="trade" onclick="li_spanP(this);event.cancelBubble=true;">
                            <p>TA公司<span class="no2Icon trade"></span></p>
                        </li> -->
                        <!-- <li tapmode data-val="place" onclick="li_spanP(this);event.cancelBubble=true;">
                            <p>地点<span class="no2Icon place"></span></p>
                        </li>
                        <li tapmode data-val="custom" onclick="li_spanP(this);event.cancelBubble=true;">
                            <p>自定义<span class="no2Icon custom"></span></p>
                        </li> -->
                    </ul>
                </div>
            </div> 
            <div class="footer">
                <span   tapmode   onclick="enter(0);event.stopPropagation();">重置</span>
                <span   tapmode   onclick="enter(1);event.stopPropagation();">确定</span>
            </div>
        </div>
        
    </div>
    
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    var val, selectedObj={},str,url;
    apiready = function(){
        fnInit();
        
        initSel()
        // 进入筛选页面初始化页面
        initPage();
        listenEvent('school');
    }
    
     // 点击确定按钮： 1； 重置按钮 0
    function enter(n) {
        if (n) {
            var parameter = {};
            var type = $api.attr($api.dom('.no1 .sel'), 'data-id');
            parameter.type = $api.attr($api.dom('.no4 .sel'), 'data-id');
            parameter.sub_type = $api.attr($api.dom('.no5 .sel'), 'data-id');
            parameter.category_ids = $api.attr($api.dom('.school'),'data-category');
            parameter.order = $api.attr($api.dom('.no3 .sel'), 'data-order');
            api.sendEvent({
                name: 'searchSupply3',
                extra: {
                    parameter: parameter,
                    selectedObj: selectedObj,
                    type: type
                }
            });
            api.closeFrame();
        } else {
            // 重置
            $api.text($api.dom('.school'), '');
            $api.attr($api.dom('.school'), 'data-category', '');
            selectedObj = {};
            $api.removeCls($api.dom('.no3 .sel'), 'sel');
            $api.removeCls($api.dom('.no4 .sel'), 'sel');
            $api.removeCls($api.dom('.no5 .sel'), 'sel');
        }
    }
    // 设置选中的条件
    function initSel() {
        console.log('设置选中的条件::'+JSON.stringify(api.pageParam))
        if (api.pageParam.parameter) {
            if (api.pageParam.parameter.type) {
                if (api.pageParam.parameter.type == 1){
                    $api.addCls($api.domAll('.no4 li')[0], 'sel');
                } else {
                    $api.addCls($api.domAll('.no4 li')[1], 'sel');
                }
            }
            if (api.pageParam.parameter.sub_type) {
                if (api.pageParam.parameter.sub_type == 1){
                    $api.addCls($api.domAll('.no5 li')[0], 'sel');
                } else {
                    $api.addCls($api.domAll('.no5 li')[1], 'sel');
                }
            }
            if (api.pageParam.parameter.order) {
               if (api.pageParam.parameter.order == 'distance') {
                    $api.addCls($api.domAll('.no3 li')[0], 'sel');
                } else if (api.pageParam.parameter.order == 'price') {
                    $api.addCls($api.domAll('.no3 li')[1], 'sel');
                }   else if (api.pageParam.parameter.order == 'create_time') {
                    $api.addCls($api.domAll('.no3 li')[2], 'sel');
                } else {
                    // $api.addCls($api.domAll('.no3 li')[0], 'sel');
                }  
            }
            if (api.pageParam.parameter.category_ids) {
                $api.text($api.dom('.school'), api.pageParam.parameter.category_ids);
            }
        }
        if (api.pageParam.type == 1) {
            // 搜索供
            url = '/supply/index';
            for (var i = 0; i < $api.domAll('.no1 li').length; i++) {
                $api.removeCls($api.domAll('.no1 li')[i], 'sel');
            }
            $api.addCls($api.byId('supply'), 'sel');
        } else if (api.pageParam.type == 2) {
            // 搜索求
            url = '/demand/index';
            for (var i = 0; i < $api.domAll('.no1 li').length; i++) {
                $api.removeCls($api.domAll('.no1 li')[i], 'sel');
            }
            $api.addCls($api.byId('ask'), 'sel');
        } else {}

    }
    function selType (ele) {
        for (var i = 0; i < $api.domAll('.no4 li').length; i++) {
            $api.removeCls($api.domAll('.no4 li')[i], 'sel');
        }
        $api.addCls(ele, 'sel');
    }
    function selSubType(ele) {
        for (var i = 0; i < $api.domAll('.no5 li').length; i++) {
            $api.removeCls($api.domAll('.no5 li')[i], 'sel');
        }
        $api.addCls(ele, 'sel');
    }
    function selClassify(ele) {
        for (var i = 0; i < $api.domAll('.no1 li').length; i++) {
            $api.removeCls($api.domAll('.no1 li')[i], 'sel');
        }
        $api.addCls(ele, 'sel');
        if ($api.text(ele) === '供') {
            url = '/supply/index';
        } else {
            url = '/demand/index';
        }
    }
    function selSort(ele) {
        for (var i = 0; i < $api.domAll('.no3 li').length; i++) {
            $api.removeCls($api.domAll('.no3 li')[i], 'sel');
        }
        $api.addCls(ele, 'sel');
    }
    // 进入筛选页面初始化页面
    function initPage() {
        // 进入筛选页面初始化页面
        if (api.pageParam.selectedObj) {
            selectedObj = api.pageParam.selectedObj
            if (selectedObj.school) {
                $api.text($api.dom('.school'), selectedObj.school[0].str);
            }
            // if(selectedObj.commpany) {
            //     $api.text($api.dom('.commpany'), selectedObj.commpany[0].str);
            // } 
            // if(selectedObj.trade) {
            //     $api.text($api.dom('.trade'), selectedObj.trade[0].str);
            // }         
            // if(selectedObj.place) {
            //     $api.text($api.dom('.place'), selectedObj.place[0].str);
            // }         
            // if(selectedObj.custom) {
            //     $api.text($api.dom('.custom'), selectedObj.custom[0].str);
            // }         
        }
    }
    // 监听事件
    function listenEvent(val) {
        api.addEventListener({
            name: 'select'+ val
        }, function(ret, err) {
            if (ret) {
                var id = '';
                for (var i = 0; i < ret.value.selectedArr.length; i++) {
                   id += ret.value.obj[ret.value.selectedArr[i].key][ret.value.selectedArr[i].index].category_id+','
                }
                id = id.substring(0,id.length-1);
                $api.text($api.dom('.'+ val +''), ret.value.schoolName);
                $api.attr($api.dom('.'+ val +''), 'data-category',id);
                selectedObj[val] = ret.value.selectedArr;
                // selectedObj[val][0].str = ret.value.schoolName;
                str = ret.value.schoolName;
                console.log('第一页面:'+JSON.stringify(ret.value))
            } else {
                alert(JSON.stringify(err));
            }
        });
    }
   
    // 选择学校/公司/行业
    function li_spanP(ele) {
        val = $api.attr(ele, 'data-val');
        api.openFrame({
            name: 'supply_slideFrame_3_',
            url: './supply_slideFrame_3_.html',
            rect: {
                x: 0,
                y: 0,
                w: 'auto',
                h: 'auto'
            },
            slidBackEnabled: false,
            pageParam: {
                val: val,
                selectedObj:　selectedObj,
                str: str,
                type: api.pageParam.type,
            },
            bounces: false
        });
    }
</script>
</html>