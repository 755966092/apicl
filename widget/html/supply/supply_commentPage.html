<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style type="text/css">
        .main {
            background-color: #fff;
            padding-top: .52rem;
            padding-bottom: .3rem;
        }
        .title {
            font-size: .3rem;
            text-align: center;
            color: #333;
            margin-bottom: .13rem;
        }
        .item {
            width: .4rem;
            height: .374rem;
            background: url(../../image/icon_supply/icon_xxx1.png);
            -webkit-background-size: .4rem .374rem;
            background-size: .4rem .374rem;
            margin: 0 .06rem;
        }
        .sel {
            background: url(../../image/icon_supply/icon_xxx2.png);
            -webkit-background-size: .4rem .374rem;
            background-size: .4rem .374rem;
        }
        textarea {
            box-sizing: border-box;
            margin-top: .55rem;
            width: 7.5rem;
            border-top: .01rem solid #F5F5F5;
            height: 1rem;
            padding: .18rem .3rem;
            font-size: .3rem;
            line-height: .42rem;
            outline: none;
        }
        .wordCount {
            text-align: right;
            font-size: .2rem;
            color: #999;
            padding: 0 .3rem;
        }
        .imgArr {
            font-size: 0;
            padding: 0 .3rem;
        }
        .imgArr img {
            width: 1.6rem;
            height: 1.6rem;
        }
        .anonymous {
            margin-top: .2rem;
            font-size: 0;
            padding: 0 .3rem;
        }
        .anonymous span {
            font-size: .24rem;
            color: #555;
        }
        .anonymous i {
            margin-right: .2rem;
            width: .33rem;
            height: .33rem;
            border-radius: 50%;
            box-sizing: border-box;
            border: .01rem solid #A2A2A2;
           
        }
        .selColor {
             background-color: #1AAD19;
            padding: .05rem;
            -webkit-background-clip: content-box;
            -moz-background-clip: content-box;
            background-clip: content-box;
        }
        .btn {
            position: fixed;
            bottom: 0;right: 0;font-size: .34rem;
            width: 7.5rem;
            height: .9rem;  
            text-align: center;
            line-height: .9rem;
            color: #fff;
            background-color: #1AAD19;
        }
    </style>
</head>
<body>
      <header  class="header">
        <div class="head">
            <span class="callback"   tapmode   onclick="api.closeWin()">返回</span>
            <span class="winTitle">
                评价
            </span>
            
        </div>
    </header>
    <div class="main"> 
        <p class="title">为Ta打个分</p>
        <div class="xx flex-def flex-zCenter">
            <span tapmode='hover' onclick="selScore(this)" data-score='1' class="item"></span>
            <span tapmode='hover' onclick="selScore(this)" data-score='2' class="item"></span>
            <span tapmode='hover' onclick="selScore(this)" data-score='3' class="item"></span>
            <span tapmode='hover' onclick="selScore(this)" data-score='4' class="item"></span>
            <span tapmode='hover' onclick="selScore(this)" data-score='5' class="item"></span>
        </div>
        <textarea placeholder="感觉怎么样,来说一说吧" maxlength="90" oninput ="changeText(this)"></textarea>
        <p class="wordCount"><span id="wordCount">0</span>/90</p>
        <div class="imgArr resultList"></div> 
            <!-- <img src="../../image/icon_supply/icon_addMedia_1.png"> -->
            <script type="text/x-dot-template" id="listT">
            {{ for (var i = 0; i < it.img.length; i++) { }} 
                <img class="fl imgpage" tapmode onclick="openImgPage(this)" data-id = '{{=i}}' src="{{=it.img[i]}}">
            {{ }; }}
                <img  src="../../image/icon_supply/icon_addMedia_1.png" class="addImg" onclick="openImg()" tapmode>
            </script>
         
    </div>
    <p class="anonymous flex-def flex-cCenter" onclick="selColor()">
        <i class="flag"></i>
        <span>匿名</span>
    </p>
    <div class="btn" ontouchstart="publishComment()">发表评价</div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript">
    var base64Data = {img:[]},imgArr=[];
    apiready = function(){
        fnInit();
        moduleInit();
        getData(base64Data);
        // 删除图片
        delImg();
    }
    // 发表评价
    function publishComment() {
        
        if (imgArr.length != base64Data.img.length) {
            // 图片未上传完
            publishComment();
        } else {
            var url;
            if (api.pageParam.type === 'demand') {
                // 求助订单

                if (api.pageParam.flag===1) {
                    // ta 帮助者
                    url = '/demand_order/helperCommentHelp'
                } else {
                    // 求助者
                    url = '/demand_order/hostCommentHelp'
                }
            } else {
                // 供求订单
                if (api.pageParam.flag===1) {
                    // ta 买家评论
                    url = '/supply_order/buyerCommentService'
                } else {
                    url = '/supply_order/sellerCommentService'
                }
            }
            var param = {}
            param = api.pageParam.obj;
            param.content = $api.val($api.dom('textarea'));
            param.point = $api.domAll('.sel').length;
            param.is_anon = $api.hasCls($api.dom('.flag'), 'selColor') ? 1 : -1;
            param.image_json = imgArr;
            api.ajax({
                url: apiSite + url,
                method: 'post',
                headers: apiHeader,
                data: {
                       values: param
                }
            }, function(ret, err) {
                if(ret) {
                    if (ret.code === 200) {
                        api.sendEvent({
                            name: 'filterOrder'
                        });
                        setTimeout(function(){api.closeWin();},500)
                    } else {
                        alert(ret.msg)
                    }
                } else {
                    alert(JSON.stringify(err))
                }
            })
        }
       
    }
    // 评分星星
    function selScore(ele) {
        var score = $api.attr(ele, 'data-score');
        var item = $api.domAll('.item');
        var selArr = $api.domAll('.sel');
        if (score == 1 && $api.hasCls(ele, 'sel') && selArr.length == 1) {
            for (var i = 0; i < item.length; i++) {
                $api.removeCls(item[i], 'sel');
            }    
        } else {
            for (var i = 0; i < item.length; i++) {
                $api.removeCls(item[i], 'sel');
            }
            for (var i = 0; i < score; i++) {
                $api.addCls(item[i], 'sel');
            }
        }
    }
    // 输入框字数
    function changeText(ele) {
        var iptLength = $api.val(ele).length;
        $api.text($api.byId('wordCount'), iptLength);
        if (iptLength >= 90) {
            $api.css($api.dom('.wordCount'), 'color:#f00');
        } else {
            $api.css($api.dom('.wordCount'), 'color:#999');
        }
    }
    // 选择匿名
    function selColor() {
        var flag = $api.dom('.flag');
        if ($api.hasCls(flag, 'selColor')) {
            $api.removeCls(flag, 'selColor');
        } else {
            $api.addCls(flag, 'selColor');
        }
    }

      // 删除图片
    function delImg() {
        api.addEventListener({
            name: 'delImg'
        }, function(ret, err) {
            if (ret) {
                for (var i = 0; i < $api.domAll('.imgpage').length; i++) {
                    if (i == (ret.value.imgId-1)) {
                        $api.remove($api.domAll('.imgpage')[i]);
                    }
                }
                base64Data = base64Data.img.filter(function(item, index) {
                    if (index != ret.value.imgId-1) {
                        return item
                    }
                })
                imgArr = imgArr.filter(function(item, index) {
                    if (index != ret.value.imgId-1) {
                        return item
                    }
                })
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }
    // 打开相册
    function openImg() {
        api.getPicture({
            sourceType: 'album',
            encodingType: 'png',
            mediaValue: 'pic',
            destinationType: 'url',
            allowEdit: false,
            quality: 70,
            // targetWidth: 100,
            // targetHeight: 100,
            saveToPhotoAlbum: false
        }, function(ret, err) {
            if (ret) {
                if (ret.data) {
                    base64Data.img.push(ret.data);
                    getData(base64Data);
                    pushImg(ret);
                }
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }
    function pushImg(ret) {
       //  var baseUrl = 'img.iinnet.com'; //七牛给你的测试域名，也可使用自己捆绑的域名youe.xxx.com
        var obj = api.require('qiniuUpfile');
        obj.upfile({
            file: ret.data,
        }, function(retUpfile, err) {
            if (retUpfile.status) {
                if (retUpfile.oper == "complete") {
                    //上传成功后组装访问路径，或直接访问文档
                    imgArr.push('http://'+ baseUrl +'/'+ retUpfile.info.key);
                } else if (retUpfile.oper == "progress") {
                    //上传过程中获取进度数据
                    // console.log(retUpfile.percent);
                }
            }
        });
    }
    function openImgPage(ele) {
       var data = $api.attr(ele, 'src'),
            n = parseInt($api.attr(ele, 'data-id'));
        api.openWin({
            name: 'supply_releaseSupply_imgPage_win',
            url: './supply_releaseSupply_imgPage_win.html',
            bounces: false,
            pageParam: {
                data: data,
                count:  base64Data.img.length,
                n: n+1
            }
        });
    }
</script>
</html>
