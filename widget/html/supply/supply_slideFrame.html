<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
        html,body {
            height: 100%;
            width: 100%;
            background-color: rgba(0,0,0,0.4);
        }


        .warp1 {
            height: 100%;
             display: -webkit-box;
            display: flex;
            -webkit-box-direction: normal;
            -webkit-box-orient: vertical;
            flex-direction: column;
            -webkit-box-align:  end;
            align-items: flex-end;
        }
        .warp {
            margin-left: 1.5rem;
            background-color: #fff;
        }
        .main {
            background-color: #fff;
            position: relative;
            height: 100%;
            box-sizing: border-box;
            padding-top: .2rem;
        }
        .main>div:first-child {
            padding: 0 .2rem;
            padding-right: 0;
        }

        .main ul.no1 {
            font-size: .24rem;
            width: 100%;
        }
        .main ul.no1 li {

            font-size: 0;
            /*margin-bottom: .1rem;*/
            border-bottom: .01rem solid #d9d9d9;
            padding-bottom: .385rem;
            margin-top: .235rem;
        }
        .main ul.no1 li:last-child {
            margin-bottom: 0;
        }
        .main ul.no1 li p {
            font-size: .24rem;
            color: #9b9b9b;
        }
        .main ul.no1 li span {
            font-size: .24rem;
            display: inline-block;
            margin-top: .2rem;
            /*margin-bottom: .1rem;*/
            width: 1.78rem;
            height: .79rem;
            background-color: #F4F4F4;
            border-radius: .06rem;
            text-align: center;
            line-height: .79rem;
            color: #555;
        }
        .main ul.no1 li span:nth-child(2),
        .main ul.no1 li span:nth-child(3) {
            margin-right: .12rem;
        }
        .main ul.no1 li span.sel {
            /*background: url(../../image/icon_supply/icon_text4.png);*/
            background-color: #E6FFE6;
            background-size: .96rem .6rem;
            color: #27B24A;
        }

        .main ul.no1 li span.li_span4 {
            background-size: 1.78rem .79rem;
            width: 1.78rem;
        }
          .main ul.no2 {
            font-size: .24rem;
            /*margin-top: .37rem;*/


        }
        .main ul.no2 p {
            line-height: .79rem;
            color: #555;
            /*border-bottom: .01rem solid #cbcbcb;*/
        }
        .main ul.no2 li {
            padding-right: .36rem;
            line-height: .79rem;
            /*border-top: .01rem solid #d9d9d9;*/
            font-size: 0;

        }
        .main ul.no2 li p {
            font-size: .24rem;
            color: #333;
            background: url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: right center;
        }
        .footer {
            height: .9rem;
            width: 6rem;
            font-size: 0;
            z-index: 999;
        }
        .footer span {
            height: .9rem;
            width: 3rem;
            font-size: .34rem;
            text-align: center;
            line-height: .9rem;
            float: left;
            background-color: #F8F8F8;
        }
        .footer span:last-child {
            background-color: #27B24A;
            color: #fff;
        }

        header.header {
            opacity: 0;
        }
        .no2Icon {
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            text-align: right;
            width: 3rem;
            color: #999999;
            float: right;
            font-size: .24rem;
            margin-right: .25rem;
        }
    </style>
</head>
<body   tapmode class=""   onclick="api.closeFrame()">

    <div class="warp1 flex-def flex-zBetween">
         <header  class="header clearfix">
            <div class="head">
                <!-- <span class="callback"   tapmode   onclick="api.closeWin()">返回</span>
                <span class="winTitle">
                    找供求
                </span> -->
            </div>
        </header>
        <div class="warp flex-item flex-def flex-zBetween flex-zTopBottom"   tapmode   onclick="api.closeFrame()">
            <div class="main"   tapmode   onclick="event.cancelBubble=true;">
                <div>
                    <ul class="no1">
                        <li class="no11">
                             <p>类型</p>
                             <span   tapmode   onclick="li_span(this);event.cancelBubble=true;" class="li_span li_span4 " data-type="type_1">个人</span>
                             <span   tapmode   onclick="li_span(this);event.cancelBubble=true;" class="li_span li_span4" data-type="type_2">公司</span>
                        </li>
                        <li class="no22">
                             <p>类别</p>
                             <span   tapmode   onclick="li_span(this);event.cancelBubble=true;" class="li_span li_span4 " data-type="sub_type_1">自产自销</span>
                             <span   tapmode   onclick="li_span(this);event.cancelBubble=true;" class="li_span li_span4" data-type="sub_type_2">代理代销</span>
                        </li>
                        <li class="no33">
                             <p>排序</p>
                             <span   tapmode   onclick="li_span(this);event.cancelBubble=true;" class="li_span li_span4 " data-type="all">全部</span>
                             <span   tapmode data-type="distance"  onclick="li_span(this);event.cancelBubble=true;" class="li_span li_span4">距离最近</span>
                             <span   tapmode  data-type="price" onclick="li_span(this);event.cancelBubble=true;" class="li_span li_span4">价格最低</span>
                             <span   tapmode  data-type="create_time" onclick="li_span(this);event.cancelBubble=true;" class="li_span li_span4">最新发布</span>
                        </li>
                     </ul>
                    <ul class="no2">
                        <li class="no2List sel clearfix"   tapmode   onclick="li_spanP(this);event.cancelBubble=true;" >
                            <p>分类<span class="no2Icon selText">选择分类</span></p>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="footer">
                <span   tapmode   onclick="enter(0);event.stopPropagation();">重置</span>
                <span   tapmode   onclick="enter(1);event.stopPropagation();">确定</span>
            </div>
        </div>
    </div>

</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    var selectedObj=0,parameter,str,flag,categoryData;
    apiready = function(){
        fnInit();
        // 供求不同的筛选
        if (api.pageParam.type == 0) {
            // 供

        } else {
            // 求
            // 不显示no22
            $api.css($api.dom('.no22'), 'display: none');
        }
        api.addEventListener({
            name: 'selClass'
        }, function(ret, err) {
            if (ret) {
                var id = '';
                for (var i = 0; i < ret.value.selectedArr.length; i++) {
                   id += $api.getStorage('classifyDataSlide')[ret.value.selectedArr[i].key][ret.value.selectedArr[i].index].category_id+','
                }
                id = id.substring(0,id.length-1);
                $api.attr($api.dom('.no2Icon'), 'data-category',id);
                $api.text($api.dom('.no2Icon'), ret.value.schoolName);
                selectedObj = ret.value.selectedArr;
                // selectedObj[val][0].str = ret.value.schoolName;
                str = ret.value.schoolName;
                // // // console.log('第一页面:'+JSON.stringify(selectedObj))
            } else {
                alert(JSON.stringify(err));
            }
        });
        ajaxClass();

    }

    function ajaxClass() {
        categoryData = $api.getStorage('categoryIndex');
        if (categoryData) {
            api.ajax({
                url: apiSite + '/category/index',
                method: 'post',
                headers: apiHeader,
                data: {
                    values: {
                        type: api.pageParam.type,
                    }
                }
            }, function(ret, err) {
                if(ret) {

                    $api.setStorage('categoryIndex', ret.data.list);
                    initPage(ret.data.list);
                } else {
                    alert(JSON.stringify(err))
                }
            })
        } else {
            initPage(categoryData);
        }
    }
    // 进入筛选页面初始化页面
    function initPage(categoryData) {
        // 进入筛选页面初始化页面
        selectedObj = api.pageParam.selectedObj;
        if (api.pageParam.selectedObj!=0) {
            $api.text($api.dom('.selText'), api.pageParam.selectedObj[0].str);
            var id = '';
            for (var i = 0; i < api.pageParam.selectedObj.length; i++) {
                for (var j = 0; j < categoryData.length; j++) {
                    if (api.pageParam.selectedObj[i].title == categoryData[j].name) {
                        id += categoryData[j].category_id +',';
                    }
                }
            }
            id = id.substring(0,id.length-1);
            $api.attr($api.dom('.no2Icon'), 'data-category',id);
        }

        parameter = api.pageParam.parameter
        if (api.pageParam.parameter != 0) {
            for (var i = 0; i < $api.domAll('span[data-type]').length; i++) {
                $api.removeCls($api.domAll('span[data-type]')[i], 'sel');
            }
            if (parameter.type == 1) {
                // 1 个人
                $api.addCls($api.dom('span[data-type="type_1"]'), 'sel');
            } else if (parameter.type == 2) {
                // 2 公司
                $api.addCls($api.dom('span[data-type="type_2"]'), 'sel');
            } else {

            }
            if (parameter.sub_type == 1) {
                // 1 自产自销
                $api.addCls($api.dom('span[data-type="sub_type_1"]'), 'sel');
            } else if (parameter.sub_type == 2) {
                // 2 代理
                $api.addCls($api.dom('span[data-type="sub_type_2"]'), 'sel');
            } else {

            }
            if (parameter.order == 'distance') {
                // 距离
                $api.addCls($api.dom('span[data-type="distance"]'), 'sel');
            } else if (parameter.order == 'price') {
                // 价格
                $api.addCls($api.dom('span[data-type="price"]'), 'sel');
            } else if (parameter.order == 'create_time') {
                // 时间
                $api.addCls($api.dom('span[data-type="create_time"]'), 'sel');
            } else if (parameter.order == 'supply_publish_2.html'){
                // 排序
                $api.addCls($api.dom('span[data-type="all"]'), 'sel');
            } else {

            }
        }

    }
      // 选中图标
    function li_span(ele) {
        flag = 1;
        var allDom = $api.not($api.closest(ele, 'li'),'p')
        for (var i = 0; i < allDom.length; i++) {
            $api.removeCls(allDom[i], 'sel');
        }
        $api.addCls(ele, 'sel');
    }

    function li_spanP(ele) {
        api.openFrame({
            name: 'supply_slideFrame_',
            url: './supply_slideFrame_.html',
            rect: {
                x: 0,
                y: 0,
                w: 'auto',
                h: 'auto'
            },
            pageParam: {
                selectedObj: selectedObj,
                str: str
            },
            bounces: false
        });
    }
    // 点击确定按钮： 1； 重置按钮 0
    function enter(n) {
        if (n) {
            var sel = $api.domAll('.no1 .sel');
            var spanSel = $api.domAll('.spanSel');
            var parameter = {
                type: '',
                order: '',
                sub_type: '',
                category_ids: ''
            }
            // sel[0] = 类型个人 | 公司
            // sel[1] = 类别自产自销 | 代理
            // sel[2] = 排序智能排序 | 距离 | 价格 | 最新发布
            if ($api.dom('.no11 .sel')) {
                parameter.type = ($api.text($api.dom('.no11 .sel')) == '个人') ? 1 : 2;
            }
            if ($api.dom('.no22 .sel')) {
                parameter.sub_type = ($api.text($api.dom('.no22 .sel')) == '自产自销') ? 1 : 2;
            }

            parameter.category_ids = $api.attr($api.dom('.no2Icon'),'data-category');
            var order = $api.text($api.dom('.no33 .sel'))
            switch (order) {
                case '智能排序': parameter.order = '';
                break;
                case '距离最近': parameter.order = 'distance';
                break;
                case '价格最低': parameter.order = 'price';
                break;
                case '最新发布': parameter.order = 'create_time';
                break;

            }
            // // // console.log('发送事件:::'+JSON.stringify(parameter))
            // 发送事件, 刷新筛选结果
            // 0 供赛选
            // 1 求赛选
            if (api.pageParam.type == 0) {
                // // // console.log('发送0')
                api.sendEvent({
                    name: 'screeningResults',
                    extra: {
                        condition: parameter,
                        flag: flag
                    }
                });
            } else {
                // // // console.log('发送1')
                api.sendEvent({
                    name: 'screeningResults1',
                    extra: {
                        condition: parameter,
                        flag: flag
                    }
                });
            }
             api.closeFrame();

        }
        else {
            $api.text($api.dom('.selText'), '请选择分类');
            $api.attr($api.dom('.selText'), 'data-category', '');
            // parameter.category_ids = '';

            api.sendEvent({
                name: 'selClass',
                extra: {
                    selectedArr: 0
                }
            });
            selectedObj = 0
            var no1 = document.getElementsByClassName('no1')[0]
            var liArr = no1.getElementsByTagName('li');
            for (var i = 0; i < liArr.length; i++) {
                for(var j = 0; j < liArr[i].childNodes.length ; j++) {
                    $api.removeCls(liArr[i].childNodes[j], 'sel');
                }
                // $api.addCls(liArr[i].childNodes[3], 'sel');
            }
            for (var i = 0; i < $api.domAll('.no2List').length; i++) {
                $api.removeCls($api.domAll('.no2List')[i], 'sel');
                for(var j = 0; j < $api.domAll('.no2List')[i].childNodes.length ; j++) {

                    $api.removeCls($api.domAll('.no2List')[i].childNodes[j], 'hide');
                    $api.removeCls($api.domAll('.no2List')[i].childNodes[j], 'spanSel');
                }
                // $api.addCls($api.domAll('.no2List')[i].childNodes[3], 'spanSel');
            }
            // $api.addCls($api.domAll('.no2List')[0], 'sel');
            // var no2Icon = $api.domAll('.no2Icon')
            // for (var i = 0; i < no2Icon.length; i++) {
            //     $api.removeCls(no2Icon[i], 'no2Icon2');
            // }
            // $api.addCls(no2Icon[0], 'no2Icon2');


        }
    }
</script>
</html>