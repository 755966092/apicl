<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style type="text/css">
        input {
            display: block;
            margin: .3rem auto;
            height: .8rem;
            width: 7rem;
            text-align: center;
            border: .01rem solid #d9d9d9;
        }
        li {
            color: #000;
            font-size: 0;
            padding-left: .3rem;
            padding-top: .1rem;
            padding-bottom: .1rem;
            border-bottom: .01rem solid #d9d9d9;
        }
        p {
            font-size: .3rem;
        }
        .pAddress {
            color: #999;
            font-size: .24rem;
        }
    </style>
</head>
<body>
   <input type="text" placeholder="请输入关键字搜索" onkeyup="sea2(this)">
   <ul class="resultList" >
    
   </ul>
    <script type="text/x-dot-template" id="listT">
        {{ for (var i = 0; i < it.length; i++) { }} 
            <li data-lon = "{{=it[i].lon}}" data-lat = "{{=it[i].lat}}" tapmode onclick = "function_name(this)"  >
                <p class="pName">{{=it[i].name}}</p>
                <p class="pAddress">{{=it[i].address}}</p>
            </li>
        {{ }; }}
    </script>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript">
    var city,district,province;
    apiready = function(){
        moduleInit();
        getPos();
        // sea();
    };

    // 获取位置
    function getPos() {
        if (api.systemType == 'ios') {
            bMap.initMapSDK(function(ret) {
                if (ret.status) {
                   getLocation();
                } else {
                    alert(JSON.stringify(err.msg))
                }
            });
        } else {
            getLocation();
        }
        
    }
    // 获取经纬度
    function getLocation() {
        bMap.getLocation({
            accuracy: '1km',
            autoStop: true,
        }, function(ret, err) {
            if (ret.status) {
                getCoords(ret.lon, ret.lat)
            } else {
                api.toast({
                    msg: '请在系统的设置-隐私-定位服务界面允许我在确定您的位置'
                });
            }
        });
    }
    // 根据经纬度获取地址
    function getCoords(lon,lat) {
        bMap.getNameFromCoords({
            lon: lon,
            lat: lat
        }, function(ret, err) {
            if (ret.status) {
                // province = ret.city;
                // city = ret.district;
                // address = ret.address;
                // console.log(JSON.stringify(ret))
                // ret.district // 县区
                // ret.province // 省份
                // ret.city // 城市
                // ret.address // 地址
                // getData(ret.poiList)
                console.log(JSON.stringify(ret))
                city = ret.city; // 城市
                district = ret.district // 县区
                province = ret.province // 省份
            }
        });
    }
    function sea2(ele) {
        console.log(JSON.stringify(event.keyCode))
        // if (event.keyCode === 13) {
            bMap.searchInCity({
                city: city,
                keyword: $api.val($api.dom('input')),
                pageIndex: 0,
                pageCapacity: 20
            }, function(ret, err) {
                if (ret.status) {
                    console.log(JSON.stringify(ret));
                    getData(ret.results)
                } else {
                    if(err.code == 1) {
                        alert('检索词有岐义')
                    } else if (err.code == 2) {
                        alert('检索地址有岐义')
                    }else if (err.code == 3) {
                        alert('没有找到检索结果')
                    }else if (err.code == 4) {
                        alert('key错误')
                    }else if (err.code == 5) {
                        alert('网络连接错误')
                    }else if (err.code == 6) {
                        alert('网络连接超时')
                    }else if (err.code == 7) {
                        alert('还未完成鉴权，请在鉴权通过后重试')
                    }
                }
            });
        // }
    }
    function function_name(ele) {
        var lon = $api.attr(ele, 'data-lon');        
        var lat = $api.attr(ele, 'data-lat');     
        var address = $api.text($api.dom(ele, '.pAddress'));  
        var name = $api.text($api.dom(ele, '.pName'));  
        // alert(address+name)
        api.sendEvent({
            name: 'selAddress',
            extra: {
                lon: lon,
                lat: lat,
                address: address,
                name: name,
                city: city,
                district: district,
                province: province,
            }
        });
        api.closeWin();
    }
</script>
</html>