<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
        html,body {
            width: 100%;
            height: 100%;
        }
        .contentText {
            background-color: #fff;
            font-size: .3rem;
            padding: 0 .3rem
        }
        .title {
            height: .9rem;
            border-bottom: .01rem solid #CBCBCB;
            line-height: .9rem;
        }
        .smallTitle {
            color: #0ABB07;
        }
        .title input {

            height: .9rem;
            outline: none;
            width: 5.3rem;
        }
        textarea {
            width: 100%;
            padding: .2rem 0;
            outline: none;
            resize: none;

        }

        .addMedia {
            font-size: 0;
            display: inline-block;
            width: 1.6rem;
            height: 1.6rem;
            background: #F8F8F8;
            text-align: center;
            color: #999;
            margin-right: .1rem;
        }
        .addMedia span {
            font-size: .3rem;
        }
        .addMedia span.icon{
            display: inline-block;
            height: .9rem;
            width: 100%;
            background: url(../../image/icon_supply/icon_addMedia_01.png)no-repeat;
            -webkit-background-size: .62rem .62rem;
            background-size: .62rem .62rem;
            background-position: bottom center;
            font-size: .3rem;
            margin-bottom: .1rem;
        }
        .addMedia:last-child span.icon {
            background: url(../../image/icon_supply/icon_addMedia_02.png)no-repeat;
            background-size: .6rem .45rem;
            background-position: bottom center;
        }
        .position {
            background: url(../../image/icon_supply/icon_pos.png)no-repeat;
            -webkit-background-size: .26rem .35rem;
            background-size: .26rem .35rem;
            background-position: 0 center;
            height: 1rem;
            line-height: 1rem;
            padding-left: .35rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }



        .classify {
            background-color: #EDECF3;
            font-size: 0;

        }
        .classify ul li {
            /*background-color: #fff;*/
            font-size: .3rem;
            height: .8rem;
            line-height: .8rem;
            /*border-bottom: .01rem solid #000;*/
            width: 100%;
            /*padding: 0 .3rem 0 .8rem;*/
            padding-left: .36rem;
            background: #fff url(../../image/icon_my/icon_fb.png)no-repeat;
            -webkit-background-size: .44rem .44rem;
            background-size: .44rem .44rem;
            background-position: .3rem center;
            box-sizing: border-box;
        }
        .classify ul li.border100 {
            border-bottom: .01rem solid #d9d9d9;
        }
        .classify ul li.border100 .wrap {
            border-bottom: 0;
        }
        .wrap {
            height: .78rem;
            padding-left: .44rem;
            border-right: .36rem;
            border-bottom: .01rem solid #d9d9d9;
             /*box-sizing: border-box;*/
        }
        .spanno2 {
            margin-right: .2rem;

            display: inline-block;
            height: .8rem;
            background: url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: right center;
            float: right;
            color: #BEBEBE;
            padding-right: .3rem;
        }
        li input {
            float: right;
            line-height: .8rem;
            text-align: right;
            padding-right: .5rem;
            font-size: .3rem;
            outline: none;
        }
        .mt37 {
            margin-top: .37rem;
        }
        .mb20 {
            margin-bottom: .2rem;
        }


        .btn {
            width: 6.32rem;
            height: .83rem;
            margin: 0 auto;
            border-radius: .1rem;
            background-color: #08BB08;
            font-size: .34rem;
            color: #fff;
            text-align: center;
            line-height: .83rem;
            margin-top: .37rem;
            margin-bottom: .3rem;
            display: none;
        }


        ul li:nth-child(1) {
                background: #fff url(../../image/icon_supply/icon_00.png)no-repeat;
                background-size: .28rem .34rem;
                background-position: .3rem center;
            }
            ul li:nth-child(2) {
                background: #fff url(../../image/icon_supply/icon_01.png)no-repeat;
                background-size: .34rem .34rem;
                background-position: .3rem center;
            }
            ul li:nth-child(3) {
                background: #fff url(../../image/icon_supply/icon_11.png)no-repeat;
                background-size: .31rem .31rem;
                background-position: .3rem center;
                display: none;
            }
            ul li:nth-child(4) {
                background: #fff url(../../image/icon_supply/icon_02.png)no-repeat;
                background-size: .32rem .34rem;
                background-position: .3rem center;
            }
             ul li:nth-child(5) {
                background: #fff url(../../image/icon_supply/icon_04.png)no-repeat;
                background-size: .32rem .34rem;
                background-position: .3rem center;
            }
            ul li:nth-child(6) {
                background: #fff url(../../image/icon_supply/icon_03.png)no-repeat;
                background-size: .34rem .29rem;
                background-position: .3rem center;

            }
            ul li:nth-child(7) {
                background: #fff url(../../image/icon_supply/icon_05.png)no-repeat;
                background-size: .3rem .34rem;
                background-position: .3rem center;
            }
            ul li:nth-child(8) {
                background: #fff url(../../image/icon_supply/icon_08.png)no-repeat;
                background-size: .34rem .34rem;
                background-position: .3rem center;
                /*display: none;*/
            }
            ul li:nth-child(9) {
                background: #fff url(../../image/icon_supply/icon_09.png)no-repeat;
                background-size: .34rem .34rem;
                background-position: .3rem center;
                /*display: none;*/
            }
            ul li:nth-child(10) {
                background: #fff url(../../image/icon_supply/icon_06.png)no-repeat;
                background-size: .33rem .34rem;
                background-position: .3rem center;
            }
            ul li:nth-child(11) {
                background: #fff url(../../image/icon_supply/icon_07.png)no-repeat;
                background-size: .33rem .34rem;
                background-position: .3rem center;
        }
        .supplyImg {
            float: left;
            font-size: 0;
        }
        .clearfix img{
            margin-right: .1rem;
            width: 1.6rem;
            height: 1.6rem;
            margin-bottom: .1rem;
        }
        .clearfix span.imgpage {
            margin-right: .1rem;
            width: 1.6rem;
            height: 1.6rem;
            margin-bottom: .1rem;
            -webkit-background-size: 1.6rem 1.6rem;
            background-size: 1.6rem 1.6rem;
            background-position: center center;
        }
        .mult {
            -webkit-box-lines: multiple;
            box-lines: multiple;
            flex-wrap:wrap;
            width: 100%;
            font-size: 0;
            -webkit-box-flex: 1.0;
            -moz-flex-shrink: 1;
            -webkit-flex-shrink: 1;
            flex-shrink: 1;
        }
        .asd {
            width: 1.6rem;
            height: 1.6rem;
            font-size: 0;

            background-color: #f00;
        }
        .companyName {
            display: none;
        }
        .loading {
            display: none;
            z-index: 10000;
            width: 100%;
            height: 100%;
            background:  rgba(0, 0, 0, .5) url(../../image/loading_more.gif)no-repeat;
            background-size: .8rem .8rem;
            background-position: center;
        }
    </style>
</head>
<body>
    <div class="loading"></div>
    <div class="contentText clearfix">
        <div class="title">
            <!-- <span class="smallTitle">#我需要#</span> -->
            <input type="text" placeholder="输入您求助的标题" id="title" maxlength="15">
        </div>
        <textarea placeholder="描述一下您求助的内容" rows="5" id="description"></textarea>
        <div class="mult clearfix flex-def resultList">
            <!-- <img class="fl imgpage" tapmode  src="../../image/icon_defaultHead.png"> -->
            <!-- <span class="fl imgpage" style="background: url(../../image/icon_defaultHead.png)no-repeat;background-size: 1.6rem 1.6rem;background-position: center center"></span>
            <img  src="../../image/icon_supply/icon_addMedia_1.png" class="addImg" onclick="openImg()" tapmode>
            <img  src="../../image/icon_supply/icon_addMedia_2.png"> -->


            <!-- <div class="addMedia" onclick="openImg()" tapmode>
                <span class="icon"></span>
                <span>添加图片</span>
            </div>
            <div class="addMedia">
                <span class="icon"></span>
                <span>添加视频</span>

                <img class="fl imgpage" tapmode onclick="openImgPage(this)" data-id = '{{=i}}'
                src="{{=it.img[i]}}">

            </div> -->
        </div>

        <script type="text/x-dot-template" id="listT">
            {{ for (var i = 0; i < it.img.length; i++) { }}
                <span class="fl imgpage" onclick="openImgPage(this)" data-id = '{{=i}}'  data-src="{{=it.img[i]}}" style="background: url({{=it.img[i]}})no-repeat;background-size: 1.6rem auto;background-position: center center"></span>
            {{ }; }}
            {{?it.img.length==0&&it.video.length==0}}
                <img  src="../../image/icon_supply/icon_addMedia_1.png" class="addImg" onclick="openImg()" tapmode>
                <!-- <img  src="../../image/icon_supply/icon_addMedia_2.png"> -->
            {{??it.video.length==0}}
                <img  src="../../image/icon_supply/icon_addMedia_1.png" class="addImg" onclick="openImg()" tapmode>
            {{??it.img.length==0}}
                <!-- <img  src="../../image/icon_supply/icon_addMedia_2.png"> -->
            {{?}}
        </script>


        <p class="position" id="position"  tapmode   onclick="openPosition()">选择地址</p>
    </div>
    <div class="classify clearfix">
        <ul>
             <li class="mt37">
                <div class="wrap">
                    <span>截至时间</span>
                    <span ontouchstart="openTime(this)" class="spanno2" id="endTime">必填</span>
                </div>
            </li>

            <li   tapmode   onclick="selectType(this)" data-val="_type">
                <div class="wrap">
                    <span>类型</span>
                    <span id="_type" class="spanno2 _type"></span>
                </div>
            </li>
            <li class="companyName" tapmode onclick="openCompany()">
                <div class="wrap">
                    <span>公司</span>
                    <span id="company_name" class="spanno2"></span>
                </div>
            </li>
            <!--<li   tapmode   onclick="selectType(this)" data-val="_genre">
                <div class="wrap">
                    <span>类别</span>
                    <span class="spanno2 _genre" id="sub_type"></span>
                </div>
            </li>-->
            <!-- <li class="border100" tapmode   onclick="selectType(this)" data-val="_classify"> -->
            <li class="border100" tapmode   onclick="openClassify()" data-val="_classify">
                <div class="wrap">
                    <span>分类</span>
                    <span class="spanno2 _classify" id="category_id"></span>
                </div>
            </li>


            <li class="mt37"  tapmode >
                <div class="wrap">
                    <span>赏金</span>
                    <input type="text" name="" placeholder="必填" class="initPriceIpt" id="reward">
                </div>
            </li>
            <li class='border100'  tapmode   onclick="selectType(this)" data-val="_format">
                <div class="wrap">
                    <span>形式</span>
                    <span class="spanno2 _format" id="form">必填</span>
                </div>
            </li>




<!--
            <li class="mt37"   tapmode   onclick="remindWho()">
                <div class="wrap">
                    <span>提醒谁看</span>
                    <span class="spanno2"></span>
                </div>
            </li>
            <li class="mb20 border100">
                <div class="wrap">
                    <span>定向投递</span>
                    <span class="spanno2"></span>
                </div>
            </li> -->
        </ul>
    </div>
    <div class="btn" tapmode onclick="addSupply()"></div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript" src="../../script/cleave.js"></script>
<script type="text/javascript">
    var type = 1, province,            //string  省份
                  city,            //string  城市
                  address,         //string  地址
                    district,
                  latitude,            //string  纬度
                  longitude,           //string  经度;
                  supply_id,
                  base64Data={
                    img: [],
                    video: []
                  },
                  categoryArr = [],
                  imgArr = [],
                  classify_dataSource,
                  classify_dataSource2=[];
    apiready = function(){
        initPriceIpt();
        moduleInit();
        classify();
        //console.log('369:::'+JSON.stringify(api.pageParam))
        if (api.pageParam.demand_id) {
            // $api.css($api.dom('.loading'), 'display: block;');
            $api.text($api.dom('.btn'), '确定');
            $api.css($api.dom('.btn'), 'display: block');
            requireData();
        } else {
            // 获取位置
            getPos();
        }
        // 我公司卖|我卖 显示不同的页面
        // showDifPage()
        // 选择类别478402
        // monitorEvent('_genre','_genre');
        // monitorEvent('_format','_format');
        // monitorEvent('_classify','_classify');

        getData(base64Data);
        // 删除图片
        delImg();
    // 监听选择修改地址
        monitorSelAddress()
    };
    function initPriceIpt() {
        var cleaveNumeral = new Cleave('.initPriceIpt', {
            numeral: true,
            numeralIntegerScale: 6,
            numeralPositiveOnly: true,
            delimiter: ''
        });
    }
    // 打开分类页面
    function openClassify() {
        api.openWin({
            name: 'supply_releaseClassifyˆ',
            url: './supply_releaseClassify.html',
            bounces: false
        });
    }
    // 监听选择修改地址
    function monitorSelAddress() {
        api.addEventListener({
            name: 'selAddress'
        }, function(ret, err) {
            if (ret) {
                 if (ret.value.address != ' ') {
                    $api.text($api.byId('position'), ret.value.name + '-' + ret.value.address);
                } else {
                    $api.text($api.byId('position'), ret.value.name);
                }
                //console.log(JSON.stringify(ret))
                province = ret.value.province;
                city = ret.value.city;
                address = ret.value.address;
                district = ret.value.district;
                latitude = ret.value.lat;
                longitude = ret.value.lon;
            } else {
                alert(JSON.stringify(err));
            }
        });
         // 监听选择公司
        api.addEventListener({
            name: 'selCompany'
        }, function(ret, err) {
            if (ret) {
                //console.log(JSON.stringify(ret))
                $api.text($api.byId('company_name'), ret.value.company_name);
                $api.attr($api.byId('company_name'), 'data-id', ret.value.company_id);
            } else {
                alert(JSON.stringify(err));
            }
        });
        // 监听选择分类
        api.addEventListener({
            name: 'selectClassify'
        }, function(ret, err){
            // console.log(JSON.stringify(ret)+'监听到时间')
            $api.text($api.byId('category_id'), ret.value.key.title);
            $api.attr($api.byId('category_id'), 'data-id',ret.value.key.category_id);
        });
    }
    // 打开公司页面
    function openCompany() {
        api.openWin({
            name: 'supply_releaseCompany',
            url: './supply_releaseCompany.html'
        });
    }
    // 编辑供应
    function editSupply(data) {
        classify();
        var titleIpt = $api.byId('title'),
            descriptionIpt = $api.byId('description'),
            reward = $api.byId('reward'),
            _type = $api.byId('_type'),
            form = $api.byId('form'),
            endTime = $api.byId('endTime'),
            category_id = $api.byId('category_id'),
            position = $api.byId('position');
        $api.val(titleIpt, data.info.title);
        $api.val(descriptionIpt, data.info.description);
        $api.val(reward, data.info.reward);

        var unitText = data.info.unit > 0 ? _dataSource[data.info.unit-1] : '其他';
        var classifyData = $api.getStorage('categoryIndex');
        if (classifyData) {
            for (var i = 0; i < classifyData.length; i++) {
                var element = classifyData[i];
                if(element.category_id == data.info.category_id) {
                    $api.text(category_id, element.name);
                    break;
                }
            }
        } else {
            api.ajax({
                url: apiSite + '/category/index',
                method: 'post',
                headers: apiHeader,
                data: {
                    values: {
                        type: 2
                    }
                }
            }, function(ret, err) {
                if(ret) {
                    if(ret.code === 200) {
                        $api.setStorage('categoryIndex', ret.data.list);
                        for (var i = 0; i < ret.data.list.length; i++) {
                            var element = ret.data.list[i];
                            if(element.category_id == data.info.category_id) {
                                $api.text(category_id, element.name);
                                break;
                            }
                        }
                    } else {
                        alert(ret.msg)
                    }
                } else {
                    alert(JSON.stringify(err))
                }
            })
        }

        var _categoryId =  categoryArr[data.info.category_id-1]
        $api.text(position, data.info.address);
        $api.text(endTime, data.info.end_date);
        // $api.text(unit, unitText);

        data.info.type == 1 ? $api.text(_type, '个人') : $api.text(_type, '公司');
        if (data.info.type == 2) {
            type = 2;
            $api.css($api.dom('.companyName'), 'display:block');
            $api.text($api.byId('company_name'), data.info.company_name);
            $api.attr($api.byId('company_name'), 'data-id', data.info.company_id);

        }
        data.info.form == 1 ? $api.text(form, '线上') : (data.info.form == 2 ? $api.text(form, '线下') : $api.text(form, '线上 + 线下'))
        base64Data.img = eval(data.info.image_json);
        getData(base64Data)
        // 编辑供应返回的相关信息
        address = data.info.address;
        latitude = data.info.latitude;
        longitude = data.info.longitude;
        province = data.info.province;
        district = data.info.district;
        city = data.info.city;
        supply_id = data.info.supply_id;

    }
    // 时间选择器
    function openTime(ele) {
        for (var i = 0; i < $api.domAll('input').length; i++) {$api.domAll('input')[i].blur()}
        var data = $api.attr(ele, 'data-val');
        var date, date1, date2;
        var current = $api.text(ele);
        if (current!='请选择') {
            current = current.split('-')
            date = current[0];
            date1 = current[1];
            date2 = current[2];
        } else　{
            date = new Date().getFullYear();
            date1 = new Date().getMonth();
            date2 = new Date().getDate();
        }
        api.openPicker({
            type: 'date',
            date: date+'-'+date1+'-'+date2,
            title: '选择截至时间'
        }, function(ret, err) {
            if (ret) {
                var time = new Date();
                if (
                    ret.year < time.getFullYear() ||
                    (ret.year === time.getFullYear() && ret.month < time.getMonth()+1) ||
                    (ret.year === time.getFullYear() && ret.month === time.getMonth()+1 && ret.day < time.getDate())) {
                    alert('截至时间不能早于当前时间')
                } else {
                    $api.text(ele, ret.year+'-'+ret.month+'-'+ret.day);
                }


            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }
    // 选择地址页面
    function openPosition() {
        // api.openWin({
        //     name: 'supply_releasePosition_win',
        //     url: './supply_releasePosition_win.html'
        // });
        api.openWin({
            name: 'map_win',
            url: './map_win.html',
            bounces: false,
        });
    }
    // 删除图片
    function delImg() {
        api.addEventListener({
            name: 'delImg'
        }, function(ret, err) {
            if (ret) {
                for (var i = 0; i < $api.domAll('.imgpage').length; i++) {
                    if (i == (ret.value.imgId-1)) {
                        $api.remove($api.domAll('.imgpage')[i]);
                    }
                }
                base64Data = base64Data.img.filter(function(item, index) {
                    if (index != ret.value.imgId-1) {
                        return item
                    }
                })
                imgArr = imgArr.filter(function (item, index) {
                    if (index != ret.value.imgId-1) {
                        return item
                    }
                })
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }
    // 打开相册
    var openImgFlag = 0;
    function openImg() {
        openImgFlag = 1;
        api.getPicture({
            sourceType: 'album',
            encodingType: 'png',
            mediaValue: 'pic',
            destinationType: 'url',
            allowEdit: false,
            quality: 70,
            // targetWidth: 100,
            // targetHeight: 100,
            saveToPhotoAlbum: false
        }, function(ret, err) {
            if (ret) {
                if (ret.data) {
                    base64Data.img.push(ret.data);
                    getData(base64Data);
                    $api.css($api.dom('.loading'), 'display: block');
                    var obj = api.require('qiniuUpfile');
                    obj.upfile({
                        file: ret.data,
                    }, function(retUpfile, err) {
                        if (retUpfile.status) {
                            if (retUpfile.oper == "complete") {
                                imgArr.push('http://'+ baseUrl +'/'+ retUpfile.info.key);
                                $api.css($api.dom('.loading'), 'display: none');
                            } else if (retUpfile.oper == "progress") {
                            }
                        }
                    });
                }
            } else {
                // alert(JSON.stringify(err.msg));
            }
        });
    }
    function openImgPage(ele) {
       var data = $api.attr(ele, 'data-src'),
            n = parseInt($api.attr(ele, 'data-id'));
        api.openWin({
            name: 'supply_releaseSupply_imgPage_win',
            url: './supply_releaseSupply_imgPage_win.html',
            bounces: false,
            pageParam: {
                data: data,
                count:  base64Data.img.length,
                n: n+1
            }
        });
    }
    var releaseFlag = 0;
    function duibi(a,b) {
        if (a == b) {
            // console.log(b)
            releaseFlag = 1;
        }
    }
    function selImg() {
       //  var baseUrl = 'img.iinnet.com'; //七牛给你的测试域名，也可使用自己捆绑的域名youe.xxx.com
        var obj = api.require('qiniuUpfile');
        for (var i = 0; i < $api.domAll('.imgpage').length; i++) {
            var fileurl = $api.attr($api.domAll('.imgpage')[i], 'data-url')
            if (fileurl[0] != 'h' && fileurl[1] != 't') {
                obj.upfile({
                    file: fileurl,
                }, function(ret, err) {
                    if (ret.status) {
                        if (ret.oper == "complete") {
                            //上传成功后组装访问路径，或直接访问文档
                            imgArr.push('http://'+baseUrl +'/'+ ret.info.key);
                            duibi($api.domAll('.imgpage').length,imgArr)
                        } else if (ret.oper == "progress") {
                            //上传过程中获取进度数据
                            // console.log(ret.percent);
                        }
                    }
                });
            } else {
                imgArr.push(fileurl)
                duibi($api.domAll('.imgpage').length,imgArr)
            }
        };
    }


    // 添加供应
    function addSupply() {
        $api.css($api.dom('.loading'), 'display:block');
        // if (openImgFlag == 0) {
        //     releaseFlag = 1;
        // }
        // 获取页面内容
        // if (releaseFlag == 1) {
            var token = $api.getStorage('userToken'),            //string  用户Token
                title = $api.val($api.byId('title')),           //string  标题
                category_id = $api.attr($api.byId('category_id'), 'data-id'),        //int 分类ID
                reward = $api.val($api.byId('reward')),           //float   价格
                // unit = _dataSource.indexOf($api.text($api.byId('unit')))+1,            //string  单位
                form = $api.text($api.byId('form')) == '线上' ? 1 : ($api.text($api.byId('form')) == '线下' ? 2 : 3),           //int 形式（1-线上，2-线下）
                description = $api.val($api.byId('description'));        //string  详细内容
                image_json = imgArr,          //string  图片（格式：["abc.jpg","ddd.jpg"]）
                company_id =  $api.attr($api.byId('company_name'), 'data-id') || '';      // 我公司卖ID（类型为2-我我公司卖卖时必传）
                end_date = $api.text($api.byId('endTime'));
                // alert('标题 : '+ title +'---截至时间ID : '+end_date+'---分类ID : '+category_id+'---价格 : '+reward+'----形式'+form+'---内容: '+description +"---省份"+ province + "---地区" +city+ "---地址" +address+ "---纬度" +latitude+'---纬度: '+longitude)
                // var category = $api.text($api.byId('category_id'));
                // for (var i = 0; i < categoryArr.length; i++) {
                //     if (categoryArr[i] === category) {
                //             category_id = i+1;
                //         break;
                //     }
                // }

                var url,obj;
                if (api.pageParam.demand_id) {
                    // 编辑供应
                    url = '/demand/edit';
                    obj = {
                        token: token,
                        title: title,
                        demand_id: api.pageParam.demand_id,
                        type: type,
                        category_id: category_id,
                        province: province,
                        city: city,
                        address: address,
                        district: district,
                        latitude: latitude,
                        longitude: longitude,
                        reward: reward,
                        form: form,
                        description: description,
                        image_json: imgArr,
                        end_date:end_date,
                        company_id:company_id
                    }
                } else {
                    // 发布新供应
                    url = '/demand/add';
                    obj = {
                        token: token,
                        title: title,
                        type: type,
                        category_id: category_id,
                        province: province,
                        city: city,
                        address: address,
                        district: district,
                        latitude: latitude,
                        longitude: longitude,
                        reward: reward,
                        form: form,
                        description: description,
                        image_json: imgArr,
                        end_date:end_date,
                        company_id:company_id
                    }
                }
                    api.ajax({
                        url: apiSite + url,
                        method: 'post',
                        headers: apiHeader,
                        data: {
                           values: obj
                        }
                    }, function(ret, err) {
                        $api.css($api.dom('.loading'), 'display:none');
                        if(ret) {
                            if (ret.code == 200) {
                                if (api.pageParam.demand_id) {
                                    
                                    // 编辑应用返回我发布的页面
                                    api.sendEvent({
                                        name: 'editSupplyAfter',
                                         extra: {
                                            flag: api.pageParam.flag,
                                            compaby_name: api.pageParam.compaby_name,
                                            demand_id: api.pageParam.demand_id
                                        }
                                    });
                                } else {
                                    // 发布新供应返回供应列表
                                    api.sendEvent({
                                        name: 'editSupplyAfter'
                                    });
                                }
                                api.closeWin();
                            } else {
                                alert(ret.msg)
                            }
                        } else {
                            alert(JSON.stringify(err))
                        }
                    })
        // } else {
        //     addSupply()
        // }


    }


    // 我公司卖|我卖 显示不同的页面
    // function showDifPage () {
    //     api.addEventListener({
    //        name: 'selectType'
    //     }, function(ret, err) {
    //        if (ret) {
    //         $api.text($api.dom('._type'), ret.value.selDate);
    //         if (ret.value.selDate == '我公司卖') {
    //             type = 2;
    //             for (var i = 0; i < $api.domAll('.companyName').length; i++) {

    //                 $api.css($api.domAll('.companyName')[i], 'display: block');
    //             }
    //         } else {
    //             type = 1;
    //             for (var i = 0; i < $api.domAll('.companyName').length; i++) {

    //                 $api.css($api.domAll('.companyName')[i], 'display: none');
    //             }
    //         }
    //        } else {
    //            alert(JSON.stringify(err.msg));
    //        }
    //     });
    // }
    // 提现谁看
    function remindWho() {
        api.openWin({
            name: 'supply_info_ask_remindWho',
            url: './supply_info_ask_remindWho.html'

        });
    }
    // 监听事件， 修改页面文本内容
    // function monitorEvent(eventName, calssName) {
    //     api.addEventListener({
    //        name: eventName
    //     }, function(ret, err) {
    //        if (ret) {
    //         $api.text($api.dom('.'+ calssName +''), ret.value.selDate);
    //        } else {
    //            alert(JSON.stringify(err.msg));
    //        }
    //     });
    // }
    // 选择类型  我公司卖 | 我卖
    function selectType(ele) {
        var person =  $api.text(ele.getElementsByClassName('spanno2')[0]);
        var _data = $api.attr(ele, 'data-val');
        var flag;
        var _dataSource2 = [],_dataSource=[];
        if (_data == '_type') {
            _dataSource = [
                {
                    name:'个人'
                },
                {
                    name:'公司'
                }
            ]
            _dataSource2 = ['个人','公司'];
            flag = 0;
            // var text = $api.text($api.dom('.type1'));
        }  else if (_data == '_format') {
            _dataSource = [
                {
                    name: '线上'
                },
                {
                    name: '线下'
                },
                {
                    name: '线上 + 线下'
                }
            ]
            _dataSource2 = ['线上','线下'];
            flag = 2;
        }else if (_data == '_classify') {
            // _dataSource = [
            //     {
            //         name:'全部'
            //     },
            //     {
            //         name:'教育'
            //     },
            //     {
            //         name: '摄影'
            //     },
            //     {
            //         name: '医疗'
            //     }
            // ]
            // _dataSource2 = ['全部','教育','摄影','医疗'];
            _dataSource = classify_dataSource;
            _dataSource2 = classify_dataSource2;
            flag = 3;
        }

        var active = [];
        if (_dataSource2.indexOf(person) == -1) {
            active = [0]
        } else {
            active.push(_dataSource2.indexOf(person))
        }
        UIActionSelector.open({
            datas: _dataSource,
            actives: active,
            layout: {
                row: 7,
                col: 1,
                height: 30,
                size: 16,
                sizeActive: 18,
                rowSpacing: 5,
                colSpacing: 5,
                maskBg: 'rgba(0,0,0,0.5)',
                bg: '#fff',
                color: '#888',
                colorSelected: '#000'
            },
            animation: true,
            cancel: {
                text: '取消',
                size: 12,
                w: 90,
                h: 35,
                bg: '#eee',
                // bgActive: '#ccc',
                color: '#000',
                // colorActive: '#fff'
            },
            ok: {
                text: '确定',
                size: 12,
                w: 90,
                h: 35,
                bg: '#eee',
                // bgActive: '#ccc',
                color: '#000',
                // colorActive: '#fff'
            },
            title: {
                text: '请选择',
                size: 20,
                h: 35,
                bg: '#eee',
                color: '#000'
            },
            fixedOn: api.frameName
        }, function(ret, err) {
            if (ret) {
                if (ret.eventType == 'ok') {
                    $api.text($api.dom('.'+ _data +''), ret.level1);
                    // 选择分类
                    if (ret.selectedInfo[0].category_id) {
                        $api.attr($api.dom('._classify'), 'data-id', ret.selectedInfo[0].category_id);
                    }
                    if (_dataSource2[1]  == '公司') {
                        if (ret.level1 == '公司') {
                            type = 2;
                            for (var i = 0; i < $api.domAll('.companyName').length; i++) {

                                $api.css($api.domAll('.companyName')[i], 'display: block');
                            }
                        } else {
                            type = 1;
                            for (var i = 0; i < $api.domAll('.companyName').length; i++) {
                                $api.css($api.domAll('.companyName')[i], 'display: none');
                            }
                        }
                    }

                }
            } else {
                alert(JSON.stringify(err.msg));
            }
        });

        // api.openFrame({
        //     name: '_type',
        //     url: 'supply_selectType.html',
        //     rect: {
        //         x: 0,
        //         y: 0,
        //         w: 'auto',
        //         h: 'auto'
        //     },
        //     pageParam: {
        //         dataSource: _dataSource,
        //         flag: flag,
        //         defaultVal: person
        //     },
        //     bounces: false
        // });
    }
    function classify() {
        api.ajax({
            url: apiSite + '/category/index',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: {
                       type: 2
                   }
            }
        }, function(ret, err) {
            if(ret) {
                classify_dataSource = ret.data.list;
                for (var i = 0; i < ret.data.list.length; i++) {
                    classify_dataSource2.push(ret.data.list[i].name)
                    categoryArr.push(ret.data.list[i].name)
                }
            } else {
                alert(JSON.stringify(err))
            }
        })
    }

    // 获取位置
    function getPos() {

        if (api.systemType === 'ios') {
            bMap.initMapSDK(function(ret) {
                if (ret.status) {
                    getLocation();
                } else {
                    alert(JSON.stringify(err.msg))
                }
            });
        } else {
            getLocation();
        }

    }
    // 获取经纬度
    function getLocation() {
        bMap.getLocation({
            accuracy: '100m',
            autoStop: true,
            filter: 1
        }, function(ret, err) {
            if (ret.status) {
                // alert(JSON.stringify(ret));
                getCoords(ret.lon, ret.lat)
                // console.log('经度：' + ret.lon + '----' +'纬度:'+ret.lat)
                latitude = ret.lat;
                longitude = ret.lon;
            } else {
                api.toast({
                    msg: '请在系统的设置-隐私-定位服务界面允许我在确定您的位置'
                });
            }
        });
    }
    // 根据经纬度获取地址
    function getCoords(lon,lat) {
        bMap.getNameFromCoords({
            lon: lon,
            lat: lat
        }, function(ret, err) {
            if (ret.status) {
                province = ret.city;
                city = ret.city;
                address = ret.address;
                district = ret.district;

                // alert(JSON.stringify(ret))
                // console.log('地区'+ret.district + '省份'+ret.city +'地址'+ret.address )
                $api.text($api.byId('position'), address);
                // ret.district // 地区
                // ret.city // 省份
                // ret.address // 地址


            }
        });
    }

    // 编辑供应的数据
    function requireData() {
        api.ajax({
            url: apiSite + '/demand/editIndex',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: {
                       token: $api.getStorage('userToken'),
                       demand_id: api.pageParam.demand_id
                   }
            }
        }, function(ret, err) {
            if(ret) {
                releaseFlag = 1;
                //console.log(JSON.stringify(ret))
                imgArr = eval(ret.data.info.image_json)
                editSupply(ret.data);
                // $api.css($api.dom('.loading'), 'display: none');
            } else {
                alert(JSON.stringify(err.msg))
            }
        })
    }
</script>
</html>