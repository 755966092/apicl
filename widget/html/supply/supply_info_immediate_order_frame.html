<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
        html,body {
            height: 100%;
            width: 100%;
        }
        .main {
            margin-top: .2rem;
            font-size: 0;
        }

        .choose {
            background-color: #fff;
            padding: .1rem .3rem;
        }

         .choose img {
            width: .64rem;
            height: .64rem;
            float: left;
        }
         .issuerInfo {
            font-size: .28rem;
            line-height: .3rem;
            margin-top: .1rem;
            margin-left: .1rem;
        }
        .issuerInfo p:last-child {
            font-size: .24rem;
            color: #9b9b9b;
        }
        .description {
            margin-left: .1rem;
            color: #999;
            font-size: .24rem;
            max-width: 4.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        footer {
            font-size: 0;
            height: 1rem;
            /* position: fixed; */
            /* bottom: 0; */
            /* left: 0; */
            width: 100%;
            background-color: #fff;
            /* border-top: .06rem solid #F8F8F8; */
        }
        footer span {
            font-size: .34rem;
            text-align: center;
            float: left;
        }

        footer .priceTitle {
            height: 1rem;
            line-height: 1rem;
            color: #222;
            font-size: .34rem;
            width: 60%;
            padding-left: .3rem;
            box-sizing: border-box;
        }
        footer .price {
            color: #F6A623;
        }

        footer span.enter {
            font-size: .34rem;
            width: 40%;
            line-height: 1rem;
            background-color: #0ABB07;
            color: #fff;
        }

        .main {
           margin-bottom: 1rem;
        }
        .content {
            background-color: #F8F8F8;
            padding: .2rem .3rem;
             position: relative;
        }
        .content img {
            width: 1.45rem;
            height: 1.45rem;
            margin-right: .2rem;

        }
        .content ._type {
            height: .28rem;
            width: .63rem;
            font-size: .2rem;
            border: .01rem solid #0076FF;
            color: #0076FF;
            border-radius: .06rem;
            margin-right: .1rem;
            text-align: center;
            line-height: .28rem;
        }
        .content .title {
            font-size: .34rem;
        }
        .content p {
            font-size: .24rem;
            position: absolute;
            bottom: .2rem;
            left: 1.95rem;
            color: #F6A623;
        }
        .main .price {
            padding: 0 .3rem;
            height: .8rem;
            line-height: .8rem;
            font-size: .34rem;
            color: #F6A623;
            background-color: #fff;
            margin-bottom: .2rem;
        }

        .tel {
            background-color: #fff;
            font-size: .34rem;
            height: .8rem;
            line-height: .8rem;
            padding: 0 .3rem;
            border-bottom: .01rem solid #f8f8f8;
        }
        .tel input {
            height: .8rem;
            outline: none;

        }

         .serveTime {
            line-height: .8rem;
            padding: 0 .3rem;
            height: .8rem;
            background-color: #fff;
            font-size: .28rem;

        }
        .serveTime span{
            color: #9A9A9A;
        }
        .serveTime i {
            display: inline-block;
            height: .8rem;
            width: .15rem;
            background: url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: 0 center;
            float: right;
            margin-left: .2rem;
        }

        footer  #total{
            color: #F6A623;
            overflow: hidden;
            width: 3rem;
            text-align: left;
             text-overflow: ellipsis;
        }
        .note {
            margin-top: .2rem;
        }
        .note input {
            outline: none;
            padding: 0 .2rem;
        }
    </style>
</head>
<body class="flex-def flex-zTopBottom flex-zBetween">
    <div class="main clearfix">
            <div class="resultList"></div>
                <script type="text/x-dot-template" id="listT">
                    <div class="choose clearfix">
                        <img src="{{=it.head_img_url}}">
                        <div class="fl issuerInfo">
                            <p>{{=it.nickname}}</p>
                            {{?it.current_company==null&&it.current_position!=null}}
                                <span class="description"> {{=it.current_position}}</span>
                            {{??it.current_position==null&&it.current_company!=null}}
                                <span class="description">{{=it.current_company}}</span>
                            {{??it.current_position==null&&it.current_company==null}}
                            {{??}}
                                <span class="description">{{=it.current_company}} {{=it.current_position}}</span>
                            {{?}}
                        </div>
                    </div>
                    <div class="content flex-def">
                        {{?it.image_json[0] == null}}
                        <img src="../../image/noimage.jpg">
                        {{??}}
                        <img src="{{=it.image_json[0]}}">
                        {{?}}
                        <div >
                            <span class="_type">{{=it.type}}</span>
                            <span class="title">{{=it.title}}</span>
                            <p>{{=it.city}} - {{=it.district}} - {{?it.form == 1}}<span> 线上</span>{{??it.form == 2}}<span> 线下</span>{{??}}<span>&nbsp;线上 + 线下</span>{{?}}
                            </p>
                        </div>
                    </div>
                    <div class="price">
                        <p>赏金：￥<span>{{=it.reward}}</span></p>
                    </div>
                </script>
            <!--  <div class="serveTime" >
                交易时间
                <i></i>
                <span class="fr" id="serverTime" ontouchstart="openTime(this)">请选择交易时间</span>
            </div> -->
            <div class="tel serveTime" ontouchstart='openPhonePage(1)'>
                联系电话
                <i></i>
                <span class="fr" id="defaultPhone"></span>
            </div>
            <div class="tel serveTime note">
                备注:
                <!-- <i></i> -->
                <input type="text" placeholder="填写备注" id="note" name="">
            </div>
           <!--  <div class="tel serveTime" id="addressWrap" ontouchstart='openPhonePage(0)'>
                地址
                <i></i>
                <span class="fr" id="address"></span>
            </div>
           <div class="tel serveTime" onclick="openEditName()" tapmode>
                真实姓名
                <i></i>
                <span class="fr" id="real_name"></span>
            </div>
            <div class="tel">
                <p>备注：
                    <input type="text" placeholder="填写备注" name="">
                </p>
            </div> -->
    </div>
    <footer>
            <span class="priceTitle">
                <span>赏金：</span>
                <span id="total">
                    <span>￥</span>
                    <span id="price"></span>
                </span>
            </span>
            <span class="enter" ontouchstart="enteroOrder()">确认接单</span>
    </footer>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript">
    apiready = function(){
        initPage()
        var str = api.pageParam.transmitData.image_json[0];
        api.pageParam.transmitData.image_json[0] = str.substring(0, str.indexOf('?')) + '?imageView2/3/w/200/h/200/q/75|imageslim'
        $api.fixTabBar($api.dom('footer'))
        getData(api.pageParam.transmitData)
        api.addEventListener({
            name: 'callbackPhone'
        }, function(ret, err) {
            if (ret) {
                $api.text($api.byId('defaultPhone'), ret.value.phone);
                $api.attr($api.byId('defaultPhone'), 'data-id', ret.value.id);

            } else {
                alert(JSON.stringify(err));
            }
        });
    };

    // 编辑姓名
    function openEditName() {
        api.openWin({
            name: 'supply_editName',
            url: './supply_editName.html',
            pageParam: {
                name: $api.text($api.byId('real_name'))
            }
        });
    }
    // 选择电话
    function openPhonePage(n) {
        if (n) {
            api.openWin({
                name: 'supply_getStroagePhone',
                url: './supply_getStroagePhone.html'
            });
        } else {
            api.openWin({
                name: 'supply_getStroageAddress',
                url: './supply_getStroageAddress.html'
            });
        }
    }
    // 初始化页面
    function initPage() {
        var userPhone = $api.getStorage('userPhone') || '';
        var userAddress = $api.getStorage('userAddress') || '';
        var real_name = $api.getStorage('real_name') || '';
        // 设置地址
        if (userAddress != '') {
            $api.text($api.byId('address'), userAddress[0].province +' '+userAddress[0].city +' '+userAddress[0].district +' '+userAddress[0].district);
            $api.attr($api.byId('address'), 'data-id', userAddress[0].address_id);
        } else {
             $api.text($api.byId('address'), '未设置默认地址')
        }
        // 设置真实姓名
        if (real_name != '') {
            $api.text($api.byId('real_name'), real_name);
        } else {
            api.ajax({
                url: apiSite + '/user_center/editBasicInfoIndex',
                method: 'post',
                headers: apiHeader,
                data: {
                       values: {
                           token: $api.getStorage('userToken'),
                       }
                }
            }, function(ret, err) {
                if(ret) {
                    // alert(JSON.stringify(ret))
                    if (ret.data.info.real_name) {
                        $api.text($api.byId('real_name'), ret.data.info.real_name);
                    } else {
                        $api.text($api.byId('real_name'), '未设置真实姓名');
                    }
                } else {
                    alert(JSON.stringify(err))
                }
            })
        }
        // 设置赏金
        $api.text($api.byId('price'), api.pageParam.transmitData.reward);
        // 设置电话
        if (userPhone != '') {
            for (var i = 0; i < userPhone.length; i++) {
                if (userPhone[i].is_default) {
                    $api.attr($api.byId('defaultPhone'), 'data-id', userPhone[i].contact_id);
                    userPhone = userPhone[i].phone;
                    $api.text($api.byId('defaultPhone'), userPhone);
                    break;
                }
            }
        } else {
            $api.text($api.byId('defaultPhone'), '未设置默认联系方式');
        }
       // 打开时间选择器
    }

   // 选择时间
    function openTime(ele) {                                                                                                                                     for (var i = 0; i < $api.domAll('input').length; i++) {             $api.domAll('input')[i].blur()         }
        var text = '选择服务时间';

        var date, date1, date2, date3, date4;
        var current = $api.text(ele);
        if (current!='请选择服务时间') {
            current = current.split(' ')
            var current1 = current[0].split('-')
            var current2 = current[1].split(':')
            current = current1.concat(current2)
            date = current[0];
            date1 = current[1];
            date2 = current[2];
            date3 = current[3];
            date4 = current[4];
        } else　{
            date = new Date().getFullYear();
            date1 = new Date().getMonth()+1;
            date2 = new Date().getDate();
        }
        api.openPicker({
            type: 'date-time',
            date: date+'-'+date1+'-'+date2+' '+date3+':'+date4,
            title: text
        }, function(ret, err) {
            if (ret) {
                if (ret.minute < 10) {
                    ret.minute = '0' + ret.minute
                }
                if (ret.hour < 10) {
                    ret.hour = '0' + ret.hour
                }
                var time = new Date();
                if (
                    ret.year < time.getFullYear() ||
                    (ret.year === time.getFullYear() && ret.month < time.getMonth()+1) ||
                    (ret.year === time.getFullYear() && ret.month === time.getMonth()+1 && ret.day < time.getDate()) ||
                    (ret.year === time.getFullYear() && ret.month === time.getMonth()+1 && ret.day === time.getDate() && ret.hour < time.getHours()) ||
                    (ret.year === time.getFullYear() && ret.month === time.getMonth()+1 && ret.day === time.getDate() && ret.hour === time.getHours() && ret.minute < time.getMinutes() )
                          ) {
                    alert('服务时间不能早于当前时间')
                } else {
                    $api.text(ele, ret.year + '-' + ret.month + '-' + ret.day + ' ' + ret.hour + ':' + ret.minute);
                }
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }

    // 确认接单
    function enteroOrder() {
        var phone = $api.text($api.byId('defaultPhone'));
        var id = $api.attr($api.byId('defaultPhone'), 'data-id');
        var note = $api.val($api.byId('note'));
        //console.log(note)
        api.ajax({
            url: apiSite + '/demand_order/helperCreateOrder',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: {
                       token: $api.getStorage('userToken'),
                       demand_id: api.pageParam.transmitData.demand_id,
                       contact_id: id,
                       note: note
                   }
            }
        }, function(ret, err) {
            if(ret) {
                if(ret.code == 200) {
                    api.openWin({
                        name: 'me_qdd_ta',
                        url: '../me/me_qdd.html'
                    });
                } else {
                    alert(ret.msg)
                }
            } else {
                alert(JSON.stringify(err))
            }
        })
    }
</script>
</html>


