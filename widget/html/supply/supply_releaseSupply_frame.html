<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
        body,html {
            background-color: #EDECF3;
        }
        .contentText {
            background-color: #fff;
            font-size: .3rem;
            padding: 0 .3rem
        }
        .title {
            height: .9rem;
            border-bottom: 1px solid #CBCBCB;
            line-height: .9rem;
        }
        .smallTitle {
            color: #0ABB07;
        }
        .title input {
            height: .9rem;
            outline: none;
        }
        textarea {
            width: 100%;
            padding: .2rem 0;
            outline: none;
            resize: none;
            font-family: 'microsoft yahei';
        }

        .addMedia {
            font-size: 0;
            display: inline-block;
            width: 1.6rem;
            height: 1.6rem;
            background: #F8F8F8;
            text-align: center;
            color: #999;
            margin-right: .1rem;
        }   
        .addMedia span {
            font-size: .3rem;
        }
        .addMedia span.icon{
            display: inline-block;
            height: .9rem;
            width: 100%;
            background: url(../../image/icon_supply/icon_addMedia_01.png)no-repeat;
            -webkit-background-size: .62rem .62rem;
            background-size: .62rem .62rem;
            background-position: bottom center;
            font-size: .3rem;
            margin-bottom: .1rem;
        }
        .addMedia:last-child span.icon {
            background: url(../../image/icon_supply/icon_addMedia_02.png)no-repeat;
            background-size: .6rem .45rem;
            background-position: bottom center;
        }
        .position {
            background: url(../../image/icon_supply/icon_pos.png)no-repeat;
            -webkit-background-size: .26rem .35rem;
            background-size: .26rem .35rem;
            background-position: 0 center;
            height: 1rem;
            line-height: 1rem;
            padding-left: .35rem;
        }



        .classify {
            background-color: #EDECF3;
            font-size: 0;
            
        }
        .classify ul li {
            /*background-color: #fff;*/
            font-size: .3rem;
            height: .8rem;
            line-height: .8rem; 
            /*border-bottom: 1px solid #000;*/
            width: 100%;
            /*padding: 0 .3rem 0 .8rem;*/
            padding-left: .36rem;
            background: #fff url(../../image/icon_my/icon_fb.png)no-repeat;
            -webkit-background-size: .44rem .44rem;
            background-size: .44rem .44rem;
            background-position: .3rem center;
            box-sizing: border-box;
        }
        .classify ul li.border100 {
            border-bottom: 1px solid #d9d9d9;
        }
        .classify ul li.border100 .wrap {
            border-bottom: 0;
        }
        .wrap {
            height: .78rem;
            padding-left: .44rem;
            border-right: .36rem;
            border-bottom: 1px solid #d9d9d9;
             /*box-sizing: border-box;*/
        }
        .spanno2 {
            margin-right: .2rem;

            display: inline-block;
            height: .8rem;
            background: url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: right center;
            float: right;
            color: #BEBEBE;
            padding-right: .3rem;
        }
        li input {
            float: right;
            line-height: .8rem;
            text-align: right;
            padding-right: .5rem;
            font-size: .3rem;
            outline: none;
        }
        .mt37 {
            margin-top: .37rem;
        }
        .mb20 {
            margin-bottom: .2rem;
        }
        

        .btn {
            width: 6.32rem;
            height: .83rem;
            margin: 0 auto;
            border-radius: .1rem;
            background-color: #08BB08;
            font-size: .34rem;
            color: #fff;
            text-align: center; 
            line-height: .83rem;
            margin-top: .37rem;
            margin-bottom: .3rem;
        }


        ul li:nth-child(1) {
                background: #fff url(../../image/icon_supply/icon_00.png)no-repeat;
                background-size: .28rem .34rem;
                background-position: .3rem center;
            }
            ul li:nth-child(2) {
                background: #fff url(../../image/icon_supply/icon_01.png)no-repeat;
                background-size: .34rem .34rem;
                background-position: .3rem center;
            }
            ul li:nth-child(3) {
                background: #fff url(../../image/icon_supply/icon_11.png)no-repeat;
                background-size: .31rem .31rem;
                background-position: .3rem center;
                display: none;
            }
            ul li:nth-child(4) {
                background: #fff url(../../image/icon_supply/icon_02.png)no-repeat;
                background-size: .32rem .34rem;
                background-position: .3rem center;
            }
             ul li:nth-child(5) {
                background: #fff url(../../image/icon_supply/icon_03.png)no-repeat;
                background-size: .34rem .29rem;
                background-position: .3rem center;
            }
            ul li:nth-child(6) {
                background: #fff url(../../image/icon_supply/icon_04.png)no-repeat;
                background-size: .32rem .34rem;
                background-position: .3rem center;
            }
            ul li:nth-child(7) {
                background: #fff url(../../image/icon_supply/icon_05.png)no-repeat;
                background-size: .3rem .34rem;
                background-position: .3rem center;
            }
            ul li:nth-child(8) {
                background: #fff url(../../image/icon_supply/icon_08.png)no-repeat;
                background-size: .34rem .34rem;
                background-position: .3rem center;
                /*display: none;*/
            }
            ul li:nth-child(9) {
                background: #fff url(../../image/icon_supply/icon_09.png)no-repeat;
                background-size: .34rem .34rem;
                background-position: .3rem center;
                /*display: none;*/
            }
            ul li:nth-child(10) {
                background: #fff url(../../image/icon_supply/icon_06.png)no-repeat;
                background-size: .33rem .34rem;
                background-position: .3rem center;
            }
            ul li:nth-child(11) {
                background: #fff url(../../image/icon_supply/icon_07.png)no-repeat;
                background-size: .33rem .34rem;
                background-position: .3rem center;
        }
        .supplyImg {
            float: left;
            font-size: 0;
        }
        .clearfix img{
            margin-right: .1rem;
            width: 1.6rem;
            height: 1.6rem;
            margin-bottom: .1rem;
        }
        .mult {
            -webkit-box-lines: multiple; 
            box-lines: multiple;
            flex-wrap:wrap;
            width: 100%;
            font-size: 0;
            -webkit-box-flex: 1.0;
            -moz-flex-shrink: 1;
            -webkit-flex-shrink: 1;
            flex-shrink: 1;
        }
        .asd {
            width: 1.6rem;
            height: 1.6rem;
            font-size: 0;
            
            background-color: #f00;
        }
        .companyName {
            display: none;  
        }
    </style>
</head>
<body>
    <div class="contentText clearfix">
        <div class="title">
            <span class="smallTitle">#我提供#</span>
            <input type="text" placeholder="输入您发布的标题" id="title">
        </div>
        <textarea placeholder="描述一下您发布的内容" rows="5" id="description"></textarea>
        <div class="mult clearfix flex-def resultList">
           <!--  <img class="fl imgpage" tapmode="hover"  src="">
            <img  src="../../image/icon_supply/icon_addMedia_1.png" class="addImg" onclick="openImg()" tapmode="hover">
            <img  src="../../image/icon_supply/icon_addMedia_2.png"> -->
           

            <!-- <div class="addMedia" onclick="openImg()" tapmode="hover">
                <span class="icon"></span>
                <span>添加图片</span>
            </div>
            <div class="addMedia">
                <span class="icon"></span>
                <span>添加视频</span>
            </div> -->
        </div>

        <script type="text/x-dot-template" id="listT">
            {{ for (var i = 0; i < it.img.length; i++) { }} 
                <img class="fl imgpage" tapmode="hover" onclick="openImgPage(this)" data-id = '{{=i}}' src="{{=it.img[i]}}">
            {{ }; }}
            {{?it.img.length==0&&it.video.length==0}}
                <img  src="../../image/icon_supply/icon_addMedia_1.png" class="addImg" onclick="openImg()" tapmode="hover">
                <img  src="../../image/icon_supply/icon_addMedia_2.png">
            {{??it.video.length==0}}
                <img  src="../../image/icon_supply/icon_addMedia_1.png" class="addImg" onclick="openImg()" tapmode="hover">
            {{??it.img.length==0}}
                <img  src="../../image/icon_supply/icon_addMedia_2.png">
            {{?}}
        </script>


        <p class="position" id="position"  tapmode="hover"   onclick="openPosition()">选择地址</p>
    </div>
    <div class="classify clearfix">
        <ul>
           <!--  <li class="mt37">
                <div class="wrap">
                    <span>截至时间</span>
                    <span ontouchstart="openTime(this)" class="spanno2">选填</span>
                </div>
            </li> -->

            <li class="mt37"  tapmode="hover"   onclick="selectType(this)" data-val="_type">
                <div class="wrap">
                    <span>类型</span>
                    <span id="_type" class="spanno2 _type"></span>
                </div>
            </li>
            <li class="companyName">
                <div class="wrap">
                    <span>公司</span>
                    <span id="company_name" class="spanno2"></span>
                </div>
            </li>
            <li   tapmode="hover"   onclick="selectType(this)" data-val="_genre">
                <div class="wrap">
                    <span>类别</span>
                    <span class="spanno2 _genre" id="sub_type"></span>
                </div>
            </li>
            <li class="border100" tapmode="hover"   onclick="selectType(this)" data-val="_classify">
                <div class="wrap">
                    <span>分类</span>
                    <span class="spanno2 _classify" id="category_id"></span>
                </div>
            </li>


            <li class="mt37"  tapmode="hover" >
                <div class="wrap">
                    <span>价格</span>
                    <input type="number" name="" placeholder="选填" id="price">
                </div>
            </li>
            <li   tapmode="hover"   onclick="selectType(this)" data-val="_format">
                <div class="wrap">
                    <span>形式</span>
                    <span class="spanno2 _format" id="form">选填</span>
                </div>
            </li>


            <li  onclick="selectType(this)" data-val="_unit">
                <div class="wrap">
                    <span>单位</span>
                    <span class="spanno2 _unit" id="unit">选填</span>
                </div>
            </li>
            <li class="border100">
                <div class="wrap">
                    <span>适用范围</span>
                    <input type="text" name="" placeholder="选填">
                </div>
            </li>


            <li class="mt37"   tapmode="hover"   onclick="remindWho()">
                <div class="wrap">
                    <span>提醒谁看</span>
                    <span class="spanno2"></span>
                </div>
            </li>
            <li class="mb20 border100">
                <div class="wrap">
                    <span>定向投递</span>
                    <span class="spanno2"></span>
                </div>
            </li>
        </ul>        
    </div>
    <div class="btn" tapmode="hover" onclick="addSupply()">发布</div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript">
    var type = 1, province,            //string  省份
                  city,            //string  城市
                  address,         //string  地址
                  latitude,            //string  纬度
                  longitude,           //string  经度; 
                  supply_id,
                  _dataSource = ["次","幅","单","小时","分钟","天","周","月","份", "个", "扇", "课时", "面议","其他","未定义"],
                  base64Data={
                    img: [],
                    video: []
                  },
                  categoryArr = ['全部','教育','摄影','摄影','医疗'];
    apiready = function(){
        
        moduleInit();
        if (api.pageParam.supply_id) {
            requireData();
        } else {
            // 获取位置
            getPos();
        }
        // // 公司|个人 显示不同的页面
        // showDifPage()
        // // 选择类别478402
        // monitorEvent('_genre','_genre');
        // monitorEvent('_format','_format');
        // monitorEvent('_classify','_classify');
        // monitorEvent('_unit','_unit');

        getData(base64Data);
        // 删除图片
        delImg();
    };
    // 编辑供应
    function editSupply(data) {
        var titleIpt = $api.byId('title'),
            descriptionIpt = $api.byId('description'),
            price = $api.byId('price'),
            _type = $api.byId('_type'),
            sub_type = $api.byId('sub_type'),
            form = $api.byId('form'),
            unit = $api.byId('unit'),
            category_id = $api.byId('category_id'),
            position = $api.byId('position');
        $api.val(titleIpt, data.info.title);
        $api.val(descriptionIpt, data.info.description);
        $api.val(price, data.info.price);

        var unitText = data.info.unit > 0 ? _dataSource[data.info.unit-1] : '未定义';
        var _categoryId =  categoryArr[data.info.category_id-1]
        $api.text(position, data.info.address);
        $api.text(unit, unitText);
        $api.text(category_id, _categoryId);
        data.info.type == 1 ? $api.text(_type, '个人') : $api.text(_type, '公司');
        if (data.info.type == 2) {
            $api.css($api.dom('.companyName'), 'display:block');
            $api.text($api.byId('company_name'), data.info.company_name);

        }
        data.info.sub_type == 1 ? $api.text(sub_type, '自产自销') : $api.text(sub_type, '代理')
        data.info.form == 1 ? $api.text(form, '线上') : $api.text(form, '线下')

        // 编辑供应返回的相关信息
        address = data.info.address;
        latitude = data.info.latitude;
        longitude = data.info.longitude;
        province = data.info.province;
        city = data.info.city;
        supply_id = data.info.supply_id;

    }
    // 时间选择器
    function openTime(ele) {
        for (var i = 0; i < $api.domAll('input').length; i++) {$api.domAll('input')[i].blur()}
        var data = $api.attr(ele, 'data-val');
        var text;
        if (data == 'startTime') {
            text = '选择开始时间'
        } else {
            text = '选择结束时间'
        }
        var date, date1, date2;
        var current = $api.text(ele);
        if (current!='请选择') {
            current = current.split('-')
            date = current[0];
            date1 = current[1];
            date2 = current[2];
        } else　{
            date = new Date().getFullYear();
            date1 = new Date().getMonth();
            date2 = new Date().getDate();
        }
        api.openPicker({
            type: 'date',
            date: date+'-'+date1+'-'+date2,
            title: text
        }, function(ret, err) {
            if (ret) {
                $api.text(ele, ret.year+'-'+ret.month+'-'+ret.day);
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }
    // 选择地址页面
    function openPosition() {
        api.openWin({
            name: 'supply_releasePosition_win',
            url: './supply_releasePosition_win.html'
        });
    }
    // 删除图片
    function delImg() {
        api.addEventListener({
            name: 'delImg'
        }, function(ret, err) {
            if (ret) {
                for (var i = 0; i < $api.domAll('.imgpage').length; i++) {
                    if (i == (ret.value.imgId-1)) {
                        $api.remove($api.domAll('.imgpage')[i]);
                    }
                }
                base64Data = base64Data.img.filter(function(item, index) {
                    if (index != ret.value.imgId-1) {
                        return item
                    }
                })
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }
    // 打开相册
    function openImg() {
        api.getPicture({
            sourceType: 'album',
            encodingType: 'png',
            mediaValue: 'pic',
            destinationType: 'base64',
            allowEdit: false,
            quality: 70,
            // targetWidth: 100,
            // targetHeight: 100,
            saveToPhotoAlbum: false
        }, function(ret, err) {
            if (ret) {
                base64Data.img.push(ret.base64Data);
                getData(base64Data);
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }
    function openImgPage(ele) {
       var data = $api.attr(ele, 'src'),
            n = parseInt($api.attr(ele, 'data-id'));
        api.openWin({
            name: 'supply_releaseSupply_imgPage_win',
            url: './supply_releaseSupply_imgPage_win.html',
            bounces: false,
            pageParam: {
                data: data,
                count:  base64Data.length,
                n: n+1
            }
        });
    }

    // 添加供应
    function addSupply() {
        // 获取页面内容
        var token = $api.getStorage('userToken'),            //string  用户Token
            title = $api.val($api.byId('title')),           //string  标题
            sub_type = $api.text($api.byId('sub_type')) == '自产自销' ? 1 : 2,            //int 类别ID（1-自产自销，2-代理）
            category_id = 1,         //int 分类ID
            price = $api.val($api.byId('price')),           //float   价格
            unit = _dataSource.indexOf($api.text($api.byId('unit')))+1,            //string  单位
            form = $api.text($api.byId('form')) == '线上' ? 1 : 2,            //int 形式（1-线上，2-线下）
            description = $api.val($api.byId('description'));        //string  详细内容
            // image_json = [],          //string  图片（格式：["abc.jpg","ddd.jpg"]）
            company_id = 1;      // 公司ID（类型为2-我公司卖时必传）
            // alert('标题 : '+ title +'---类别ID : '+sub_type+'---分类ID : '+category_id+'---价格 : '+price+'----形式'+form+'---内容: '+description +"---省份"+ province + "---地区" +city+ "---地址" +address+ "---纬度" +latitude+'---纬度: '+longitude)
            var category = $api.text($api.byId('category_id'));
            for (var i = 0; i < categoryArr.length; i++) {
                if (categoryArr[i] === category) {
                        category_id = i+1;
                    break;
                }
            }
            var url,obj;
            if (api.pageParam.supply_id) {
                // 编辑供应
                url = '/api/supply/edit';
                obj = {
                    token: token,
                    title: title,
                    supply_id: supply_id,
                    type: type,
                    sub_type: sub_type,
                    category_id: category_id,
                    province: province,
                    city: city,
                    address: address,
                    latitude: latitude,
                    longitude: longitude,
                    price: price,
                    unit: unit,
                    form: form,
                    description: description,
                    image_json: [],
                    company_id:1
                }
            } else {
                // 发布新供应
                url = '/api/supply/add';
                obj = {
                    token: token,
                    title: title,
                    type: type,
                    sub_type: sub_type,
                    category_id: category_id,
                    province: province,
                    city: city,
                    address: address,
                    latitude: latitude,
                    longitude: longitude,
                    price: price,
                    unit: unit,
                    form: form,
                    description: description,
                    image_json: [],
                    company_id:1
                }
            }
                api.ajax({
                    url: apiSite + url,
                    method: 'post',
                    headers: apiHeader,
                    data: {
                       values: obj
                    }
                }, function(ret, err) {
                    if(ret) {
                        if (api.pageParam.supply_id) {
                            // 编辑应用返回我发布的页面
                            api.sendEvent({
                                name: 'renovateMySupply',
                                 extra: {
                                    supply_id: api.pageParam.supply_id
                                }
                            });
                           
                        } else {
                            // 发布新供应返回供应列表
                            api.sendEvent({
                                name: 'editSupplyAfter'
                            });
                        }
                        api.closeWin();
                    } else {
                        alert(JSON.stringify(err.msg))
                    }
                })
            
    }


    // 公司|个人 显示不同的页面
    function showDifPage () {
        api.addEventListener({
           name: 'selectType'
        }, function(ret, err) {
           if (ret) {
            $api.text($api.dom('._type'), ret.value.selDate);
            if (ret.value.selDate == '公司') {
                type = 2;
                for (var i = 0; i < $api.domAll('.companyName').length; i++) {
                    
                    $api.css($api.domAll('.companyName')[i], 'display: block');
                }
            } else {
                type = 1;
                for (var i = 0; i < $api.domAll('.companyName').length; i++) {
                    
                    $api.css($api.domAll('.companyName')[i], 'display: none');
                }
            }
           } else {
               alert(JSON.stringify(err.msg));
           }
        });
    }
    // 提现谁看
    function remindWho() {
        api.openWin({
            name: 'supply_info_ask_remindWho',
            url: './supply_info_ask_remindWho.html'
            
        });
    }
    // 监听事件， 修改页面文本内容
    function monitorEvent(eventName, calssName) {
        api.addEventListener({
           name: eventName
        }, function(ret, err) {
           if (ret) {
            $api.text($api.dom('.'+ calssName +''), ret.value.selDate);
           } else {
               alert(JSON.stringify(err.msg));
           }
        });
    }
    // 选择类型  公司 | 个人
    function selectType(ele) {
        var person =  $api.text(ele.getElementsByClassName('spanno2')[0]);
        var _data = $api.attr(ele, 'data-val');
        var flag;
        var _dataSource = [],_dataSource2=[];
        if (_data == '_type') {
            _dataSource = [
                {
                    name: '个人'
                },
                {
                    name: '公司'
                }
            ];
            _dataSource2 = ['个人','公司']
            flag = 0;
        } else if (_data == '_genre') {
            _dataSource = [
                {
                    name: '自产自销'
                },
                {
                    name: '代理'
                }
            ];
            _dataSource2 = ['自产自销','代理']
            flag = 1;
        } else if (_data == '_format') {
            _dataSource = [
                {
                    name: '线上'
                },{
                    name: '线下'
                }
            ];
            _dataSource2 = ['线上','线下']
            flag = 2;
        }else if (_data == '_classify') {
            _dataSource = [
                {
                    name: '全部'
                },{
                    name: '教育'
                },{
                    name: '摄影'
                },{
                    name: '医疗'
                }
            ];
            _dataSource2 = ['全部','教育','摄影','医疗']
            flag = 3;
        } else if (_data == '_unit') {
            _dataSource = [
                {
                    name: "次"
                },
                {
                    name: "幅"
                },
                {
                    name: "单"
                },
                {
                    name: "小时"
                },
                {
                    name: "分钟"
                },
                {
                    name: "天"
                },
                {
                    name: "周"
                },
                {
                    name: "月"
                },
                {
                    name: "份"
                },
                {
                    name: "个"
                },
                {
                    name: "扇"
                },
                {
                    name: "课时" 
                },
                {
                    name: "面议"
                },
                {
                    name: "其他"
                },
                {
                    name: "未定义" 
                }
            ];
            _dataSource2 = ["次","幅","单","小时","分钟","天","周","月","份", "个", "扇", "课时", "面议","其他","未定义"]
            flag = 4;
            // "1": "次",
            // "2": "幅",
            // "3": "单",
            // "4": "小时",
            // "5": "分钟",
            // "6": "天",
            // "7": "周",
            // "8": "月",
            // "9": "份",
            // "10": "个",
            // "11": "扇",
            // "12": "课时",
            // "13": "面议",
            // "14": "其他",
            // "15": "未定义"
        }
        var active = [];
        if (_dataSource2.indexOf(person) == -1) {
            active = [1]
        } else {
            active.push(_dataSource2.indexOf(person))
        }
        UIActionSelector.open({
            datas: _dataSource,
            actives: active,
            layout: {
                row: 7,
                col: 1,
                height: 30,
                size: 16,
                sizeActive: 18,
                rowSpacing: 5,
                colSpacing: 5,
                maskBg: 'rgba(0,0,0,0.5)',
                bg: '#fff',
                color: '#888',
                colorSelected: '#000'
            },
            animation: true,
            cancel: {
                text: '取消',
                size: 12,
                w: 90,
                h: 35,
                bg: '#eee',
                // bgActive: '#ccc',
                color: '#000',
                // colorActive: '#fff'
            },
            ok: {
                text: '确定',
                size: 12,
                w: 90,
                h: 35,
                bg: '#eee',
                // bgActive: '#ccc',
                color: '#000',
                // colorActive: '#fff'
            },
            title: {
                text: '请选择',
                size: 20,
                h: 35,
                bg: '#eee',
                color: '#000'
            },
            fixedOn: api.frameName
        }, function(ret, err) {
            if (ret) {
                if (ret.eventType == 'ok') {
                    $api.text($api.dom('.'+ _data +''), ret.level1);
                    if (_dataSource2[1]  == '公司') {
                        if (ret.level1 == '公司') {
                            type = 2;
                            for (var i = 0; i < $api.domAll('.companyName').length; i++) {
                                
                                $api.css($api.domAll('.companyName')[i], 'display: block');
                            }
                        } else {
                            type = 1;
                            for (var i = 0; i < $api.domAll('.companyName').length; i++) {
                                
                                $api.css($api.domAll('.companyName')[i], 'display: none');
                            }
                        }
                    }
                }
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
        // api.openFrame({
        //     name: '_type',
        //     url: 'supply_selectType.html',
        //     rect: {
        //         x: 0,
        //         y: 0,
        //         w: 'auto',
        //         h: 'auto'
        //     },
        //     pageParam: {
        //         dataSource: _dataSource,
        //         flag: flag,
        //         defaultVal: person
        //     },
        //     bounces: false
        // });
    }
    // 获取位置
    function getPos() {
        if (api.systemType === 'ios') {
            bMap.initMapSDK(function(ret) {
                if (ret.status) {
                   getLocation();
                } else {
                    alert(JSON.stringify(err.msg))
                }
            });
        } else {
            getLocation();
        }
        
    }
    // 获取经纬度
    function getLocation() {
        bMap.getLocation({
            accuracy: '100m',
            autoStop: true,
            filter: 1
        }, function(ret, err) {
            if (ret.status) {
                // alert(JSON.stringify(ret));
                getCoords(ret.lon, ret.lat)
                // alert('经度：' + ret.lon + '----' +'纬度:'+ret.lat)
                latitude = ret.lat;
                longitude = ret.lon;
            } else {
                alert(err.code);
            }
        });
    }
    // 根据经纬度获取地址
    function getCoords(lon,lat) {
        bMap.getNameFromCoords({
            lon: lon,
            lat: lat
        }, function(ret, err) {
            if (ret.status) {
                province = ret.city;
                city = ret.district;
                address = ret.address;
                // alert(JSON.stringify(ret))
                // alert('地区'+ret.district + '省份'+ret.city +'地址'+ret.address )
                $api.text($api.byId('position'), address);
                // ret.district // 地区
                // ret.city // 省份
                // ret.address // 地址


            }
        });
    }

    // 编辑供应的数据
    function requireData() {
        api.ajax({
            url: apiSite + '/api/supply/editIndex',
            method: 'post',
            headers: apiHeader,
            data: {
                   values: { 
                       token: $api.getStorage('userToken'),
                       supply_id: api.pageParam.supply_id
                   }
            }
        }, function(ret, err) {
            if(ret) {
                console.log(JSON.stringify(ret))
                editSupply(ret.data)
            } else {
                alert(JSON.stringify(err.msg))
            }
        })
    }
</script>
</html>