<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
        body,html {
            background-color: #EDECF3;
        }
        .contentText {
            background-color: #fff;
            font-size: .24rem;
            padding: 0 .3rem
        }
        .title {
            height: .9rem;
            border-bottom: 1px solid #CBCBCB;
            line-height: .9rem;
        }
        .smallTitle {
            color: #0ABB07;
        }
        .title input {
            height: .9rem;
            outline: none;
        }
        textarea {
            width: 100%;
            padding: .2rem 0;
            outline: none;
        }

        .addMedia {
            width: 1.6rem;
            height: 1.6rem;
            background: #F8F8F8;
            text-align: center;
            color: #999;
            margin-right: .2rem;
        }   
        .addMedia span{
            display: inline-block;
            height: .9rem;
            width: 100%;
            background: url(../../image/icon_supply/icon_addMedia_01.png)no-repeat;
            -webkit-background-size: .62rem .62rem;
            background-size: .62rem .62rem;
            background-position: bottom center;
            
            margin-bottom: .1rem;
        }
        .addMedia:last-child span {
            background: url(../../image/icon_supply/icon_addMedia_02.png)no-repeat;
            background-size: .6rem .45rem;
            background-position: bottom center;
        }
        .position {
            background: url(../../image/icon_supply/icon_pos.png)no-repeat;
            -webkit-background-size: .26rem .35rem;
            background-size: .26rem .35rem;
            background-position: 0 center;
            height: 1rem;
            line-height: 1rem;
            padding-left: .35rem;
        }



        .classify {
            background-color: #EDECF3;
            font-size: 0;
            
        }
        .classify ul li {
            /*background-color: #fff;*/
            font-size: .24rem;
            height: .8rem;
            line-height: .8rem; 
            width: 100%;
            padding: 0 .3rem 0 .8rem;
            background: #fff url(../../image/icon_my/icon_fb.png)no-repeat;
            -webkit-background-size: .44rem .44rem;
            background-size: .44rem .44rem;
            background-position: .3rem center;
            box-sizing: border-box;
        }
        
        .spanno2 {
            margin-right: .2rem;

            display: inline-block;
            height: .8rem;
            background: url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: right center;
            float: right;
            color: #BEBEBE;
            padding-right: .3rem;
        }
        li input {
            float: right;
            line-height: .8rem;
            text-align: right;
            padding-right: .5rem;
            font-size: .24rem;
            outline: none;
        }
        .mt37 {
            margin-top: .37rem;
        }
        .mb20 {
            margin-bottom: .2rem;
        }
        

        .btn {
            width: 6.32rem;
            height: .83rem;
            margin: 0 auto;
            border-radius: .1rem;
            background-color: #08BB08;
            font-size: .34rem;
            color: #fff;
            text-align: center; 
            line-height: .83rem;
            margin-top: .37rem;
            margin-bottom: .3rem;
        }


        ul li:nth-child(1) {
                background: #fff url(../../image/icon_supply/icon_00.png)no-repeat;
                background-size: .28rem .34rem;
                background-position: .3rem center;
            }
            ul li:nth-child(2) {
                background: #fff url(../../image/icon_supply/icon_01.png)no-repeat;
                background-size: .34rem .34rem;
                background-position: .3rem center;
            }
            ul li:nth-child(3) {
                background: #fff url(../../image/icon_supply/icon_11.png)no-repeat;
                background-size: .31rem .31rem;
                background-position: .3rem center;
                display: none;
            }
            ul li:nth-child(4) {
                background: #fff url(../../image/icon_supply/icon_02.png)no-repeat;
                background-size: .32rem .34rem;
                background-position: .3rem center;
            }
             ul li:nth-child(5) {
                background: #fff url(../../image/icon_supply/icon_03.png)no-repeat;
                background-size: .34rem .29rem;
                background-position: .3rem center;
            }
            ul li:nth-child(6) {
                background: #fff url(../../image/icon_supply/icon_04.png)no-repeat;
                background-size: .32rem .34rem;
                background-position: .3rem center;
            }
            ul li:nth-child(7) {
                background: #fff url(../../image/icon_supply/icon_05.png)no-repeat;
                background-size: .3rem .34rem;
                background-position: .3rem center;
            }
            ul li:nth-child(8) {
                background: #fff url(../../image/icon_supply/icon_08.png)no-repeat;
                background-size: .34rem .34rem;
                background-position: .3rem center;
                display: none;
            }
            ul li:nth-child(9) {
                background: #fff url(../../image/icon_supply/icon_09.png)no-repeat;
                background-size: .34rem .34rem;
                background-position: .3rem center;
                display: none;
            }
            ul li:nth-child(10) {
                background: #fff url(../../image/icon_supply/icon_06.png)no-repeat;
                background-size: .33rem .34rem;
                background-position: .3rem center;
            }
            ul li:nth-child(11) {
                background: #fff url(../../image/icon_supply/icon_07.png)no-repeat;
                background-size: .33rem .34rem;
                background-position: .3rem center;
        }
    </style>
</head>
<body>
    <div class="contentText clearfix">
        <div class="title">
            <span class="smallTitle">#我提供#</span>
            <input type="text" placeholder="输入您发布的标题" id="title">
        </div>
        <textarea placeholder="描述一下您发布的内容" rows="5" id="description"></textarea>
        <div class="clearfix">
            <div class="fl addMedia">
                <span></span>
                添加图片
            </div>
            <div class="fl addMedia">
                <span></span>
                添加视频
            </div>
        </div>
        <p class="position" id="position"  tapmode="hover"   onclick="getPos()">北京 北京 海淀区</p>
    </div>
    <div class="classify clearfix">
        <ul>
            <li class="mt37">
                <span>截至时间</span>
                <span class="spanno2">选填</span>
            </li>

            <li   tapmode="hover"   onclick="selectType(this)" data-val="_type">
                <span>类型</span>
                <span class="spanno2 _type"></span>
            </li>
            <li class="companyName">
                <span>公司</span>
                <span class="spanno2"></span>
            </li>
            <li   tapmode="hover"   onclick="selectType(this)" data-val="_genre">
                <span>类别</span>
                <span class="spanno2 _genre" id="sub_type"></span>
            </li>
            <li tapmode="hover"   onclick="selectType(this)" data-val="_classify">
                <span>分类</span>
                <span class="spanno2 _classify"></span>
            </li>


            <li class="mt37"  tapmode="hover" >
                <span>赏金</span>
                <input type="text" name="" placeholder="选填" id="price">
            </li>
            <li   tapmode="hover"   onclick="selectType(this)" data-val="_format">
                <span>形式</span>
                <span class="spanno2 _format" id="form">选填</span>
            </li>


            <li class="companyName">
                <span>单位</span>
                <input type="text" name="" placeholder="选填">
            </li>
            <li class="companyName">
                <span>适用范围</span>
                <input type="text" name="" placeholder="选填">
            </li>


            <li class="mt37"   tapmode="hover"   onclick="remindWho()">
                <span>提醒谁看</span>
                <span class="spanno2"></span>
            </li>
            <li class="mb20">
                <span>定向投递</span>
                <span class="spanno2"></span>
            </li>
        </ul>        
    </div>
    <div class="btn" onclick="addSupply()">发布</div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    var type = 1, province,            //string  省份
                  ity,            //string  城市
                  ddress,         //string  地址
                  atitude,            //string  纬度
                  ongitude,           //string  经度; 
    apiready = function(){
        moduleInit();
        // 获取位置
        getPos();
        // 公司|个人 显示不同的页面
        showDifPage()
        // 选择类别
        monitorEvent('_genre','_genre');
        monitorEvent('_format','_format');
        monitorEvent('_classify','_classify');
    };


    // 添加供应
    function addSupply() {
        // 获取页面内容
        var token = $api.getStorage('userToken'),            //string  用户Token
            title = $api.val($api.byId('title')),           //string  标题
            sub_type = $api.text($api.byId('sub_type')) == '自产自销' ? 1 : 2,            //int 类别ID（1-自产自销，2-代理）
            category_id = 1,         //int 分类ID
            price = $api.val($api.byId('price')),           //float   价格
            // unit,            //string  单位
            form = $api.text($api.byId('form')) == '线上' ? 1 : 2,            //int 形式（1-线上，2-线下）
            description = $api.val($api.byId('description'));        //string  详细内容
            // image_json = [],          //string  图片（格式：["abc.jpg","ddd.jpg"]）
            company_id = 1;      // 公司ID（类型为2-我公司卖时必传）
            alert('标题 : '+ title +'---类别ID : '+sub_type+'---分类ID : '+category_id+'---价格 : '+price+'----形式'+form+'---内容: '+description +"---省份"+ province + "---地区" +city+ "---地址" +address+ "---纬度" +latitude+'---纬度: '+longitude)
                api.ajax({
                    url: apiSite + '/api/supply/add',
                    method: 'post',
                    headers: apiHeader,
                    data: {
                       values: { 
                            token: token,
                            title: title,
                            type: type,
                            sub_type: sub_type,
                            category_id: category_id,
                            province: province,
                            city: city,
                            address: address,
                            latitude: latitude,
                            longitude: longitude,
                            price: price,
                            unit: '个',
                            form: form,
                            description: description,
                            image_json: null,
                            company_id:1
                       }
                    }
                }, function(ret, err) {
                    if(ret) {
                        alert(JSON.stringify(ret))
                    } else {
                        alert(JSON.stringify(err))
                    }
                })
            
    }


    // 公司|个人 显示不同的页面
    function showDifPage () {
        api.addEventListener({
           name: 'selectType'
        }, function(ret, err) {
           if (ret) {
            $api.text($api.dom('._type'), ret.value.selDate);
            if (ret.value.selDate == '公司') {
                type = 2;
                for (var i = 0; i < $api.domAll('.companyName').length; i++) {
                    
                    $api.css($api.domAll('.companyName')[i], 'display: block');
                }
            } else {
                type = 1;
                for (var i = 0; i < $api.domAll('.companyName').length; i++) {
                    
                    $api.css($api.domAll('.companyName')[i], 'display: none');
                }
            }
           } else {
               alert(JSON.stringify(err));
           }
        });
    }
    // 提现谁看
    function remindWho() {
        api.openWin({
            name: 'supply_info_ask_remindWho',
            url: './supply_info_ask_remindWho.html'
            
        });
    }
    // 监听时间， 修改页面文本内容
    function monitorEvent(eventName, calssName) {
        api.addEventListener({
           name: eventName
        }, function(ret, err) {
           if (ret) {
            $api.text($api.dom('.'+ calssName +''), ret.value.selDate);
           } else {
               alert(JSON.stringify(err));
           }
        });
    }
    // 选择类型  公司 | 个人
    function selectType(ele) {
        var person =  $api.text(ele.getElementsByClassName('spanno2')[0]);

        var _data = $api.attr(ele, 'data-val');
        var flag;
        var _dataSource = [];
        if (_data == '_type') {
            _dataSource = ['个人','公司'];
            flag = 0;
            // var text = $api.text($api.dom('.type1'));
        } else if (_data == '_genre') {
            _dataSource = ['自产自销','代理'];
            flag = 1;
        } else if (_data == '_format') {
            _dataSource = ['线上','线下'];
            flag = 2;
        }else if (_data == '_classify') {
            _dataSource = ['全部','教育','摄影','医疗'];
            flag = 3;
        }
        

        api.openFrame({
                name: '_type',
                url: 'supply_selectType.html',
                rect: {
                    x: 0,
                    y: 0,
                    w: 'auto',
                    h: 'auto'
                },
                pageParam: {
                    dataSource: _dataSource,
                    flag: flag,
                    defaultVal: person
                },
                bounces: false
            });
    }


   // 获取位置
   function getPos() {
        if (api.systemType == 'ios') {
            bMap.initMapSDK(function(ret) {
                if (ret.status) {
                   getLocation();
                } else {
                    alert(JSON.stringify(err))
                }
            });
        } else {
            getLocation();
        }
        
   }
   // 获取经纬度
    function getLocation() {
        bMap.getLocation({
            accuracy: '100m',
            autoStop: true,
            filter: 1
        }, function(ret, err) {
            if (ret.status) {
                // alert(JSON.stringify(ret));
                getCoords(ret.lon, ret.lat)
                // alert('经度：' + ret.lon + '----' +'纬度:'+ret.lat)
                latitude = ret.lat;
                longitude = ret.lon;
            } else {
                alert(err.code);
            }
        });
    }
    // 根据经纬度获取地址
    function getCoords(lon,lat) {
        bMap.getNameFromCoords({
            lon: lon,
            lat: lat
        }, function(ret, err) {
            if (ret.status) {
                province = ret.city;
                city = ret.district;
                address = ret.address;
                // alert('地区'+ret.district + '省份'+ret.city +'地址'+ret.address )
                $api.text($api.byId('position'), address);
                // ret.district // 地区
                // ret.city // 省份
                // ret.address // 地址


            }
        });
    }
</script>
</html>