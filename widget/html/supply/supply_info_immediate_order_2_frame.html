<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>

        .main {
            margin-top: .2rem;
            font-size: 0;
            
        }
        
        .choose {
            height: .7rem;
            background-color: #fff;
            padding: 0 .3rem;
        }
        .choose p.name{
            font-size: .34rem;
            color: #000;
        }
         
         .choose img {
            width: .5rem;
            height: .5rem;
            border-radius: 50%;
        }
         .issuerInfo {
            font-size: .28rem;
            line-height: .3rem;
            margin-left: .1rem;
        }
        .issuerInfo p {
            font-size: .24rem;
            color: #9b9b9b;
        }
        
        footer {
            font-size: 0;   
            height: 1rem;   
            position: fixed;
            bottom: 0;  
            left: 0;    
            width: 100%;    
            background-color: #fff;
            border-top: .06rem solid #F8F8F8;
        }
        footer span {
            font-size: .34rem;  
            text-align: center; 
            float: left;
        }
        
        footer .priceTitle {
            height: 1rem;
            line-height: 1rem;
            color: #222;
            font-size: .34rem;
            width: 60%;
            padding-left: .3rem;
            box-sizing: border-box;
        }
        footer  #total{
            color: #F6A623;
            overflow: hidden;
            width: 3rem;
            text-align: left;
             text-overflow: ellipsis;
        }

        footer span.enter {
            font-size: .34rem;  
            width: 40%; 
            line-height: 1rem;  
            background-color: #0ABB07;
            color: #fff;
        }
         
        .main {
           margin-bottom: 1rem; 
        }
        .content {
            background-color: #F8F8F8;
            padding-left: .3rem;
            position: relative;
        }
        .content .div {
            padding-right: .2rem;
            padding-top: .3rem;
            padding-bottom: .3rem;
            border-bottom: .01rem solid #EFEFEF;
            border-top: .01rem solid #EFEFEF;
        }
        .content img {
            width: 1.45rem;
            height: 1.45rem;
            margin-right: .2rem;
           
        }
        .content ._type {
            /*display: inline-block;*/
            height: .28rem;
            width: .63rem;
            font-size: .2rem;
            border: .01rem solid #0076FF;
            color: #0076FF;
            border-radius: .06rem;
            margin-right: .1rem;
            text-align: center;
            line-height: .28rem;
        }
        .content .title {
            font-size: .34rem;
        }
        .content p {
            font-size: .24rem;
            /*position: absolute;*/
            /*bottom: .2rem;*/
            /*left: 1.95rem;*/

            color: #F6A623;
        }
        .main .price {
            padding: 0 .3rem;
            height: .8rem;
            line-height: .8rem;
            font-size: .34rem;
            color: #F6A623;
            background-color: #fff;
            margin-bottom: .2rem;
            /*position: relative;*/
        }

        .tel {
            background-color: #fff;
            font-size: .28rem;
            height: .8rem;
            line-height: .8rem;
            padding-left: .3rem;
            box-sizing: border-box;
        }
        .tel input {
            height: .8rem;
            outline: none;

        }
        .price .count {
            margin-top: .17rem;
            border: .01rem solid #B5B5B5;
            border-radius: .2rem;
            width: 1.45rem;
            height: .45rem;
            font-size: 0;
            text-align: center;
            line-height: .45rem;
            background-color: #fff;
        }
        .price .count i {
            display: inline-block;
            border-radius: 50%;
            width: .45rem;
            height: .45rem;
            font-style: normal;
            line-height: .4rem;
            font-size: .48rem;
            background-color: #fff;
            color: #0ABB07;
        }
        .price .count input {
            background-color: #fff;
            /*border-right: .01rem solid #979797;*/
            /*border-left: .01rem solid #979797;*/
            width: .4rem;
            text-align: center;
            display: inline-block;
            height: .45rem;
            font-size: .24rem;
            outline: none;
            border-radius: 0;
        }
        .serveTime {
            line-height: .8rem;
            /*padding: 0 .3rem;*/
            padding-left: .3rem;
            height: .8rem;
            background-color: #fff;
            font-size: .28rem;
            margin-top: 1px;
            box-sizing: border-box;
        }
        .serveTime .wrap {
            padding-right: .3rem;   
            box-sizing: border-box;
            border-bottom: .01rem solid #EBEBEB;
        }
        .serveTime span{
            color: #9A9A9A;
        }
        .serveTime i {
            display: inline-block;
            height: .8rem;
            width: .15rem;
            background: url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: 0 center;
            float: right;
            margin-left: .2rem;
        }
        .icon {
            width: .15rem;
            display: inline-block;
            height: .7rem;
            background: url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: 0 center;


        }
        .mt20 {
            margin-top: .2rem;
        }
        .info {
            background-color: #fff;
        }
    </style>
</head>
<body>
   
    <div class="main clearfix">
            <div class="resultList"></div>
            <script type="text/x-dot-template" id="listT">
                <div class="choose clearfix flex-def flex-zLeftRight flex-cCenter" data-id="{{=it.user_id}}" tapmode onclick="openUserInfoPage(this)">
                    <img src="{{=it.head_img_url}}">
                    <div class="issuerInfo flex-item flex-def flex-zLeftRight flex-cCenter flex-zBetween">
                        <div>
                            <span class="name">{{=it.nickname}}</span>
                            {{?it.current_company==null&&it.current_position!=null}}
                                <span> {{=it.current_position}}</span>
                            {{??it.current_position==null&&it.current_company!=null}}
                                <span>{{=it.current_company}}</span>
                            {{??it.current_position==null&&it.current_company==null}}
                            {{??}}
                                <span>{{=it.current_company}} {{=it.current_position}}</span>
                            {{?}}
                        </div>
                        <span class="icon"></span>
                    </div>
                </div>
                <div class="content clearfix">
                    <div class="div flex-def">
                        {{?it.image_json[0] == null}}
                        <img  src="../../image/noimage.jpg">
                        {{??}}
                        <img  src="{{=it.image_json[0]}}">
                        {{?}}
                        <div class="flex-def flex-zTopBottom flex-zBetween">
                            <div class="flex-def flex-cCenter">
                                <span class="_type">{{=it.type}}</span>
                                <span class="title">{{=it.title}}</span>
                            </div>
                            <p class="flex-def">{{=it.city}} - {{=it.district}} - {{?it.form == 1}}<span> 线上</span>{{??}}<span> 线下</span>
                            {{?}}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="price">
                    <span><span id="unitPrice">{{=it.price}}</span>元 / {{=it.unit}}</span>
                    <div class="fr count">
                        <i class="fl"   tapmode   onclick="subtractCount()">-</i>
                        <input id="buyCount" type="number" name="" value="1" onkeyup="computeTatol()">
                        <i class="fr"   tapmode   onclick="addCount()">+</i>
                    </div>
                </div>
            </script>
            <div class="info">
                <div class="serveTime" >
                    <div class="wrap">
                        交易时间
                        <i></i>
                        <span class="fr" id="serverTime" tapmode onclick="openTime(this)">请选择交易时间</span>
                    </div>
                </div>
                <div class="tel serveTime" tapmode onclick='openPhonePage(1)'>
                    <div class="wrap">
                        联系电话
                        <i></i>
                        <span class="fr" id="defaultPhone"></span>
                    </div>
                </div>
                <div class="tel serveTime" id="addressWrap" tapmode onclick='openPhonePage(0)'>
                    <div class="wrap">
                        地址
                        <i></i>
                        <span class="fr" id="address"></span>
                    </div>
                </div>
                <div class="tel serveTime" onclick="openEditName()" tapmode>
                    <div class="wrap">
                        真实姓名
                        <i></i>
                        <span class="fr" id="real_name"></span>
                    </div>
                </div>
                
            </div>
            <div class="tel mt20">
                <div class="wrap">
                    <p>备注：
                        <input type="text" id="note"  placeholder="填写备注" name="">
                    </p>
                </div>
            </div>
    </div>
    <footer>    
    
            <span class="priceTitle">
                <span>合计：</span>
                <span id="total">
                    <span>￥</span>
                    <span id="price">123</span>
                </span>
            </span>
            
            <span class="enter" tapmode onclick="enterPay()">确认支付</span>
    </footer>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript">
    var price=0;
    apiready = function(){
        getData(api.pageParam.transmitData)
        console.log(JSON.stringify(api.pageParam.transmitData))
        computeTatol();
        // 初始化页面
        // 判断是否是新用户
        // if ($api.getStorage('userAddress') != '') {
        initPage();
        // }
        // 线上服务不要地址
        if (api.pageParam.transmitData.form === 1) {
            $api.css($api.byId('addressWrap'), 'display:none');
        } else {
            api.addEventListener({
                name: 'callbackAddress'
            }, function(ret, err) {
                if (ret) {
                    $api.attr($api.byId('address'), 'data-id', ret.value.addressId);
                    $api.text($api.byId('address'), ret.value.province +' '+ ret.value.city+ ' ' + ret.value.district+ ' ' +ret.value.callbackAddress);
                    console.log('360:::'+$api.attr($api.byId('address'), 'data-id'))
                } else {
                    alert(JSON.stringify(err));
                }
            });
        }
        api.addEventListener({
            name: 'callbackPhone'
        }, function(ret, err) {
            if (ret) {
                console.log(JSON.stringify(ret))
                $api.text($api.byId('defaultPhone'), ret.value.phone);
                $api.attr($api.byId('defaultPhone'), ret.value.id);
            } else {
                alert(JSON.stringify(err));
            }
        });
        api.addEventListener({
            name: 'editSupplyName'
        }, function(ret, err) {
            if (ret) {
                 $api.text($api.byId('real_name'), ret.value.name);
            } else {
                alert(JSON.stringify(err));
            }
        });
    };
    // 进入个人详情页面
    function openUserInfoPage(ele) {
        api.openWin({
            name: 'txl_memberInfo_Win',
            url: '../addressList/txl_memberInfo_Win.html',
            pageParam: {
                userId: $api.attr(ele, 'data-id')
            }
        });
    }
    // 编辑姓名
    function openEditName() {

        api.openWin({
            name: 'supply_editName',
            url: './supply_editName.html',
            pageParam: {
                name: $api.text($api.byId('real_name'))
            }
        });
    }
    // 选择电话
    function openPhonePage(n) {
        if (n) {
            api.openWin({
                name: 'supply_getStroagePhone',
                url: './supply_getStroagePhone.html'
            });
        } else {
            console.log('403:::'+$api.attr($api.byId('address'), 'data-id'))
            var id = $api.attr($api.byId('address'), 'data-id');
            api.openWin({
                name: 'supply_getStroageAddress',
                url: './supply_getStroageAddress.html',
                pageParam: {
                    id: id
                }
            });
        }
    }
    // 确认支付
    function enterPay() {
        // 获取表单数据
         var supply_id = api.pageParam.transmitData.supply_id;        //   int 供应ID
         // console.log(supply_id)
         var amount = $api.val($api.byId('buyCount'));        //  int 数量
         var note = $api.val($api.byId('note'));        //  int 数量
         // console.log(amount)
         var service_time = $api.text($api.byId('serverTime'));        //    string  服务时间
         var paramPhone = $api.text($api.byId('defaultPhone'));        //    string  服务时间
         // console.log(service_time)
         // var pay_method = ;        //  string  支付方式（仅限付费圈子：balance-余额，wechat-微信支付，alipay-支付宝）
         var name = $api.text($api.byId('real_name'));        //    string  姓名（线下供应必传）
         // console.log(name)
         var contact_id = $api.attr($api.byId('defaultPhone'), 'data-id');        //  float   用户联系方式ID（线下供应必传）
         // console.log(contact_id)
         var address_id = $api.attr($api.byId('address'), 'data-id');        //
         // console.log(address_id)
         if (api.pageParam.transmitData.form === 1) {
            // 线上 服务时间
            if (service_time == '请选择交易时间') {
                alert('请选择交易时间')
                
            } else {
                var obj = {
                    supply_id: supply_id,
                    amount: amount,
                    service_time: service_time,
                    name: name,
                    contact_id: contact_id,
                    address_id: address_id,
                    note: note
                }

                console.log("429:::"+JSON.stringify(obj))
                api.openFrame({
                    name: 'supply_modeOfPayment',
                    url: './supply_modeOfPayment.html',
                    rect: {
                        x: 0,
                        y: 0,
                        w: 'auto',
                        h: 'auto'
                    },
                    pageParam: {
                        obj: obj,
                        price: price,
                        form: api.pageParam.transmitData.form,
                        paramPhone: paramPhone
                    },
                    bounces: false
                });
            }
         } else {
            // 线下  姓名  联系方式  地址
            if (service_time == '请选择交易时间') {
                alert('请选择交易时间')
            } else if (name == '未设置真实姓名') {
                alert('请设置真实姓名')
            } else if (contact_id == null) {
                alert('请选择联系方式')
            } else if (address_id == null) {
                alert('请选择地址')
            } else {
                var obj = {
                    supply_id: supply_id,
                    amount: amount,
                    service_time: service_time,
                    name: name,
                    contact_id: contact_id,
                    address_id: address_id,
                    note: note
                }

                console.log("429:::"+JSON.stringify(obj))
                api.openFrame({
                    name: 'supply_modeOfPayment',
                    url: './supply_modeOfPayment.html',
                    rect: {
                        x: 0,
                        y: 0,
                        w: 'auto',
                        h: 'auto'
                    },
                    pageParam: {
                        obj: obj,
                        price: price,
                        form: api.pageParam.transmitData.form,
                        paramPhone: paramPhone
                    },
                    bounces: false
                });
            }
         }
         
         
    }
    // 初始化页面
    function initPage() {
        var userPhone = $api.getStorage('userPhone') || '';
        var userAddress = $api.getStorage('userAddress') || '';
        var real_name = $api.getStorage('real_name') || '';

        console.log(JSON.stringify(userAddress))
        if (userAddress != '') {
            $api.text($api.byId('address'), userAddress[0].province +' '+userAddress[0].city +' '+userAddress[0].district +' '+userAddress[0].district);
            $api.attr($api.byId('address'), 'data-id', userAddress[0].address_id);
        } else {
             $api.text($api.byId('address'), '未设置默认地址')
        }
        // 设置真实姓名
        if (real_name != '') {
            $api.text($api.byId('real_name'), real_name);
        } else {
            api.ajax({
                url: apiSite + '/user_center/editBasicInfoIndex',
                method: 'post',
                headers: apiHeader,
                data: {
                       values: { 
                           token: $api.getStorage('userToken'),
                       }
                }
            }, function(ret, err) {
                if(ret) {
                    // alert(JSON.stringify(ret))
                    if (ret.data.info.real_name) {
                        $api.text($api.byId('real_name'), ret.data.info.real_name);
                    } else {
                        $api.text($api.byId('real_name'), '未设置真实姓名');
                    }
                } else {
                    alert(JSON.stringify(err))
                }
            })

        }
        // 设置电话
        if (userPhone != '') {
            for (var i = 0; i < userPhone.length; i++) {
                if (userPhone[i].is_default) {
                    $api.attr($api.byId('defaultPhone'), 'data-id', userPhone[i].contact_id);
                    userPhone = userPhone[i].phone;
                    $api.text($api.byId('defaultPhone'), userPhone);
                    break;
                }
            }
        } else {
            $api.text($api.byId('defaultPhone'), '未设置默认联系方式');
        }
       // 打开时间选择器
    }
    // 选择时间
    function openTime(ele) {
        for (var i = 0; i < $api.domAll('input').length; i++) {
            $api.domAll('input')[i].blur()
        }
        var text = '选择交易时间';
        var date, date1, date2, date3, date4;
        var current = $api.text(ele);
        if (current != '请选择交易时间') {
            current = current.split(' ')
            var current1 = current[0].split('-')
            var current2 = current[1].split(':')
            current = current1.concat(current2)
            date = current[0];
            date1 = current[1];
            date2 = current[2];
            date3 = current[3];
            date4 = current[4];
        } else　 {
            date = new Date().getFullYear();
            date1 = new Date().getMonth()+1;
            date2 = new Date().getDate();
        }
        api.openPicker({
            type: 'date-time',
            date: date + '-' + date1 + '-' + date2 + ' ' + date3 + ':' + date4,
            title: text
        }, function(ret, err) {
            if (ret) {
                if (ret.minute < 10) {
                    ret.minute = '0' + ret.minute
                }
                if (ret.hour < 10) {
                    ret.hour = '0' + ret.hour
                }
                var time = new Date();
                if (
                    ret.year < time.getFullYear() || 
                    (ret.year === time.getFullYear() && ret.month < time.getMonth()+1) ||
                    (ret.year === time.getFullYear() && ret.month === time.getMonth()+1 && ret.day < time.getDate()) ||
                    (ret.year === time.getFullYear() && ret.month === time.getMonth()+1 && ret.day === time.getDate() && ret.hour < time.getHours()) ||
                    (ret.year === time.getFullYear() && ret.month === time.getMonth()+1 && ret.day === time.getDate() && ret.hour === time.getHours() && ret.minute < time.getMinutes() )
                          ) {
                    alert('服务时间不能早于当前时间')
                } else {
                    $api.text(ele, ret.year + '-' + ret.month + '-' + ret.day + ' ' + ret.hour + ':' + ret.minute);
                }        
               
            } else {
                alert(JSON.stringify(err.msg));
            }
        });
    }

    // 计算总价
    function computeTatol () {

        var unitPrice = $api.text($api.byId('unitPrice')) || api.pageParam.transmitData.price;
        var buyCount = $api.val($api.byId('buyCount')) || 1;
        if (buyCount < 1) {
            $api.val($api.byId('buyCount'),1)
            buyCount = 1;
        }
        price = unitPrice * buyCount
        $api.text($api.byId('price'), price);
    }
    
    // 增减数量
    var count = 0;
    function addCount() {
        $api.val($api.byId('buyCount'), ++count);
         computeTatol();
     }
    function subtractCount() {
        if (count < 1) {
            count =1
        }
        $api.val($api.byId('buyCount'), --count);
        computeTatol();
    }


  
</script>
</html>


