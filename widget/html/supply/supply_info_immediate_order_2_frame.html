<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
        html,body {
            background-color: #F8F8F8;
        }

        .main {
            /*margin-top: .2rem;*/
            font-size: 0;
            
        }
        
        .choose {
            height: 1rem;
            background-color: #fff;
            padding: 0 .3rem;
        }
        .choose p.name{
            font-size: .34rem;
            color: #000;
        }
         
         .choose img {
            width: .71rem;
            height: .71rem;
        }
         .issuerInfo {
            font-size: .28rem;
            line-height: .3rem;
            margin-left: .1rem;
        }
        .issuerInfo p {
            font-size: .24rem;
            color: #9b9b9b;
        }
        
        footer {
            font-size: 0;   
            height: 1rem;   
            position: fixed;
            bottom: 0;  
            left: 0;    
            width: 100%;    
            background-color: #fff;
            border-top: .06rem solid #F8F8F8;
        }
        footer span {
            font-size: .34rem;  
            text-align: center; 
            float: left;
        }
        
        footer .priceTitle {
            height: 1rem;
            line-height: 1rem;
            color: #222;
            font-size: .34rem;
            width: 60%;
            padding-left: .3rem;
            box-sizing: border-box;
        }
        footer  #total{
            color: #d0011b;
            overflow: hidden;
            width: 3rem;
            text-align: left;
             text-overflow: ellipsis;
        }

        footer span.enter {
            font-size: .34rem;  
            width: 40%; 
            line-height: 1rem;  
            background-color: #0ABB07;
            color: #fff;
        }
         
        .main {
           margin-bottom: 1rem; 
        }
        .content {
            background-color: #F8F8F8;
            padding: .2rem .3rem;
            position: relative;
        }
        .content img {
            width: 1.45rem;
            height: 1.45rem;
            margin-right: .2rem;
           
        }
        .content ._type {
            display: inline-block;
            height: .28rem;
            width: .63rem;
            background: url(../../image/icon_supply/icon_gs.png)no-repeat;
            -webkit-background-size: .63rem .28rem;
            background-size: .63rem .28rem;
            margin-right: .1rem;
        }
        .content .title {
            font-size: .34rem;
        }
        .content p {
            font-size: .24rem;
            position: absolute;
            bottom: .2rem;
            left: 1.95rem;
            color: #d0011b;
        }
        .main .price {
            padding: 0 .3rem;
            height: .8rem;
            line-height: .8rem;
            font-size: .34rem;
            color: #d0011b;
            background-color: #fff;
            margin-bottom: .2rem;
            /*position: relative;*/
        }

        .tel {
            background-color: #fff;
            font-size: .28rem;
            height: .8rem;
            line-height: .8rem;
            padding: 0 .3rem;
            border-bottom: 1px solid #f8f8f8;
        }
        .tel input {
            height: .8rem;
            outline: none;

        }
        .price .count {
            margin-top: .17rem;
            border: 1px solid #B5B5B5;
            border-radius: .2rem;
            width: 1.45rem;
            height: .45rem;
            font-size: 0;
            text-align: center;
            line-height: .45rem;
            background-color: #F8F8F8;
        }
        .price .count i {
            display: inline-block;
            width: .4rem;
            height: .4rem;
            font-style: normal;
            line-height: .4rem;
            font-size: .48rem;
            color: #333;
        }
        .price .count input {
            background-color: #fff;
            border-right: 1px solid #979797;
            border-left: 1px solid #979797;
            width: .4rem;
            text-align: center;
            display: inline-block;
            height: .45rem;
            font-size: .24rem;
            outline: none;
            border-radius: 0;
        }
        .serveTime {
            line-height: .8rem;
            padding: 0 .3rem;
            height: .8rem;
            background-color: #fff;
            font-size: .28rem;
            
        }
        .serveTime span{
            color: #9A9A9A;
        }
        .serveTime i {
            display: inline-block;
            height: .8rem;
            width: .15rem;
            background: url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
            background-position: 0 center;
            float: right;
            margin-left: .2rem;
        }

    </style>
</head>
<body>
   
    <div class="main clearfix">
            <div class="resultList"></div>
            <script type="text/x-dot-template" id="listT">
                <div class="choose clearfix flex-def flex-cCenter">
                    <img src="../../image/tx_3.jpg">
                    <div class="fl issuerInfo">
                        <p class="name">{{=it.nickname}}</p>
                        {{?it.current_company==null&&it.current_position!=null}}
                            <p> {{=it.current_position}}</p>
                        {{??it.current_position==null&&it.current_company!=null}}
                            <p>{{=it.current_company}}</p>
                        {{??it.current_position==null&&it.current_company==null}}
                        {{??}}
                            <p>{{=it.current_company}} {{=it.current_position}}</p>
                        {{?}}
                    </div>
                </div>
                <div class="content clearfix">
                    <img class="fl" src="../../image/tx_5.jpg">
                    <div class="fl">
                        <span class="_type"></span>
                        <span class="title">{{=it.title}}</span>
                        <p >{{=it.city}} - 
                        {{?it.form == 1}}
                            <span>线上</span>
                        {{??}}
                            <span>线下</span>
                        {{?}}
                        </p>
                    </div>
                </div>
                <div class="price">
                    <span><span id="unitPrice">{{=it.price}}</span>元 / {{=it.unit}}</span>
                    <div class="fr count">
                        <i class="fl"   tapmode="hover"   onclick="subtractCount()">-</i>
                        <input id="buyCount" type="text" name="" value="1" onkeyup="computeTatol()">
                        <i class="fr"   tapmode="hover"   onclick="addCount()">+</i>
                    </div>
                </div>
            </script>
            <div class="serveTime" >
                服务时间
                <i></i>
                <span class="fr" id="serverTime" ontouchstart="openTime(this)">请选择服务时间</span>
            </div>
            <div class="tel serveTime">
                联系电话
                <i></i>
                <span class="fr" id="defaultPhone"></span>
            </div>
            <div class="tel serveTime">
                地址
                <i></i>
                <span class="fr" id="address"></span>
            </div>
           <div class="tel serveTime">
                真实姓名
                <i></i>
                <span class="fr" id="real_name"></span>
            </div>
            <div class="tel">
                <p>备注：
                    <input type="text" placeholder="填写备注" name="">
                </p>
            </div>
    </div>
    <footer>    
    
            <span class="priceTitle">
                <span>合计：</span>
                <span id="total">
                    <span>￥</span>
                    <span id="price">123</span>
                </span>
            </span>
            
            <span class="enter" ontouchstart="enterPay()">确认支付</span>
    </footer>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript">
    var price=0;
    apiready = function(){
        
        getData(api.pageParam.transmitData)
        computeTatol();
        // 初始化页面
        initPage();

        

    };
    // 确认支付
    function enterPay() {
        // 获取表单数据
         var supply_id = api.pageParam.supply_id;        //   int 供应ID
         // console.log(supply_id)
         var amount = $api.val($api.byId('buyCount'));        //  int 数量
         // console.log(amount)
         var service_time = $api.text($api.byId('serverTime'));        //    string  服务时间
         // console.log(service_time)
         // var pay_method = ;        //  string  支付方式（仅限付费圈子：balance-余额，wechat-微信支付，alipay-支付宝）
         var name = $api.text($api.byId('real_name'));        //    string  姓名（线下供应必传）
         // console.log(name)
         var contact_id = $api.attr($api.byId('defaultPhone'), 'data-id');        //  float   用户联系方式ID（线下供应必传）
         // console.log(contact_id)
         var address_id = $api.attr($api.byId('address'), 'data-id');        //
         // console.log(address_id)
         var obj = {
            supply_id: supply_id,
            amount: amount,
            service_time: service_time,
            name: name,
            contact_id: contact_id,
            address_id: address_id
         }
         // console.log(JSON.stringify(obj))
        api.openFrame({
            name: 'supply_modeOfPayment',
            url: './supply_modeOfPayment.html',
            rect: {
                x: 0,
                y: 0,
                w: 'auto',
                h: 'auto'
            },
            pageParam: {
                obj: obj,
                price: price
            },
            bounces: false
        });
    }
    // 初始化页面
    function initPage() {
        var userPhone = $api.getStorage('userPhone') || '';
        var userAddress = $api.getStorage('userAddress') || '';
        var real_name = $api.getStorage('real_name') || '';
        // 设置地址
        if (userAddress) {
            $api.text($api.byId('address'), userAddress[0].province +' '+userAddress[0].city +' '+userAddress[0].district +' '+userAddress[0].district);
            $api.attr($api.byId('address'), 'data-id', userAddress[0].address_id);
        } else {
             $api.text($api.byId('address'), '未设置默认地址')
        }
        // 设置真实姓名
        if (real_name) {
            $api.text($api.byId('real_name'), real_name);
        } else {
            $api.text($api.byId('real_name'), '未设置真实姓名');
        }
        // 设置电话
        if (userPhone) {
            for (var i = 0; i < userPhone.length; i++) {
                if (userPhone[i].is_default) {
                    $api.attr($api.byId('defaultPhone'), 'data-id', userPhone[i].contact_id);
                    userPhone = userPhone[i].phone;
                    $api.text($api.byId('defaultPhone'), userPhone);
                    break;
                }
            }
        } else {
            $api.text($api.byId('defaultPhone'), '未设置默认联系方式');
        }
       // 打开时间选择器
    }
    // 选择时间
    function openTime(ele) {                                                                                                                                     for (var i = 0; i < $api.domAll('input').length; i++) {             $api.domAll('input')[i].blur()         }
        var text = '选择服务时间';

        var date, date1, date2, date3, date4;
        var current = $api.text(ele);
        if (current!='请选择服务时间') {
            current = current.split(' ')
            var current1 = current[0].split('-')
            var current2 = current[1].split(':')
            current = current1.concat(current2)
            date = current[0];
            date1 = current[1];
            date2 = current[2];
            date3 = current[3];
            date4 = current[4];
        } else　{
            date = new Date().getFullYear();
            date1 = new Date().getMonth();
            date2 = new Date().getDate();
        }
        api.openPicker({
            type: 'date-time',
            date: date+'-'+date1+'-'+date2+' '+date3+':'+date4,
            title: text
        }, function(ret, err) {
            if (ret) {
                if (ret.minute<10) {
                    ret.minute = '0'+ret.minute
                }
                if (ret.hour<10) {
                    ret.hour = '0'+ret.hour
                }
                $api.text(ele, ret.year+'-'+ret.month+'-'+ret.day+' '+ret.hour+':'+ret.minute);
            } else {
                alert(JSON.stringify(err));
            }
        });
    }

    // 计算总价
    function computeTatol () {
        var unitPrice = $api.text($api.byId('unitPrice')) || api.pageParam.transmitData.price;
        var buyCount = $api.val($api.byId('buyCount')) || 1;
        price = unitPrice * buyCount
        $api.text($api.byId('price'), price);

    }
    
    // 增减数量
    var count = 0;
     function addCount() {
        $api.val($api.byId('buyCount'), ++count);
         computeTatol();
     }
     function subtractCount() {
        if (count < 1) {
            count =1
        }
        $api.val($api.byId('buyCount'), --count);
        computeTatol();
     }
    // 切换留言和详情
    function datum(n,ele) {
        for (var i = 0; i < $api.domAll('.no5Title').length; i++) {
            $api.removeCls($api.domAll('.no5Title')[i], 'borderBottom');
        }
        if (n) { // 传入1  点击留言
            $api.css($api.dom('.detail'), 'display:none');
            $api.css($api.dom('.leaveWord'), 'display:block');
            $api.addCls($api.first(ele, 'span'), 'borderBottom');
        } else { // 点击详情
            $api.css($api.dom('.detail'), 'display:block');
            $api.css($api.dom('.leaveWord'), 'display:none');
            $api.addCls($api.first(ele, 'span'), 'borderBottom');
        }
    }
   



    var a = 1;
    $api.addEvt($api.dom('.main'), 'touchmove', function(event) {
        if (window.scrollY > 300) {
            a -= 0.1;
            $api.css($api.byId('cloaswin'), 'opacity:'+ a +';');
            if (a<0) {
                a = 0;
            }
        } else {
            a += 0.1;
            $api.css($api.byId('cloaswin'), 'opacity:'+ a +';');
            if (a>1) {
                a = 1;
            }
        }
    });
    $api.addEvt($api.dom('.main'), 'touchend', function(event) {
        if (window.scrollY > 300) {
            // $api.css($api.dom('#cloaswin'), 'display:none');
            $api.css($api.byId('cloaswin'), 'opacity:0;');
        } else {
            $api.css($api.byId('cloaswin'), 'opacity:1;');
        }
    });
   
</script>
</html>


