<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <style>
        .no_data {
            background-color: #EDECF3;
            text-align: center;
            color: #999;
            font-size: .3rem;
            margin-top: .5rem;
        }
        
        .bbottomLoading {
            text-align: center;
            font-size: .24rem;
            color: #999;
            line-height: .8rem;
            display: none;
        }
        
        .item {
            width: 7.5rem;
            /* height: 5.7rem; */
            background-color: #fff;
            padding: 0.2rem;
            box-sizing: border-box;
            margin-bottom: 0.1rem;
            border-bottom: .01rem solid #d9d9d9;
        }
        
        .firstImg {
            display: inline-block;
            width: 100%;
            height: 4.04rem;
            margin-top: 0.2rem;
            border-radius: .1rem;
            position: relative;
        }
        
        .price {
            display: inline-block;
            border-bottom-left-radius: .1rem;
            border-bottom-right-radius: .1rem;
            box-sizing: border-box;
            padding: 0 .2rem;
            height: 0.5rem;
            line-height: 0.5rem;
            background-color: rgba(0, 0, 0, .4);
            width: 100%;
            font-size: 0;
            position: absolute;
            bottom: 0;
            left: 0;
            color: #fff;
            text-align: right
        }
        
        .price span {
            font-size: 0.24rem;
        }
        
        .name,
        .user {
            height: 0.48rem;
            font-size: 0;
            margin-bottom: 0.2rem;
        }
        
        .user {
            margin: 0;
            padding: 0.02rem 0;
        }
        
        .createTime {
            margin-bottom: 0.24rem;
        }
        
        .title {
            font-weight: bolder;
            font-size: 0.3rem;
            max-width: 5rem;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }
        
        .announcer {
            font-size: 0.26rem;
        }
        
        .announcerHead {
            width: 0.72rem;
            height: 0.72rem;
            border-radius: 50%;
        }
        
        .name .icon {
            width: 1rem;
            height: 0.48rem;
            background: url(../../image/icon_supply/icon_collecr03.png)no-repeat;
            background-size: .36rem .31rem;
            background-position: right center;
        }
        
        .name .collect {
            background: url(../../image/icon_supply/icon_collecr04.png)no-repeat;
            background-size: .36rem .31rem;
            background-position: right center;
        }
        
        .user .icon {
            padding-left: 0.35rem;
            height: 0.48rem;
            background: url(../../image/icon_supply/icon_pageviews.png)no-repeat;
            background-size: .26rem .16rem;
            background-position: left center;
            font-size: 0rem;
        }
        
        .icon .count {
            font-size: 0.18rem;
            color: #999;
        }
        
        .company {
            color: #999;
            font-size: 0.22rem;
        }
        
        .price2 {
            font-weight: 500;
            font-size: 0.28rem;
            color: #CC0019;
        }
        
        .username {
            margin-left: 0.2rem;
        }
        
        .label {
            font-size: 0.2rem;
            color: #CC0019;
        }
        
        .createTime {
            font-size: 0.24rem;
        }
        
        .classifyLabel {
            border: .01rem solid #0ABB07;
            color: #0ABB07;
            font-size: 0.24rem;
            border-radius: .17rem;
            padding: 0 .12rem;
        }
        
        .position {
            padding-left: 0.3rem;
            background: url(../../image/icon_supply/icon_position.png)no-repeat;
            background-size: .18rem .24rem;
            background-position: left center
        }
        
        .distance {
            padding-left: 0.3rem;
            background: url(../../image/icon_supply/icon_distance.png)no-repeat;
            background-size: .2rem .2rem;
            background-position: left center
        }
    </style>
</head>

<body>
    <!-- <div class="title1">
        <p class="results"   tapmode   onclick="viewResults(this)">
            <span></span>
           当筛选结果有变动时通知我
        </p>
    </div> -->
    <div class="main resultList"></div>
    <script type="text/x-dot-template" id="listT">
        {{?it.length === 0}}
        <p class="no_data">暂无数据</p>
        {{??}} {{ for (var i = 0; i
        < it.length; i++) { }} <div class="item" data-id="{{=it[i].demand_id}}" data-company="{{=it[i].company_name}}" tapmode onclick="info(this)">
            <div class="userLeft flex-def flex-cCenter flex-zBetween" tapmode data-id="{{=it[i].user_id}}" onclick="openUserInfoPage(this);event.stopPropagation(); ">
                <img src="{{=it[i].head_img_url}}?imageView2/1/w/150/h/150/interlace/1/q/100|imageslim" class="announcerHead">
                <div class="username flex-item">
                    <p class="announcer">{{=it[i].nickname}}</p>
                    <p class="company">{{=it[i].company_name}}</p>
                </div>
                <p class="price2">{{=it[i].reward}}元</p>
            </div>
            <span class="firstImg" style="background: url({{=it[i].image_json[0]?it[i].image_json[0]:'../../image/icon_supply/supply_noImg.png'}})no-repeat;background-size: 7.1rem auto;background-position: center center;">
                    {{?it[i].distance  || it[i].distance==0}}
                    <span class="price ">
                                    <!-- <span class="position fl">清华大学</span> -->
            <span class="distance">距离我{{=it[i].distance}}km</span>
            </span>
            {{?}}
            </span>
            <div class="name flex-def flex-cCenter flex-zBetween ">
                <span class="title  flex-def flex-cCenter"><span>{{=it[i].title}}</span>&nbsp;<span class="label">[{{=it[i].type == 2?'公司':'个人'}}]</span></span>
                <span tapmode data-id="{{=it[i].demand_id}}" onclick="collect(this);event.stopPropagation();" class=" {{=it[i].is_collect==true?" collect icon ":"icon "}} "></span>
            </div>
            <p class="createTime">{{=it[i].create_time}}</p>
            <div class="user flex-def flex-cCenter flex-zBetween ">
                <!-- <div class="userLeft flex-def flex-cCenter " tapmode data-id="{{=it[i].user_id}}" onclick="openUserInfoPage(this);event.stopPropagation(); ">
                                <img src="{{=it[i].head_img_url}}?imageView2/1/w/150/h/150/interlace/1/q/100|imageslim" class="announcerHead" >
                                <span class="announcer">{{=it[i].nickname}}</span>
                                <span class="company">{{=it[i].company_name}}</span>
                            </div> -->
                <span class="classifyLabel">{{=it[i].category_name}}</span>
                <span class="icon flex-def flex-cCenter "><span class="count ">{{=it[i].browse_count}}</span></span>
            </div>
            </div>
            {{ }; }} {{?}}
    </script>
    <p class="bbottomLoading">正在加载...</p>

</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>

<script type="text/javascript">
    var _dataSource = ["次", "幅", "单", "小时", "分钟", "天", "周", "月", "份", "个", "扇", "课时", "面议", "其他"];
    var dataList = [],
        page_num = 1,
        dataListFlag = [],
        selectedObj, condition, parameter, flag;
    apiready = function() {
        moduleInit();
        api.execScript({
            name: 'winName',
            frameName: 'frmName',
            script: 'funcGoto();'
        });
        // 请求数据
        requireData();
        // 筛选后的结果
        bySelect();
        // 下拉刷新
        api.setCustomRefreshHeaderInfo({
            bgColor: '#EFEFF4',
        }, function(ret, err) {
            page_num = 1;
            //在这里从服务器加载数据，加载完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
            requireData(condition, 'setCustomRefreshHeaderInfo');
        });
        api.addEventListener({
            name: 'editSupplyAfter'
        }, function(ret, err) {
            if (ret) {
                dataList = [];
                page_num = 1;
                requireData();
            } else {
                alert(JSON.stringify(err));
            }
        });
        // 上啦加载
        scrollBotton()
    };
    // 用户详情页面
    function openUserInfoPage(ele) {
        var userId = $api.attr(ele, 'data-id');
        api.openWin({
            name: 'winName',
            url: '../addressList/txl_memberInfo_Win.html',
            pageParam: {
                userId: userId
            }
        });
    }
    var scrollFlag = 1;
    // 滚动到底部触发的事件
    function scrollBotton() {
        // 滚动到底部触发的事件
        api.addEventListener({
            name: 'scrolltobottom',
            extra: {
                threshold: 0 //设置距离底部多少距离时触发，默认值为0，数字类型
            }
        }, function(ret, err) {
            // alert('已滚动到底部');
            // if ($api.text($api.dom('.bbottomLoading')) == '暂无更多供求') {
                //console.log('已滚动到底部, 不继续请求')
            // } else {
                if (scrollFlag) {
                    //console.log('继续请求')
                    scrollFlag = 0;
                    $api.css($api.dom('.bbottomLoading'), 'display: block');
                    if (page_num == 1) {
                        page_num = 2;
                    }
                    requireData2(condition);
                }
            // }

        });
    }
    // 收藏
    function collect(ele) {
        var url;
        if ($api.hasCls(ele, 'collect')) {
            // 已收藏
            // $api.removeCls(ele, 'collect');
            url = '/demand/cancelCollect';
        } else {
            // 未收藏
            // $api.addCls(ele, 'collect');
            url = '/demand/collect';
        }
        api.ajax({
            url: apiSite + url,
            method: 'post',
            headers: apiHeader,
            data: {
                values: {
                    token: $api.getStorage('userToken'),
                    demand_id: $api.attr(ele, 'data-id')
                }
            }
        }, function(ret, err) {
            if (ret) {
                if ($api.hasCls(ele, 'collect')) {
                    // 已收藏
                    $api.removeCls(ele, 'collect');
                    api.toast({
                        msg: '取消收藏成功'
                    });
                } else {
                    // 未收藏
                    $api.addCls(ele, 'collect');
                    api.toast({
                        msg: '收藏供应成功'
                    });
                }
            } else {
                alert(JSON.stringify(err.msg))
            }
        })
    }

    function requireData2(data) {
        var data = data || {};
        var latitude, longitude;
        page_num++;
        // if (data !== {}) {
        //     if (data.order == 'distance') {
        bMap.getLocation({
            accuracy: '100m',
            autoStop: true,
            filter: 1
        }, function(ret, err) {
            if (ret.status) {
                data.latitude = ret.lat;
                data.longitude = ret.lon;
                api.ajax({
                    url: apiSite + '/demand/index',
                    method: 'post',
                    headers: apiHeader,
                    data: {
                        values: {
                            token: $api.getStorage('userToken'),
                            // keyword: '',
                            type: data.type || '',
                            sub_type: data.sub_type || '',
                            category_ids: data.category_ids || '',
                            order: data.order || '',
                            latitude: data.latitude || '',
                            longitude: data.longitude || '',
                            page_num: page_num
                        }
                    }
                }, function(ret, err) {
                    if (ret) {
                        if (ret.code == 200) {
                            scrollFlag = 1;
                            
                            if (ret.data.list < 20) {
                                $api.text($api.dom('.bbottomLoading'), '暂无更多供求');
                            } else {
                                $api.css($api.dom('.bbottomLoading'), 'display: none');
                            }
                            renderPage(ret);
                        } else {
                            alert(ret.msg)
                        }
                    } else {
                        alert(JSON.stringify(err.msg))
                    }
                })
            } else {
                api.toast({
                    msg: '请在设置中打开定位权限',
                    duration: 2000,
                    location: 'bottom'
                });
                $api.css($api.dom('.loading'), 'display: none');
                api.refreshHeaderLoadDone()
            }
        });
        //     }
        // }

    }
    // 渲染页面
    function renderPage(ret, bottomFlag) {
           
        if (bottomFlag === 'setCustomRefreshHeaderInfo') {
            dataList = [];
        }
        for (var i = 0; i < ret.data.list.length; i++) {
            // 解析图片json
            ret.data.list[i].image_json = eval(ret.data.list[i].image_json);

            if (ret.data.list[i].unit == 0) {
                ret.data.list[i].unit = _dataSource[_dataSource.length - 1]
            } else {
                ret.data.list[i].unit = _dataSource[ret.data.list[i].unit - 1]
            }
            var retSql = db.selectSqlSync({
                name: 'db_' + $api.getStorage('userToken'),
                sql: 'SELECT * FROM addressList_simplify WHERE user_id = ' + ret.data.list[i].user_id
            });
            if (retSql.status) {
                // 如果有备注返回备注
                if (retSql.data.length == 1) {
                    ret.data.list[i].company_name = retSql.data[0].subTitle;
                    ret.data.list[i].head_img_url = retSql.data[0].img;
                    ret.data.list[i].nickname = retSql.data[0].title;
                }
            } else {
                alert('292' + JSON.stringify(err));
            }
        }
        for (var i = 0; i < ret.data.list.length; i++) {
            dataList.push(ret.data.list[i])
        }
        getData(dataList);
    }
    // 根据上传图片的多少自适应图片的大小
    function selfAdaption() {
        var listContent = $api.domAll('.item');
        for (var i = 0; i < listContent.length; i++) {
            var imgArr = listContent[i].getElementsByClassName('content_img');
            var imgCount = imgArr.length
            if (imgCount == 1) {
                $api.css(listContent[i].getElementsByClassName('content_img')[0], 'width:3.26rem;height:2.86rem;margin-top:.1rem');

            } else {
                for (var j = 0; j < imgCount; j++) {
                    $api.css(listContent[i].getElementsByClassName('content_img')[j], 'height:1.56rem');
                }
            }
        }
    }
    // 筛选后结果
    function bySelect() {
        api.addEventListener({
            name: 'screeningResults1'
        }, function(ret, err) {
            dataList=[];
            if (ret.value.flag) {
                // $api.css($api.dom('.title1'), 'display:block');
                parameter = ret.value.parameter
            }
            condition = ret.value.condition
            page_num = 1;
            requireData(ret.value.condition);
            api.pageUp({
                top: true
            }, function (ret, err) { });
        })

        api.addEventListener({
            name: 'addPublish'
        }, function(ret, err) {
            api.openFrame({
                name: 'supply_addSupply',
                url: 'supply_addSupply.html',
                rect: {
                    x: 0,
                    y: api.pageParam.headerH,
                    w: api.winWidth,
                    h: api.winHeight
                },
                bounces: false
            });
        });
    }
    // 筛选后页面变化
    function viewResults(ele) {

        $api.css($api.dom('.results'), 'background: #fff url(../../image/icon_zk.png)no-repeat;background-position: right center;-webkit-background-size: .15rem .25rem;background-size: .15rem .25rem;');
        // $api.css(ele, 'b');
        // getData(data2);
        // selfAdaption();
        if ($api.text(ele) == '查看订阅的筛选结果') {
            // getData(data3);
            // selfAdaption();
            api.openWin({
                name: 'supply_subscribeWin',
                url: './supply_subscribeWin.html',
                pageParam: {
                    name: 'value'
                }
            });
        }
        $api.html(ele, '查看订阅的筛选结果');
    }

    // 请求数据
    function requireData(data,bottomFlag) {
        // console.log('参数:::'+JSON.stringify(data))
        var data = data || {};
        var latitude, longitude, latitudeNum, longitudeNum;
        // if (data !== {}) {
        //     if (data.order == 'distance') {
        bMap.getLocation({
            accuracy: '100m',
            autoStop: true,
            filter: 1
        }, function(ret, err) {
            if (ret.status) {
                data.latitude = ret.lat;
                data.longitude = ret.lon;
                var supplyCache = $api.getStorage('supply_publish_2');
                if (supplyCache) {
                    // console.log(JSON.stringify(supplyCache))
                    getData(supplyCache);
                }
                renderData(data, supplyCache, bottomFlag);
            } else {
                var supplyCache = $api.getStorage('supply_publish_2');
                if (supplyCache) {
                    // console.log(JSON.stringify(supplyCache))
                    getData(supplyCache);
                    selfAdaption();
                }
                renderData(data, supplyCache, bottomFlag);
                $api.css($api.dom('.loading'), 'display: none');
                api.refreshHeaderLoadDone()
            }
        });
        //     }
        // }
    }
    function renderData(data, supplyCache, bottomFlag) {
        api.ajax({
            url: apiSite + '/demand/index',
            method: 'post',
            headers: apiHeader,
            data: {
                values: {
                    token: $api.getStorage('userToken'),
                    // keyword: '',
                    type: data.type || '',
                    // sub_type: data.sub_type || '',
                    category_ids: data.category_ids || '',
                    order: data.order || '',
                    latitude: data.latitude || '',
                    longitude: data.longitude || '',
                    page_num: page_num
                }
            }
        }, function(ret, err) {
            // 停止下拉刷新
            // console.log(JSON.stringify(ret));
            api.refreshHeaderLoadDone()
            if (ret) {
                if (supplyCache === ret.data.list) {

                } else {
                    renderPage(ret, bottomFlag);
                    $api.setStorage('supply_publish_2', ret.data.list);
                    if (ret.data.list.length < 15) {
                        $api.css($api.dom('.bbottomLoading'), 'display: none');
                    }
                }
            } else {
                alert(JSON.stringify(err.msg))
            }
        })
    }
    // 进入详情
    function info(ele) {
        var flag = 0;
        var compaby_name = $api.attr(ele, 'data-company'),
            demand_id = $api.attr(ele, 'data-id');
        if (compaby_name != '') {
            flag = 1;
        }
        // alert(flag +'---'+ compaby_name)
        api.openWin({
            name: 'supply_info_demand_win',
            url: './supply_info_demand_win.html',
            pageParam: {
                flag: flag,
                compaby_name: compaby_name,
                demand_id: demand_id
            }
        });

    }
</script>

</html>