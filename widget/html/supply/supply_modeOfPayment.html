<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
        body,html{
            background-color: rgba(0,0,0,0.3);
            height: 100%;
        }
        .main {
            width: 6.1rem;
            height: 6.26rem;
            background-color: #fff;
            border-radius: .2rem;
            margin: 0 auto;
            vertical-align: middle;
            /* 垂直居中 */
            position: absolute;
            top: 0;
            bottom: 0;  
            left: 0;
            right: 0; 
            margin: auto;


        }
       
        .zf, .title {
            font-size: .28rem;
            height: 1.56rem;
            vertical-align: middle;
            border-bottom: .01rem solid #EFEFEF;
        }
        .zf {
            line-height: 1.2rem;
            vertical-align: middle;
            height: 1.2rem;
            position: relative;
        }
        
         .title {
            font-size: .34rem;
            text-align: center;
            line-height: 1.56rem;
        }
        
        /* 选择图标 */
        .icon {
            display: inline-block;
            width: .43rem;
            height: 1.2rem;
            background: url(../../image/icon_member/icon_cz01.png)no-repeat;
            -webkit-background-size: .43rem .43rem;
            background-size: .43rem .43rem;
            background-position: 0 center;
            margin-left: .8rem;
            margin-right: .6rem;
            }
        input {
            opacity: 0.5;
             width: .43rem;
            height: 1.2rem;
            position: absolute;
            left: .83rem;
            opacity: 0;
        }
        .select1 {
             background: url(../../image/icon_member/icon_cz02.png)no-repeat;
            -webkit-background-size: .43rem .43rem;
            background-size: .43rem .43rem;
            background-position: 0 center;
        }
        /* 支付图标 */
        .zfb, .wx, .ye {
            margin-right: .2rem;
            display: inline-block;
            width: .58rem;
            height: 1.2rem;
            background: url(../../image/icon_member/icon_zfb.png)no-repeat;
            -webkit-background-size: .58rem .58rem;
            background-size: .58rem .58rem;
            background-position: 0 center;
        }
        .wx {
             background: url(../../image/icon_member/icon_wx.png)no-repeat;
            -webkit-background-size: .58rem .58rem;
            background-size: .58rem .58rem;
            background-position: 0 center;
        }
        .ye {
             background: url(../../image/icon_member/icon_ye.png)no-repeat;
            -webkit-background-size: .58rem .58rem;
            background-size: .58rem .58rem;
            background-position: 0 center;
        }
        
        /* 底部按钮 */
        .btn {
            line-height: 1.05rem;
            font-size: 0;
        }
        .clear,.enter {
            height: 1.05rem;
            font-size: .34rem;
            width: 3.05rem;
            text-align: center;
            background-color: #EEEEEE;
            color: #08BB08;
        }
        .clear {
            border-bottom-left-radius: .2rem;
        }
        .enter {
            background-color: #08BB08;
            color: #fff;
            border-bottom-right-radius: .2rem;
            height: 1.08rem;
        }
    </style>
</head>
<body>
     <div class="main">
         <p class="title">支付￥<span class="money"></span>，请选择支付方式</p>
         <p class="zf zf1"   tapmode   onclick="selType(this)">
            <span   class="icon select1 fl" data-val='alipay'></span>
            <!-- <input class="fl" type="radio" name="zf"> -->
            <span class="zfb fl" ></span>
            <span class="text fl">支付宝</span>
        </p>
         <p class="zf"   tapmode   onclick="selType(this)" >
            <span class="icon  fl" data-val='wechat'></span>
            <!-- <input class="fl" type="radio" name="zf"> -->
            <span class="wx fl"></span>
           <span class="text fl">微信</span>
        </p>
        <p class="zf"   tapmode   onclick="selType(this)" >
            <span class="icon  fl" data-val='balance'></span>
            <!-- <input class="fl" type="radio" name="zf"> -->
            <span class="ye fl"></span>
           <span class="text fl">余额</span>
        </p>
        <div class="btn">
            <span class="clear fl"   tapmode   onclick="submit(this)">取消</span>
            <span class="enter fl"   tapmode   onclick="submit(this)">确定</span>
        </div>
     </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    var money;
    apiready = function(){
        console.log('156:::'+JSON.stringify(api.pageParam))
        moduleInit();
        $api.text($api.dom('.money'), api.pageParam.price);
    }
    function selType(ele) {
        for (var i = 0; i < document.getElementsByClassName('icon').length; i++) {
            $api.removeCls(document.getElementsByClassName('icon')[i],'select1')
        }
        $api.addCls(ele.getElementsByClassName('icon')[0], 'select1');
    }
  
    function submit(ele) {
        var obj;
        var text = $api.text(ele)
        if (text === '确定') {
            var pay_method = $api.attr($api.dom('.select1'), 'data-val');
            // alert($api.attr($api.dom('.select1'), 'data-val'))
            // console.log(JSON.stringify(obj))
            var url;
            if (api.pageParam.flag == 1) {
                // 买家付款未支付服务
                url = '/supply_order/buyerPayService';
                obj = api.pageParam.obj
                obj.pay_method = pay_method;
            } else if (api.pageParam.flag == 2) {
                // 买家补差价操作
                url = '/supply_order/buyerPayExtraMoney';
                obj = api.pageParam.obj
                obj.pay_method = pay_method;
            } else if (api.pageParam.flag == 3) {
                // 接收帮助付款
                url = '/demand_order/hostConfirmHelp';
                obj = api.pageParam.obj
                obj.pay_method = pay_method;

            } else {
                // 买家购买供应操作
                url = '/supply_order/buyerCreateOrder';
                var obj = api.pageParam.obj;
                obj.token = $api.getStorage('userToken');
                obj.pay_method = pay_method;
                obj.pay_password = '';
                if (obj.service_time.length < 18) {
                    obj.service_time = obj.service_time+':00'
                }
            }
            console.log('193:::'+JSON.stringify(obj));
            if (pay_method == 'balance') {
                // 余额支付
                // 判斷是否设置支付密码
                api.ajax({
                    url: apiSite + '/settings/checkPayPassword',
                    method: 'post',
                    headers: apiHeader,
                    data: {
                           values: { 
                               token: $api.getStorage('userToken'),
                           }
                    }
                }, function(ret, err) {
                    if(ret) {
                        if(ret.data.is_set_pay_password) {
                            // 已设置
                            api.openFrame({
                                name: 'frameName',
                                url: './supply_psdKeyset.html',
                                rect: {
                                    x: 0,
                                    y: 0,
                                    w: api.winWidth,
                                    h: api.winHeight
                                },
                                pageParam: {
                                    obj: obj,
                                    url: url,
                                    price: api.pageParam.price,
                                    form: api.pageParam.form,
                                    flag: 1,
                                    paramPhone: api.pageParam.paramPhone
                                },
                                bounces: false
                            });
                        } else {
                            // 未设置, 打开设置密码界面
                            api.openWin({
                                name: 'me_hy_tx_setPsd_win',
                                url: '../me/me_hy_tx_setPsd_win.html',
                            });

                        }
                    } else {
                        alert(JSON.stringify(err))
                    }
                })
            } else {
                api.ajax({
                    url: apiSite + url,
                    method: 'post',
                    headers: apiHeader,
                    data: {
                           values: obj
                    }
                }, function(retAJAX, err) {
                    if(retAJAX) {
                        if (retAJAX.code !== 200) {
                            alert(JSON.stringify(retAJAX.msg))
                        } else {
                            if (api.pageParam.flag === 3) {
                                // 接收帮助付款
                                if (pay_method === 'wechat') {
                                    // 微信支付
                                   
                                   wxPayFun(obj,retAJAX,'receiveHelp');
                                } else if (pay_method === 'alipay') {
                                    aliPay.payOrder({
                                      orderInfo: retAJAX.data.config
                                    },function(ret,err) {
                                       if (ret) {
                                        console.log(JSON.stringify(ret))
                                            if (ret.code == 9000) {
                                                api.openWin({
                                                    name: 'supply_payResult_win',
                                                    url: './supply_payResult_win.html',
                                                    pageParam: {
                                                        obj: obj,
                                                        price: api.pageParam.price,
                                                        form: api.pageParam.form,
                                                        flag: 1,
                                                        flagType:'receiveHelp',
                                                        supplyFlag:api.pageParam.flag,
                                                        paramPhone: api.pageParam.paramPhone
                                                    }
                                                });
                                                api.sendEvent({
                                                    name: 'saleMoney'
                                                });
                                                api.sendEvent({
                                                    name: 'filterOrder'
                                                });
                                                api.closeWin();
                                            } else {
                                                api.openWin({
                                                    name: 'supply_payResult_win',
                                                    url: './supply_payResult_win.html',
                                                    pageParam: {
                                                        obj: obj,
                                                        supplyFlag:api.pageParam.flag,
                                                        flag: 0,
                                                    }
                                                });
                                            }
                                        } else {
                                            console.log(JSON.stringify(err))
                                        }
                                    });
                                } else {
                                    api.openWin({
                                        name: 'me_gdd',
                                        url: '../me/me_gdd.html'
                                    });
                                    setTimeout(function(){api.closeFrame();},1000)
                                }
                                
                            } else {
                                if (pay_method === 'wechat') {
                                    // 微信支付
                                   wxPayFun(obj,retAJAX,'receiveHelp');

                                } else if (pay_method === 'alipay') {
                                    aliPay.payOrder({
                                      orderInfo: retAJAX.data.config
                                    },function(ret,err) {
                                        if (ret) {
                                            console.log('成功::'+JSON.stringify(ret))
                                                //支付成功
                                            if (ret.code == 9000) {
                                                api.openWin({
                                                    name: 'supply_payResult_win',
                                                    url: './supply_payResult_win.html',
                                                    pageParam: {
                                                        obj: obj,
                                                        price: api.pageParam.price,
                                                        form: api.pageParam.form,
                                                        flag: 1,
                                                        supplyFlag:api.pageParam.flag,
                                                        flagType:'receiveHelp',
                                                        paramPhone: api.pageParam.paramPhone
                                                    }
                                                });
                                                api.sendEvent({
                                                    name: 'saleMoney'
                                                });
                                                api.sendEvent({
                                                    name: 'filterOrder'
                                                });
                                                api.closeWin();
                                            } else {
                                                // alert(JSON.stringify(ret))
                                            }
                                            
                                        } else {
                                            console.log(JSON.stringify(err))
                                        }
                                    });
                                } else {
                                    api.openWin({
                                        name: 'me_gdd',
                                        url: '../me/me_gdd.html'
                                    });
                                    setTimeout(function(){api.closeFrame();},1000)
                                }
                            
                            }
                            // setTimeout(function(){api.closeFrame();},1000)
                        }
                    } else {
                        alert(JSON.stringify(err.msg))
                    }
                })
            }
        } else {
            api.closeFrame();
        }
        
    }
    function wxPayFun(obj,retAJAX, flagType) {
         wxPay.payOrder({
            apiKey: retAJAX.data.config.appid,
            orderId: retAJAX.data.config.prepayid,
            mchId: retAJAX.data.config.partnerid,
            nonceStr: retAJAX.data.config.noncestr,
            timeStamp: retAJAX.data.config.timestamp,
            package: retAJAX.data.config.package,
            sign: retAJAX.data.config.sign
        }, function(ret, err) {
            if (ret) {
                if (ret.status) {
                    //支付成功
                    api.openWin({
                        name: 'supply_payResult_win',
                        url: './supply_payResult_win.html',
                        pageParam: {
                            obj: obj,
                            price: api.pageParam.price,
                            form: api.pageParam.form,
                            flag: 1,
                            supplyFlag:api.pageParam.flag,
                            flagType: flagType,
                            paramPhone: api.pageParam.paramPhone
                        }
                    });
                  api.sendEvent({
                        name: 'saleMoney'
                    });
                  api.sendEvent({
                        name: 'filterOrder'
                    });
                    api.closeWin();
                } else {
                    // api.toast({
                    //     msg: ret.statusMessage || '取消支付'
                    // });
                }
            } else {
                alert(JSON.stringify(err))
            }
        })
    }
    function payFruitPage(obj,ret) {
        
    }

    
</script>
</html>