<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/swiper.min.css"/>
    <style type="text/css">
        img.default {
            width: 7.5rem;
            height: 4.36rem;
        }
        .main {
            margin-bottom: 1.2rem;
        }
        .img {
            font-size: 0;
        }
        .img img {
            width: 7.5rem;
            height: 3.76rem;
        }
        .title {
            height: 1rem;
            padding: 0 .3rem;
            box-sizing: border-box;
            border-bottom: .01rem solid #E8E8E8;
            background-color: #fff;
        }
        .title img {
            width: .7rem;
            height: .7rem;
        }
        .titleRight {
            font-size: 0;
            padding-left: .2rem;
            box-sizing: border-box;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: hidden;
        }
        .titleRight h3 {
            font-size: .3rem;
            line-height: .42rem;

        }
        .titleRight p {
            font-size: .24rem;
            line-height: .33rem;
            color: #999;
        }
        .title2 {
            padding: .2rem .3rem .1rem;
            border-bottom: .01rem solid #E8E8E8;
            background-color: #fff;
        }
         .title2 .typeIcon {
            line-height: .24rem;
            text-align: center;
            border-radius: .04rem;
            width: .41rem;
            height: .24rem;
            font-size: .16rem;
            color: #576c96;
            border: .02rem solid #576c96;
            margin-right: .1rem;
        }

        .title2 .shareIcon {
            width: .258rem;
            height: .36rem;
            background: url(../../image/icon_supply/icon_share.png)no-repeat;
            -webkit-background-size: .258rem .36rem;
            background-size: .258rem .36rem;

        }
        .title2 .titleName {
            font-size: 0;

        }
        .title2 .titleName p {
            font-size: .34rem;
        }
        .price {
            font-size: 0;
            margin: .2rem 0 .45rem;
            /*width: 100%;*/
        }
        .price .priceText {
            color: #D0011B;
            font-size: .34rem;
        }
        .price .priceText .price1{
            font-size: .34rem;
        }
        .price .time {
            color: #999;
            font-size: .24rem;
        }

        .sold_cound,
        .avg_point {
            margin-left: .1rem;
            font-size: 0;
        }
        .avg_point .avg_pointIcon {
            width: .245rem;
            height: .245rem;
            background: url(../../image/icon_supply/icon_xx.png)no-repeat;
            -webkit-background-size: .245rem .245rem;
            background-size: .245rem .245rem;
            margin-right: .06rem;
        }
        .sold_cound .count, .form{
            font-size: .24rem;
            color: #999;
            /*margin-right: .2rem;*/
            /*margin-bottom: .1rem;*/
        }

        .sel {
            height: .8rem;
            padding: 0 .3rem;
            font-size: 0;
            line-height: .8rem;
            margin: .2rem 0;
            background-color: #fff;
        }
        .sel .selTitle {
            font-size: .3rem;
            color: #999;
        }
        .sel .selText {
            font-size: .3rem;
            color: #000;
        }
        .sel .selIcon {
            width: .15rem;
            height: .25rem;
            background: url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;
        }
        .infoTitle {
            margin-bottom: .3rem;
            font-size: 0;
        }
        .infoTitle .line {
            width: .97rem;
            height: .01rem;
            background-color: #999;
        }
        .infoTitle .imgIcon {
            width: .34rem;
            height: .29rem;
            background: url(../../image/icon_supply/icon_init.png)no-repeat;
            -webkit-background-size: .34rem .29rem;
            background-size: .34rem .29rem;
            margin-right: .1rem;
        }
        .infoTitle .infoTitleText {
            font-size: .34rem;
            line-height: .48rem;


        }

        .infoTitle .text {
            margin: 0 .2rem;
            font-size: 0;
        }
        .info {
            background-color: #fff;
            padding: .2rem .3rem;
        }
        .infoData {
            font-size: 0;
        }
        .infoData p {
            font-size: .3rem;
            color: #555;
            margin: .3rem 0;
        }
        .infoData img {
            width: 6.9rem;
            margin-bottom: .3rem;
        }
        .comment {
            margin-top: .2rem;
            background-color: #fff;
        }
        .comment .commentCount {
            font-size: .3rem;
        }
        .comment .commentTitle {
            width: 100%;
            box-sizing: border-box;
            font-size: 0;
            line-height: .8rem;
            height: .8rem;
            background-color: #fff;
            border-bottom: .01rem solid #D9D9D9;
            padding: 0 .3rem;
        }
        .comment .commentIcon {
            width: .15rem;
            height: .25rem;
            background: url(../../image/icon_zk.png)no-repeat;
            -webkit-background-size: .15rem .25rem;
            background-size: .15rem .25rem;

        }
        .commentContent {
            font-size: 0;
            padding: .25rem .3rem .25rem 0;
            margin-left: .3rem;
            border-bottom: .01rem solid #d9d9d9;
            background-color: #fff;
        }
        .commentContentTitle img {
            width: .76rem;
            height: .76rem;
            margin-right: .2rem;
        }
        .commentName {
            width: 6.24rem;
        }
 
        .commentNameLeft {
            font-size: 0;
        }
        .commentNameLeft .name {
            font-size: .34rem;
        }
        .commentNameRight {
            font-size: .24rem;
            color: #999;
        }
        .commentText {
            font-size: .3rem;
            color: #555;
            margin-top: .18rem;
        }
        .btn {
            height: .75rem;
        }
        .btn>div {
            color: #D0011B;
            font-size: .24rem;
            width: 1.4rem;
            height: .4rem;
            margin: 0 auto;
            border: 2px solid #D0011B;
            border-radius: .1rem;
            text-align: center;
            line-height: .4rem;

        }
        footer {
            font-size: 0;       
            height: .88rem;   
            position: fixed;
            bottom: 0;  
            left: 0;    
            width: 100%;     
            background-color: #fff;
            border-top: .01rem solid #F8F8F8;
         }
         footer.footer {
            color: #fff;
            font-size: .3rem;   
            height: .88rem;   
            position: fixed;
            text-align: center;
            line-height: .88rem;    
            bottom: 0;  
            left: 0;    
            width: 100%;
            border-top: .01rem solid #F8F8F8;
            background-color: #0ABB07;     
         }
         footer span {
            font-size: .18rem;  
            color: #999;
            text-align: center; 
            float: left;
         }
         footer span:nth-child(1),
         footer span:nth-child(2) {
             width: 25%;    
         }
 
         footer span:nth-child(3) {
             font-size: .3rem;  
             width: 50%; 
             line-height: .88rem;  
             background-color: #0ABB07;
             color: #fff;
         }
          footer i {
             display: inline-block;  
             width: 100%;    
             height: .55rem; 
             background: url(../../image/icon_supply/icon_chat.png)no-repeat;
            background-size: .4rem .38rem;
            background-position: center bottom;
         }
         footer span:nth-child(2) i {
            background: url(../../image/icon_supply/icon_collect.png)no-repeat;
            background-size: .4rem .35rem;
            background-position: center bottom;
         }
         footer span i.cancelCollect {
            background: url(../../image/icon_supply/icon_collect02.png)no-repeat;
            background-size: .4rem .35rem;
            background-position: center bottom;
         }
         .loading {
            width: .8rem;
            height: .8rem;
            background: url(../../image/loading_more.gif)no-repeat;
            background-size: .8rem .8rem;
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
            margin: auto;
         }
         #cloaswin {
            width: .44rem;  
            height: .44rem; 
            background: url(../../image/icon_supply/icon_callback.png)no-repeat;
            -webkit-background-size: .44rem .44rem;
            background-size: .44rem .44rem;
            position: fixed;    
            top: .55rem;                
            left: .3rem;        
         }  
          header.header {
            background-color: rgba(58,57,62,.1);
            position: fixed;
            width: 7.5rem;
            top: 0;
            left: 0;
            z-index: 999;
         }
         header .head {
            background-color: rgba(58,57,62,0)
         }
         .swiper-wrapper img {
            height: 4.36rem;
         }
         header .rightBtn {
            line-height: .5rem;
            color: #fff;
            font-size: .65rem;
         }
    </style>
</head>     
<body>
    <!-- <div id="cloaswin" onclick="api.closeWin();"></div> -->
    <header  class="header">
        <div class="head">
            <span class="callback"   tapmode   onclick="api.closeWin()">返回</span>
            <span class="winTitle">
                信息详情
            </span>
            <!-- <div class="rightBtn">...</div> -->
        </div>
    </header>
    <!-- <div class="loading" ></div> -->
    <div class="swiper-container">
        <div class="swiper-wrapper">
            <!-- <img src="http://imgsrc.baidu.com/imgad/pic/item/83025aafa40f4bfb281dbe70094f78f0f63618c0.jpg" class="swiper-slide blue-slide">
            <img src="http://imgsrc.baidu.com/imgad/pic/item/5366d0160924ab18cb0aad123ffae6cd7b890bf2.jpg" class="swiper-slide red-slide">
            <img src="http://img.taopic.com/uploads/allimg/140826/267848-140R60T34860.jpg" class="swiper-slide orange-slide"> -->
        </div>
        <div class="swiper-pagination">
            
        </div>
    </div>
    <div class="resultList"></div>
    <script type="text/x-dot-template" id="listT">
        <div class="main flex-def flex-zTopBottom">
            <div class="title flex-def flex-zLeftRight flex-cCenter" tapmode onclick="openUserInfoPage(this)" data-id="{{=it.info.user_id}}">
                <img src="{{=it.info.head_img_url}}" id="headImg" >
                <div class="titleRight">
                    <h3>{{=it.info.nickname}}</h3>
                    {{?it.info.current_company==null&&it.info.current_position!=null}}
                        <p> {{=it.info.current_position}}</p>
                    {{??it.info.current_position==null&&it.info.current_company!=null}}
                        <p>{{=it.info.current_company}}</p>
                    {{??it.info.current_position==null&&it.info.current_company==null}}
                    {{??}}
                        <p>{{=it.info.current_company}} {{=it.info.current_position}}</p>
                    {{?}}
                </div>
            </div>
            <div class="title2">
                <div class="top flex-def flex-zBetween">
                    <div class="titleName flex-def flex-zLeftRight flex-cCenter">
                        <span class="typeIcon">{{=it.info.type}}</span>
                        <p class="supplyName">{{=it.info.title}}</p>
                    </div>
                    <!-- 分享按钮 -->
                    <!-- <div class="shareIcon"></div> -->
                </div>
                <div class="price flex-def flex-zBetween flex-zLeftRight">
                    <div class="priceText">
                        ￥<span class="price1">{{=it.info.price}}/{{=it.info.unit}}</span>
                    </div>
                    <div class="time">
                        {{=it.info.create_time}}
                    </div>
                </div>
                <div class="sold_cound flex-def flex-zLeftRight flex-cCenter">
                    <span class="count">[已售{{=it.info.sold_count}}]</span>
                    <span class="avg_point">
                        {{for(var i = 0;i < it.info.avg_point;i++){ }}
                            <span class="avg_pointIcon"></span>
                        {{};}}
                    </span>
                </div>
                {{?it.info.form == 1}}
                    <div class="form">线上服务</div>
                {{??}}
                    <div class="form">线下服务</div>
                {{?}}
            </div>
            <!-- <div class="sel flex-def flex-zBetween flex-cCenter">
                <div>
                    <span class="selTitle">已选：</span>
                    <span class="selText">设计、“APP图标”</span>
                </div>
                <span class="selIcon"></span>
            </div> -->
            <div class="info">
                <div class="infoTitle flex-def flex-zCenter flex-cCenter flex-zLeftRight">
                    <span class="line"></span>
                    <div class="text flex-def flex-zLeftRight flex-cCenter">
                        <span class="imgIcon"></span>
                        <span class="infoTitleText">详情</span>
                    </div>
                    <span class="line"></span>
                </div>
                <div class="infoData">
                    <p>{{=it.info.description}}</p>
                    {{?it.info.image_json.length != 0}}
                        {{for(var i=0;i< it.info.image_json.length; i++){ }}
                            <img src="{{=it.info.image_json[i]}}">
                        {{ }; }}
                    {{??it.info.image_json.length == 0}}
                    {{?}}
                </div>
            </div>
            <div class="comment">
                <div class="commentTitle flex-def flex-cCenter flex-zBetween">
                    <span class="commentCount">评论（{{=it.info.comment_count}}）</span>
                    <!-- <span class="commentIcon"></span> -->
                </div>
                {{?it.last_comment!=null}}
                    <div class="commentContent">
                        <div class="commentContentTitle flex-def flex-zLeftRight">
                            <img src="{{=it.last_comment.head_img_url}}">
                            <div class="commentName flex-def flex-zBetween flex-zLeftRight flex-cCenter">
                                <div class="commentNameLeft flex-def flex-cCenter">
                                    <div class="name">{{=it.last_comment.nickname}}</div>
                                    <div class="avg_point">
                                        {{ for(var j = 0;j < it.last_comment.point;j++){ }}
                                            <span class="avg_pointIcon"></span>
                                        {{ }; }}
                                    </div>
                                </div>
                                <div class="commentNameRight">
                                    {{=it.last_comment.create_time}}
                                </div>
                            </div>
                        </div>
                        <p class="commentText">{{=it.last_comment.content}}</p>
                    </div>
                {{?}}
                
                {{?it.info.comment_count==0}}
                {{??}}
                    <div data-avg="{{=it.info.avg_point}}" class="btn flex-def flex-cCenter" tapmode onclick="openCommentPage(this)">
                        <div>查看全部</div>
                    </div>
                {{?}}
            </div>
          
        </div>
        {{?!it.is_self_add}}
        <footer>    
            <span tapmode onclick="openChatPage(this)" data-rongId="{{=it.info.rongcloud_user_id}}"><i></i>聊天</span>
            {{?it.is_collect}}
                <span id="collect" ontouchstart="supplyCollect(this)"><i class="cancelCollect"></i>取消收藏</span>
            {{??}}
                <span id="collect" ontouchstart="supplyCollect(this)"><i></i>收藏</span>
            {{?}}
            <span tapmode onclick="immediateOrder(this)">立即下单</span>
        </footer>
        {{??}}
        <footer class="footer" ontouchstart="editSupply()">编辑</footer>
        {{?}}
    </script>
  
    
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/jquery.min.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript" src="../../script/swiper.min.js"></script>
<script type="text/javascript">
    var transmitData,_dataSource = ["次","幅","单","小时","分钟","天","周","月","份", "个", "扇", "课时", "面议","其他","未定义"];
    apiready = function(){
        fnInit();
        // 初始化页面
        window.onscroll = function() {
            $api.css($api.dom('header.header'), 'background-color: rgba(58,57,62,' + document.body.scrollTop/145 + ')');
        }
        initialise(api.pageParam.flag, api.pageParam.compaby_name, api.pageParam.supply_id);
        api.addEventListener({
            name: 'editSupplyAfter'
        }, function(ret, err) {
            if (ret) {
                initialise(ret.value.flag, ret.value.compaby_name, ret.value.supply_id)
            } else {
                alert(JSON.stringify(err));
            }
        });
    };
    // 打开聊天页面
    function openChatPage(ele) {
        var rong_id = $api.attr(ele, 'data-rongId');
        var userName = $api.text($api.dom('h3'));
        // 头像 昵称 供应名字 价格 单位
        var userHeadImg = $api.attr($api.byId('headImg'), 'src');
        var supplyName = $api.text($api.dom('.supplyName'));
        var priceUint = $api.text($api.dom('.price')); 
        api.openWin({
            name: 'chatPage',
            url: '../news/chatPage.html',
             pageParam: {
                type:'supplyInfo',
                targetRongId: rong_id,
                nickname: userName,
                userHeadImg: userHeadImg,
                supplyName: supplyName,
                priceUint: priceUint,
                order_id: api.pageParam.order_id
            }
        });
    }
    // 打开用户详情
    function openUserInfoPage(ele) {
        var userId = $api.attr(ele, 'data-id');
        api.openWin({
            name: 'winName',
            url: '../addressList/txl_memberInfo_Win.html',
            pageParam: {
                userId: userId
            }
        });
    }
    // 打开评论页面
    function openCommentPage(ele) {
        var avg = $api.attr(ele, 'data-avg');
        api.openWin({
            name: 'supply_commentPage_win',
            url: './supply_commentPage_win.html',
            pageParam: {
                supply_id: api.pageParam.supply_id,
                avg: avg
            }
        });
    }
    // 编辑供应
    function editSupply() {
        api.openWin({
            name: 'winName',
            url: './supply_releaseSupply_win.html',
            pageParam: {
                flag: api.pageParam.flag,
                compaby_name: api.pageParam.compaby_name,
                supply_id: api.pageParam.supply_id
            }
        });
    }
    // 收藏供应
    function supplyCollect(ele) {
        var url;
        if ($api.text(ele) === '收藏') {
            $api.html(ele, '<i class="cancelCollect"></i>取消收藏');
            url = '/supply/collect';
        } else {
            $api.html(ele, '<i></i>收藏');
            url = '/supply/cancelCollect';
            
        }
        api.ajax({
            url: apiSite + url,
            method: 'post',
            headers: apiHeader,
            data: {
                   values: { 
                       token: $api.getStorage('userToken'),
                       supply_id: api.pageParam.supply_id
                   }
            }
        }, function(ret, err) {
            if(ret) {
                // // alert(JSON.stringify(ret))
                if ($api.text(ele) === '收藏') {
                    api.toast({
                        msg: '取消收藏成功'
                    });
                } else {
                    
                    api.toast({
                        msg: '收藏供应成功'
                    });
                }
               
            } else {
                alert(JSON.stringify(err.msg))
            }
        })
    }
    // 初始化页面
    function  initialise(flag, compaby_name, supply_id) {
        // if (flag) {
        //     $api.css($api.byId('companyTtile'), 'display:block');
        //     $api.text($api.byId('compaby_name'), compaby_name);
        // } else {
        //     $api.css($api.byId('companyTtile'), 'display:none');
        // }   
        // 请求数据
        api.ajax({
            url: apiSite + '/supply/detail',
            method: 'post',
            headers: apiHeader,
            data: {
               values: { 
                   token: $api.getStorage('userToken'),
                   supply_id: supply_id
               }
            }
        }, function(ret, err) {
            console.log(JSON.stringify(ret))
            // 解析图片json
            ret.data.info.image_json = eval(ret.data.info.image_json);
            var eleHtml='';
            for (var i = 0; i < ret.data.info.image_json.length; i++) {
                eleHtml += '<img src="'+ ret.data.info.image_json[i] +'?imageView2/1/w/750/h/436/format/jpg/q/100|imageslim" class="swiper-slide blue-slide">'
                ret.data.info.image_json[i] = ret.data.info.image_json[i] + '?imageMogr2/auto-orient/thumbnail/710x/blur/1x0/quality/100|imageslim'
            }
            console.log(eleHtml)
            if (eleHtml) {
                $api.html($api.dom('.swiper-wrapper'), eleHtml);
            } else {
                 $api.html($api.dom('.swiper-wrapper'), '<img class="default" src="../../image/noimage.jpg">');
            }
             if (ret.data.info.image_json.length > 1) {
                swiperFun();
             }
            // 处理时间显示
            ret.data.info.create_time = initTime(ret.data.info.create_time)   
            if (ret.data.info.unit > 0) {
                ret.data.info.unit = _dataSource[ret.data.info.unit-1]
            } else {
                ret.data.info.unit = '未定义'
            }
            ret.data.info.type = ret.data.info.type === 1 ? "个人" : "公司";
            $api.css($api.dom('.loading'), 'display:none'); 
            getData(ret.data);
            // ret.data
            transmitData = ret.data.info;
        })
    }
    function swiperFun() {  
        var mySwiper = new Swiper('.swiper-container',{
            loop: true,
            autoplay: 3000,
            pagination : '.swiper-pagination',
            observer: true,  //修改swiper自己或子元素时，自动初始化swiper
            observeParents: true,    //修改swiper的父元素时，自动初始化swiper
        });
    }
    function immediateOrder(ele) {
        // 下单
        api.openWin({
            name: 'supply_info_immediate_order',
            url: './supply_info_immediate_order_2.html',
            softInputMode: 'pan',
            pageParam: {
                transmitData: transmitData,
            }
        });
        // 接单
        // api.openWin({
        //     name: 'supply_info_immediate_order',
        //     url: './supply_info_immediate_order.html',
        //     softInputMode: 'pan',
        //     pageParam: {
        //         transmitData: transmitData,
        //         supply_id: api.pageParam.supply_id
        //     }
        // });
    }
   
</script>
</html>