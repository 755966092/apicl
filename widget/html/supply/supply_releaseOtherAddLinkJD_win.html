<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"
    />
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/weui.css" />
    <style>
        .introduction {
            font-size: 0.24rem;
            color: #999;
            width: 6.7rem;
            margin: 0 auto;
            margin-top: 0.36rem;
        }

        .mt36 {
            margin-top: 0.36rem;
        }

        .weui-cell__bd {
            position: relative;
        }

        .weui-input {
            width: 95%;
        }

        i {

            position: absolute;
            right: 0;
            top: 0;
            display: none;
            width: 0.25rem;
            height: 100%;
            background: url(../../image/icon_login/icon-clearText.png)no-repeat;
            background-position: center;
            background-size: .25rem;
        }

        .weui-panel__bd {
            background-color: #fff;
        }

        .weui-media-box__bd {
            font-size: 0;
        }

        .weui-media-box_appmsg .weui-media-box__hd {
            width: 2.22rem;
            height: 2.22rem;
            margin-right: 0.2rem;
        }

        .weui-media-box__bd {
            height: 2.2rem;
        }

        .currentPrice {
            font-size: .3rem;
            color: #CC0019;
        }

        .originalPrice {
            font-size: .24rem;
            color: #3F3F3F;
            text-decoration: line-through;
        }

        .clear {
            font-size: .3rem;
            color: #5D7099;



        }

        .weui-media-box__title {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            white-space: normal
        }

        .hide {
            display: none;
        }

        .weui-cells {
            border-bottom: #d9d9d9 solid .01rem;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="head">
            <span class="callback" tapmode onclick="api.closeWin()">返回</span>
            <span class="winTitle">
            </span>
            <span class="rightBtn" tapmode onclick="enter()">确定</span>
        </div>
    </header>
    <div class="mt36">
        <div class="weui-panel__bd hide" id="list">
            <a href="javascript:void(0);" class="weui-media-box weui-media-box_appmsg">
                <div class="weui-media-box__hd">
                    <img class="weui-media-box__thumb" src="" alt="">
                </div>
                <div class="weui-media-box__bd flex-def flex-zBetween flex-zTopBottom">
                    <h4 class="weui-media-box__title" id="title"></h4>
                    <div>
                        <!-- <p class="currentPrice" id="currentPrice">$30</p> -->
                        <p class="flex-def flex-zBetween">
                            <span class="currentPrice" id="currentPrice"></span>
                            <span class="clear" tapmode onclick="clearLink()">取消链接</span>
                        </p>
                    </div>
                </div>
            </a>
        </div>
        <div id="ipt">
            <div class="weui-cells ">
                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <input class="weui-input" oninput="clearBtn(this)" type="text" placeholder="将电商app中想要添加的商品链接复制到这里">
                        <i tapmode onclick="clearText()"></i>
                    </div>
                </div>
            </div>
            <p class="introduction">打开淘宝APP，打开选好的商品详情，点击右上角的分享，复制商品链接</p>
        </div>
    </div>

</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    var obj, paramObj;
    apiready = function () {
        obj = api.pageParam.obj.jd
        fnInit();
        initPage();
    };
    function initPage() {
        console.log(JSON.stringify(api.pageParam, null, 4))
        if (obj) {
            // 选完后的
            runderPage(obj.title, obj.price, obj.img_url);
            clearLink(1);
        } else {
            // 第一次选
            clearLink()
        }
        if (api.pageParam.source == 1) {
            $api.text($api.dom('.winTitle'), '添加京东链接');
            $api.attr($api.dom('input'), 'placeholder', '将京东app中想要添加的商品链接复制到这里');
            $api.text($api.dom('.introduction'), '打开京东APP，打开选好的商品详情，点击右上角的分享，复制商品链接');
        } else if (api.pageParam.source == 2) {
            $api.text($api.dom('.winTitle'), '添加淘宝链接');
            $api.attr($api.dom('input'), 'placeholder', '将淘宝app中想要添加的商品链接复制到这里');
            $api.text($api.dom('.introduction'), '打开淘宝APP，打开选好的商品详情，点击右上角的分享，复制商品链接');
        } else {

        }
    }
    function clearBtn(ele) {
        var textLength = $api.val(ele);
        if (textLength.length) {
            $api.css($api.dom('i'), 'display: inline-block;');
        } else {
            $api.css($api.dom('i'), 'display: none')
        }
    }
    function clearText() {
        $api.val($api.dom('input'), '');
        $api.css($api.dom('i'), 'display: none')
    }
    // 取消链接
    function clearLink(n) {
        if (n) {
            $api.removeCls($api.byId('list'), 'hide');
            $api.addCls($api.byId('ipt'), 'hide');
        } else {
            $api.removeCls($api.byId('ipt'), 'hide');
            $api.addCls($api.byId('list'), 'hide');
            obj = {};
        }
    }
    // 提交
    function enter() {
        // input 隐藏关闭本业
        // 否则提交解析王子
        if ($api.hasCls($api.byId('ipt'), 'hide')) {
            api.sendEvent({
                name: 'addOtherLink',
                extra: {
                    obj: obj,
                    source: api.pageParam.source
                }
            });

            api.closeWin()

        } else {
            if ($api.val($api.dom('input'))) {
                api.ajax({
                    url: apiSite + '/supply/extraProductInfo',
                    method: 'post',
                    headers: apiHeader,
                    data: {
                        values: {
                            token: $api.getStorage('userToken'),
                            url_str: $api.val($api.dom('input'))
                        }
                    }
                }, function (ret, err) {
                    if (ret) {
                        if (ret.code === 200) {
                            if (ret.data.info) {
                                if (ret.data.info.source == api.pageParam.source) {
                                    obj = ret.data.info;
                                    runderPage(ret.data.info.title, ret.data.info.price, ret.data.info.img_url)
                                    clearLink(1);
                                } else {
                                    alert('您输入的不是' + (api.pageParam.source == 1 ? '京东' : '淘宝') + '的链接, 请重新输入')
                                    clearText();
                                }
                            } else {
                                alert('您输入的不是' + (api.pageParam.source == 1 ? '京东' : '淘宝') + '的链接, 请重新输入')
                                clearText();
                            }
                        } else {
                            alert(ret.msg)
                        }
                    } else {
                        alert(JSON.stringify(err))
                    }
                })
            } else {
                api.sendEvent({
                    name: 'addOtherLink',
                    extra: {
                        obj: '',
                        source: api.pageParam.source
                    }
                });
                api.closeWin()
            }
            

        }
    }
    function runderPage(title, price, img_url) {
        $api.text($api.byId('title'), title);
        $api.text($api.byId('currentPrice'), '￥' + price);
        $api.attr($api.dom('img'), 'src', img_url);
    }
</script>

</html>