<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no" />
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <style>
        header.header {
            background-color: #EDECF3;
            
        }
        header.header .head {
            background-color: #EDECF3;
        }
        .main {
            text-align: center;
        }
        .main h3 {
            font-size: .44rem;
            line-height: .62rem;
        }
        .main .textContent {
            font-size: .28rem;
            line-height: .33rem;
            color: #888;
            padding: 0 .53rem;
            text-align: left;
            margin-top: .68rem;
        }
        ul {
            margin-top: .32rem;
            list-style: disc;
            padding: 0 0 0 .8rem;
        }
        ul li {
            list-style: disc;
            margin-top: .1rem;  
            font-size: .22rem;
            line-height: .33rem;
            color: #b2b2b2;
            width: 5.94rem;
            text-align: left;
        }
        .btn {
            width: 6.8rem;
            height: .86rem;
            background-color: #1AAD19;
            font-size: .34rem;
            line-height: .86rem;
            color: #fff;
            text-align: center;
            margin: 0 auto;
            border-radius: 2px;
        }
        .after {
            font-size: .28rem;
            line-height: .4rem;
            margin-top: .32rem;
            color: #576B95;
            text-align: center;
        }
        footer {
            position: fixed;
            bottom: .4rem;
            left: 0;
            width: 100%;
        }
    </style>
</head>
<body>
    <header class="header"></header>
    <div class="main">
        <h3>加朋友</h3>
        <div class="textContent">
            我在请求上传你的手机通讯录至我在服务器，帮你匹配手机通讯录中已在使用我在的朋友。我们上传通讯录仅用于匹配朋友，不会保存任何资料，亦不会用作它用。
        </div>
        <ul>
            <li>你的通讯录都不会明文发送</li>
            <li>你的信息仅仅用于查找朋友，所有信息都会被加密并安全存储任何人都无法查看你的通讯录信息</li>
            <li>你随时可以在“设置-隐私”中修改通讯录相关的隐私设置</li>
            <li>如果通讯录中联系人的联系方式发生变化，请及时整理通讯录</li>
        </ul>
        
    </div>
    <footer>
        <p class="btn"   tapmode   onclick="accessAddressBook()">同意，并进入我在</p>
        <p class="after"   tapmode   onclick="openMainPage()">以后再说</p>
    </footer>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/pinyin4js.js"></script>
<script>

    apiready = function(){
        fnInit();
        moduleInit();
    }
    var contactArr = {
            "status": true,
            "pages": 3,
            "contacts": [],
            "total": 6987
        };
    function queryContactByPage(page) {
        $api.css($api.dom('.loading'), 'display: block');
        if ("undefined" == typeof page) {
            var page = 0;
        }
        var contacts = api.require('contacts');
        contacts.queryByPage({
            count: 3000,
            pageIndex: page
        }, function (ret, err) {
            if (ret.status) {
                contactArr.contacts = contactArr.contacts.concat(ret.contacts);
                if (page < (ret.pages - 1)) {
                    queryContactByPage(page + 1);
                } else {
                    accessAddressBook(contactArr)
                }
            } else {
                api.toast({
                    msg: '请在系统的设置-隐私-通讯录界面允许我在访问您的通讯录'
                });
            }
        });
    }
    // 同步通讯录
    function accessAddressBook(contactArr) {
        api.ajax({
            url: apiSite + '/contact/sync',
            method: 'post',
            headers: apiHeader,
            data: {
                values: { 
                    token: $api.getStorage('userToken'),
                    contact_json: contactArr
                }
            }
        }, function(ret, err) {
            openDb($api.getStorage('userToken'))
            requestData();
            // 获得极光推送
            ajpush.getRegistrationId(function(ret) {
                var registrationId = ret.id;
                $api.setStorage('registrationId', registrationId);
                var appVersion = api.appVersion;
                // $api.setStorage('registration_id', registrationId);
                // $api.setStorage('appVersion', appVersion);
                api.ajax({
                    url: apiSite + '/settings/registerDevice',
                    method: 'post',
                    headers: apiHeader,
                    data: {
                            values: {
                                token: $api.getStorage('userToken'),
                                registration_id: registrationId,
                                version: appVersion
                            }
                    }
                }, function(ret, err) {
                    if(ret) {
                        api.openWin({
                            name: 'main',
                            url: '../main.html',
                            slidBackEnabled: false,
                            pageParam: {
                                userToken: api.pageParam.userToken,
                                rongToken: api.pageParam.rongToken
                            }
                            });
                    } else {
                        alert(JSON.stringify(err))
                    }
                })
            });
        })
        openMain();
    }
    function openMain() {
          // 获得极光推送
        ajpush.getRegistrationId(function(ret) {
            var registrationId = ret.id;
            $api.setStorage('registrationId', registrationId);
            var appVersion = api.appVersion;
            // $api.setStorage('registration_id', registrationId);
            // $api.setStorage('appVersion', appVersion);
            api.ajax({
                url: apiSite + '/settings/registerDevice',
                method: 'post',
                headers: apiHeader,
                data: {
                       values: {
                           token: $api.getStorage('userToken'),
                           registration_id: registrationId,
                           version: appVersion
                       }
                }
            }, function(ret, err) {
                if(ret) {
                    api.openWin({
                        name: 'main',
                        url: '../main.html',
                        slidBackEnabled: false,
                        pageParam: {
                            userToken: api.pageParam.userToken,
                            rongToken: api.pageParam.rongToken
                        }
                     });
                } else {
                    alert(JSON.stringify(err))
                }
            })
        });
       
    }

     // 打开数据库
    function openDb(userToken) {
        // alert('打开数据库'+userToken)
        // 打开数据库
        db.openDatabase({
            name: 'db_'+userToken
        }, function(ret, err) {
            if (ret.status) {
                // alert('打开成功');
                db.executeSql({
                    name: 'db_'+userToken,
                    sql: 'CREATE TABLE IF NOT EXISTS addressList(user_id int PRIMARY KEY NOT NULL, nickname varchar(255),real_name varchar(255), head_img_url varchar(255), current_position varchar(255), current_company varchar(255), current_degree varchar(255), current_contact varchar(255), titleSize int, title varchar(255), img varchar(255), flag varchar(255), litter varchar(255), type int, sex varchat(10), remark_nickname varchar(255),  remark_real_name varchar(255) , remark_head_img_url varchar(255) , remark_sex varchar(255) , remark_birthday varchar(255) , remark_hometown varchar(255) , remark_current_company varchar(255) , remark_current_position varchar(255) , remark_current_degree varchar(255), remark_current_contact varchar(255), current_status varchar(255))'
                }, function(ret, err) {
                    // ;CREATE UNIQUE INDEX user_id_idx on addressList (user_id);
                    if (ret.status) { 
                        // console.log(JSON.stringify(ret));
                        // alert('执行成功')

                    } else {
                        alert('新建表错误:'+JSON.stringify(err));
                    }
                });
               db.executeSql({
            name: 'db_'+$api.getStorage('userToken'),
            sql: 'CREATE TABLE IF NOT EXISTS addressList_simplify(user_id int PRIMARY KEY NOT NULL, title varchar(255),img varchar(255), subTitle varchar(255), current_contact varchar(255), flag varchar(255), type int)'   
        }, function(ret, err){        
            if( ret.status ){
                //console.log('新建表成功')
                db.executeSql({
                    name: 'db_'+$api.getStorage('userToken'),
                    sql: 'CREATE INDEX IF NOT EXISTS type_idx ON addressList_simplify (type);'    
                }, function(ret, err){        
                    if( ret.status ){
                        db.executeSql({
                            name: 'db_'+$api.getStorage('userToken'),
                            sql: 'CREATE INDEX IF NOT EXISTS flag_idx ON addressList_simplify (flag);'    
                        }, function(ret, err){        
                            if( ret.status ){
                               
                            }else{
                                alert( JSON.stringify( err ) );
                            }
                        });
                    }else{
                        alert( JSON.stringify( err ) );
                    }
                });
            }else{
                alert( JSON.stringify( err ) );
            }
        });
            } else {
                alert('新建库错误:'+JSON.stringify(err));
            }
        });
    }
    // 请求数据
    function requestData() {
        // console.log('请求数据')
        api.ajax({
            url: apiSite + '/contact/index',
            method: 'post',
            headers: apiHeader,
            data: {
               values: { 
                  token: $api.getStorage('userToken'),
               }
            }
       }, function(ret, err) {
            //console.log('请求数据2222222'+JSON.stringify(ret))
            api.ajax({
                url: apiSite + '/contact/friend',
                method: 'post',
                headers: apiHeader,
                data: {
                       values: { 
                           token: $api.getStorage('userToken'),
                       }
                }
            }, function(retFriend, err) {
                if(retFriend) {
                    if (retFriend.code == 200) {
                        disData(ret.data.friend_list.concat(retFriend.data.list), 4)
                    } else {
                        alert(retFriend.msg)                        
                    }
                } else {
                    alert(JSON.stringify(err))
                }
            })
            disData(ret.data.single_list, 1)
            disData(ret.data.both_list, 2)
            disData(ret.data.unavailable_list, 3)
       })
           
    }
    function disData (data, type) {
        // console.log('disData'+type)
        // console.log('disData'+data)
        if (data != '') {
            for (var i = 0; i < data.length; i++) {
                // single_list
                // both_list
                // friend_list
                // 去除空格
                data[i].nickname = $api.trimAll(data[i].nickname)
                if (data[i].remark_nickname) {
                    data[i].litter = PinyinHelper.getShortPinyin(data[i].remark_nickname).toUpperCase();
                } else {
                    data[i].litter = PinyinHelper.getShortPinyin(data[i].nickname).toUpperCase();
                }
                // data[i].litter = PinyinHelper.getShortPinyin(data[i].nickname).toUpperCase();
                data[i].title = data[i].nickname;
                data[i].img = data[i].head_img_url;
                data[i].titleSize = 15;
                if (data[i].current_position == null) {
                    data[i].current_position = '';
                } 
                if (data[i].current_company == null) {
                    data[i].current_company = '';
                }
            }
            // 模块数据格式
            litterSort(data, type)
            // sqlSyntax(initialData);
        }
    }
    // 排序
    function litterSort(data,type) {
        for (var i = 0; i < data.length; i++) {
            for (var j = 0; j < data.length; j++) {
                if (data[i].litter < data[j].litter) {
                    var temp = data[i];
                    data[i] = data[j];
                    data[j] = temp;
                }
            }
         }
         sqlSyntax(data, type);
    }
    // 拼数据库语法字符串
    function sqlSyntax(data1, type) {
        // console.log('数据库'+ type)
        // console.log('数据库'+ data1)
        for (var i = 0; i < data1.length; i++) {
            data1[i].flag = data1[i].litter[0];
        }
        // console.log('数据库语法字符串:'+data1);
        var SQLName = 'db_'+$api.getStorage('userToken');
        var SQL = 'INSERT OR REPLACE INTO addressList(user_id,nickname,real_name,head_img_url,current_company,current_position,current_contact,current_degree, titleSize,title,img,flag,litter,type, sex, remark_nickname, remark_real_name, remark_head_img_url, remark_sex, remark_birthday, remark_hometown, remark_current_company, remark_current_position, remark_current_degree, remark_current_contact) VALUES '
        var SQL2 = 'INSERT OR REPLACE INTO addressList_simplify(user_id,title,img,subTitle,current_contact, flag,type) VALUES ';
        for (var i = 0; i < data1.length; i++) {
                var subTitleStr= '',contactStr = '';
                SQL += '('+data1[i].user_id+',"'+ data1[i].nickname +'","'+ data1[i].head_img_url +'","'+ (data1[i].current_company || "") +'","'+ (data1[i].current_position || "")+'","'+ (data1[i].current_contact || "") +'","'+ (data1[i].current_degree || "") +'","'+ data1[i].titleSize +'","'+ data1[i].title +'","'+ data1[i].img+'","'+ data1[i].flag +'","'+ data1[i].litter +'","'+ type +'","'+ (data1[i].sex || 1) +'","'+ (data1[i].remark_nickname || "") +'","'+ (data1[i].remark_real_name || "") +'","'+ (data1[i].remark_head_img_url || "") +'","'+ (data1[i].remark_sex || "") +'","'+ (data1[i].remark_birthday || "") +'","'+ (data1[i].remark_hometown || "") +'","'+ (data1[i].remark_current_company || "") +'","'+ (data1[i].remark_current_position || "") +'","'+ (data1[i].remark_current_degree || "") +'","'+ (data1[i].remark_current_contact || "") +'"),';
                if (data1[i].remark_current_company) {
                    subTitleStr += data1[i].remark_current_company+" "   
                } else if(data1[i].current_company){
                    subTitleStr += data1[i].current_company+" "   
                } else {
                   
                }
                if (data1[i].remark_current_position) {
                    subTitleStr += data1[i].remark_current_position + " "
                } else if (data1[i].current_position) {
                    subTitleStr += data1[i].current_position + " "
                } else {
                   
                }
                if (data1[i].remark_current_degree) {
                    subTitleStr += data1[i].remark_current_degree+" "
                } else if (data1[i].current_degree) {
                    subTitleStr += data1[i].current_degree+" "
                } else {
                   
                }
                if (data1[i].remark_current_contact) {
                    contactStr = data1[i].remark_current_contact;
                } else if(data1[i].current_contact) {
                    contactStr = data1[i].current_contact
                } else {
                    
                }
                // subTitleStr
                SQL2 += '('+data1[i].user_id+',"'+ (data1[i].remark_nickname || data1[i].nickname) +'","'+ (data1[i].remark_head_img_url || data1[i].head_img_url) +'","'+ subTitleStr+'","'+ contactStr +'","'+  data1[i].flag  +'","'+ type  +'"),';            
            }
        SQL = SQL.substring(0,SQL.length-1) + ';'
        SQL2 = SQL2.substring(0,SQL2.length-1) + ';'
        // console.log(SQL)
        db.executeSql({
            name: SQLName,
            sql: SQL2
        }, function(ret, err) {
            if (ret.status) {
                db.executeSql({
                    name: SQLName,
                    sql: SQL
                }, function(ret, err) {
                    if (ret.status) {
                        //console.log('执行语句正确'+JSON.stringify(ret));
                        api.closeWin({
                            name: 'login_enroll1'
                        });
                        api.closeWin({
                            name: 'registerWin2'
                        });
                        api.closeWin();
                    } else {
                        //console.log('执行语句错误:' + JSON.stringify(err))
                    }
                });
            } else {
                //console.log('执行语句错误:' + JSON.stringify(err))
            }
        });
    }
    
    function openMainPage() {
        // 设置缓存字段, 未获取通讯录权限
        $api.setStorage('noAccessToContacts', 'true');
        api.openWin({
            name: 'main',
            url: '../main.html',
            slidBackEnabled: false,
            pageParam: {
                userToken: api.pageParam.userToken,
                rongToken: api.pageParam.rongToken
            }
        });
    }
</script>
</html>
